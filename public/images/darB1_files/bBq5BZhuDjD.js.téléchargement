;/*FB_PKG_DELIM*/

__d("ACTSanitizerApiLazyLoader",["JSResourceForInteraction","MAWMpsGating"],(function(a,b,c,d,e,f,g){"use strict";var h=null,i=512*1024,j=1024*1024;function a(){h==null&&(h=k());var a=h;void a.then(function(a){a=a.getWasmMemorySize();a!=null&&a>=(d("MAWMpsGating").isMpsEnabled()?j:i)&&(h=k())});return a}function k(){return c("JSResourceForInteraction")("ACTSanitizerApiWasm").__setRef("ACTSanitizerApiLazyLoader").load().then(function(a){return a.ACTSanitizerWasm()})}g.loadACTSanitizerApi=a}),98);
__d("ArmadilloReceiveWriteDbFailureFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("5720");b=d("FalcoLoggerInternal").create("armadillo_receive_write_db_failure",a);e=b;g["default"]=e}),98);
__d("ArmadilloTaskHandlers",["JSResourceForInteraction"],(function(a,b,c,d,e,f,g){"use strict";b={add:(a=c("JSResourceForInteraction"))("AddTaskHandler").__setRef("ArmadilloTaskHandlers"),get_messenger_db_dump_attachments_for_bug_reporting:a("GetMessengerDBDumpAttachments").__setRef("ArmadilloTaskHandlers"),maw_get_devices:a("MAWGetDevicesTaskHandler").__setRef("ArmadilloTaskHandlers"),preload_messenger_db_dump_attachments_for_bug_reporting:a("PreloadDBDumpAttachments").__setRef("ArmadilloTaskHandlers"),test:a("TestNativeTaskHandler").__setRef("ArmadilloTaskHandlers"),zenon_send_chatd_mws_message:a("MAWZenonSendMultiwayMsgChatdTaskHandler").__setRef("ArmadilloTaskHandlers")};g.TASK_HANDLERS_RESOURCES=b}),98);
__d("MAWCommonWebWorkerErrorLogging",["Env","ErrorGuard","ErrorPubSub","ErrorSetup","ErrorTransport","JSErrorLoggingConfig","SiteData","getErrorSafe"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function a(){var a;(h||(h=c("ErrorGuard"))).skipGuardGlobal((i||(i=c("Env"))).nocatch);c("ErrorSetup").setup({appId:c("JSErrorLoggingConfig").appId,client_revision:c("SiteData").client_revision,extra:c("JSErrorLoggingConfig").extra,loggingFramework:"worker",projectBlocklist:c("JSErrorLoggingConfig").projectBlocklist,report_source:c("JSErrorLoggingConfig").report_source,report_source_ref:c("JSErrorLoggingConfig").report_source_ref,sample_weight:(a=c("JSErrorLoggingConfig").sampleWeight)!=null?a:0,site_category:"armadillo-worker"},d("ErrorTransport").log);self.addEventListener("unhandledrejection",function(a){a=a.reason;(j||(j=c("ErrorPubSub"))).reportError(c("getErrorSafe")(a))})}c("ErrorSetup").preSetup();g.init=a}),98);
__d("MAWPREListeners",["MAWODSProxy","MAWQplProxy","SiteData","WALogger","WAMapWithDefault","WAOdsEnums","WAPREList","WAPREMetrics","qpl"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Received unreachable stage value for the event"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["The QPL event of "," was processed already"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["The QPL event of "," was processed already"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["The QPL event of "," was processed already"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["The QPL event of "," was completed or failed already"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot RESUME without instanceKey"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["The QPL event of "," was completed or failed already"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["Received unreachable stage value for the ODS event"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["Event "," not implemented"]);p=function(){return a};return a}function a(){d("WAPREMetrics").subscribe(r)}var q=new(d("WAMapWithDefault").MapWithDefault)(function(){return new Map()});function b(a){return r(a)}function r(a){switch(a.name){case d("WAPREList").PRE_METRIC.EBDB_INIT:t(c("qpl")._(521473151,"2593"),a);break;case d("WAPREList").PRE_METRIC.DELETE_THREAD:t(c("qpl")._(1056845732,"691"),a);break;case d("WAPREList").PRE_METRIC.FRANKING_VALIDATION:t(c("qpl")._(25299246,"150"),a);break;case d("WAPREList").PRE_METRIC.QUERY_GROUPS:t(c("qpl")._(741087294,"2028"),a);break;case d("WAPREList").PRE_METRIC.QUERY_GROUP:s(d("WAOdsEnums").Entity.WA_QUERY_GROUP,a);break;case d("WAPREList").PRE_METRIC.OFFLINE_RETRY:t(c("qpl")._(25309990,"124"),a);break;case d("WAPREList").PRE_METRIC.MEDIA_DOWNLOAD:t(c("qpl")._(25312150,"83"),a);break;case d("WAPREList").PRE_METRIC.MEDIA_UPLOAD:t(c("qpl")._(25313100,"131"),a);break;case d("WAPREList").PRE_METRIC.MEDIA_VALIDATE:t(c("qpl")._(25304678,"2352"),a);break;case d("WAPREList").PRE_METRIC.GET_DEVICES:s(d("WAOdsEnums").Entity.GET_DEVICES,a);break;case d("WAPREList").PRE_METRIC.MESSAGE_DECRYPTION:t(c("qpl")._(25306682,"11176"),a);s(d("WAOdsEnums").Entity.DECRYPTION,a);break;case d("WAPREList").PRE_METRIC.DECRYPT_MESSAGE_FINAL:t(c("qpl")._(741087294,"2028"),a);break;case d("WAPREList").PRE_METRIC.MESSAGE_ENCRYPTION:t(c("qpl")._(25299294,"12933"),a);t(c("qpl")._(741087294,"2028"),a);break;case d("WAPREList").PRE_METRIC.OFFLINE_QUEUE:t(c("qpl")._(25306361,"5664"),a);break;case d("WAPREList").PRE_METRIC.SYNCD_FATAL_ERROR:t(c("qpl")._(25310891,"540"),a);break;case d("WAPREList").PRE_METRIC.SEND_MESSAGE:t(c("qpl")._(25313175,"1551"),a);break;case d("WAPREList").PRE_METRIC.CREATE_GROUP:t(c("qpl")._(25307987,"970"),a);break;case d("WAPREList").PRE_METRIC.REMOVE_PARTICIPANTS:t(c("qpl")._(25312342,"971"),a);break;case d("WAPREList").PRE_METRIC.RECEIVE_MESSAGE:t(c("qpl")._(1056840931,"814"),a);break;case d("WAPREList").PRE_METRIC.SYNCD_CRITICAL_EVENT:t(c("qpl")._(25311142,"804"),a);break;case d("WAPREList").PRE_METRIC.SYNCD_CRITICAL_BOOTSTRAP_STAGE:t(c("qpl")._(741087294,"2028"),a);break;case d("WAPREList").PRE_METRIC.SYNCD_BOOTSTRAP_APP_STATE_DOWNLOAD:t(c("qpl")._(741087294,"2028"),a);break;case d("WAPREList").PRE_METRIC.SYNCD_DECRYPT_MUTATIONS:t(c("qpl")._(741087294,"2028"),a);break;case d("WAPREList").PRE_METRIC.SYNCD_BOOTSTRAP_DATA_APPLIED:t(c("qpl")._(741087294,"2028"),a);break;case d("WAPREList").PRE_METRIC.SYNCD:t(c("qpl")._(741087294,"2028"),a);break;case d("WAPREList").PRE_METRIC.APP_STATE_SYNC_DAILY:t(c("qpl")._(25306941,"813"),a);break;case d("WAPREList").PRE_METRIC.ICDC_ERROR:t(c("qpl")._(25313187,"948"),a);break;case d("WAPREList").PRE_METRIC.WA_DISCONNECT:s(d("WAOdsEnums").Entity.WA_DISCONNECT,a);break;case d("WAPREList").PRE_METRIC.WA_FAIL_STANZA_QUEUE_ITEM:s(d("WAOdsEnums").Entity.WA_FAIL_STANZA_QUEUE_ITEM,a);break;case d("WAPREList").PRE_METRIC.WA_JOBS_ORCHESTRATOR:t(c("qpl")._(25311870,"1004"),a);break;case d("WAPREList").PRE_METRIC.WA_JOB_MANAGER:t(c("qpl")._(25308825,"136"),a);break;case d("WAPREList").PRE_METRIC.SYNCD_KEY_ROTATION:t(c("qpl")._(25304909,"1204"),a);break;case d("WAPREList").PRE_METRIC.STANZA_QUEUE_MESSAGE_CONSUMER:break;case d("WAPREList").PRE_METRIC.DOWNLOAD_AND_DECRYPT:d("WALogger").ERROR(p(),a.name);break;case d("WAPREList").PRE_METRIC.ONE_QUEUE:t(c("qpl")._(25308201,"2007"),a);break;case d("WAPREList").PRE_METRIC.WORM:t(c("qpl")._(1056840657,"2716"),a);break;case d("WAPREList").PRE_METRIC.WA_NO_SIGNED_PRE_KEY:s(d("WAOdsEnums").Entity.WA_NO_SIGNED_PRE_KEY,a);break}}function s(a,b){var c;switch(b.stage){case"START":break;case"RESUME":case"POINT":case"ANNOTATE":case"CANCEL":break;case"SUCCESS":d("MAWODSProxy").odsBumpEntityKey({entity:a,key:(c=(c=b.annotations)==null?void 0:(c=c.string)==null?void 0:c.key)!=null?c:"success"},!0);break;case"FAIL":d("MAWODSProxy").odsBumpEntityKey({entity:a,key:b.reason},!0);break;default:b.stage;d("WALogger").ERROR(o());break}}function t(a,b){var e=babelHelpers["extends"]({},b.annotations);switch(b.stage){case"START":if(q.get(a).has(b.instanceKey))return;var f=babelHelpers["extends"]({},e,{"int":babelHelpers["extends"]({},e["int"],{sharedWorkerRev:c("SiteData").client_revision})});f=d("MAWQplProxy").startQplUserFlow(a,f,{providedTimeoutInMs:b.timeoutInMs});q.get(a).set(b.instanceKey,f);break;case"ANNOTATE":f=q.get(a).get(b.instanceKey);if(f==null){d("WALogger").WARN(n(),b.name);return}f.addAnnotations(e);break;case"RESUME":if(b.instanceKey==null){d("WALogger").ERROR(m());return}if(u(a,b.instanceKey))return;f=d("MAWQplProxy").startQplUserFlow(a,e,{providedInstanceKey:b.instanceKey});q.get(a).set(b.instanceKey,f);break;case"POINT":f=q.get(a).get(b.instanceKey);if(f==null){d("WALogger").WARN(l(),b.name);return}f.addPoint(b.reason,e);break;case"SUCCESS":f=q.get(a).get(b.instanceKey);if(f==null){d("WALogger").WARN(k(),b.name);return}f.endSuccess(e);q.get(a)["delete"](b.instanceKey);break;case"CANCEL":f=q.get(a).get(b.instanceKey);if(f==null){d("WALogger").WARN(j(),b.name);return}f.endCancel(e);q.get(a)["delete"](b.instanceKey);break;case"FAIL":f=q.get(a).get(b.instanceKey);if(f==null){d("WALogger").WARN(i(),b.name);return}f.endFail(b.reason,e);q.get(a)["delete"](b.instanceKey);break;default:d("WALogger").ERROR(h());break}}function u(a,b){return q.get(a).has(b)||a===c("qpl")._(25313175,"1551")}g.initializeWAPREMetrics=a;g.testOnly_logger=b}),98);
__d("WAAbPropConverters",[],(function(a,b,c,d,e,f){"use strict";function a(a){if(!a)return{};var b={};Object.keys(a).forEach(function(c){var d=a[c];d!=null&&(b[c]=d)});return b}f.convertAbPropsToPlainObject=a}),66);
__d("WAAbPropsCache",["WAAbPropConverters"],(function(a,b,c,d,e,f,g){"use strict";var h=86400;a=function(){function a(a){var b=a.abKey,c=a.abHash,d=a.lastSyncTime,e=a.expoKeyStr,f=a.refresh,g=a.internalExpoKeys,h=a.propExpoKeys,i=a.propValues;a=a.overridePropValues;this.$1=a!=null?a:{};this.$2=i;this.$4=c;this.$3=b;this.$5=d;this.$7=f;this.$6=e;this.$8=g;this.$9=h}var b=a.prototype;b.getAbProp=function(a){var b;return this.$1[a]!=null?this.$1[a]:(b=this.$2)==null?void 0:b[a]};b.getHash=function(){return this.$4};b.getRefreshSecs=function(){var a;return(a=this.$7)!=null?a:h};b.overrideAbProp=function(a,b){this.$1[a]=b};b.readAll=function(){var a={abKey:this.$3,hash:this.getHash(),refresh:this.getRefreshSecs(),lastSyncTime:this.$5||0};this.$9!=null&&(a.propExpoKeys=this.$9);this.$8!=null&&(a.internalExpoKeys=this.$8);this.$6!=null&&(a.expoKeyStr=this.$6);if(this.$2!=null){var b=this.$2;b!=null&&(a.propValues=d("WAAbPropConverters").convertAbPropsToPlainObject(b),this.$1!=null&&(a.propValues=babelHelpers["extends"]({},a.propValues,d("WAAbPropConverters").convertAbPropsToPlainObject(this.$1))))}return a};b.rewrite=function(a){var b=a.abKey,c=a.abHash,d=a.lastSyncTime,e=a.expoKeyStr,f=a.refresh,g=a.internalExpoKeys,h=a.propExpoKeys;a=a.propValues;this.$2=a;this.$4=c;this.$3=b;this.$5=d;this.$7=f;this.$6=e;this.$8=g;this.$9=h};return a}();g.AbPropsCache=a}),98);
__d("WAAbPropsConverters",["WAAbPropsTypes","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["convertDbAbPropsToParsed: unsure how to read ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["convertAbPropsParsedToDbEntity: unsure how to read ",""]);i=function(){return a};return a}function a(a){var b={expoKeyStr:a.expoKeyStr,internalExpoKeys:a.internalExpoKeys?Array.from(a.internalExpoKeys):[],lastSyncTime:a.lastSyncTime,refresh:a.refresh};a.abHash!=null&&(b.abHash=a.abHash);a.abKey!=null&&(b.abKey=a.abKey);if(a.propExpoKeys){var c=a.propExpoKeys,e=[];Object.keys(c).forEach(function(a){a=Number(a);var b={expoKey:a};c[a]!=null&&(b.value=c[a]);e.push(b)});b.propExpoKeys=e}if(a.propValues){var f=a.propValues,g=[];Object.keys(f).forEach(function(a){var b={name:a,value:{}};switch(typeof f[a]){case"boolean":b.value.boolValue=f[a];break;case"number":b.value.intValue=f[a];break;case"string":b.value.strValue=f[a];break;default:d("WALogger").WARN(i(),f[a]);return}g.push(b)});b.propValues=g}return b}function b(a){var b={expoKeyStr:a.expoKeyStr,internalExpoKeys:a.internalExpoKeys,lastSyncTime:a.lastSyncTime,propExpoKeys:a.propExpoKeys,refresh:a.refresh};a.hash!=null&&(b.abHash=a.hash);a.abKey!=null&&(b.abKey=a.abKey);if(a.propValues){var c=a.propValues,d={};Object.keys(c).forEach(function(a){c[a]!=null&&(d[a]=c[a])});b.propValues=d}return b}function c(a){var b=a.abHash,c=a.abKey,e=a.expoKeyStr,f=a.internalExpoKeys,g=a.lastSyncTime,i=a.propExpoKeys,j=a.propValues;a=a.refresh;b={abHash:b,abKey:c,expoKeyStr:e,lastSyncTime:g,refresh:a};f!=null&&(b.internalExpoKeys=new Set(f));if(i!=null){var k={};i.forEach(function(a){a.expoKey!=null&&(k[a.expoKey]=a.value)});b.propExpoKeys=k}if(j!=null){var l={};j.forEach(function(a){var b=a.name,c=d("WAAbPropsTypes").ABPropConfigs[b];if(c==null||c.length<3)return;c=c[2];switch(typeof c){case"boolean":l[b]=a.value.boolValue;return;case"number":l[b]=a.value.intValue;return;case"string":l[b]=a.value.strValue;return;default:d("WALogger").WARN(h(),c);return}});b.propValues=l}return b}g.convertAbPropsParsedToDbEntity=a;g.convertAbPropsDataToParsed=b;g.convertDbAbPropsToParsed=c}),98);
__d("WAGetAbPropsApi",["WAGetMetaApiV2"],(function(a,b,c,d,e,f,g){"use strict";a=function(){return d("WAGetMetaApiV2").getMeta().then(function(a){a=a.abProps;return a})};g.getAbProps=a}),98);
__d("WASetAbPropsApi",["WASetMetaApiV2"],(function(a,b,c,d,e,f,g){"use strict";a=function(a){return d("WASetMetaApiV2").setMeta({abProps:a})};g.setAbProps=a}),98);
__d("WAAbPropsInit",["WAAbProps","WAAbPropsCache","WAAbPropsConverters","WAAbPropsToUI","WAAbPropsTypes","WABridge","WAGetAbPropsApi","WALogger","WASetAbPropsApi","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["ABProps inited"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Starting ABProps store"]);i=function(){return a};return a}var j;function a(){if(!j)throw c("err")("Trying to get hash before AbProps gets initialized");return Promise.resolve(j.getHash())}function b(){if(!j)throw c("err")("Trying to get refresh secs before AbProps gets initialized");return Promise.resolve(j.getRefreshSecs())}var k={getAbProps:function(){if(!j)throw c("err")("Trying to read ABProps before they gets initialized");return Promise.resolve(j.readAll())},getHash:a,getRefreshSecs:b,setAbProps:async function(a){var b;a=d("WAAbPropsConverters").convertAbPropsDataToParsed(a);(b=j)==null?void 0:b.rewrite(a);await d("WASetAbPropsApi").setAbProps(d("WAAbPropsConverters").convertAbPropsParsedToDbEntity(a));l(a)}};function l(a){if(!a.propValues)return;a=d("WAAbPropsToUI").prepareAbPropsForUI(a.propValues);d("WABridge").getBridge().fireAndForget("event","abPropsUpdated",{abProps:a})}async function e(){d("WALogger").LOG(i());var a=await d("WAGetAbPropsApi").getAbProps(),b={};a&&(b=d("WAAbPropsConverters").convertDbAbPropsToParsed(a));j=new(d("WAAbPropsCache").AbPropsCache)(b);d("WAAbProps").startAbProps(k,d("WAAbPropsTypes").ABPropConfigs);l(b);d("WALogger").LOG(h())}function f(a,b){if(j==null)throw c("err")("Trying to override ABProp before they get initialized");var e=j;e.overrideAbProp(a,b);l(d("WAAbPropsConverters").convertAbPropsDataToParsed(e.readAll()))}function m(a){return d("WAAbPropsTypes").ABPropConfigs[a][2]}function n(){if(!j)throw c("err")("Trying to read ABProps before they get initialized");return j.readAll()}function o(a){if(!j)throw c("err")("Trying to read ABProp "+a+" before AbProps gets initialized");var b=j.getAbProp(a);return b!=null?b:m(a)}g.getHash=a;g.getRefreshSecs=b;g.initAbProps=e;g.overrideAbProp=f;g.getAbDefault=m;g.getAbProps=n;g.getAbProp=o}),98);
__d("MAWWebWorkerLogger",["MAWBridge","MAWConsoleLogger","MAWLeakDetection","MAWLoggingSwitches","MAWSaveLogToDisk","WAAbPropsInit","WAJids","WATagsLogger","err","fb-error"],(function(a,b,c,d,e,f,g){"use strict";var h=2;function a(){d("WATagsLogger").initializeWaLogger(i)}var i={count:function(a,b){k("count",a,b),d("MAWConsoleLogger").logToConsole("count",a,b)},debug:function(a,b,c){d("MAWConsoleLogger").logToConsole("log",a,b,c)},devConsole:function(a,b,c,e){for(var f=arguments.length,g=new Array(f>4?f-4:0),h=4;h<f;h++)g[h-4]=arguments[h];switch(a){case"COUNT":d("MAWConsoleLogger").logToConsole.apply(void 0,["count",b,c,e].concat(g));break;case"DEV":d("MAWConsoleLogger").logToConsole.apply(void 0,["log",b,c,e].concat(g));break;case"DEV_XMPP":d("MAWConsoleLogger").logToConsole.apply(void 0,["log",b,c,e].concat(g));break;case"LOG":d("MAWConsoleLogger").logToConsole.apply(void 0,["info",b,c,e].concat(g));break;case"WARN":d("MAWConsoleLogger").logToConsole.apply(void 0,["warn",b,c,e].concat(g));break;case"ERROR":d("MAWConsoleLogger").logToConsole.apply(void 0,["error",b,c,e].concat(g));break;case"CATCHING":d("MAWConsoleLogger").logToConsole.apply(void 0,["error",b,c,e].concat(g));break}},error:function(a,b,e){a=d("MAWLeakDetection").maybeReplaceVaultedString(a);e?l(a,b,e):l("webworker",b,c("err")(d("WAJids").maybeSanitizeLogLineText(a)));d("MAWConsoleLogger").logToConsole("error",a,b)},info:function(a,b){k("log",a,b),d("MAWConsoleLogger").logToConsole("info",a,b)},logRestricted:function(a,b){k("logRestricted",a,b),d("MAWConsoleLogger").logToConsole("log",a,b)},warn:function(a,b){k("warn",a,b),d("MAWConsoleLogger").logToConsole("warn",a,b)}};function j(){try{return d("WAAbPropsInit").getAbProp("msgrw_logger_entries")}catch(a){return d("WAAbPropsInit").getAbDefault("msgrw_logger_entries")}}function k(a,b,c){if(d("MAWLoggingSwitches").removeLoggingFromBridge){d("MAWSaveLogToDisk").saveLogEntry("worker",d("MAWSaveLogToDisk").formatLog({date:Date.now(),logLevel:a,logString:b,tags:c}));a==="count"&&d("MAWBridge").getBridge().fireAndForget("event","log",{logLevel:a,logString:b,tags:c},!0);return}a!=="debug"&&d("MAWBridge").getBridge().fireAndForget("event","log",{logLevel:a,logString:b,tags:c},!0)}async function b(){await d("MAWSaveLogToDisk").forceCachedLogEntryPersist()}function l(a,b,e){var f=0;if(e.taalOpcodes!=null){var g;(g=e.taalOpcodes)==null?void 0:g.forEach(function(a){a===c("fb-error").TAALOpcode.PREVIOUS_FRAME&&f++})}else f=h;d("MAWLoggingSwitches").removeLoggingFromBridge&&d("MAWSaveLogToDisk").saveLogEntry("worker",d("MAWSaveLogToDisk").formatErrorForLogging(a,b,e,f,j(),e.stack));d("MAWBridge").getBridge().fireAndForget("event","logError",{entriesToReport:j(),framesToPop:f,logString:a,message:e.message,stack:e.stack,tags:b},!0)}g.setupWebWorkerWaLogger=a;g.flushLogs=b}),98);
__d("WAQPLProxy",["WALogger","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["WAQPLProxy: Proxy implementation is not provided for ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["WAQPLProxy: Proxy implementation is not provided for ",""]);i=function(){return a};return a}function a(a,b,e,f,g){g===void 0&&(g=!0);if(j==null){d("WALogger").ERROR(i(),a);throw c("err")("WAQPLProxy: Proxy implementation is not provided")}return j.start(a,b,e,f,g)}function b(a,b){if(j==null){d("WALogger").ERROR(h(),a);throw c("err")("WAQPLProxy: Proxy implementation is not provided")}return j.resume(a,b)}var j=null;function e(a){j=a}g.waQPLProxyStart=a;g.waQPLProxyStartResume=b;g.provideProxyImplementationForWAQPLProxy=e}),98);
__d("BackendInitLoggingUtils",["ErrorMetadata","MAWCommonWebWorkerErrorLogging","MAWLoggerUtils","MAWPREListeners","MAWQplProxy","MAWWebWorkerLogger","MWSetupDBEncryption","WAQPLProxy","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h=function(a,b){return d("MAWQplProxy").measurePerfInQPL_USE_WITH_CARE(c("qpl")._(25310776,"6155"),"backend_"+a,b)};b=function(a){return d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(25310776,"6155"),a)};e=function(a){return d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(1056839232,"112"),a)};function a(){d("MAWWebWorkerLogger").setupWebWorkerWaLogger(),d("MAWCommonWebWorkerErrorLogging").init(),c("ErrorMetadata").addGlobalMetadata("MESSENGER_E2EE_WEB","ENVIRONMENT","worker"),d("MAWLoggerUtils").initMessengerWebLogging(),d("WAQPLProxy").provideProxyImplementationForWAQPLProxy({resume:d("MAWQplProxy").makeQplUserFlowFromExistedInstance,start:function(a,b,c,e,f){return d("MAWQplProxy").startQplUserFlow(a,b,{callBridgeWithTimestamp:f,providedInstanceKey:c,providedTimeoutInMs:e})}}),d("MAWPREListeners").initializeWAPREMetrics(),d("MWSetupDBEncryption").setPerformanceMeasurementTool(h)}g.measureMawInit=h;g.MAWInitPoint=b;g.MAWMICPoint=e;g.initializeBackendLogging=a}),98);
__d("BroadcastChannelClientServerHandshake",["FBLogger","Promise","Random","setTimeout"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){a.addEventListener("message",function(b){var c;((c=b.data)==null?void 0:c.type)==="BroadcastChannelHandshake-syn"&&a.postMessage({nonce:b.data.nonce,type:"BroadcastChannelHandshake-syn-ack"})})}function e(a,e){var f=d("Random").random(),g=0;return new(h||(h=b("Promise")))(function(b,d){var h=!1,i=function b(){if(g===6){h=!0;a.removeEventListener("message",j);try{throw c("FBLogger")("messenger_web").mustfixThrow("[LS] BC handshake failed, failing, likely worker failure%s",e!=null?" for"+e:"")}catch(a){d(a)}return}if(h)return;a.postMessage({nonce:f,type:"BroadcastChannelHandshake-syn"});c("setTimeout")(b,100*Math.pow(2,g++))},j=function c(d){var e;((e=d.data)==null?void 0:e.type)==="BroadcastChannelHandshake-syn-ack"&&((e=d.data)==null?void 0:e.nonce)===f&&(b(),h=!0,a.removeEventListener("message",c))};a.addEventListener("message",j);i()})}g.listen=a;g.checkAlive=e}),98);
__d("CometTaskFrameworkTypes",["$InternalEnum"],(function(a,b,c,d,e,f){"use strict";a=b("$InternalEnum").Mirrored(["UNKNOWN","BACKGROUND","CURRENT_THREAD","LS_WORKER","MAW_WORKER","TEST"]);c="comet_task_framework";f.ExecutionContext=a;f.TASK_FRAMEWORK_PREFIX=c}),66);
__d("CurrentWorkerMessagePort",["err","ifRequired"],(function(a,b,c,d,e,f,g){"use strict";var h=null;function a(){if(h==null)if("SharedWorkerGlobalScope"in self&&self instanceof self.SharedWorkerGlobalScope){var a;h=(a=c("ifRequired")("SharedWorkerBootstrapExperimental",function(a){return new a.CurrentSharedWorkerExperimentalAdapter()},function(){return null}))!=null?a:c("ifRequired")("CurrentSharedWorkerAdapter",function(a){return new a.CurrentSharedWorkerAdapter()},function(){return null})}else if("DedicatedWorkerGlobalScope"in self&&self instanceof self.DedicatedWorkerGlobalScope)h=self;else throw new Error("CurrentWorkerAdapter: Unsupported worker type");if(h==null)throw c("err")("CurrentWorkerAdapter: None of shared worker adapters are available");return h}g.getMessagePort=a}),98);
__d("InstamadilloCoreTypeActionLog.pb",["WAProtoConst"],(function(a,b,c,d,e,f,g){a={};b={};a.name="ActionLog";a.internalSpec={actionLogReaction:[1,d("WAProtoConst").TYPES.MESSAGE,b],__oneofs__:{actionLogSubtype:["actionLogReaction"]}};b.name="ActionLogReaction";b.internalSpec={emojiUnicode:[1,d("WAProtoConst").TYPES.STRING]};g.ActionLogSpec=a;g.ActionLogReactionSpec=b}),98);
__d("InstamadilloCoreTypeAdminMessage.pb",["WAProtoConst"],(function(a,b,c,d,e,f,g){a={DEVICE_ADMIN_MESSAGE_TYPE_NONE:0,DEVICE_ADMIN_MESSAGE_TYPE_LOCAL_USER_CHANGED_IDENTITY_KEY_NAMED_DEVICE:1,DEVICE_ADMIN_MESSAGE_TYPE_SECURITY_ALERT_PARTICIPANT_KEY_CHANGE:2,DEVICE_ADMIN_MESSAGE_TYPE_SECURITY_ALERT_PARTICIPANT_NEW_LOGIN:3};b={};c={};b.name="AdminMessage";b.internalSpec={deviceAdminMessage:[1,d("WAProtoConst").TYPES.MESSAGE,c],__oneofs__:{adminMessageSubtype:["deviceAdminMessage"]}};c.name="DeviceAdminMessage";c.internalSpec={deviceAdminMessageType:[1,d("WAProtoConst").TYPES.ENUM,a],deviceName:[2,d("WAProtoConst").TYPES.STRING]};g.DEVICE_ADMIN_MESSAGE_TYPE=a;g.AdminMessageSpec=b;g.DeviceAdminMessageSpec=c}),98);
__d("InstamadilloCoreTypeMedia.pb",["WAProtoConst"],(function(a,b,c,d,e,f,g){a={PJPEG_SCAN_CONFIGURATION_UNSPECIFIED:0,PJPEG_SCAN_CONFIGURATION_WA:1,PJPEG_SCAN_CONFIGURATION_E15:2,PJPEG_SCAN_CONFIGURATION_E35:3};b={RAVEN_VIEW_MODEL_UNSPECIFIED:0,RAVEN_VIEW_MODEL_ONCE:1,RAVEN_VIEW_MODEL_REPLAYABLE:2,RAVEN_VIEW_MODEL_PERMANENT:3};c={UNSET:0,NONE:1,NUDE:2};e={};f={};var h={},i={},j={},k={},l={},m={},n={},o={},p={};e.name="Media";e.internalSpec={staticPhoto:[1,(d=d("WAProtoConst")).TYPES.MESSAGE,f],voice:[2,d.TYPES.MESSAGE,h],video:[3,d.TYPES.MESSAGE,i],raven:[4,d.TYPES.MESSAGE,l],gif:[5,d.TYPES.MESSAGE,j],avatarSticker:[6,d.TYPES.MESSAGE,k],__oneofs__:{media:["staticPhoto","voice","video","raven","gif","avatarSticker"]}};f.name="StaticPhoto";f.internalSpec={mediaTransport:[1,d.TYPES.MESSAGE,o],height:[2,d.TYPES.INT32],width:[3,d.TYPES.INT32],scanLengths:[4,d.FLAGS.REPEATED|d.FLAGS.PACKED|d.TYPES.INT32],thumbnail:[5,d.TYPES.MESSAGE,n],pjpegScanConfiguration:[6,d.TYPES.ENUM,a]};h.name="Voice";h.internalSpec={mediaTransport:[1,d.TYPES.MESSAGE,o],duration:[2,d.TYPES.INT32],waveforms:[3,d.FLAGS.REPEATED|d.FLAGS.PACKED|d.TYPES.FLOAT],waveformSamplingFrequencyHz:[4,d.TYPES.INT32]};i.name="Video";i.internalSpec={mediaTransport:[1,d.TYPES.MESSAGE,o],height:[2,d.TYPES.INT32],width:[3,d.TYPES.INT32],thumbnail:[4,d.TYPES.MESSAGE,n],videoExtraMetadata:[5,d.TYPES.MESSAGE,p]};j.name="Gif";j.internalSpec={mediaTransport:[1,d.TYPES.MESSAGE,o],height:[2,d.TYPES.INT32],width:[3,d.TYPES.INT32],isSticker:[4,d.TYPES.BOOL],stickerId:[5,d.TYPES.STRING],gifUrl:[6,d.TYPES.STRING],gifSize:[7,d.TYPES.INT32],isRandom:[8,d.TYPES.BOOL]};k.name="AvatarSticker";k.internalSpec={mediaTransport:[1,d.TYPES.MESSAGE,o],isAnimated:[2,d.TYPES.BOOL],stickerId:[3,d.TYPES.STRING],stickerTemplate:[4,d.TYPES.STRING],nuxType:[5,d.TYPES.INT32]};l.name="Raven";l.internalSpec={viewMode:[1,d.TYPES.ENUM,b],content:[2,d.TYPES.MESSAGE,m]};m.name="RavenContent";m.internalSpec={staticPhoto:[1,d.TYPES.MESSAGE,f],video:[2,d.TYPES.MESSAGE,i],__oneofs__:{ravenContent:["staticPhoto","video"]}};n.name="Thumbnail";n.internalSpec={mediaTransport:[1,d.TYPES.MESSAGE,o],height:[2,d.TYPES.INT32],width:[3,d.TYPES.INT32]};o.name="CommonMediaTransport";o.internalSpec={mediaId:[1,d.TYPES.STRING],fileSha256:[2,d.TYPES.STRING],mediaKey:[3,d.TYPES.STRING],fileEncSha256:[4,d.TYPES.STRING],directPath:[5,d.TYPES.STRING],mediaKeyTimestamp:[6,d.TYPES.STRING],sidecar:[7,d.TYPES.STRING],fileLength:[8,d.TYPES.INT32],mimetype:[9,d.TYPES.STRING],objectId:[10,d.TYPES.STRING]};p.name="VideoExtraMetadata";p.internalSpec={uploadMosClientScore:[1,d.TYPES.FLOAT]};g.PJPEG_SCAN_CONFIGURATION=a;g.RAVEN_VIEW_MODE=b;g.MEDIA_INTERVENTION_TYPE=c;g.MediaSpec=e;g.StaticPhotoSpec=f;g.VoiceSpec=h;g.VideoSpec=i;g.GifSpec=j;g.AvatarStickerSpec=k;g.RavenSpec=l;g.RavenContentSpec=m;g.ThumbnailSpec=n;g.CommonMediaTransportSpec=o;g.VideoExtraMetadataSpec=p}),98);
__d("InstamadilloCoreTypeCollection.pb",["InstamadilloCoreTypeMedia.pb","WAProtoConst"],(function(a,b,c,d,e,f,g){a={};a.name="Collection";a.internalSpec={name:[1,d("WAProtoConst").TYPES.STRING],media:[2,d("WAProtoConst").FLAGS.REPEATED|d("WAProtoConst").TYPES.MESSAGE,d("InstamadilloCoreTypeMedia.pb").MediaSpec]};g.CollectionSpec=a}),98);
__d("InstamadilloCoreTypeLink.pb",["InstamadilloCoreTypeMedia.pb","WAProtoConst"],(function(a,b,c,d,e,f,g){a={};b={};c={};a.name="Link";a.internalSpec={text:[1,(e=d("WAProtoConst")).TYPES.STRING],linkContext:[2,e.TYPES.MESSAGE,b]};b.name="LinkContext";b.internalSpec={linkImageUrl:[1,e.TYPES.MESSAGE,c],linkPreviewTitle:[2,e.TYPES.STRING],linkUrl:[3,e.TYPES.STRING],linkSummary:[4,e.TYPES.STRING],linkMusicPreviewUrl:[5,e.TYPES.STRING],linkMusicPreviewCountriesAllowed:[6,e.FLAGS.REPEATED|e.TYPES.STRING],linkPreviewThumbnail:[7,e.TYPES.MESSAGE,d("InstamadilloCoreTypeMedia.pb").ThumbnailSpec],linkPreviewBody:[8,e.TYPES.STRING]};c.name="ImageUrl";c.internalSpec={url:[1,e.TYPES.STRING],width:[2,e.TYPES.INT32],height:[3,e.TYPES.INT32]};g.LinkSpec=a;g.LinkContextSpec=b;g.ImageUrlSpec=c}),98);
__d("InstamadilloCoreTypeText.pb",["InstamadilloCoreTypeMedia.pb","WAProtoConst"],(function(a,b,c,d,e,f,g){var h;a={TEXT_FORMAT_STYLE_UNSPECIFIED:0,TEXT_FORMAT_STYLE_BOLD:1,TEXT_FORMAT_STYLE_ITALIC:2,TEXT_FORMAT_STYLE_STRIKETHROUGH:3,TEXT_FORMAT_STYLE_UNDERLINE:4,TEXT_FORMAT_STYLE_INVALID:5};b={};c={};e={};f={};var i={};b.name="Text";b.internalSpec={text:[1,(h=d("WAProtoConst")).TYPES.STRING],isSuggestedReply:[2,h.TYPES.BOOL],postbackPayload:[3,h.TYPES.STRING],powerUpData:[4,h.TYPES.MESSAGE,c],commands:[5,h.FLAGS.REPEATED|h.TYPES.MESSAGE,e],animatedEmojiCharacterRanges:[6,h.FLAGS.REPEATED|h.TYPES.MESSAGE,i]};c.name="PowerUpsData";c.internalSpec={style:[1,h.TYPES.INT32],mediaAttachment:[2,h.TYPES.MESSAGE,d("InstamadilloCoreTypeMedia.pb").CommonMediaTransportSpec]};e.name="CommandRangeData";e.internalSpec={offset:[1,h.TYPES.INT32],length:[2,h.TYPES.INT32],type:[3,h.TYPES.INT32],fbid:[4,h.TYPES.STRING],userOrThreadFbid:[5,h.TYPES.STRING]};f.name="FormattedText";f.internalSpec={offset:[1,h.TYPES.INT32],length:[2,h.TYPES.INT32],style:[3,h.TYPES.ENUM,a]};i.name="AnimatedEmojiCharacterRange";i.internalSpec={offset:[1,h.TYPES.INT32],length:[2,h.TYPES.INT32]};g.TEXT_FORMAT_STYLE=a;g.TextSpec=b;g.PowerUpsDataSpec=c;g.CommandRangeDataSpec=e;g.FormattedTextSpec=f;g.AnimatedEmojiCharacterRangeSpec=i}),98);
__d("InstamadilloXmaContentRef.pb",["WAProtoConst"],(function(a,b,c,d,e,f,g){a={XMA_ACTION_TYPE_UNSPECIFIED:0,XMA_ACTION_TYPE_SHARE:1,XMA_ACTION_TYPE_REPLY:2,XMA_ACTION_TYPE_REACT:3,XMA_ACTION_TYPE_MENTION:4};b={RECEIVER_FETCH_CONTENT_TYPE_UNSPECIFIED:0,RECEIVER_FETCH_CONTENT_TYPE_NOTE:1,RECEIVER_FETCH_CONTENT_TYPE_STORY:2,RECEIVER_FETCH_CONTENT_TYPE_PROFILE:3,RECEIVER_FETCH_CONTENT_TYPE_CLIP:4,RECEIVER_FETCH_CONTENT_TYPE_FEED:5,RECEIVER_FETCH_CONTENT_TYPE_LIVE:6,RECEIVER_FETCH_CONTENT_TYPE_COMMENT:7,RECEIVER_FETCH_CONTENT_TYPE_LOCATION_SHARE:8,RECEIVER_FETCH_CONTENT_TYPE_REELS_AUDIO:9,RECEIVER_FETCH_CONTENT_TYPE_MEDIA_NOTE:10,RECEIVER_FETCH_CONTENT_TYPE_STORY_HIGHLIGHT:11,RECEIVER_FETCH_CONTENT_TYPE_SOCIAL_CONTEXT:12};c={MEDIA_NOTE_FETCH_PARAMS_MESSAGE_TYPE_UNSPECIFIED:0,MEDIA_NOTE_FETCH_PARAMS_MESSAGE_TYPE_MENTION:1,MEDIA_NOTE_FETCH_PARAMS_MESSAGE_TYPE_REPLY:2};e={};f={};var h={},i={},j={},k={},l={},m={},n={},o={},p={},q={},r={};e.name="XmaContentRef";e.internalSpec={actionType:[1,(d=d("WAProtoConst")).TYPES.ENUM,a],contentType:[2,d.TYPES.ENUM,b],targetUrl:[3,d.TYPES.STRING],userName:[4,d.TYPES.STRING],ownerFbid:[5,d.TYPES.STRING],fetchParams:[6,d.TYPES.MESSAGE,f]};f.name="ReceiverFetchXmaFetchParams";f.internalSpec={noteFetchParams:[1,d.TYPES.MESSAGE,h],storyFetchParams:[2,d.TYPES.MESSAGE,i],profileFetchParams:[3,d.TYPES.MESSAGE,j],clipFetchParams:[4,d.TYPES.MESSAGE,k],feedFetchParams:[5,d.TYPES.MESSAGE,l],liveFetchParams:[6,d.TYPES.MESSAGE,m],commentFetchParams:[7,d.TYPES.MESSAGE,n],locationShareFetchParams:[8,d.TYPES.MESSAGE,o],reelsAudioFetchParams:[9,d.TYPES.MESSAGE,p],mediaNoteFetchParams:[10,d.TYPES.MESSAGE,q],socialContextFetchParams:[11,d.TYPES.MESSAGE,r],__oneofs__:{receiverFetchXmaFetchParams:["noteFetchParams","storyFetchParams","profileFetchParams","clipFetchParams","feedFetchParams","liveFetchParams","commentFetchParams","locationShareFetchParams","reelsAudioFetchParams","mediaNoteFetchParams","socialContextFetchParams"]}};h.name="ReceiverFetchXmaNoteFetchParams";h.internalSpec={noteIgid:[1,d.TYPES.STRING]};i.name="ReceiverFetchXmaStoryFetchParams";i.internalSpec={storyIgid:[1,d.TYPES.STRING],reelId:[2,d.TYPES.STRING]};j.name="ReceiverFetchXmaProfileFetchParams";j.internalSpec={profileIgid:[1,d.TYPES.STRING]};k.name="ReceiverFetchXmaClipFetchParams";k.internalSpec={mediaIgid:[1,d.TYPES.STRING]};l.name="ReceiverFetchXmaFeedFetchParams";l.internalSpec={mediaIgid:[1,d.TYPES.STRING],carouselShareChildMediaIgid:[2,d.TYPES.STRING]};m.name="ReceiverFetchXmaLiveFetchParams";m.internalSpec={liveIgid:[1,d.TYPES.STRING]};n.name="ReceiverFetchXmaCommentFetchParams";n.internalSpec={commentFbid:[1,d.TYPES.STRING]};o.name="ReceiverFetchXmaLocationShareFetchParams";o.internalSpec={locationIgid:[1,d.TYPES.STRING]};p.name="ReceiverFetchXmaReelsAudioFetchParams";p.internalSpec={audioIgid:[1,d.TYPES.STRING]};q.name="ReceiverFetchXmaMediaNoteFetchParams";q.internalSpec={mediaNoteIgid:[1,d.TYPES.STRING],messageType:[2,d.TYPES.ENUM,c]};r.name="ReceiverFetchXmaSocialContextFetchParams";r.internalSpec={mediaIgid:[1,d.TYPES.STRING]};g.XMA_ACTION_TYPE=a;g.RECEIVER_FETCH_CONTENT_TYPE=b;g.MEDIA_NOTE_FETCH_PARAMS_MESSAGE_TYPE=c;g.XmaContentRefSpec=e;g.ReceiverFetchXmaFetchParamsSpec=f;g.ReceiverFetchXmaNoteFetchParamsSpec=h;g.ReceiverFetchXmaStoryFetchParamsSpec=i;g.ReceiverFetchXmaProfileFetchParamsSpec=j;g.ReceiverFetchXmaClipFetchParamsSpec=k;g.ReceiverFetchXmaFeedFetchParamsSpec=l;g.ReceiverFetchXmaLiveFetchParamsSpec=m;g.ReceiverFetchXmaCommentFetchParamsSpec=n;g.ReceiverFetchXmaLocationShareFetchParamsSpec=o;g.ReceiverFetchXmaReelsAudioFetchParamsSpec=p;g.ReceiverFetchXmaMediaNoteFetchParamsSpec=q;g.ReceiverFetchXmaSocialContextFetchParamsSpec=r}),98);
__d("InstamadilloAddMessage.pb",["InstamadilloCoreTypeActionLog.pb","InstamadilloCoreTypeAdminMessage.pb","InstamadilloCoreTypeCollection.pb","InstamadilloCoreTypeLink.pb","InstamadilloCoreTypeMedia.pb","InstamadilloCoreTypeText.pb","InstamadilloXmaContentRef.pb","WAProtoConst"],(function(a,b,c,d,e,f,g){var h;a={PLACEHOLDER_TYPE_NONE:0,PLACEHOLDER_TYPE_DECRYPTION_FAILURE:1,PLACEHOLDER_TYPE_NOT_SUPPORTED_NEED_UPDATE:2,PLACEHOLDER_TYPE_DEVICE_UNAVAILABLE:3,PLACEHOLDER_TYPE_NOT_SUPPORTED_NOT_RECOVERABLE:4};b={};c={};e={};f={};var i={},j={},k={},l={},m={},n={},o={};b.name="AddMessagePayload";b.internalSpec={content:[1,(h=d("WAProtoConst")).TYPES.MESSAGE,c],metadata:[2,h.TYPES.MESSAGE,e]};c.name="AddMessageContent";c.internalSpec={text:[1,h.TYPES.MESSAGE,d("InstamadilloCoreTypeText.pb").TextSpec],like:[2,h.TYPES.MESSAGE,m],link:[3,h.TYPES.MESSAGE,d("InstamadilloCoreTypeLink.pb").LinkSpec],receiverFetchXma:[4,h.TYPES.MESSAGE,n],media:[5,h.TYPES.MESSAGE,d("InstamadilloCoreTypeMedia.pb").MediaSpec],placeholder:[6,h.TYPES.MESSAGE,o],collection:[7,h.TYPES.MESSAGE,d("InstamadilloCoreTypeCollection.pb").CollectionSpec],adminMessage:[8,h.TYPES.MESSAGE,d("InstamadilloCoreTypeAdminMessage.pb").AdminMessageSpec],actionLog:[9,h.TYPES.MESSAGE,d("InstamadilloCoreTypeActionLog.pb").ActionLogSpec],__oneofs__:{addMessageContent:["text","like","link","receiverFetchXma","media","placeholder","collection","adminMessage","actionLog"]}};e.name="AddMessageMetadata";e.internalSpec={sendSilently:[1,h.TYPES.BOOL],privateReplyInfo:[2,h.TYPES.MESSAGE,j],repliedToMessage:[3,h.TYPES.MESSAGE,f],forwardingParams:[4,h.TYPES.MESSAGE,k],ephemeralityParams:[5,h.TYPES.MESSAGE,l]};f.name="RepliedToMessage";f.internalSpec={repliedToMessageOtid:[1,h.TYPES.STRING],repliedToMessageWaServerTimeSec:[2,h.TYPES.STRING],repliedToMessageCollectionItemId:[3,h.TYPES.STRING],omMicroSecTs:[4,h.TYPES.MESSAGE,i]};i.name="OpenMessageMicroSecondTimestamp";i.internalSpec={timestampMs:[1,h.TYPES.INT64],microSecondsBits:[2,h.TYPES.INT32]};j.name="PrivateReplyInfo";j.internalSpec={commentId:[1,h.TYPES.STRING],postLink:[2,h.TYPES.STRING]};k.name="ForwardingParams";k.internalSpec={forwardedThreadId:[1,h.TYPES.STRING]};l.name="EphemeralityParams";l.internalSpec={ephemeralDurationSec:[1,h.TYPES.INT64]};m.name="Like";m.internalSpec={};n.name="ReceiverFetchXma";n.internalSpec={contentRef:[1,h.TYPES.STRING],text:[2,h.TYPES.STRING],media:[3,h.TYPES.MESSAGE,d("InstamadilloCoreTypeMedia.pb").MediaSpec],xmaContentRef:[4,h.TYPES.MESSAGE,d("InstamadilloXmaContentRef.pb").XmaContentRefSpec]};o.name="Placeholder";o.internalSpec={placeholderType:[1,h.TYPES.ENUM,a]};g.PLACEHOLDER_TYPE=a;g.AddMessagePayloadSpec=b;g.AddMessageContentSpec=c;g.AddMessageMetadataSpec=e;g.RepliedToMessageSpec=f;g.OpenMessageMicroSecondTimestampSpec=i;g.PrivateReplyInfoSpec=j;g.ForwardingParamsSpec=k;g.EphemeralityParamsSpec=l;g.LikeSpec=m;g.ReceiverFetchXmaSpec=n;g.PlaceholderSpec=o}),98);
__d("InstamadilloDeleteMessage.pb",["WAProtoConst"],(function(a,b,c,d,e,f,g){a={};a.name="DeleteMessagePayload";a.internalSpec={messageOtid:[1,d("WAProtoConst").TYPES.STRING]};g.DeleteMessagePayloadSpec=a}),98);
__d("InstamadilloMessageIdUtils",["FBLogger","I64","MAWUnsafeCoerce","WAJids"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a,b){var c;(h||(h=d("I64"))).isI64(a)?c=(h||(h=d("I64"))).to_string(a):c=a;return c+":"+b}function a(a){a=a.split(":");if(a.length!==2)throw c("FBLogger")("igd_web").mustfixThrow("Invalid instamadillo message id format. Format is <threadKey>:<stanzaId>.");return{stanzaId:a[1],threadKey:a[0]}}function b(a){a=a.split(":");if(a.length!==2){c("FBLogger")("igd_web").warn("Invalid instamadillo message id format. Format is <threadKey>:<stanzaId>.");return null}return{stanzaId:a[1],threadKey:a[0]}}function e(a){a=a.message.decrypted.id;return j(a)}function j(a){var b=a.externalId;a=d("WAJids").threadIdForChatJid(a.chat);return i(a,b)}function f(a,b,c){return{author:d("WAJids").toMsgrUserJid(c),chat:d("WAJids").toMsgrUserJid((h||(h=d("I64"))).to_string(a)),externalId:d("MAWUnsafeCoerce").unsafeCoerce(b)}}g.toInstamadilloMessageId=i;g.fromInstamadilloMessageId=a;g.maybeFromInstamadilloMessageId=b;g.getInstamadilloMessageIdFromStanza=e;g.getInstamadilloMessageIdFromProtocolMsgId=j;g.toProtocolMsgId=f}),98);
__d("InstamadilloSupplementMessage.pb",["InstamadilloCoreTypeMedia.pb","WAProtoConst"],(function(a,b,c,d,e,f,g){var h;a={};b={};c={};e={};f={};var i={},j={},k={};a.name="SupplementMessagePayload";a.internalSpec={targetMessageOtid:[1,(h=d("WAProtoConst")).TYPES.STRING],uniquingKeyForSupplementalData:[2,h.TYPES.STRING],content:[3,h.TYPES.MESSAGE,b],targetMessageWaServerTimeSec:[4,h.TYPES.STRING],targetWaThreadId:[5,h.TYPES.STRING]};b.name="SupplementMessageContent";b.internalSpec={reaction:[1,h.TYPES.MESSAGE,e],contentView:[2,h.TYPES.MESSAGE,f],editText:[3,h.TYPES.MESSAGE,i],mediaReaction:[4,h.TYPES.MESSAGE,c],originalTransportPayload:[5,h.TYPES.MESSAGE,j],mediaInterventions:[6,h.TYPES.MESSAGE,k],__oneofs__:{supplementMessageContent:["reaction","contentView","editText","mediaReaction","originalTransportPayload","mediaInterventions"]}};c.name="MediaReaction";c.internalSpec={mediaId:[1,h.TYPES.STRING],reaction:[2,h.TYPES.MESSAGE,e]};e.name="Reaction";e.internalSpec={reactionType:[1,h.TYPES.STRING],reactionStatus:[2,h.TYPES.STRING],emoji:[3,h.TYPES.STRING],superReactType:[4,h.TYPES.STRING],actionLogOtid:[5,h.TYPES.STRING]};f.name="ContentView";f.internalSpec={seen:[1,h.TYPES.BOOL],screenshotted:[2,h.TYPES.BOOL],replayed:[3,h.TYPES.BOOL],mimetype:[4,h.TYPES.STRING],objectId:[5,h.TYPES.STRING]};i.name="EditText";i.internalSpec={newContent:[1,h.TYPES.STRING],editCount:[2,h.TYPES.INT32]};j.name="OriginalTransportPayload";j.internalSpec={originalTransportPayload:[1,h.TYPES.BYTES]};k.name="MediaInterventions";k.internalSpec={mediaId:[1,h.TYPES.STRING],interventionType:[2,h.TYPES.ENUM,d("InstamadilloCoreTypeMedia.pb").MEDIA_INTERVENTION_TYPE]};g.SupplementMessagePayloadSpec=a;g.SupplementMessageContentSpec=b;g.MediaReactionSpec=c;g.ReactionSpec=e;g.ContentViewSpec=f;g.EditTextSpec=i;g.OriginalTransportPayloadSpec=j;g.MediaInterventionsSpec=k}),98);
__d("InstamadilloTransportPayload.pb",["InstamadilloAddMessage.pb","InstamadilloDeleteMessage.pb","InstamadilloSupplementMessage.pb","WAProtoConst"],(function(a,b,c,d,e,f,g){a={PAYLOAD_CREATOR_UNSPECIFIED:0,PAYLOAD_CREATOR_IGIOS:1,PAYLOAD_CREATOR_IG4A:2,PAYLOAD_CREATOR_WWW:3,PAYLOAD_CREATOR_IGLITE:4};b={};c={};b.name="TransportPayload";b.internalSpec={franking:[4,(e=d("WAProtoConst")).TYPES.MESSAGE,c],openEb:[5,e.TYPES.BOOL],isE2EeAttributed:[6,e.TYPES.BOOL],payloadCreator:[7,e.TYPES.ENUM,a],add:[1,e.TYPES.MESSAGE,d("InstamadilloAddMessage.pb").AddMessagePayloadSpec],"delete":[2,e.TYPES.MESSAGE,d("InstamadilloDeleteMessage.pb").DeleteMessagePayloadSpec],supplement:[3,e.TYPES.MESSAGE,d("InstamadilloSupplementMessage.pb").SupplementMessagePayloadSpec],__oneofs__:{transportPayload:["add","delete","supplement"]}};c.name="Franking";c.internalSpec={frankingKey:[1,e.TYPES.BYTES],frankingVersion:[2,e.TYPES.INT32]};g.PAYLOAD_CREATOR=a;g.TransportPayloadSpec=b;g.FrankingSpec=c}),98);
__d("LSOptOutOfBackup",["LSAppendDataTraceAddon","LSIsMobileClient","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop","justknobx"],(function(a,b,c,d,e,f,g){function a(){var a=arguments,d=a[a.length-1],e=[],f=[];return d.sequence([function(g){return d.sequence([function(f){return e[0]=d.i64.of_float(Date.now()),function(a){d.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsOptOutOfBackupStoredProcedure] Beginning execution."),c("justknobx")._("1099")?d.sequence([function(a){return d.sequence([function(a){return void 0!==void 0?d.storedProcedure(b("LSAppendDataTraceAddon"),void 0,d.i64.cast([0,1469]),d.i64.cast([0,2]),void 0,void 0):d.resolve()},function(a){return d.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,e[11]=a[0],a})},function(a){return e[11]?e[12]=!0:e[12]=!1,e[12]&&!0?(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),e[14]="LSDataTraceMciTraceLog native op not supported",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",e[14]].join("")),e[13]=d.createArray(),void 0!==void 0?e[15]=(e[13].push(void 0),e[13]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",e[14],e[13],d.i64.cast([0,3]))):d.resolve()}])},function(c){return e[8]=new d.Map(),e[8].set("backup_id",a[0]),e[8].set("trace_id",void 0),e[9]=d.toJSON(e[8]),d.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_opt_out",d.i64.cast([0,50019]),e[9],d.i64.cast([0,0]),d.i64.cast([0,93]),d.i64.cast([0,0]),void 0,d.i64.cast([0,0])).then(function(a){return a=a,e[10]=a[0],a})},function(a){return e[1]=d.i64.cast([0,0])}]):d.resolve((function(a){d.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsOptOutOfBackupStoredProcedure] backup opt out flow is not enabled"),e[1]=d.i64.cast([0,1])))},function(a){return e[2]=d.i64.of_float(Date.now()),e[3]=d.i64.random(),e[5]="Finishing execution. Execution time: ",e[6]=d.i64.to_string(d.i64.sub(e[2],e[0])),e[7]=" ms",e[4]="",function(a){d.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsOptOutOfBackupStoredProcedure] ",e[4],e[5],e[4],e[6],e[4],e[7]].join("")),d.i64.eq(d.i64.mod_(e[3],d.i64.cast([0,1e3])),d.i64.cast([0,0]))?(e[8]=",",e[9]=d.createArray(),void 0!==void 0?e[10]=(e[9].push(void 0),e[9]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsOptOutOfBackupStoredProcedure",[e[5],e[8],e[6],e[8],e[7]].join(""),e[9],d.i64.cast([0,4]))):d.resolve()},function(a){return f[0]=e[1]}])},function(a){return d.resolve(f)}])}a.__sproc_name__="LSEncryptedBackupsOptOutOfBackupStoredProcedure";a.__tables__=[];d=a;g["default"]=d}),98);
__d("LSOptOutOfBackupStoredProcedure",["LSOptOutOfBackup","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSOptOutOfBackup"),e.backupId);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("MAWIncomingReceiptUtils",["WALogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["User "," is in affectedUserJids in receipt-writing results, but they have no corresponding read/delivery receipt entry in the DB"]);h=function(){return a};return a}function a(a){var b=new Map();a.forEach(function(a){if(a.msgRenderType==="unrendered")return;a.affectedUserJids.forEach(function(c){var e=a.receipt.statusTsPerUser.get(c);if(e==null){d("WALogger").WARN(h(),c);return}c=[a.threadJid,c];var f=b.get(JSON.stringify(c)),g=e.deliveredTs!=null,i=e.readTs!=null;g=g?a.msgTs:0;i=i?a.msgTs:0;e=(e=e.readTs)!=null?e:0;if(f!=null){var j=f.lastDeliveredMsgTs,k=f.lastReadMsgTs;f=f.lastReadActionTs;g=Math.max(g,j);i=Math.max(i,k);e=Math.max(e,f)}b.set(JSON.stringify(c),{lastDeliveredMsgTs:d("WATimeUtils").castToUnixTime(g),lastReadActionTs:d("WATimeUtils").castToUnixTime(e),lastReadMsgTs:d("WATimeUtils").castToUnixTime(i)})})});return new Map(Array.from(b).map(function(a){var b=a[0];a=a[1];return[JSON.parse(b),a]}))}g.getMaxTimestampsPerParticipant=a}),98);
__d("MAWAckAndTimestampUpdatesForReceiptsTxns",["MAWDbMsgTxns","MAWDbParticipantTxns","MAWDbUnrenderedMsgTxns","MAWDexieTable","MAWIncomingReceiptUtils","MAWLoggerUtils","WATagsLogger","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Updating timestamps for "," participants"]);h=function(){return a};return a}var i=d("WATagsLogger").TAGS([d("MAWLoggerUtils").Tag.Ephemeral,d("MAWLoggerUtils").Tag.Countdown,d("MAWLoggerUtils").Tag.Incoming]);function a(a,b,e){b=d("MAWIncomingReceiptUtils").getMaxTimestampsPerParticipant(b);i.LOG(h(),b.size);var f=[];b.forEach(function(a,b){f.push({deliveredWatermarkTs:a.lastDeliveredMsgTs,lastReadActionTs:a.lastReadActionTs,lastReadWatermarkTs:a.lastReadMsgTs,participantKey:b})});b=e.regular.length>0?d("MAWDbMsgTxns").bulkUpdateSystemAck(a,e.regular):d("MAWDexieTable").dexieResolve();e=e.unrendered.length>0?d("MAWDbUnrenderedMsgTxns").bulkUpdateSystemAckForUnrenderedMsgs(a,e.unrendered):d("MAWDexieTable").dexieResolve();b=d("MAWDexieTable").dexieAll([b,e]);return d("MAWDexieTable").dexieAll([b,f.length>0?d("MAWDbParticipantTxns").bulkUpdateParticipantTimestamps(a,f,i):d("MAWDexieTable").dexieResolve()]).then(c("emptyFunction"))}g.handleAckAndTimestampUpdatesForReceipts=a}),98);
__d("MAWAdminMsgHelpers",["MAWCreateParticipantAdminMsg","MAWExternalId","MAWRemoveParticipantAdminMsg","WAAckLevel","WAGlobals","WAJids"],(function(a,b,c,d,e,f,g){"use strict";var h="Facebook User";function a(a){return a==null||a===""?h:a}function b(a){return a!=null?d("WAJids").userIdFromJid(a):h}function c(a,b,c,e){return{ack:d("WAAckLevel").ACK.SENT,id:{author:d("WAJids").AUTHOR_SYSTEM,chat:a,externalId:d("MAWExternalId").generateExternalId()},msgContent:d("MAWCreateParticipantAdminMsg").createParticipantAdminMessage(c==="@me"?d("WAGlobals").getMyUserJid():c,b),serverTs:e,ts:e,type:"Admin"}}function e(a,b,c,e){return{ack:d("WAAckLevel").ACK.SENT,id:{author:d("WAJids").AUTHOR_SYSTEM,chat:a,externalId:d("MAWExternalId").generateExternalId()},msgContent:d("MAWRemoveParticipantAdminMsg").removeParticipantAdminMessage(c==="@me"?d("WAGlobals").getMyUserJid():c,b),serverTs:e,ts:e,type:"Admin"}}function f(a,b,c,e){var f,g=d("WAGlobals").getMyUserJid();c=c==="@me"?g:c;if(c===g)f={adminMsgContent:[d("WAJids").userIdFromJid(b)],adminType:"currentUserPromotedParticipant"};else if(c==null)f=b===g?{adminMsgContent:[],adminType:"currentUserGotPromoted"}:{adminMsgContent:[d("WAJids").userIdFromJid(b)],adminType:"participantGotPromoted"};else{c=d("WAJids").userIdFromJid(c);f=b===g?{adminMsgContent:[c],adminType:"participantPromotedYou"}:{adminMsgContent:[c,d("WAJids").userIdFromJid(b)],adminType:"participantPromotedParticipant"}}return{ack:d("WAAckLevel").ACK.SENT,id:{author:d("WAJids").AUTHOR_SYSTEM,chat:a,externalId:d("MAWExternalId").generateExternalId()},msgContent:f,serverTs:e,ts:e,type:"Admin"}}function i(a,b,c,e){var f,g=d("WAGlobals").getMyUserJid();c=c==="@me"?g:c;if(c===g)f=b===g?{adminMsgContent:[],adminType:"currentUserSelfDemoted"}:{adminMsgContent:[d("WAJids").userIdFromJid(b)],adminType:"currentUserDemotedParticipant"};else if(c==null)f=b===g?{adminMsgContent:[],adminType:"currentUserGotDemoted"}:{adminMsgContent:[d("WAJids").userIdFromJid(b)],adminType:"participantGotDemoted"};else{var h=d("WAJids").userIdFromJid(c);f=b===g?{adminMsgContent:[h],adminType:"participantDemotedYou"}:{adminMsgContent:[h,d("WAJids").userIdFromJid(b)],adminType:c===b?"participantSelfDemoted":"participantDemotedParticipant"}}return{ack:d("WAAckLevel").ACK.SENT,id:{author:d("WAJids").AUTHOR_SYSTEM,chat:a,externalId:d("MAWExternalId").generateExternalId()},msgContent:f,serverTs:e,ts:e,type:"Admin"}}function j(a,b,c,e){var f=[],g=b.subject.content;if(g==null)return;b.subject.user===d("WAGlobals").getMyUserJid()?(b="currentUserNamedGroup",f.push(g)):c==null?(b="unkonwnUserNamedGroup",f.push(g)):(b="participantNamedGroup",f.push(c,g));return{ack:d("WAAckLevel").ACK.SENT,id:{author:d("WAJids").AUTHOR_SYSTEM,chat:a,externalId:d("MAWExternalId").generateExternalId()},msgContent:{adminMsgContent:f,adminType:b},serverTs:e,ts:e,type:"Admin"}}function k(a,b,c,e){var f,g=[];if(c===d("WAGlobals").getMyUserJid())switch(b){case"all_member_add":f="currentUserSetAddModeAllMembers";break;case"admin_add":f="currentUserSetAddModeAdminOnly";break}else if(c!=null){g.push(d("WAJids").userIdFromJid(c));switch(b){case"all_member_add":f="participantSetAddModeAllMembers";break;case"admin_add":f="participantSetAddModeAdminOnly";break}}else switch(b){case"all_member_add":f="serverSetAddModeAllMembers";break;case"admin_add":f="serverSetAddModeAdminOnly";break}if(f==null)return;return{ack:d("WAAckLevel").ACK.SENT,id:{author:d("WAJids").AUTHOR_SYSTEM,chat:a,externalId:d("MAWExternalId").generateExternalId()},msgContent:{adminMsgContent:g,adminType:f},serverTs:e,ts:e,type:"Admin"}}g.UNKNOWN_USER=h;g.maybeUnknownParticipantName=a;g.createAdminMsgContactId=b;g.createParticipantAddAdminMessage=c;g.createParticipantRemoveAdminMsg=e;g.createParticipantPromoteAdminMsg=f;g.createParticipantDemoteAdminMsg=i;g.createGroupNameChangeAdminMsg=j;g.createMemberAddModeChangeAdminMsg=k}),98);
__d("MAWCreateParticipantAdminMsg",["MAWAdminMsgHelpers","WAGlobals"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b,c){switch(a){case 1:return{adminMsgContent:[b],adminType:"participantAddedYou"};case 2:return{adminMsgContent:[b,c],adminType:"participantAddedYouAndOneUser"};default:return{adminMsgContent:[b,a.toString()],adminType:"participantAddedYouAndMoreThanOneUsers"}}}function i(a,b,c){switch(a){case 1:return{adminMsgContent:[b],adminType:"currentUserAddedOneParticipant"};case 2:return{adminMsgContent:[b,c],adminType:"currentUserAddedTwoParticipant"};default:return{adminMsgContent:[b,a.toString()],adminType:"currentUserAddedMoreThanTwoParticipant"}}}function j(a,b,c,d){switch(a){case 1:return{adminMsgContent:[b,c],adminType:"participantAddedOneUser"};case 2:return{adminMsgContent:[b,c,d],adminType:"participantAddedTwoUser"}}return{adminMsgContent:[b,c,a.toString()],adminType:"participantAddedMoreThanTwoUser"}}function a(a,b,c,e){e=e==null?b.map(d("MAWAdminMsgHelpers").createAdminMsgContactId):e;var f=e[0];e=e[1];c=c==null?d("MAWAdminMsgHelpers").createAdminMsgContactId(a):d("MAWAdminMsgHelpers").maybeUnknownParticipantName(c);if(a===d("WAGlobals").getMyUserJid())return i(b.length,d("MAWAdminMsgHelpers").maybeUnknownParticipantName(f),d("MAWAdminMsgHelpers").maybeUnknownParticipantName(e));return b.includes(d("WAGlobals").getMyUserJid())?h(b.length,d("MAWAdminMsgHelpers").maybeUnknownParticipantName(c),d("MAWAdminMsgHelpers").maybeUnknownParticipantName(b[0]===d("WAGlobals").getMyUserJid()?e:f)):j(b.length,c,d("MAWAdminMsgHelpers").maybeUnknownParticipantName(f),d("MAWAdminMsgHelpers").maybeUnknownParticipantName(e))}g.createParticipantAdminMessage=a}),98);
__d("MAWRemoveParticipantAdminMsg",["MAWAdminMsgHelpers","WAGlobals"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b,c){switch(a){case 1:return{adminMsgContent:[b],adminType:"participantRemovedYou"};case 2:return{adminMsgContent:[b,c],adminType:"participantRemovedYouAndOneUser"};default:return{adminMsgContent:[b,a.toString()],adminType:"participantRemovedYouAndMoreThanOneUsers"}}}function i(a,b,c,d){switch(a){case 1:return d?{adminMsgContent:[],adminType:"currentUserLeftGroup"}:{adminMsgContent:[b],adminType:"currentUserRemovedOneParticipant"};case 2:return{adminMsgContent:[b,c],adminType:"currentUserRemovedTwoParticipant"};default:return{adminMsgContent:[b,a.toString()],adminType:"currentUserRemovedMoreThanTwoParticipant"}}}function j(a,b,c,d,e){switch(a){case 1:return e?{adminMsgContent:[b],adminType:"participantLeftGroup"}:{adminMsgContent:[b,c],adminType:"participantRemovedOneUser"};case 2:return{adminMsgContent:[b,c,d],adminType:"participantRemovedTwoUser"}}return{adminMsgContent:[b,c,a.toString()],adminType:"participantRemovedMoreThanTwoUser"}}function a(a,b,c,e){e=e==null?b.map(d("MAWAdminMsgHelpers").createAdminMsgContactId):e;var f=e[0];e=e[1];c=c==null?d("MAWAdminMsgHelpers").createAdminMsgContactId(a):d("MAWAdminMsgHelpers").maybeUnknownParticipantName(c);if(a===d("WAGlobals").getMyUserJid())return i(b.length,d("MAWAdminMsgHelpers").maybeUnknownParticipantName(f),d("MAWAdminMsgHelpers").maybeUnknownParticipantName(e),b[0]===d("WAGlobals").getMyUserJid());return b.includes(d("WAGlobals").getMyUserJid())?h(b.length,c,d("MAWAdminMsgHelpers").maybeUnknownParticipantName(b[0]===d("WAGlobals").getMyUserJid()?e:f)):j(b.length,c,d("MAWAdminMsgHelpers").maybeUnknownParticipantName(f),d("MAWAdminMsgHelpers").maybeUnknownParticipantName(e),b[0]===a)}g.removeParticipantAdminMessage=a}),98);
__d("MAWDbGroupInviteTxns",["MAWDexieTable","MAWMsgType"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return a.groupInvites.put(b).then(function(){return b})}function b(a,b,c){return a.groupInvites.where(["threadJid","inviteeJid"]).anyOf([[b,c]])["delete"]()}function h(a,b,c){return a.groupInvites.where(["threadJid","inviteeJid"]).equals([b,c]).first()}function c(a,b,c){return a.groupInvites.where(["threadJid","inviteeJid"]).anyOf([[b,c]]).toArray()}function e(a,b){return b.type===d("MAWMsgType").MSG_TYPE.GROUP_INVITE?b.invitedParticipantUserJid==null?d("MAWDexieTable").dexieResolve():h(a,b.threadJid,b.invitedParticipantUserJid):d("MAWDexieTable").dexieResolve()}g.putGroupInvite=a;g.deleteGroupInvitesByThreadAndInvitedParticipant=b;g.maybeGetGroupInvite=h;g.getGroupInvitesByThreadAndInvitedParticipant=c;g.getAndCheckGroupInviteFromMsg=e}),98);
__d("MAWLoadGroupInvitesTxns",["MAWBridgeTypesCreators","MAWDbGroupInviteTxns","MAWDexieTable","MAWIndexedDb","MAWUserJidWrapper","WAJids","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var e=[],f=d("MAWUserJidWrapper").getMyUserJid();b.forEach(function(b){return d("WAJids").switchOnMsgrChatJidType(b.jid,{group:function(){e.push(d("MAWDbGroupInviteTxns").getGroupInvitesByThreadAndInvitedParticipant(a,b.jid,f))},user:c("emptyFunction")})});return d("MAWDexieTable").dexieAll(e).then(function(a){a.forEach(function(a,b){a.forEach(function(b,a){d("MAWIndexedDb").afterTransaction({tag:"GroupInviteUpdate",value:d("MAWBridgeTypesCreators").createBridgeGroupInvite(b)})})})})}g.loadGroupInvites=a}),98);
__d("MAWDbPollTxns",["MAWIndexedDb","MAWTransactionMode","WAStanzaUtils"],(function(a,b,c,d,e,f,g){"use strict";e=d("MAWIndexedDb").makeMsgrTransactor({poll:d("MAWTransactionMode").READONLY},"handleIncomingMessagesStanzas",function(a){return function(b,c){return a.poll.get([b,d("WAStanzaUtils").toStanzaId(c)])}});function a(a,b){return a.poll.put(b).then(function(){return b})}function b(a,b,c){return a.poll.get([b,d("WAStanzaUtils").toStanzaId(c)])}function c(a,b,c){return a.messages.where(["threadJid","pollStanzaId","sortOrderMs"]).between([c,b,Number.MIN_SAFE_INTEGER],[c,b,Number.MAX_SAFE_INTEGER],!1,!1).reverse().first()}g.getDbPoll=e;g.updatePoll=a;g.getPoll=b;g.maybeGetLatestPollUpdateMsg=c}),98);
__d("MAWLoadMessagesRequest",["FBLogger","MAWMessagesCompare","MAWMessagesDirection","MessagesRangesV2ExternalIds","WAStanzaUtils"],(function(a,b,c,d,e,f,g){"use strict";b={admin:!1,editMsgHistory:!1,media:!1,polls:!1,reactions:!1,receiverFetch:!1,xma:!1};function h(a,b,e){if(a.length===0)return[];e=d("MAWMessagesCompare").getSortComparisonFunctionForDirection(d("MAWMessagesDirection").translateMawDirectionToMwpDirection(e));a=[].concat(a).sort(e);if(b.lowerBoundExternalId!=null&&((e=b.lowerBoundExternalId)==null?void 0:e.toString())!==d("MessagesRangesV2ExternalIds").MIN_EXTERNAL_ID&&((e=b.lowerBoundExternalId)==null?void 0:e.toString())!==d("MessagesRangesV2ExternalIds").MAX_EXTERNAL_ID){e=a.findIndex(function(a){return a.externalId===b.lowerBoundExternalId});e!==-1?a=a.slice(e):c("FBLogger")("messenger_web").mustfix("Get messages for range: no external id in source msgs list")}a=i(a,b);return a.slice(0,b.numMsgs)}function a(a,b,c,e){a=a.filter(function(a){var c;return((c=a.sortOrderMs)!=null?c:Number.MAX_SAFE_INTEGER)>=b.gte[0]&&((c=a.sortOrderMs)!=null?c:Number.MIN_SAFE_INTEGER)<=b.lte[0]});var f=d("MAWMessagesDirection").switchOnMAWMessagesDirection(c,{after:[b.gte,b.lte],before:[b.lte,b.gte]}),g=f[0],i=g[0];g=g[1];f=f[1];f[0];var j=f[1];f=h(a,{includeLowerBoundMsg:!0,lowerBoundExternalId:d("WAStanzaUtils").toStanzaId(g),lowerBoundSortOrderMs:i,numMsgs:e},c);if(j!==d("MessagesRangesV2ExternalIds").MIN_EXTERNAL_ID&&j!==d("MessagesRangesV2ExternalIds").MAX_EXTERNAL_ID){a=f.findIndex(function(a){return a.externalId===j});if(a!==-1)return f.slice(0,a)}return f}function i(a,b){if(b.includeLowerBoundMsg||a.length===0)return a;return a[0].externalId===b.lowerBoundExternalId||a[0].sortOrderMs===b.lowerBoundSortOrderMs?a.slice(1):a}g.loadMsgsConfigForCheckingOnly=b;g.getMsgsForRange=h;g.getMsgsForBounds=a}),98);
__d("MAWLoadMsgsDedupper",["MAWDbMsgUtil","WAMsg"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a=new Set();return function(b){b=d("MAWDbMsgUtil").getProtocolMsgIdFromDbMsg(b);if(b==null)return!0;b=d("WAMsg").craftWAMsgIdString(b);if(b!=null){if(a.has(b))return!1;a.add(b)}return!0}}g["default"]=a}),98);
__d("MAWLoadMsgsUtil",[],(function(a,b,c,d,e,f){"use strict";function a(a,b,c){var d=0,e=0,f=!1,g=null;return function(h){e++;if(g!=null&&g===h.sortOrderMs)return!1;if(e>b&&h.sortOrderMs!==a)return!0;h.msgId===c&&(f=!0);f&&d++;if(d>b)return!0;g=h.sortOrderMs;return!1}}function b(a){var b=!0,c=0,d=null;return function(e){if(d===null)c++;else if(d===e.sortOrderMs){c+=b?0:1;return!1}else c++,b=!1;if(c>a)return!0;d=e.sortOrderMs;return!1}}f.makeUntilWithRangeExtension=a;f.makeUntilWithRangeExtensionBothDirections=b}),66);
__d("MAWLoadMsgsTxnsV2",["FBLogger","I64","MAWBridgeMsg","MAWBridgeMsgCountdown","MAWBridgeReceiverFetchInfo","MAWBridgeTypesCreators","MAWBridgeXMA","MAWCurrentUser","MAWDbChunkTxns","MAWDbEditMsgHistoryTxns","MAWDbMediaTxns","MAWDbPollTxns","MAWDbReactionsTxns","MAWDbReceiverFetchTxns","MAWDbXMATxns","MAWDexieTable","MAWGetIsMediaDownloadStatusEnabled","MAWHandleXmaTransactionUtil","MAWLoadMessagesRequest","MAWLoadMsgsDedupper","MAWLoadMsgsUtil","MAWLoadReplyMediaTxns","MAWLoggerUtils","MAWMediaUtils","MAWMessagesDirection","MAWODSProxy","MAWRavenUtils","MAWXMAUtils","WAMsgType","WAOdsEnums","WATagsLogger","WATimeUtils","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["LoadMsgsByExternalId: From: externalId:",". ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["LoadMoreMsgs, chatJid: ",", result: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["LoadMoreMsgs: From:"," orignalMsgId:",", chatJid: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["LoadMoreMsgs, chatJid: ",", range: ",".}"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["EphemeralCounter: Showing UI counter for ",""]);m=function(){return a};return a}function n(a,b,d,e,f,g){switch(d){case"before":return h();case"after":return i().then(function(a){return a.reverse()})}function h(){var d=c("MAWLoadMsgsDedupper")();return a.messages.where(["threadJid","sortOrderMs"]).between([b,0],[b,e],!0,!0).reverse().filter(f).filter(d).filter(function(a){return c("justknobx")._("3227")?a.source!=="media_restore":a!=null}).until(g,!0).toArray()}function i(){var d=c("MAWLoadMsgsDedupper")();return a.messages.where(["threadJid","sortOrderMs"]).between([b,e],[b,Number.MAX_SAFE_INTEGER],!0,!0).filter(f).filter(d).filter(function(a){return c("justknobx")._("3227")?a.source!=="media_restore":a!=null}).until(g,!0).toArray()}}function o(a,b){return d("MAWDbReactionsTxns").getReactionsFromMessages(a,b).then(function(a){return a.map(function(a){var b=a.author,c=a.reaction,e=a.reactToMsgId,f=a.threadJid;a=a.ts;if(e==null)return;return c==null?{reaction:d("MAWBridgeTypesCreators").createBridgeDeleteReaction({author:b,chatJid:f,reactToMsgId:e}),type:"delete"}:{reaction:d("MAWBridgeTypesCreators").createBridgeUpsertReaction({author:b,chatJid:f,reaction:c||"",reactToMsgId:e,ts:a}),type:"upsert"}}).filter(Boolean)})}function p(a,b){return d("MAWDbMediaTxns").getMsgMediaPairFromMsgs(a,b).then(function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){var c=b[0],e=b[1];return d("MAWDbChunkTxns").hasMediaChunk(a,e.hashedPlaintextHash).then(function(b){return q(a,c.threadJid,e).then(function(f){var g=f.map(function(a){return a.msgId}),h=d("MAWMediaUtils").createHdTypesForBridgeMedia(f);g=c.ravenEphemeralType!=null&&c.ravenEphemeralMediaState!=null?d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:c.threadJid,filteredMsgIds:g,hasMediaForUI:b,hdTypes:h,media:e,ravenSettings:d("MAWRavenUtils").deriveRavenSettings(c.ravenEphemeralType,c.ravenEphemeralMediaState),sortOrderMs:c.sortOrderMs}):d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:c.threadJid,filteredMsgIds:g,hasMediaForUI:b,hdTypes:h,media:e,sortOrderMs:c.sortOrderMs});return d("MAWMediaUtils").getBridgeMediaAnnotatedForDisplay(a,g,f)})})}))})}function q(a,b,c){return a.messages.where("msgId").anyOf(c.msgIds).toArray().then(function(a){return a.filter(function(a){return a.threadJid===b})})}function r(a,b){return d("MAWDbXMATxns").getXMAFromMsgs(a,b).then(function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){if(d("MAWXMAUtils").isXMAStoryReply(b.targetType))return d("MAWDexieTable").dexieResolve(null);if(d("MAWGetIsMediaDownloadStatusEnabled").getIsMediaDownloadStatusForXMAsEnabledWithChunkVerification()){var c=[b.defaultPreviewMediaId,b.faviconMediaId,b.headerMediaId].filter(Boolean);return d("MAWDbMediaTxns").maybeBulkGetMediaFromMediaId(a,c).then(function(c){if(c.size===0)return d("MAWBridgeXMA").createBridgeXMA(null,b,{hasMedia:!1,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1});var e=b.defaultPreviewMediaId!=null?c.get(b.defaultPreviewMediaId):null,f=b.headerMediaId!=null?c.get(b.headerMediaId):null;c=b.faviconMediaId!=null?c.get(b.faviconMediaId):null;return d("MAWHandleXmaTransactionUtil").verifyAllMediaChunksForXMA(e,c,f,a).then(function(a){var c=a.hasMedia,f=a.hasXmaFaviconMedia;a=a.hasXmaHeaderMedia;return d("MAWBridgeXMA").createBridgeXMA(e,b,{hasMedia:c,hasXmaFaviconMedia:f,hasXmaHeaderMedia:a})})})}return d("MAWDbMediaTxns").maybeGetMediaFromMediaId(a,b.defaultPreviewMediaId).then(function(c){return c==null?d("MAWBridgeXMA").createBridgeXMA(c,b,{hasMedia:!1,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1}):d("MAWDexieTable").dexieAll([c,d("MAWDbChunkTxns").hasMediaChunk(a,c==null?void 0:c.hashedPlaintextHash)]).then(function(a){var c=a[0];a=a[1];return d("MAWBridgeXMA").createBridgeXMA(c,b,{hasMedia:a,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1})})})}))}).then(function(a){return a.filter(Boolean)})}function s(a,b){return d("MAWDexieTable").dexieAll(b.map(function(b){return b.receiverFetchId==null?d("MAWDexieTable").dexieResolve(null):d("MAWDbReceiverFetchTxns").maybeGetReceiverFetchInfoFromReceiverFetchId(a,b.receiverFetchId).then(function(a){return a==null?d("MAWDexieTable").dexieResolve(null):d("MAWBridgeReceiverFetchInfo").createBridgeReceiverFetchInfoPayloadFromDbInfo(b,a)})})).then(function(a){return a.filter(Boolean)})}function t(a,b){var e=new Map();return d("MAWDexieTable").dexieAll(b.map(function(b){if(b.type!==d("WAMsgType").MSG_TYPE.GROUP_POLL_CREATE&&b.type!==d("WAMsgType").MSG_TYPE.GROUP_POLL_UPDATE)return null;var f=b.type===d("WAMsgType").MSG_TYPE.GROUP_POLL_CREATE?b.externalId:b.pollStanzaId;if(f==null){c("FBLogger")("GroupPollsE2EE").mustfix("pollStanzaId is null for poll msg in MLV2");return null}var g=e.get(f);if(g!=null){if(g.externalId===b.externalId){return u(a,b.threadJid,f,g.msgId,d("WATimeUtils").castToMillisTime((g=g==null?void 0:g.sortOrderMs)!=null?g:0))}return null}return d("MAWDbPollTxns").maybeGetLatestPollUpdateMsg(a,f,b.threadJid).then(function(c){if(c==null){var g;return u(a,b.threadJid,f,b.msgId,d("WATimeUtils").castToMillisTime((g=b.sortOrderMs)!=null?g:0))}e.set(f,c);if(c.externalId===b.externalId){return u(a,b.threadJid,f,c.msgId,d("WATimeUtils").castToMillisTime((g=c==null?void 0:c.sortOrderMs)!=null?g:0))}else return null})})).then(function(a){return a.filter(Boolean)})["finally"](function(){e.clear()})}function u(a,b,e,f,g){return a.poll.get([b,e]).then(function(a){if(a==null){c("FBLogger")("GroupPollsE2EE").mustfix("Poll is null in MLV2");return null}return{contactIdForCurrentUser:(h||(h=d("I64"))).of_string(d("MAWCurrentUser").getID()),dbPoll:a,latestUpdateMsgId:f,latestUpdateTimestampMs:g}})}function v(a,b,c,e,f,g,h){h===void 0&&(h=function(){return!0});var i=d("WATimeUtils").unixTime(),j=function(a){return a.messageExpirationTs==null||a.messageExpirationTs>i};c=d("MAWLoadMsgsUtil").makeUntilWithRangeExtension(f,c,g);return n(a,b,e,f,function(a){return h(a)&&j(a)},c).then(function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b)})).then(function(a){return{msgs:b,replyMediaInfo:a}})})}function w(a,b){return a.messages.where("externalId").equals(b).toArray()}function x(a,b){return w(a,b).then(function(e){e.length>1&&c("FBLogger")("messenger_web_pinned_messages").warn("duplicate MAW msg returned for externalId",b);return d("MAWDexieTable").dexieAll(e.map(function(b){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b)})).then(function(a){return{msgs:e,replyMediaInfo:a}})})}function y(a){a=a.filter(function(a){return a.ephemeralCounterStarted});if(a.length>0){d("WATagsLogger").TAGS([d("MAWLoggerUtils").Tag.Ephemeral,d("MAWLoggerUtils").Tag.Countdown,d("MAWLoggerUtils").Tag.OnLoad]).LOG(m(),a.map(function(a){return a.msgId}));return d("MAWBridgeMsgCountdown").createBridgeMsgsStartCountdown(a).msgs}return[]}function z(a,b){return a!=null?a:d("MAWMessagesDirection").switchOnMAWMessagesDirection(b,{after:Number.MIN_SAFE_INTEGER,before:Number.MAX_SAFE_INTEGER})}function a(a){var b=a.chatJid,c=a.config,e=a.db,f=a.direction,g=a.range,h=d("WATimeUtils").unixTime();a=function(a){var b=a.messageExpirationTs!=null&&a.messageExpirationTs<h,e=a.type===d("WAMsgType").MSG_TYPE.ADMIN&&!c.admin;a=a.isCollapsed===!0;return!b&&!e&&!a};var i=g.includeLowerBoundMsg?g.numMsgs:g.numMsgs+1;i=d("MAWLoadMsgsUtil").makeUntilWithRangeExtensionBothDirections(i);var j=z(g.lowerBoundSortOrderMs,f);return n(e,b,f,j,a,i).then(function(a){var b=d("MAWLoadMessagesRequest").getMsgsForRange(a,g,f);return d("MAWDexieTable").dexieAll(b.map(function(a){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,a)})).then(function(a){return{msgsForRange:b,replyMediaInfo:a}})}).then(function(a){var h=a.msgsForRange;a=a.replyMediaInfo;d("WATagsLogger").TAGS(["MAWSecureLocalDBDataSource"]).LOG(l(),b,g);return A(e,h,a,f,g.numMsgs,c,b)})}function b(a,b,c,e,f,g,h,i){var j=z(f,e);return v(a,b,c,e,j,h,function(a){var b=a.isCollapsed===!0;a=!i.admin&&a.type===d("WAMsgType").MSG_TYPE.ADMIN;return!(b||a)}).then(function(f){var l=f.msgs;f=f.replyMediaInfo;var m=l;g||(m=m.filter(function(a){return a.msgId!==h}),m.length===l.length&&l.length!==0&&d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.LOAD_MORE_NO_ORIGINAL_MSG_IN_MAW,key:"mismatch"}));d("WATagsLogger").TAGS(["MAWSecureLocalDBDataSource"]).LOG(k(),j,h,b);return A(a,m,f,e,c,i,b)})}function A(a,b,c,e,f,g,h){var i=b.length;if(i===0)return d("MAWDexieTable").dexieResolve({editMsgHistory:[],expiringCountdown:[],hasMoreAfter:C(i,f,e),hasMoreBefore:B(i,f,e),medias:[],msgs:[],polls:[],reactions:[],receiverFetchInfoPayloads:[],xmas:[]});var k=b.map(function(a,b){if(d("MAWXMAUtils").isXMAStoryReply(a.xmaMessageType))return;return d("MAWBridgeMsg").createBridgeMsg(a,void 0,(c||[])[b])}).filter(Boolean),l=y(b);d("WATagsLogger").TAGS(["MAWSecureLocalDBDataSource"]).LOG(j(),h,k.map(function(a){return a.msgId+":"+a.sortOrderMs}));return d("MAWDexieTable").dexieAll([g.reactions?o(a,b):d("MAWDexieTable").dexieResolve([]),g.media?p(a,b):d("MAWDexieTable").dexieResolve([]),g.xma?r(a,b):d("MAWDexieTable").dexieResolve([]),g.editMsgHistory?d("MAWDbEditMsgHistoryTxns").loadEditMsgHistory(a,b):d("MAWDexieTable").dexieResolve([]),g.receiverFetch?s(a,b):d("MAWDexieTable").dexieResolve([]),g.polls?t(a,b):d("MAWDexieTable").dexieResolve([])]).then(function(a){var b=a[0],c=a[1],d=a[2],g=a[3],h=a[4];a=a[5];return{editMsgHistory:g,expiringCountdown:l,hasMoreAfter:C(i,f,e),hasMoreBefore:B(i,f,e),medias:c,msgs:k,polls:a,reactions:b,receiverFetchInfoPayloads:h,xmas:d}})}function B(a,b,c){switch(c){case"before":return a>=b;default:c;return!0}}function C(a,b,c){switch(c){case"after":return a>=b;default:c;return!0}}function e(a,b,c){return x(a,b).then(function(e){var f=e.msgs,g=e.replyMediaInfo;if(f.length===0)return{editMsgHistory:[],medias:[],msgs:[],polls:[],reactions:[],receiverFetchInfoPayloads:[],xmas:[]};var h=f.map(function(a,b){if(d("MAWXMAUtils").isXMAStoryReply(a.xmaMessageType))return;return d("MAWBridgeMsg").createBridgeMsg(a,void 0,(g||[])[b])}).filter(Boolean);d("WATagsLogger").TAGS(["MAWFetchMessageByPinnedExternalId"]).LOG(i(),b,h.map(function(a){return""+a.msgId}));return d("MAWDexieTable").dexieAll([c.reactions?o(a,f):d("MAWDexieTable").dexieResolve([]),c.media?p(a,f):d("MAWDexieTable").dexieResolve([]),c.xma?r(a,f):d("MAWDexieTable").dexieResolve([]),c.editMsgHistory?d("MAWDbEditMsgHistoryTxns").loadEditMsgHistory(a,f):d("MAWDexieTable").dexieResolve([]),c.receiverFetch?s(a,f):d("MAWDexieTable").dexieResolve([]),c.polls?t(a,f):d("MAWDexieTable").dexieResolve([])]).then(function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4];a=a[5];return{editMsgHistory:e,medias:c,msgs:h,polls:a,reactions:b,receiverFetchInfoPayloads:f,xmas:d}})})}g.loadMoreMsgsAndMediaForRange=a;g.loadMoreMsgsAndMediaFromTs=b;g.loadMsgsAndMediaByExternalId=e}),98);
__d("MAWLoadMsgsTxns",["MAWBridgeMsg","MAWBridgeMsgCountdown","MAWBridgeTypesCreators","MAWDbChunkTxns","MAWDbEditMsgHistoryTxns","MAWDbMediaTxns","MAWDbMsgTxns","MAWDbReactionUtils","MAWDbReactionsTxns","MAWDbXMATxns","MAWDexieTable","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWLoadMsgsTxnsV2","MAWLoadReplyMediaTxns","MAWLoggerUtils","MAWMediaAfterTxns","MAWXMAUtils","WATagsLogger","gkx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["EphemeralCounter: Showing UI counter for ",""]);h=function(){return a};return a}function i(a,b){return d("MAWDbMediaTxns").getMsgMediaPairFromMsgs(a,b).then(function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){var c=b[0],e=b[1];return d("MAWDbChunkTxns").hasMediaChunk(a,e.hashedPlaintextHash).then(function(b){d("MAWMediaAfterTxns").handleNewMediaAfterTxn(c,e,b,a)})}))})}function j(a,b){return d("MAWDbXMATxns").getXMAFromMsgs(a,b).then(function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){if(d("MAWXMAUtils").isXMAStoryReply(b.targetType))return;return d("MAWDbMediaTxns").maybeGetMediaFromMediaId(a,b.defaultPreviewMediaId).then(function(c){return d("MAWHandleXmaTransactionUtil").checkMediaChunkAndHandleXmaAfterTransaction(a,b,c)})}))})}function k(a,b){return d("MAWDbReactionsTxns").getReactionsFromMessages(a,b).then(function(a){a.forEach(function(a){return d("MAWDbReactionUtils").dispatchReaction(a)});return a})}function a(a,b,e,f,g){f===void 0&&(f=!1);g===void 0&&(g="before");return!c("gkx")("14304")?l(a,b,null,e,f,g).then(function(a){return{hasMoreAfter:a.hasMoreAfter,hasMoreBefore:a.hasMoreBefore}}):d("MAWLoadMsgsTxnsV2").loadMoreMsgsAndMediaFromTs(a,b,e,g,null,f,null,{admin:!0,editMsgHistory:!0,media:!0,polls:!0,reactions:!0,receiverFetch:!0,xma:!0}).then(function(a){var b=a.editMsgHistory,c=a.expiringCountdown,e=a.hasMoreAfter,f=a.hasMoreBefore,g=a.medias,h=a.msgs,i=a.reactions,j=a.receiverFetchInfoPayloads;a=a.xmas;h.length>0&&d("MAWIndexedDb").afterTransaction({tag:"NewMsgs",value:{msgs:h}});c.length>0&&d("MAWIndexedDb").afterTransaction({tag:"MsgsStartCountdown",value:{msgs:c}});i.filter(function(a){return a.type==="upsert"}).forEach(function(a){return d("MAWIndexedDb").afterTransaction({tag:"UpsertReaction",value:a.reaction})});i.filter(function(a){return a.type==="delete"}).forEach(function(a){return d("MAWIndexedDb").afterTransaction({tag:"DeleteReaction",value:a.reaction})});a.forEach(function(a){return d("MAWIndexedDb").afterTransaction({tag:"NewXMA",value:a})});b.length>0&&d("MAWIndexedDb").afterTransaction({tag:"EditMsgHistoryAdded",value:b});g.length>0&&d("MAWIndexedDb").afterTransaction({tag:"NewMedias",value:g});j.forEach(function(a){return d("MAWIndexedDb").afterTransaction({tag:"NewReceiverFetchInfo",value:a})});return{hasMoreAfter:e,hasMoreBefore:f}})}function l(a,b,c,e,f,g,l){f===void 0&&(f=!1);l===void 0&&(l=null);return d("MAWDbMsgTxns").getMsgsFromOffset(a,b,c,e,f,!1,g,l).then(function(b){var c=b.msgs,e=babelHelpers.objectWithoutPropertiesLoose(b,["msgs"]);return d("MAWDexieTable").dexieAll(c.map(function(b){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b)})).then(function(a){return babelHelpers["extends"]({msgs:c,replyMediaInfo:a},e)})}).then(function(e){var l=e.hasMoreAfter,m=e.hasMoreBefore,n=e.msgs,o=e.replyMediaInfo;e=n.map(function(a,b){if(d("MAWXMAUtils").isXMAStoryReply(a.xmaMessageType))return;return d("MAWBridgeMsg").createBridgeMsg(a,void 0,(o||[])[b])}).filter(Boolean);e.length>0&&d("MAWIndexedDb").afterTransaction({tag:"NewMsgs",value:{msgs:e}});e=n.filter(function(a){return a.ephemeralCounterStarted});e.length>0&&(d("WATagsLogger").TAGS([d("MAWLoggerUtils").Tag.Ephemeral,d("MAWLoggerUtils").Tag.Countdown,d("MAWLoggerUtils").Tag.OnLoad]).LOG(h(),e.map(function(a){return a.msgId})),d("MAWIndexedDb").afterTransaction({tag:"MsgsStartCountdown",value:d("MAWBridgeMsgCountdown").createBridgeMsgsStartCountdown(e)}));(n.length>0||c==null)&&d("MAWIndexedDb").afterTransaction({tag:"MsgsLoaded",value:d("MAWBridgeTypesCreators").createBridgeMsgsLoadedInfo(b,n,f,m,l,g)});return d("MAWDexieTable").dexieAll([k(a,n),d("MAWDbEditMsgHistoryTxns").loadEditMsgHistory(a,n),i(a,n),j(a,n)]).then(function(a){a=a[0];return{hasMoreAfter:l,hasMoreBefore:m,msgs:n,reactions:a}})})}g.loadMsgAndMedia_COMPAT=a;g.loadMsgsAndMediaFromOffset_DO_NOT_USE=l}),98);
__d("MAWLoadOneToOneMessageRequestCapabilitiesTxn",["MAWDexieTable","MAWIndexedDb","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function a(a){a.map(d("WAJids").interpretAsUserJid).forEach(function(a){return a!=null&&d("MAWIndexedDb").afterTransaction({tag:"OneToOneMessageRequestLoaded",value:{fbid:d("WAJids").extractUserId(a),threadJid:a}})});return d("MAWDexieTable").dexieResolve()}g.loadOneToOneMessageRequestCapabilities=a}),98);
__d("MAWLoadThreadsTxns",["FBLogger","I64","MAWBridgeParticipants","MAWBridgeThread","MAWBridgeTypesCreators","MAWDbParticipantTxns","MAWDexieTable","MAWIndexedDb","MAWLoadGroupInvitesTxns","MAWLoadMsgsTxns","MAWLoadOneToOneMessageRequestCapabilitiesTxn","MAWMpsGating","MAWThreadMappingQPL","MAWThreadSnippetUtils","MAWTransactionMode","MAWUserJidWrapper","WAJids","WALogger","emptyFunction","err","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,c,e,f){f===void 0&&(f="unknown");b.forEach(function(a){var b=d("MAWThreadMappingQPL").getInstanceKeyForJidInWorker(a.jid);d("MAWThreadMappingQPL").startInWorker({instanceKey:b,jid:a.jid,threadKey:a.optimisticThreadKey==null?void 0:(h||(h=d("I64"))).of_string(a.optimisticThreadKey),trigger:"loadContentsForThreads_"+f});d("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:d("MAWBridgeThread").createBridgeThread(a,e==null?void 0:e.get(a.jid),void 0,"loadContentsForThreads_"+f,null,b)})});return d("MAWMpsGating").isFullMpsEnabled()?d("MAWDexieTable").dexieResolve(b):d("MAWDexieTable").dexieAll([].concat(b.map(function(b){return j(a,b,c)}),[i(a,b),k(a,b),d("MAWLoadOneToOneMessageRequestCapabilitiesTxn").loadOneToOneMessageRequestCapabilities(b.map(function(a){return a.jid})),d("MAWLoadGroupInvitesTxns").loadGroupInvites(a,b)])).then(function(){return b})}function b(a,b,c,e,f){f===void 0&&(f=!1);return d("MAWDexieTable").dexieAll([i(a,[c]),j(a,c,e),d("MAWThreadSnippetUtils").updateThreadInfoToUIOnPageLoad(a,c,f)]).then(function(e){e=e[0];b||m(a,c.jid,d("WAJids").interpretAsGroupJid(c.jid)!=null,!1,c.cannotReplyReason,c.archived);return e})}function e(a,b,c,e){e===void 0&&(e=!1);return d("MAWDexieTable").dexieAll([i(a,[c]),d("MAWThreadSnippetUtils").updateThreadInfoToUIOnPageLoad(a,c,e)]).then(function(e){e=e[0];b||m(a,c.jid,d("WAJids").interpretAsGroupJid(c.jid)!=null,!1,c.cannotReplyReason,c.archived);return e})}function i(a,b){return b.length===0?d("MAWDexieTable").dexieResolve([]):d("MAWDbParticipantTxns").getParticipantsInThreads(a,b.map(function(a){return a.jid})).then(function(a){c("gkx")("13628")||d("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:d("MAWBridgeParticipants").createBridgeParticipants(a)});return a})}function j(a,b,c){return d("MAWLoadMsgsTxns").loadMsgAndMedia_COMPAT(a,b.jid,c,!0)}function k(a,b){var e=[];b.forEach(function(a){return d("WAJids").switchOnMsgrChatJidType(a.jid,{group:function(a){return e.push(a)},user:c("emptyFunction")})});return a.groupInfo.bulkGet(e).then(function(a){a.forEach(function(a){a!=null&&d("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedGroupInfo(a)})})})}f=function(a){a=a.threadJid;return l(a)};var l=d("MAWIndexedDb").makeMsgrTransactor({participants:d("MAWTransactionMode").READONLY},"checkIfGroupParticipant",function(a){return function(){for(var b=arguments.length,c=new Array(b),d=0;d<b;d++)c[d]=arguments[d];return m.apply(void 0,[a].concat(c))}});function m(a,b,e,f,g,h){e===void 0&&(e=!0);f===void 0&&(f=!0);var i=d("MAWUserJidWrapper").getMyUserJid();return d("MAWDbParticipantTxns").getParticipant(a,b,i).then(function(a){if(!a.success){var j=e?"group":"one_to_one";d("WALogger").LOG(["[Occamadillo] User is not a participant of "+j+" thread\n        "+b.toString()+", showing a VIEWER_NOT_SUBSCRIBED composer blocker"]);if(g==null){var k;c("FBLogger")("maw_db","checkIfParticipant").catching((k=a.payload)!=null?k:c("err")(a.error)).warn("[Occamadillo] User %s is not a participant of %s thread %s, occam: %s, archived: %s, cannotReplyReason null.",i,j,b.toString(),f,h)}c("FBLogger")("labyrinth_web","checkIfParticipant").warn("[Occamadillo] User not a participant from checkIfParticipant");k={cannotReplyReason:"viewer_not_subscribed",threadJid:b};d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread(k)})}})}g.loadContentsForThreads=a;g.loadParticipantsAndMsgs=b;g.loadParticipantsAndThreadInfo=e;g.loadParticipants=i;g.loadGroups=k;g.checkIfGroupParticipant=f;g.checkIfParticipant=m}),98);
__d("MAWDbGroupInfoTxns",["MAWBridgeTypesCreators","MAWIndexedDb","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return h(a,b.jid).then(function(c){var d=b.participantVersion;c.success&&c.value.participantVersion!=null&&b.participantVersion==null&&(d=c.value.participantVersion);c=b.subject.content;c!=null&&c.length===0&&(c=void 0);var e={creationTs:b.creationTs,creator:b.creator,groupJid:b.jid,inviter:b.inviter,memberAddMode:b.memberAddMode,name:c,nameOwner:b.subject.user,nameTs:b.subject.ts,participantVersion:d};return i(a,e).then(function(){return e})})}function h(a,b){return a.groupInfo.get({groupJid:b}).then(function(a){return a==null?d("WAResultOrError").makeError("missing"):d("WAResultOrError").makeResult(a)})}function i(a,b){return a.groupInfo.put(b).then(function(){d("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedGroupInfo(b)})})}function b(a,b){return a.groupInfo.bulkPut(b).then(function(){b.forEach(function(a){return d("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedGroupInfo(a)})})})}function c(a,b){return a.groupInfo.bulkGet(b)}function e(a,b){return a.groupInfo["delete"](b)}g.putGroupInfo=a;g.getGroupInfo=h;g.updateGroupInfo=i;g.bulkUpdateGroupInfo=b;g.getGroupInfos=c;g.deleteGroupInfo=e}),98);
__d("MAWGroupInviteManagementTxns",["MAWDbGroupInviteTxns","MAWDbParticipantTxns","MAWDexieTable","MAWUserJidWrapper"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var c=!1;return d("MAWDbParticipantTxns").getInvitedParticipantsInThread(a,b).then(function(e){if(e.length===0){c=!0;var f=d("MAWUserJidWrapper").getMyUserJid();return d("MAWDbGroupInviteTxns").deleteGroupInvitesByThreadAndInvitedParticipant(a,b,f).then(function(){return c})}else{var g=[];e.forEach(function(c){g.push(d("MAWDbGroupInviteTxns").deleteGroupInvitesByThreadAndInvitedParticipant(a,b,c.userJid))});return d("MAWDexieTable").dexieAll(g).then(function(){return c})}})}g.deleteGroupInvitesByThread=a}),98);
__d("MAWThreadManagementTxns",["MAWBridgeEventTransmitter","MAWBridgeParticipants","MAWBridgeTypesCreators","MAWDbGroupInfoTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbParticipantTxns","MAWDbReactionsTxns","MAWDbThreadTxns","MAWDexieTable","MAWGetOrCreateThreadTxns","MAWGroupInviteManagementTxns","MAWIndexedDb","MAWLoadOneToOneMessageRequestCapabilitiesTxn","MAWQplProxy","WAJids","WALogger","WAMsgType","WASortedLists","WATimeUtils","qpl"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Successfully deleted "," media rows and "," chunk rows"]);h=function(){return a};return a}function a(a,b,e,f){var g=b.authoritativeThreadKey,h=b.createTs,i=b.description,j=b.folder,k=b.lastActivityTimestamp,m=b.lastReadWatermarkTimestamp,n=b.offlineThreadingId,o=b.skipVerifyThread,p=b.userJid;return d("MAWGetOrCreateThreadTxns").getOrCreateThread(a,{authoritativeThreadKey:g,clientThreadKey:n,createTs:h,description:i,folder:j,instanceKey:f,jid:p,lastActivityTimestamp:k,lastReadWatermarkTimestamp:m,skipVerifyThread:o},e).then(function(b){var g=b.created;b=b.thread;e!=null&&d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(25313175,"1551"),"process-setup-thread-start",{instanceKey:e});f!=null&&d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(1056836502,"2778"),"process_setup_thread_start",{instanceKey:f});g=l(a,p,g,b);e!=null&&d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(25313175,"1551"),"process-setup-thread-end",{instanceKey:e});f!=null&&d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(1056836502,"2778"),"process_setup_thread_end",{instanceKey:f});return g})}function b(a,b,c,e){return d("MAWDbGroupInfoTxns").getGroupInfo(a,b).then(function(b){if(!b.success)return null;var f=b.value;return d("MAWGetOrCreateThreadTxns").getOrCreateThread(a,{createTs:d("WATimeUtils").castUnixTimeToMillisTime(f.creationTs),description:"getOrRepairGroupThread",folder:c,jid:f.groupJid,skipVerifyThread:e}).then(function(a){var b=a.created;a=a.thread;return{created:b,groupInfo:f,thread:a}})})}function i(a,b){var c=[],e=[];b.forEach(function(a){d("MAWDbMsg").isMediaMsg(a)&&a.mediaId!=null&&(c.push(a.mediaId),e.push(a.msgId))});return a.media.bulkGet(c).then(function(b){var c=[],f=[];b.forEach(function(a,b){if(a!=null){var g=e[b];a.msgIds=d("WASortedLists").filter(a.msgIds,function(a){return a!==g});a.mediaEntries["delete"](g);a.msgIds.length===0&&a.mediaEntries.size===0&&(a.plaintextHash!=null&&c.push(a.hashedPlaintextHash),f.push(a.mediaId))}});b=a.media.bulkDelete(f);var g=a.chunk.where("hashedPlaintextHash").anyOf(c)["delete"]();return d("MAWDexieTable").dexieAll([b,g]).then(function(){d("WALogger").LOG(h(),f.length,c.length)})})}function j(a,b){return d("MAWDbMsgTxns").getThreadNewestMessageTs(a,b).then(function(c){return a.messages.where("threadJid").equals(b.jid).toArray().then(function(d){return k(a,b,c,d,!0)})})}function e(a,b,c,e){var f=c==null?void 0:c.lastMessageTimestamp;if(c==null)return j(a,b);var g=a.messages.where("threadJid").equals(b.jid).toArray(),h=d("MAWDbMsgTxns").getThreadNewestMessageTs(a,b);return d("MAWDexieTable").dexieAll([g,h]).then(function(g){var h=g[0];g=g[1];var i=[],j=new Set();f!=null&&h.forEach(function(a){var b;b=(b=a.originalTs)!=null?b:a.ts;b<=f+1&&(j.add(a.msgId),i.push(a))});if((c==null?void 0:c.messages.length)!==0){var l=new Set();c.messages.forEach(function(a){l.add((a=a.key)==null?void 0:a.id)});h.forEach(function(a){l.has(a.externalId)&&!j.has(a.msgId)&&(j.add(a.msgId),i.push(a))})}if(i.length!==h.length)for(var m of h)if(!j.has(m.msgId)&&m.type!==d("WAMsgType").ADMIN)return k(a,b,g,i,!1,e);return k(a,b,g,h,!0,e)})}function k(a,b,c,e,f,g){var h=d("WAJids").interpretAsGroupJid(b.jid),j=f?d("MAWDbThreadTxns").deleteThreadRow(a,b.jid):d("MAWDexieTable").dexieResolve(),k=f?d("MAWDbParticipantTxns").deleteAllParticipantsForThread(a,b.jid):d("MAWDexieTable").dexieResolve(),l=d("MAWDexieTable").dexieResolve(!1),m=d("MAWDexieTable").dexieResolve();h!=null&&f&&(l=d("MAWGroupInviteManagementTxns").deleteGroupInvitesByThread(a,h),m=d("MAWDbGroupInfoTxns").deleteGroupInfo(a,h));return d("MAWDexieTable").dexieAll([i(a,e),d("MAWDbReactionsTxns").deleteAllReactionsForMessages(a,e),d("MAWDbMsgTxns").deleteMessages(a,e,g),j,k,m,l]).then(function(a){a[0];a[1];a[2];a[3];a[4];a[5];a=a[6];f?(d("MAWBridgeEventTransmitter").deleteMessagesOfThreadAfterTxn(b,c),h!=null&&a&&d("MAWIndexedDb").afterTransaction({tag:"DeleteGroupInvite",value:d("MAWBridgeTypesCreators").createBridgeDeleteGroupInvite(b.jid)}),d("MAWIndexedDb").afterTransaction({tag:"ThreadHiddenV2",value:b.jid})):d("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:d("MAWBridgeTypesCreators").createBridgeDeleteMessages(b.jid,e)});return{deletedMessages:e.map(function(a){return d("MAWDbMsg").getWAMsgId(a)})}})}function l(a,b,c,e){a=d("MAWDbParticipantTxns").bulkRemoveIncorrectAndInsertMissingParticipantsInOneToOneThread(a,b).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:d("MAWBridgeParticipants").createBridgeParticipants(a)})});return d("MAWDexieTable").dexieAll([d("MAWLoadOneToOneMessageRequestCapabilitiesTxn").loadOneToOneMessageRequestCapabilities([e.jid]),a]).then(function(){return{created:c,thread:e}})}g.getOrSetupOneToOneThread=a;g.getGroupThread=b;g.deleteAllThreadData=j;g.metaSyncChatDeleteThread=e;g.processSetupThreadResponseForOneToOneThread=l}),98);
__d("MAWGroupInfoStore",["MAWBridgeTypesCreators","MAWDbMsgTxns","MAWDbThreadTxns","MAWDexieCastToPromise","MAWDexieTable","MAWFolderTypes","MAWGetOrCreateThreadTxns","MAWIndexedDb","MAWLoadThreadsTxns","MAWThreadManagementTxns","MAWTransactionMode","WAResultOrError","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return a!=null&&typeof a==="object"&&a.groupStatus!=null&&typeof a.groupStatus==="string"?a.groupStatus:void 0}function i(a){return a!=null&&typeof a==="object"&&a.clientThreadKey!=null&&typeof a.clientThreadKey==="string"?a.clientThreadKey:void 0}function j(a){return a!=null&&typeof a==="object"&&a.folder!=null&&typeof a.folder==="number"?a.folder:void 0}function k(a){return a!=null&&typeof a==="object"&&a.updateParticipantMedatadata!=null&&typeof a.updateParticipantMedatadata==="boolean"?a.updateParticipantMedatadata:void 0}function l(a){return a===null?{}:a}a=function(){function a(a){var b=this;this.get=function(a,c){c=j(c);return d("MAWDexieCastToPromise").dexieCastToPromise(d("MAWThreadManagementTxns").getGroupThread(b.db,a,c).then(function(a){return a!=null?a:null}).then(function(a){return a==null?d("WAResultOrError").makeError("missing_group"):d("MAWLoadThreadsTxns").loadContentsForThreads(b.db,[a.thread],1,null,"getGroupInfoStore").then(function(){return a.groupInfo}).then(function(a){return d("WAResultOrError").makeResult(m(a))})}))};this.create=function(a,c){var e=h(c)==="added"?d("WATimeUtils").millisTime():d("WATimeUtils").castUnixTimeToMillisTime(a.creationTs);return d("MAWDexieCastToPromise").dexieCastToPromise(d("MAWGetOrCreateThreadTxns").getOrCreateThread(b.db,{clientThreadKey:i(c),createTs:e,description:"MAWGroupInfoStore-create",folder:d("MAWFolderTypes").FOLDER_ID.INBOX,jid:a.jid}).then(function(c){var e=c.created,f=c.thread,g=n(a);return d("MAWDexieTable").dexieAll([b.db.groupInfo.put(g),d("MAWDbMsgTxns").getThreadNewestMessageId(b.db,f.jid)]).then(function(a){a[0],a[1],d("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedGroupInfo(g)})}).then(function(){return f.archived===!0?d("MAWDbThreadTxns").unarchiveThreads(b.db,[f.jid]):d("MAWDexieTable").dexieResolve()}).then(function(){return e?d("WAResultOrError").makeResult(g.groupJid):d("WAResultOrError").makeError("existing")})}))};this["delete"]=function(a){return d("MAWDexieCastToPromise").dexieCastToPromise(d("MAWDexieTable").dexieAll([b.db.threads.get({jid:a}),b.db.groupInfo["delete"](a)]).then(function(a){a=a[0];return a==null?d("WAResultOrError").makeError("missing_group"):d("MAWDexieTable").dexieAll([d("MAWDbThreadTxns").deleteThreadRow(b.db,a.jid),b.db.participants.where("threadJid").equals(a.jid)["delete"]()]).then(function(){return d("WAResultOrError").makeResult()})}))};this.update=function(a,c,e){return d("MAWDexieCastToPromise").dexieCastToPromise(b.db.threads.get({jid:a}).then(function(f){return f==null?d("WAResultOrError").makeError("missing_group"):b.db.groupInfo.get(a).then(function(a){if(a==null)return d("WAResultOrError").makeError("missing_group");a=m(a);a=c(a);var g=n(a);return b.db.groupInfo.put(g).then(function(){d("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedGroupInfo(g)});k(e)===!0&&d("MAWIndexedDb").afterTransaction({tag:"UpdateE2EEMetadataParticipants",value:d("MAWBridgeTypesCreators").createBridgeUpdateE2EEMetadataParticipants(f.jid)});return d("WAResultOrError").makeResult()})})}))};this.clear=function(){return d("MAWDexieCastToPromise").dexieCastToPromise(b.db.groupInfo.clear())};this.db=a}var b=a.prototype;b.has=function(a){return d("MAWDexieCastToPromise").dexieCastToPromise(this.db.groupInfo.get(a).then(function(a){return a!=null?!0:!1}))};return a}();a.tableLocks={chunk:(b=d("MAWTransactionMode")).READONLY,editMsgHistory:b.READONLY,groupInfo:b.READWRITE,groupInvites:b.READONLY,media:b.READONLY,messages:b.READWRITE,participants:b.READWRITE,poll:b.READONLY,reactions:b.READONLY,receiverFetchInfo:b.READONLY,threads:b.READWRITE,xma:b.READONLY};function m(a){return babelHelpers["extends"]({jid:a.groupJid},l(a.creator!=null?{creator:a.creator}:null),{creationTs:a.creationTs},l(a.participantVersion!=null?{participantVersion:a.participantVersion}:null),{inviter:a.inviter,memberAddMode:a.memberAddMode,subject:babelHelpers["extends"]({content:a.name},l(a.nameOwner!=null?{user:a.nameOwner}:null),l(a.nameTs!=null?{ts:a.nameTs}:null))})}function n(a){var b=a.subject.content;b!=null&&b.length===0&&(b=void 0);return{creationTs:a.creationTs,creator:a.creator,groupJid:a.jid,inviter:a.inviter,memberAddMode:a.memberAddMode,name:b,nameOwner:a.subject.user,nameTs:a.subject.ts,participantVersion:a.participantVersion}}g.MAWGroupInfoStore=a}),98);
__d("MAWThreadFetchAndEmitTxns",["MAWDexieTable","MAWLoadGroupInvitesTxns","MAWLoadOneToOneMessageRequestCapabilitiesTxn","MAWLoadThreadsTxns","MAWThreadManagementTxns","WAJids","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f){f===void 0&&(f="fetchAndEmitThread");return d("WAJids").switchOnMsgrChatJidType(b,{group:function(b){return d("MAWThreadManagementTxns").getGroupThread(a,b,c).then(function(a){return a==null?null:{created:a.created,thread:a.thread}})},user:function(b){var g;return d("MAWThreadManagementTxns").getOrSetupOneToOneThread(a,{createTs:e==null?void 0:d("WATimeUtils").castUnixTimeToMillisTime(e),description:f,folder:(g=c)!=null?g:void 0,userJid:b})}}).then(function(b){return b==null||b.thread==null?null:d("MAWLoadThreadsTxns").loadContentsForThreads(a,[b.thread],1,null,f).then(function(){return b})})}function b(a,b){if(b.size===0)return d("MAWDexieTable").dexieResolve();b=Array.from(b);return a.threads.where("jid").anyOf(b).toArray().then(function(b){b=b.filter(Boolean);return d("MAWDexieTable").dexieAll([d("MAWLoadThreadsTxns").loadParticipants(a,b),d("MAWLoadThreadsTxns").loadGroups(a,b),d("MAWLoadOneToOneMessageRequestCapabilitiesTxn").loadOneToOneMessageRequestCapabilities(b.map(function(a){return a.jid})),d("MAWLoadGroupInvitesTxns").loadGroupInvites(a,b)])}).then(c("emptyFunction"))}g.fetchAndEmitThread=a;g.emitThreadContents=b}),98);
__d("MAWMessageStore",["MAWAckLevel","MAWAuthor","MAWBridgeMsg","MAWDbMsgTxns","MAWDbThread","MAWDexieCastToPromise","MAWDexieTable","MAWFolderTypes","MAWIndexedDb","MAWLocalizationUtils","MAWMsgType","MAWThreadFetchAndEmitTxns","MAWTransactionMode","MAWWriteMsgTxns","WAJids","WALogger","WAResultOrError","WATimeUtils","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Successfully deleted: "," reactions rows."]);h=function(){return a};return a}function i(a){if(a!=null&&typeof a==="object"&&a.optimisticMsg!=null){a=a.optimisticMsg;if(typeof a.msgId==="string"&&typeof a.ts==="number")return{msgId:a.msgId,ts:a.ts}}return void 0}function j(a){return a!=null&&typeof a==="object"&&a.openMessageOtid!=null&&typeof a.openMessageOtid==="string"?a.openMessageOtid:void 0}function k(a){if(a!=null&&typeof a==="object"&&a.folder!=null&&typeof a.folder==="number")if(a.folder===d("MAWFolderTypes").FOLDER_ID.INBOX)return d("MAWFolderTypes").FOLDER_ID.INBOX;else if(a.folder===d("MAWFolderTypes").FOLDER_ID.PENDING)return d("MAWFolderTypes").FOLDER_ID.PENDING;else if(a.folder===d("MAWFolderTypes").FOLDER_ID.OTHER)return d("MAWFolderTypes").FOLDER_ID.OTHER;else if(a.folder===d("MAWFolderTypes").FOLDER_ID.ARCHIVED)return d("MAWFolderTypes").FOLDER_ID.ARCHIVED;return null}a=function(){function a(a){this.db=a}var b=a.prototype;b.create=function(a,b){var e=this,f=i(b),g=j(b);b=k(b);return d("MAWDexieCastToPromise").dexieCastToPromise(d("MAWThreadFetchAndEmitTxns").fetchAndEmitThread(this.db,a.id.chat,b,void 0,"MAWMessageStore_DEPRECATED-create").then(function(b){if(b==null)return d("WAResultOrError").makeError({type:"missing_thread"});b=b.thread;if(a.type===d("MAWMsgType").MSG_TYPE.TEXT){var h=void 0;a.ephemeralSetting!=null&&(h={ephemeralExpirationInSec:a.ephemeralSetting.expirationTs,ephemeralLastUpdatedOrSetTimestamp:a.ephemeralSetting.updatedTs});h={ack:a.ack,altIndex:void 0,author:a.id.author,ephemeralSetting:h,externalId:a.id.externalId,forwardingScore:a.forwardingScore,isForwarded:a.forwardingScore>0,msgContent:{content:((h=a.msgContent)==null?void 0:h.content)||""},serverTs:a.serverTs,threadJid:b.jid,ts:a.ts,type:d("MAWMsgType").MSG_TYPE.TEXT};return d("MAWWriteMsgTxns").writeMsg(e.db,h,b,"MAWMessageStore::create",{openMessageOtid:g,optimisticMsg:f}).then(function(){return d("WAResultOrError").makeResult()})}else if(a.type===d("MAWMsgType").MSG_TYPE.ICDC_ALERT){h={ack:a.ack,altIndex:void 0,author:a.id.author,externalId:a.id.externalId,msgContent:{adminType:a.msgContent.adminType,authorName:a.msgContent.authorName},serverTs:a.serverTs,threadJid:b.jid,ts:a.ts,type:d("MAWMsgType").MSG_TYPE.ICDC_ALERT};return d("MAWWriteMsgTxns").writeMsg(e.db,h,b,"MAWMessageStore::create",{openMessageOtid:g,optimisticMsg:f}).then(function(){a.hasUnknownName&&!d("WAJids").isAuthorMe(a.id.author)&&!d("WAJids").isAuthorSystem(a.id.author)&&d("MAWIndexedDb").afterTransaction({tag:"SyncContacts",value:[d("WAJids").userIdFromJid(a.id.author)]});return d("WAResultOrError").makeResult()})}else if(a.type===d("MAWMsgType").MSG_TYPE.ADMIN){h={ack:a.ack,altIndex:void 0,author:d("WAJids").AUTHOR_SYSTEM,externalId:a.id.externalId,msgContent:babelHelpers["extends"]({},a.msgContent,{version:d("MAWLocalizationUtils").isAdminMsgNormalized(a.msgContent.adminType)?1:0}),serverTs:a.serverTs,threadJid:b.jid,ts:a.ts,type:a.type};return d("MAWWriteMsgTxns").writeMsg(e.db,h,b,"MAWMessageStore::create").then(function(){return d("WAResultOrError").makeResult()})}throw c("err")("non renderable store not implemented yet")}))};b.get=function(a){return d("MAWDexieCastToPromise").dexieCastToPromise(d("MAWDexieTable").dexieAll([this.db.threads.get({jid:a.chat}),this.db.messages.where("externalId").equals(a.externalId).toArray()]).then(function(b){var c,e=b[0];b=b[1];if(e==null)return d("MAWDexieTable").dexieResolve(null);b=b.find(function(b){return b.threadJid===e.jid&&b.author===a.author});return b==null||b.type!=="Text"?d("MAWDexieTable").dexieResolve(null):d("MAWDexieTable").dexieResolve({ack:b.ack,forwardingScore:(c=b.forwardingScore)!=null?c:0,id:a,msgContent:{content:b.msgContent.content},ts:b.ts,type:b.type})}))};b.update=function(a){var b=this;return d("MAWDexieCastToPromise").dexieCastToPromise(d("MAWDexieTable").dexieAll([this.db.threads.get({jid:a.id.chat}),this.db.messages.where("externalId").equals(a.id.externalId).toArray()]).then(function(c){var e=c[0];c=c[1];if(e==null)return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError("missing"));var f=c.find(function(b){return b.threadJid===e.jid&&b.author===a.id.author});if(f==null||f.type!=="Text")return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError("missing"));c=f.ack<d("MAWAckLevel").ACK.sent;f.ack=a.ack;f.ts=a.ts;f.serverTs=a.sentTs;var g=void 0;a.ephemeralSetting!=null&&(g={ephemeralExpirationInSec:a.ephemeralSetting.expirationTs,ephemeralLastUpdatedOrSetTimestamp:a.ephemeralSetting.updatedTs});f.ephemeralSetting=g;g=a.sentTs;g=g==null?g:d("WATimeUtils").castUnixTimeToMillisTime(g);c=g!=null&&c?b.db.threads.put(babelHelpers["extends"]({},e,{newestMsgTs:g,threadOrder:d("MAWDbThread").craftThreadOrder(g,e.jid)})):d("MAWDexieTable").dexieResolve();return d("MAWDexieTable").dexieAll([b.db.messages.put(f),c]).then(function(){var a=null;d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(f,void 0,a)});return d("WAResultOrError").makeResult()})}))};b.deleteReactionsForMsg=function(a){var b=this;return d("MAWDexieCastToPromise").dexieCastToPromise(this.db.reactions.where("reactToExternalId").equals(a.externalId).filter(function(b){return d("MAWAuthor").getAuthorUserJid(b.reactToAuthor)===d("MAWAuthor").getAuthorUserJid(a.author)&&b.threadJid===a.chat}).toArray().then(function(a){return b.db.reactions.bulkDelete(a.map(function(a){return a.rowId}))}))};b.bulkDelete=function(a){var b=this,c=d("MAWDexieTable").dexieAll(a.map(function(a){var c=a.author,e=a.chat;a=a.externalId;var f=d("MAWAuthor").getAuthorUserJid(c);return b.db.reactions.where("reactToExternalId").equals(a).filter(function(a){return d("MAWAuthor").getAuthorUserJid(a.reactToAuthor)===f&&a.threadJid===e}).toArray()})).then(function(a){return a.flat()}).then(function(a){d("WALogger").LOG(h(),a.length);return b.db.reactions.bulkDelete(a.map(function(a){return a.rowId}))});return d("MAWDexieCastToPromise").dexieCastToPromise(d("MAWDbMsgTxns").getMsgsByProtocolMsgId(this.db,a).then(function(a){var e=a.map(function(a){return a.rowId});return d("MAWDexieTable").dexieAll([b.db.messages.bulkDelete(e),c]).then(function(){return e.length})}))};b.bulkGetInGroup=function(a){return d("MAWDexieCastToPromise").dexieCastToPromise(this.db.messages.where("threadJid").equals(a).toArray()).then(function(b){return b==null||b.length===0?[]:b.map(function(b){return{author:b.author,chat:a,externalId:b.externalId}})})};return a}();a.tableLocks={chunk:(b=d("MAWTransactionMode")).READONLY,ftsBackloggedMessages:b.READWRITE,groupInfo:b.READWRITE,groupInvites:b.READONLY,media:b.READONLY,messages:b.READWRITE,participants:b.READWRITE,poll:b.READONLY,reactions:b.READWRITE,receiverFetchInfo:b.READONLY,threads:b.READWRITE,xma:b.READONLY};g.MAWMessageStore_DEPRECATED_DO_NOT_USE=a}),98);
__d("WAResultOrErrorUtils",[],(function(a,b,c,d,e,f){"use strict";function a(a){var b=[];a.forEach(function(a){a.success&&b.push(a.value)});return b}function b(a){var b=[];a.forEach(function(a){a.success||b.push(a.error)});return b}f.unpackValues=a;f.unpackErrors=b}),66);
__d("MAWParticipantsStore",["MAWBridgeParticipants","MAWBridgeTypesCreators","MAWDbParticipant","MAWDbParticipantTxns","MAWDbThreadTxns","MAWDexieCastToPromise","MAWDexieTable","MAWIndexedDb","MAWTransactionMode","WAArrayGroupBy","WAArrayZip","WAGlobals","WAResultOrError","WAResultOrErrorUtils","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";a=function(a){var b=this;this.bulkGetInGroup=function(a){return d("MAWDexieCastToPromise").dexieCastToPromise(b.db.threads.get({jid:a}).then(function(a){return a!=null?d("MAWDbParticipantTxns").getParticipantsInThread(b.db,a.jid).then(function(b){return d("WAResultOrError").makeResult(b.map(function(b){return h(b,a.jid)}))}):d("WAResultOrError").makeError("missing_group")}))};this.bulkPut=function(a){return d("MAWDexieCastToPromise").dexieCastToPromise(k(b.db,a.map(function(a){a=a.chatJid;return a})).then(function(b){return d("WAResultOrErrorUtils").unpackValues(a.map(function(a){return!b.has(a.chatJid)?d("WAResultOrError").makeError():d("WAResultOrError").makeResult({participantId:d("MAWDbParticipant").craftParticipantId(a.chatJid,a.user),waParticipant:a})}))}).then(function(a){return b.db.participants.bulkGet(a.map(function(a){a=a.participantId;return a})).then(function(b){return d("WAArrayZip").zip(a,b).map(function(a){var b=a[0].waParticipant;a=a[1];return{chatJid:b.chatJid,dbParticipantToPut:babelHelpers["extends"]({deliveredWatermarkTs:d("WATimeUtils").castToUnixTime(0),lastReadWatermarkTs:d("WATimeUtils").castToUnixTime(0)},a,i(b)),existed:a!=null,participant:b}})})}).then(function(a){var c=a.map(function(a){a=a.dbParticipantToPut;return babelHelpers["extends"]({},a)});c.forEach(function(a){return d("MAWDbParticipantTxns").logIfIllegalParticipant(a,"MAWParticipantsStore::bulkPut")});return b.db.participants.bulkPut(c).then(function(){return l(b.db,a)})}))};this.bulkDelete=function(a,c){c=c||{};var e=c.remover,f=d("WAArrayGroupBy").groupBy(a.map(function(a,b){return{index:b,key:a}}),function(a){a=a.key;return a.groupJid});c=f.map(function(a){a=a[0];return a});return d("MAWDexieCastToPromise").dexieCastToPromise(k(b.db,c).then(function(a){return f.flatMap(function(b){var c=b[0];b=b[1];return b.map(function(b){var e=b.index;b=b.key;return!a.has(c)?d("WAResultOrError").makeError({index:e,message:"missing_group"}):d("WAResultOrError").makeResult({groupJid:c,index:e,participantId:d("MAWDbParticipant").craftParticipantId(c,b.userJid),participantKey:[c,b.userJid],userJid:b.userJid})})})}).then(function(a){var c=d("WAResultOrErrorUtils").unpackValues(a),e=d("WAResultOrErrorUtils").unpackErrors(a).map(function(a){return d("WAResultOrError").makeError(a)});a=c.map(function(a){a=a.participantId;return a});return b.db.participants.bulkGet(a).then(function(a){return d("WAArrayZip").zip(c,a).map(function(a){var b=a[0];a=a[1];return a==null?d("WAResultOrError").makeError({index:b.index,message:"missing_participant"}):d("WAResultOrError").makeResult(b)}).concat(e)})}).then(function(a){var c=d("WAResultOrErrorUtils").unpackValues(a),f=c.map(function(a){a=a.participantKey;return a}),g=c.map(function(a){var b=a.groupJid;a=a.userJid;return{groupJid:b,userJid:a}});return d("MAWDbParticipantTxns").bulkDeleteParticipants(b.db,f).then(function(){return m(b.db,g,e)}).then(function(){return a})}).then(function(a){return a.map(function(a){return a.success?{index:a.value.index,result:d("WAResultOrError").makeResult()}:{index:a.error.index,result:d("WAResultOrError").makeError(a.error.message)}}).sort(function(a,b){a=a.index;b=b.index;return a-b}).map(function(a){a=a.result;return a})}))};this.clear=function(){return d("MAWDexieCastToPromise").dexieCastToPromise(b.db.participants.clear())};this.db=a};a.tableLocks={participants:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE};function h(a,b){var c=a.addressable!=null?{addressable:a.addressable}:null;return babelHelpers["extends"]({chatJid:b,type:a.type,user:a.userJid},c)}function i(a){return{addressable:a.addressable,id:d("MAWDbParticipant").craftParticipantId(a.chatJid,a.user),threadJid:a.chatJid,type:a.type,userJid:a.user}}function j(a){return a.map(function(a){return a.user}).filter(function(a){return a===d("WAGlobals").getMyUserJid()||a==="@me"}).length>0}function k(a,b){a=a.threads;return a.where("jid").anyOf(b).toArray().then(function(a){return new Set(a.map(function(a){a=a.jid;return a}))})}function l(a,b){var c=b.filter(function(a){a=a.existed;return!a}).map(function(a){var b=a.chatJid;a=a.participant;return{chatJid:b,participant:a}});c=d("WAArrayGroupBy").groupBy(c,function(a){a=a.chatJid;return a}).map(function(a){var b=a[0];a=a[1];return[b,a.map(function(a){a=a.participant;return a})]});b.forEach(function(a){a=a.dbParticipantToPut;d("MAWIndexedDb").afterTransaction({tag:"ParticipantUpdated",value:d("MAWBridgeParticipants").createBridgeParticipant(a)})});b=c.filter(function(a){a[0];a=a[1];return j(a)}).map(function(a){a=a[0];return a});return d("MAWDbThreadTxns").subscribeToThreads(a,b)}function m(a,b,c){b=Array.from(b);b.forEach(function(a){a=a.groupJid;return d("MAWIndexedDb").afterTransaction({tag:"UpdateE2EEMetadataParticipants",value:d("MAWBridgeTypesCreators").createBridgeUpdateE2EEMetadataParticipants(a)})});var e=new Set(b.filter(function(a){return a.userJid===d("WAGlobals").getMyUserJid()&&(c===d("WAGlobals").getMyUserJid()||c==="@me")}).map(function(a){return a.groupJid}));b=new Set(b.filter(function(a){a=a.userJid;return a!==c&&(a===d("WAGlobals").getMyUserJid()||a==="@me")}).filter(function(a){a=a.groupJid;return!e.has(a)}).map(function(a){a=a.groupJid;return a}));return d("MAWDexieTable").dexieAll([d("MAWDbThreadTxns").archiveThreads(a,Array.from(e),!0),d("MAWDbThreadTxns").unsubscribeFromThreads(a,Array.from(b))])}g.MAWParticipantsStore=a}),98);
__d("MAWRunInTransaction",["MAWDexie","MAWGroupInfoStore","MAWIndexedDb","MAWMessageStore","MAWParticipantsStore","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";var h={GroupInfoStore:d("MAWGroupInfoStore").MAWGroupInfoStore.tableLocks,MessagesStore:d("MAWMessageStore").MAWMessageStore_DEPRECATED_DO_NOT_USE.tableLocks,ParticipantsStore:d("MAWParticipantsStore").MAWParticipantsStore.tableLocks};a=function(a,b,e){var f=[];for(var g in a)a[g]===!0&&f.push(g);g=f.flatMap(function(a){return Object.entries(h[a])}).reduce(function(a,b){var c=b[0];b=b[1];if(a[c]===d("MAWTransactionMode").READWRITE)return a;c=c;return babelHelpers["extends"]({},a,(a={},a[""+c]=b,a))},{});g=d("MAWIndexedDb").makeMsgrTransactor(g,(f=e)!=null?f:"runInTransaction",function(e){return function(){var f={CollectionVersionStore:null,GroupInfoStore:a.GroupInfoStore===!0?new(d("MAWGroupInfoStore").MAWGroupInfoStore)(e):null,MessagesStore:a.MessagesStore===!0?new(d("MAWMessageStore").MAWMessageStore_DEPRECATED_DO_NOT_USE)(e):null,MissingKeyStore:null,ParticipantsStore:a.ParticipantsStore===!0?new(d("MAWParticipantsStore").MAWParticipantsStore)(e):null,PendingMutationStore:null,SyncActionStore:null,SyncKeyStore:null};return new(c("MAWDexie").Promise)(function(a){a(b(f))})}});return g()};g.runInTransaction=a}),98);
__d("MAWAddGroupParticipantsApi",["MAWAdminMsgHelpers","MAWRunInTransaction","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";a=function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return d("MAWRunInTransaction").runInTransaction({GroupInfoStore:!0,MessagesStore:!0,ParticipantsStore:!0},function(a){return h.apply(void 0,[a].concat(b))},"addGroupParticipants")};var h=async function(a,b,c,e,f,g,h,i){h=a.GroupInfoStore;var j=a.MessagesStore;a=a.ParticipantsStore;var k=await h.get(c);if(!k.success)return d("WAResultOrError").makeError("missing_group");k=f.map(function(a){return{addressable:a.addressable,chatJid:c,type:a.type,user:a.user}});await a.bulkPut(k);if(b!=null){f=d("MAWAdminMsgHelpers").createParticipantAddAdminMessage(c,k.map(function(a){return a.user}),e,i);await j.create(f);await h.update(c,function(a){return babelHelpers.extends({},a,{participantVersion:b.current})},{updateParticipantMedatadata:g})}return d("WAResultOrError").makeResult()};g.addGroupParticipants=a;g.addGroupParticipantsTransactor=h}),98);
__d("MAWAdminAddParticipantMsg",["MAWLocalizationType","MAWUserJidWrapper","WAJids"],(function(a,b,c,d,e,f,g){"use strict";var h=1;function i(a,b,c){switch(a){case 1:return{adminMsgContent:[b],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU};case 2:return{adminMsgContent:[b,c],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU_AND_ONE_USER};default:return{adminMsgContent:[b,(a-1).toString()],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU_AND_MORE_THAN_ONE_USERS}}}function j(a,b,c){switch(a){case 1:return{adminMsgContent:[b],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_ONE_PARTICIPANT};case 2:return{adminMsgContent:[b,c],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_TWO_PARTICIPANTS};default:return{adminMsgContent:[b,(a-1).toString()],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_MORE_THAN_TWO_PARTICIPANTS}}}function k(a,b,c,e){switch(a){case 1:return{adminMsgContent:[b,c],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_ONE_USER};case 2:return{adminMsgContent:[b,c,e],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_TWO_USER}}return{adminMsgContent:[b,c,(a-1).toString()],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_MORE_THAN_TWO_USER}}function l(a,b){switch(a){case 1:return{adminMsgContent:[],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_YOU};case 2:return{adminMsgContent:[b],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_YOU_AND_ONE_USER}}return{adminMsgContent:[(a-1).toString()],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_YOU_AND_MORE_THAN_ONE_USER}}function m(a,b,c){switch(a){case 1:return{adminMsgContent:[b],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_ONE_USER};case 2:return{adminMsgContent:[b,c],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_TWO_USER}}return{adminMsgContent:[b,(a-1).toString()],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_MORE_THAN_TWO_USER}}function n(a,b){var c=d("MAWUserJidWrapper").getMyUserJid(),e=b[0],f=b[1],g=d("WAJids").userIdFromJid(e);f=f!=null?d("WAJids").userIdFromJid(f):"";if(a==null)return b.includes(c)?l(b.length,e===c?f:g):m(b.length,g,f);if(a===c)return j(b.length,g,f);a=d("WAJids").userIdFromJid(a);return b.includes(c)?i(b.length,a,e===c?f:g):k(b.length,a,g,f)}function a(a,b){return babelHelpers["extends"]({},n(a,b),{version:h})}g.createAddParticipantsAdminMessage=a}),98);
__d("MAWAdminRemoveParticipantMsg",["MAWAdminMsgType","MAWUserJidWrapper","WAJids"],(function(a,b,c,d,e,f,g){"use strict";var h=1;function i(a,b,c){switch(a){case 1:return{adminMsgContent:[b],adminType:d("MAWAdminMsgType").ADMIN_MSG_TYPE.PARTICIPANT_REMOVED_YOU};case 2:return{adminMsgContent:[b,c],adminType:d("MAWAdminMsgType").ADMIN_MSG_TYPE.PARTICIPANT_REMOVED_YOU_AND_ONE_USER};default:return{adminMsgContent:[b,(a-1).toString()],adminType:d("MAWAdminMsgType").ADMIN_MSG_TYPE.PARTICIPANT_REMOVED_YOU_AND_MORE_THAN_ONE_USERS}}}function j(a,b,c,e){switch(a){case 1:return e?{adminMsgContent:[],adminType:d("MAWAdminMsgType").ADMIN_MSG_TYPE.CURRENT_USER_LEFT_GROUP}:{adminMsgContent:[b],adminType:d("MAWAdminMsgType").ADMIN_MSG_TYPE.CURRENT_USER_REMOVED_ONE_PARTICIPANT};case 2:return{adminMsgContent:[b,c],adminType:d("MAWAdminMsgType").ADMIN_MSG_TYPE.CURRENT_USER_REMOVED_TWO_PARTICIPANTS};default:return{adminMsgContent:[b,(a-1).toString()],adminType:d("MAWAdminMsgType").ADMIN_MSG_TYPE.CURRENT_USER_REMOVED_MORE_THAN_TWO_PARTICIPANTS}}}function k(a,b,c,e,f){switch(a){case 1:return f?{adminMsgContent:[b],adminType:d("MAWAdminMsgType").ADMIN_MSG_TYPE.PARTICIPANT_LEFT_GROUP}:{adminMsgContent:[b,c],adminType:d("MAWAdminMsgType").ADMIN_MSG_TYPE.PARTICIPANT_REMOVED_ONE_USER};case 2:return{adminMsgContent:[b,c,e],adminType:d("MAWAdminMsgType").ADMIN_MSG_TYPE.PARTICIPANT_REMOVED_TWO_USER}}return{adminMsgContent:[b,c,(a-1).toString()],adminType:d("MAWAdminMsgType").ADMIN_MSG_TYPE.PARTICIPANT_REMOVED_MORE_THAN_TWO_USER}}function l(a,b){var c=d("MAWUserJidWrapper").getMyUserJid(),e=b[0],f=b[1],g=d("WAJids").userIdFromJid(e);f=f!=null?d("WAJids").userIdFromJid(f):"";if(a==null)return b.includes(c)?{adminMsgContent:[],adminType:d("MAWAdminMsgType").ADMIN_MSG_TYPE.UNKNOWN_USER_REMOVED_YOU}:{adminMsgContent:[g],adminType:d("MAWAdminMsgType").ADMIN_MSG_TYPE.UNKNOWN_USER_REMOVED_ONE_USER};if(a===c)return j(b.length,g,f,e===c);var h=d("WAJids").userIdFromJid(a);return b.includes(c)?i(b.length,h,e===c?f:g):k(b.length,h,g,f,e===a)}function a(a,b){return babelHelpers["extends"]({},l(a,b),{version:h})}g.createRemoveParticipantsAdminMessage=a}),98);
__d("MAWAdminWriteChangeParticipantsAdminMsgTxn",["FBLogger","MAWAdminAddParticipantMsg","MAWAdminRemoveParticipantMsg","MAWDbThreadTxns","MAWLocalizationUtils","MAWUserJidWrapper","MAWWriteMsgTxns","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return h(a,b,d("MAWAdminAddParticipantMsg").createAddParticipantsAdminMessage)}function b(a,b){return h(a,b,d("MAWAdminRemoveParticipantMsg").createRemoveParticipantsAdminMessage)}function h(a,b,e){var f=b.admin,g=b.chatJid,h=b.participants,i=b.serverTs;if(h.length===0)throw c("FBLogger")("messenger_web").mustfixThrow("invalid number of participants when writing participants change admin msg");return d("MAWDbThreadTxns").getThread(a,g).then(function(g){if(!g.success)throw c("FBLogger")("messenger_web").mustfixThrow("no thread when writing participants change admin msg");g=g.value;var j=d("MAWUserJidWrapper").getMyUserJid();j=f==="@me"?j:f;if(j==null)return;j=d("MAWLocalizationUtils").buildUnstoredDbAdminMsg(e(j,h),g.jid,b.externalId,i);return d("MAWWriteMsgTxns").writeMsg(a,j,g,"MAWAdminWriteChangeParticipantsAdminMsgTxn").then(c("emptyFunction"))})}g.writeAddParticipantAdminMsg=a;g.writeRemoveParticipantAdminMsg=b}),98);
__d("MAWAdminWriteGroupNameChangeTxn",["MAWAdminMsgType","MAWDexieTable","MAWExternalId","MAWLocalizationUtils","MAWUserJidWrapper","MAWWriteMsgTxns","WAJids","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e){var f=b.name;if(f==null)return d("MAWDexieTable").dexieResolve();var g=d("MAWUserJidWrapper").getMyUserJid(),h=[];b.nameOwner===g?(g=d("MAWAdminMsgType").ADMIN_MSG_TYPE.CURRENT_USER_NAMED_GROUP,h.push(f)):b.nameOwner==null?(g=d("MAWAdminMsgType").ADMIN_MSG_TYPE.UNKNOWN_USER_NAMED_GROUP,h.push(f)):(g=d("MAWAdminMsgType").ADMIN_MSG_TYPE.PARTICIPANT_NAMED_GROUP,h.push(d("WAJids").userIdFromJid(b.nameOwner),f));b=d("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:h,adminType:g,version:1},e.jid,d("MAWExternalId").generateExternalId(),d("WATimeUtils").castMillisTimeToUnixTime(d("WATimeUtils").millisTime()));return d("MAWWriteMsgTxns").writeMsg(a,b,e,"MAWAdminWriteGroupNameChangeTxn").then(c("emptyFunction"))}g.writeGroupNameChangeInfo=a}),98);
__d("MAWAdminWriteUserDeviceMsgTxn",["MAWAckLevel","MAWAdminMsgHelpers","MAWDbMsgTxns","MAWDexieTable","MAWExternalId","MAWLocalizationType","MAWLocalizationUtils","MAWMsgType","MAWUserJidWrapper","MAWWriteMsgTxns","WAJids","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";e={add:"add",remove:"remove",update:"update"};function h(a,b){switch(a){case"add":if(b)return d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_DEVICE;else return d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_DEVICE;case"remove":if(b)return d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_DEVICE;else return d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_DEVICE;case"update":if(b)return d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_UPDATED_DEVICE;else return d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_UPDATED_DEVICE}}function a(a,b,e,f,g){return d("MAWDbMsgTxns").getIsThreadEmpty(a,e.jid).then(function(i){if(i)return d("MAWDexieTable").dexieResolve();i=b===d("MAWUserJidWrapper").getMyUserJid();var j=h(f,i);i=i?[]:[d("WAJids").userIdFromJid(b)];i=d("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:i,adminType:j,version:1},e.jid,d("MAWExternalId").generateExternalId(),g);return d("MAWWriteMsgTxns").writeMsg(a,i,e,"MAWAdminWriteUsersConnectedMsgTxn::writeUserDeviceAdminMsg").then(c("emptyFunction"))})}function b(a,b,e,f){var g=d("MAWAdminMsgHelpers").UNKNOWN_USER,h=b===d("MAWUserJidWrapper").getMyUserJid();b={ack:d("MAWAckLevel").ACK.received,altIndex:void 0,author:h?d("WAJids").AUTHOR_ME:b,externalId:d("MAWExternalId").generateExternalId(),msgContent:{adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.ICDC_ALERT_ADMIN_MESSAGE,authorName:g},threadJid:e.jid,ts:(h=f)!=null?h:d("WATimeUtils").unixTime(),type:d("MAWMsgType").MSG_TYPE.ICDC_ALERT};return d("MAWWriteMsgTxns").writeMsg(a,b,e,"MAWAdminWriteUsersConnectedMsgTxn::writeICDCAlert").then(c("emptyFunction"))}g.DeviceChange=e;g.getUserDeviceAdminType=h;g.writeUserDeviceAdminMsg=a;g.writeICDCAlert=b}),98);
__d("MAWAdminWriteUsersConnectedMsgTxn",["MAWDbMsgTxns","MAWDbThreadTxns","MAWDexieTable","MAWExternalId","MAWIndexedDb","MAWLocalizationType","MAWLocalizationUtils","MAWMsgType","MAWUserJidWrapper","MAWWriteMsgTxns","MessengerMSplitFlag","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["writeUsersConnectedAdminMsg found a thread without messages from both users, which we'll not append to."]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["writeUsersConnectedAdminMsg failed to create or get 1:1 thread"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["writeUsersConnectedAdminMsg is called for self thread"]);j=function(){return a};return a}function a(a,b,e,f){var g=d("MAWUserJidWrapper").getMyUserJid();if(b===g){d("WALogger").WARN(j());return d("MAWDexieTable").dexieResolve()}return d("MAWDbThreadTxns").getThread(a,b).then(function(b){if(!b.success){d("WALogger").WARN(i());return}var j=b.value;b=d("MAWDbMsgTxns").doesThreadHaveMsgsMatchCriteria(a,j.jid,function(a){return a.type===d("MAWMsgType").MSG_TYPE.ADMIN?!1:a.author===g||a.author===d("WAJids").AUTHOR_ME});var k=d("MAWDbMsgTxns").doesThreadHaveMsgsMatchCriteria(a,j.jid,function(a){return a.type===d("MAWMsgType").MSG_TYPE.ADMIN?!1:a.author!==g&&a.author!==d("WAJids").AUTHOR_ME});return d("MAWDexieTable").dexieAll([b,k]).then(function(b){var g=b[0];b=b[1];if(!g||!b){d("WALogger").WARN(h());return}g=d("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:[],adminType:c("MessengerMSplitFlag").is_msplit_account||e?d("MAWLocalizationType").LOCALIZATION_TYPE.TWO_USERS_CONNECTED_ONE_MSPLIT:d("MAWLocalizationType").LOCALIZATION_TYPE.TWO_USERS_CONNECTED,version:1},j.jid,d("MAWExternalId").generateExternalId(),f);return d("MAWWriteMsgTxns").writeDedupedUsersConnectedAdminMessage(a,g,j).then(function(){var a=d("WAJids").interpretAsUserJid(j.jid);if(a==null)return;d("MAWIndexedDb").afterTransaction({tag:"UpdateContactAsConnected",value:{contactUserId:d("WAJids").extractUserId(a),threadJid:j.jid}})})})})}g.writeUsersConnectedAdminMsg=a}),98);
__d("MAWBuildNewMsgPayload",["FBLogger","MAWAdminMsgType","MAWAuthor","MAWDbMsg","MAWJids","MAWMsgType","WAArmadilloXMA.pb","WAAssertUnreachable","WAJids","WALogger","WAMsgType","WAStanzaUtils","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["msgToQuotedMsg: Unsupported message type ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["BumpExistingMessage does not have quote content when replying"]);i=function(){return a};return a}function a(a,b,e,f){if(d("MAWDbMsg").isUnrenderedMsgType(a))throw c("FBLogger")("messenger_web").mustfixThrow("getNewMsg called for wrong message type "+a);var g,h;if(e.quote!=null&&(f==null?void 0:f.content)!=null){var i;h=f==null?void 0:(i=f.content)==null?void 0:i.externalId;g={content:f==null?void 0:f.content,remoteJid:(i=f==null?void 0:f.remoteJid)!=null?i:void 0}}if(e.noteContent!=null){f=d("MAWJids").toUserJid(b.threadJid);g={content:{author:f,expirationTs:d("WATimeUtils").castToUnixTime(e.noteExpirationTs),externalId:b.externalId,msgContent:{content:e.noteContent},ts:b.ts,type:d("WAMsgType").NOTE_REPLY},remoteJid:void 0}}i=babelHelpers["extends"]({},b,{quote:g,quoteExternalId:h});f=e.mediaGroupMetadata;switch(a){case"Text":return babelHelpers["extends"]({},i,{msgContent:{commands:e.commands,content:e.content!=null?e.content:"",mentionedJids:e.mentionedJids},type:d("MAWMsgType").MSG_TYPE.TEXT});case"Image":return babelHelpers["extends"]({},i,{hdType:e.hdType,type:d("MAWMsgType").MSG_TYPE.IMAGE},f);case"Video":return babelHelpers["extends"]({},i,{type:d("MAWMsgType").MSG_TYPE.VIDEO});case"Ptt":return babelHelpers["extends"]({},i,{type:d("MAWMsgType").MSG_TYPE.PTT});case"Gif":return babelHelpers["extends"]({},i,{type:d("MAWMsgType").MSG_TYPE.GIF});case"Sticker":return babelHelpers["extends"]({},i,{type:d("MAWMsgType").MSG_TYPE.STICKER});case"DocumentFile":return babelHelpers["extends"]({},i,{type:d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE});case"XMA":if(e.xmaMessageType==null)throw c("FBLogger")("messenger_web").mustfixThrow("XMA Message Missing xmaMessageType");f=e.content!=null&&e.xmaMessageType===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE?e.content:"";return babelHelpers["extends"]({},i,{msgContent:{commands:e.commands,content:f,mentionedJids:e.mentionedJids},type:d("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:e.xmaMessageType});case"EditAction":throw c("FBLogger")("messenger_web").mustfixThrow("EditAction is not supported yet");case"BumpExistingMessage":return babelHelpers["extends"]({},i,{type:d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE});case"ReceiverFetch":throw c("FBLogger")("messenger_web").mustfixThrow("ReceiverFetch is not supported yet");case"GroupPollCreate":return babelHelpers["extends"]({},b,{msgContent:{adminMsgContent:[(f=e.title)!=null?f:""],adminType:d("MAWAdminMsgType").CURRENT_USER_CREATED_POLL,version:1},type:d("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE});case"GroupPollUpdate":throw c("FBLogger")("messenger_web").mustfixThrow("GroupPollUpdate is not supported yet");case"Revoked":case"DeleteForMe":case"Ciphertext":case"Futureproof":case"Unavailable":case"Admin":case"ExpiredEphemeral":case"EphemeralSettingAdmin":case"EphemeralScreenshotAction":case"AlertICDC":case"GroupInvite":case"Reaction":case"Raven":case"RavenAction":throw c("FBLogger")("messenger_web").mustfixThrow("Should not be writing ciphertext, futureproof, unsent, admin,\n        ephemeral setting messages, ephemeral screenshot action, group invite messages");default:throw c("WAAssertUnreachable")(a)}}function b(a,b,e,f){if(!d("MAWDbMsg").isUnrenderedMsgType(a))throw c("FBLogger")("messenger_web").mustfixThrow("getNewUnrenderedMsg called for wrong message type "+a);switch(a){case"EphemeralSyncResponse":if(e.ephemeralSetting==null)throw c("FBLogger")("messenger_web").mustfixThrow("Ephemeral Sync Response without ephemeral settings");return babelHelpers["extends"]({},b,{ephemeralSetting:e.ephemeralSetting,type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE});case"EphemeralSettingChangeFromCurrentDevice":var g;if(e.ephemeralSetting==null)throw c("FBLogger")("messenger_web").mustfixThrow("Ephemeral Setting Change without ephemeral settings");return babelHelpers["extends"]({},b,{ephemeralSetting:e.ephemeralSetting,isEphemeralSettingReset:(g=e.isEphemeralSettingReset)!=null?g:!1,type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE});case"GroupInvite":g=d("WAJids").interpretAsGroupJid(b.threadJid);if(g==null)throw c("FBLogger")("messenger_web").mustfixThrow("Group Invite without valid group jid");if(e.invitedParticipantUserJid==null)throw c("FBLogger")("messenger_web").mustfixThrow("Group Invite without invited user jid");return babelHelpers["extends"]({},b,{groupName:e.groupName==null?void 0:e.groupName,invitedParticipantUserJid:e.invitedParticipantUserJid,type:d("MAWMsgType").MSG_TYPE.GROUP_INVITE});case"SenderKeyDistribution":return babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.SK_DISTRIBUTION});case"RavenAction":if(f==null)throw c("FBLogger")("messenger_web").mustfixThrow("Raven Action without Raven Message External Id");if(e.actionType==null)throw c("FBLogger")("messenger_web").mustfixThrow("Raven Action without Action Type");return babelHelpers["extends"]({},b,{actionType:e.actionType,ravenActionToMsgExternalId:d("WAStanzaUtils").toStanzaId(f),type:d("MAWMsgType").MSG_TYPE.RAVEN_ACTION});case"EditAction":throw c("FBLogger")("messenger_web").mustfixThrow("Edit action not implemented yet");default:throw c("WAAssertUnreachable")(a)}}function e(a){var b,e={author:d("MAWAuthor").getAuthorUserJid(a.author)||d("WAJids").AUTHOR_ME,externalId:a.externalId,mediaId:a.mediaId,msgId:a.msgId,plaintextHash:a.plaintextHash,specialTextSize:a.specialTextSize,ts:a.ts,xmaMessageType:a.xmaMessageType};switch(a.type){case d("MAWMsgType").MSG_TYPE.IMAGE:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.IMAGE});case d("MAWMsgType").MSG_TYPE.VIDEO:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.VIDEO});case d("MAWMsgType").MSG_TYPE.PTT:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.PTT});case d("MAWMsgType").MSG_TYPE.TEXT:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.TEXT});case d("MAWMsgType").MSG_TYPE.STICKER:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.STICKER});case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE});case d("MAWMsgType").MSG_TYPE.GIF:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.GIF});case d("MAWMsgType").MSG_TYPE.XMA:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:a.xmaMessageType});case d("MAWMsgType").MSG_TYPE.REVOKED:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.UNAVAILABLE});case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:if(((b=a.quote)==null?void 0:b.content)==null){d("WALogger").ERROR(i());return null}return babelHelpers["extends"]({},a.quote.content,{author:d("MAWAuthor").getAuthorUserJid(a.quote.content.author)||d("WAJids").AUTHOR_ME});case d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH});case d("MAWMsgType").MSG_TYPE.RAVEN:return babelHelpers["extends"]({},e,{ravenEphemeralMediaState:a.ravenEphemeralMediaState,ravenEphemeralType:a.ravenEphemeralType,ravenMediaType:a.ravenMediaType,type:d("MAWMsgType").MSG_TYPE.RAVEN});default:d("WALogger").ERROR(h(),a.type);throw c("FBLogger")("messenger_web").mustfixThrow("Trying to reply to a message type that does not support replies")}}g.buildNewMsg=a;g.getNewUnrenderedMsg=b;g.msgToQuotedMsg=e}),98);
__d("MAWBulkGetAppDataForRetryApi",["MAWIndexedDb","MAWTransactionMode","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h=30*d("WATimeUtils").DAY_SECONDS;a=d("MAWIndexedDb").makeMsgrTransactor({appData:d("MAWTransactionMode").READONLY},"bulkGetAppDataForRetry",function(a){return function(b){var c=b.map(function(a){a=a.externalId;return a});return a.appData.where("externalId").anyOf(c).toArray().then(function(a){var c=new Map(a.map(function(a){return[a.externalId,a]}));return b.map(function(a){var b=a.deviceJid;a=a.externalId;a=c.get(a);if(a==null)return{type:"missing"};b=a.permittedIdentitiesPerDevice.get(b);return b==null||!d("WATimeUtils").happenedWithin(a.ts,h)?{type:"unauthorized"}:{appData:a.contents,deviceIdentity:b,permittedIdentitiesPerDevice:a.permittedIdentitiesPerDevice,type:"unacked"}})})}});g.bulkGetAppDataForRetry=a}),98);
__d("MAWHIMLogger",["MWFBLogger"],(function(a,b,c,d,e,f,g){"use strict";a=d("MWFBLogger").MWLogger.tags(["HandleIncomingMessage"]);g["default"]=a}),98);
__d("MAWEphemeralAdminMsgBuildTxns",["FBLogger","MAWAckLevel","MAWBridgeMsg","MAWBridgeTypesCreators","MAWDbMsgTxns","MAWDexieTable","MAWEphemeralUtils","MAWIndexedDb","MAWMsgType","MAWODSProxy","MAWUserJidWrapper","MAWWriteMsgTxns","WAJids","WAOdsEnums","WATimeUtils","qex"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e,f,g,h,i,j){if(e<0)throw c("FBLogger")("messenger_web").mustfixThrow("Received unexpected ephemeral time setting");e=d("MAWEphemeralUtils").getEphemeralSettingChangeData(b,e,h,i);var k={ack:d("MAWAckLevel").ACK.sent,altIndex:void 0,author:(h=b)!=null?h:d("WAJids").AUTHOR_SYSTEM,msgContent:e,type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN};i=b!=null?d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,j,g.jid,b):d("MAWDexieTable").dexieResolve();return i.then(function(b){if(b==null){var e=babelHelpers["extends"]({},k,{externalId:j,sortOrderMs:d("WATimeUtils").castUnixTimeToMillisTime(f),threadJid:g.jid,ts:f});return d("MAWWriteMsgTxns").writeDedupedEphemeralSettingAdminMessage(a,e,g,d("WATimeUtils").castUnixTimeToMillisTime(f)).then(function(a){return babelHelpers["extends"]({},e,{msgId:a.msgId,protocolMsgId:a.protocolMsgId,rowId:a.rowId})})}else if(b.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT){d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_LS_SYNC_IMPROVEMENTS,key:"ephemeral_setting_admin_msg_ciphertext_replacement"});var h=babelHelpers["extends"]({},b,k);return a.messages.put(h).then(function(){c("qex")._("4486")?d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(h)}):(d("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:d("MAWBridgeTypesCreators").createBridgeDeleteMessages(b.threadJid,[b])}),d("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:d("MAWBridgeMsg").createBridgeMsg(h)}));return h})}else return null})}function b(a,b,e,f,g,h,i){var j=b===d("MAWUserJidWrapper").getMyUserJid(),k=d("MAWEphemeralUtils").getEphemeralScreenshotActionData(g,b,j),l=k.ephemeralScreenshotActionContent;k=k.ephemeralScreenshotActionType;if(i==null){var m={ack:d("MAWAckLevel").ACK.received,altIndex:void 0,author:j?d("WAJids").AUTHOR_ME:b,externalId:h,msgContent:{adminMsgContent:l,adminType:k,screenshotActionType:g,version:1},sortOrderMs:d("WATimeUtils").castUnixTimeToMillisTime(f),threadJid:e.jid,ts:f,type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION};return d("MAWWriteMsgTxns").writeDedupedEphemeralSettingAdminMessage(a,m,e,d("WATimeUtils").castUnixTimeToMillisTime(f)).then(function(a){return babelHelpers["extends"]({},m,{msgId:a.msgId,protocolMsgId:a.protocolMsgId,rowId:a.rowId})})}else if(i.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT){d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_LS_SYNC_IMPROVEMENTS,key:"ephemeral_screenshot_action_msg_ciphertext_replacement"});var n=babelHelpers["extends"]({},i,{ack:d("MAWAckLevel").ACK.received,altIndex:void 0,author:j?d("WAJids").AUTHOR_ME:b,msgContent:{adminMsgContent:l,adminType:k,screenshotActionType:g,version:1},type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION});return a.messages.put(n).then(function(){c("qex")._("4486")?d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(n)}):(d("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:d("MAWBridgeTypesCreators").createBridgeDeleteMessages(i.threadJid,[i])}),d("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:d("MAWBridgeMsg").createBridgeMsg(n)}));return n})}else return d("MAWDexieTable").dexieResolve(null)}g.writeEphemeralSettingAdminMsg=a;g.writeEphemeralScreenshotActionMsg=b}),98);
__d("MAWMsgActionType",[],(function(a,b,c,d,e,f){"use strict";a={DELETE_FOR_ME:"DELETE_FOR_ME",NO_ACTION:"NO_ACTION",REVOKE:"REVOKE",UPDATE_CIPHERTEXT:"UPDATE_CIPHERTEXT",UPDATE_CIPHERTEXT_WITH_ASSOCIATED:"UPDATE_CIPHERTEXT_WITH_ASSOCIATED",WRITE:"WRITE",WRITE_WITH_ASSOCIATED:"WRITE_WITH_ASSOCIATED"};f.MSG_ACTION=a}),66);
__d("MAWDbReceiptTxns",["MAWDexieTable","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unexpectedly fetched null data from a msgIdToReceiptData map"]);h=function(){return a};return a}function a(a,b,c){return i([{deliveryReceipts:b==="delivered"?c:[],msgId:a,readReceipts:b==="read"?c:[],senderReceipts:b==="sender"?c:[]}]).then(function(a){return a[0]||{type:"missing"}})}function i(a){var b=a.map(function(a){return a.msgId}),c=new Map();a.forEach(function(a){c.set(a.msgId,a)});a=b.map(function(a){var b=c.get(a);if(b==null){d("WALogger").ERROR(h());return null}var e=new Set(),f=new Map(),g=b.deliveryReceipts,i=b.readReceipts;b=b.senderReceipts;[{receiptType:"delivered",receivers:g},{receiptType:"read",receivers:i},{receiptType:"sender",receivers:b}].forEach(function(a){var b=a.receiptType;a=a.receivers;a.forEach(function(a){var c=a.device;a=a.ts;c=d("WAJids").extractUserJid(c);var g=!1;if(b!=="sender"){var h=f.get(c);a=j(h,b,a);f.set(c,a);g=k(h,a)}g&&e.add(c)})});return{affectedUserJids:e,receipt:{msgId:a,statusTsPerUser:f}}}).filter(Boolean);return d("MAWDexieTable").dexieResolve(a.map(function(a){return{affectedUserJids:a.affectedUserJids,receipt:a.receipt}}))}function j(a,b,c){var d;d=(d=a==null?void 0:a.deliveredTs)!=null?d:c;a=a==null?void 0:a.readTs;b==="read"&&a==null&&(a=c);return{deliveredTs:d,readTs:a}}function k(a,b){return((b==null?void 0:b.deliveredTs)||0)>((a==null?void 0:a.deliveredTs)||0)||((b==null?void 0:b.readTs)||0)>((a==null?void 0:a.readTs)||0)}function b(a,b){return a.receipts.bulkDelete(b)}g.writeReceiptsForDevices=a;g.bulkWriteReceiptsForDevices=i;g.bulkDeleteAllReceiptsForMessages=b}),98);
__d("MAWMessageRequestUtils",["MAWFolderTypes","WADbContact"],(function(a,b,c,d,e,f,g){"use strict";function a(a){a=a===d("MAWFolderTypes").FOLDER_ID.PENDING||a===d("MAWFolderTypes").FOLDER_ID.OTHER;return a}function b(a,b){return(a===null||a===d("MAWFolderTypes").FOLDER_ID.INBOX)&&(b===d("WADbContact").REVERSED_ONE_WAY_CONTACT||b===d("WADbContact").NON_CONTACT)}g.isMessageRequestOrSpamThread=a;g.isInboxRequest=b}),98);
__d("MAWMarkThreadAsReadTxns",["FBLogger","MAWBridgeThread","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWMessageRequestUtils","MAWTimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,d,e,f){f===void 0&&(f=!1);var g=new Map();g.set(b,{msgId:d,sortOrderMs:e});return h(a,g,f).then(function(a){a=a.get(b);if(a==null)throw c("FBLogger")("messenger_web_devx","maw_mark_thread_as_read").warn("ThreadReadReceiptInfo unexpectedly unavailable for thread\n         in markThreadAsReadUpToMsgSortOrderMs()");return a})}function h(a,b,c){c===void 0&&(c=!1);return j(a,b).then(function(e){var f=e.threadJidToReadReceiptInfo,g=e.updatedThreads;return a.threads.bulkPut(g).then(function(){g.forEach(function(a){var e;e=(e=b.get(a.jid))==null?void 0:e.sortOrderMs;e!=null&&!c&&d("MAWIndexedDb").afterTransaction({tag:"ThreadTimestampsUpdated",value:d("MAWBridgeThread").createBridgeThreadTimestampsUpdated(a.jid,e,e,!1)});f.set(a.jid,{isReadReceiptExpectedToBeSent:(a=(e=f.get(a.jid))==null?void 0:e.isReadReceiptExpectedToBeSent)!=null?a:!1,type:"success"})});return f})})}function i(a,b,c){return d("MAWDbMsgTxns").getThreadOldestMessageId(a,b.jid).then(function(a){if(a==null)return null;a=d("MAWTimeUtils").ensureValidMillisTime(b.newestMsgTs);return babelHelpers["extends"]({},b,{lastReadMsg:c.msgId,newestMsgTs:a})})}function j(a,b){var e=new Map(),f=Array.from(b.keys()),g=[];return a.threads.where("jid").anyOf(f).toArray().then(function(h){var j=new Map();h.forEach(function(a){return j.set(a.jid,a)});f.forEach(function(a){j.has(a)||j.set(a,null)});h=Array.from(j).map(function(d){var f=d[0];d=d[1];if(d==null){e.set(f,{isReadReceiptExpectedToBeSent:!1,type:"missing"});return}f=k(d.folder);e.set(d.jid,{isReadReceiptExpectedToBeSent:f,type:"success"});f=b.get(d.jid);if(f==null)throw c("FBLogger")("maw_threads","maw_mark_thread_as_read").warn("ThreadReadReceiptInfo unexpectedly unavailable for thread\n            in getThreadJidToReadReceiptInfo()");return i(a,d,f).then(function(a){a!=null&&g.push(a)})});return d("MAWDexieTable").dexieAll(h).then(function(){return{threadJidToReadReceiptInfo:e,updatedThreads:g}})})}function k(a){return!d("MAWMessageRequestUtils").isMessageRequestOrSpamThread(a)}g.markThreadAsReadUpToMsgSortOrderMs=a;g.bulkMarkThreadAsReadUpToMsgSortOrderMs=h;g.isReadReceiptExpectedToBeSentFor=k}),98);
__d("MAWPendingReceiptProcessingTxns",["MAWDbMsg","MAWDbParticipantTxns","MAWDbReceiptTxns","MAWDexieTable","MAWMarkThreadAsReadTxns","WAJids","WALogger","WAMsg","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Processing pending receipts for "," from ",""]);h=function(){return a};return a}function a(a,b,c){var e=d("WAMsg").craftWAMsgIdString({author:c.author,chat:b,externalId:c.externalId});return a.pendingReceipts.get(e).then(function(b){if(b==null)return;d("WALogger").LOG(h(),c.externalId,c.author);if(b.author===d("WAJids").AUTHOR_ME){var f=d("MAWDexieTable").dexieResolve();b.deliveryReceipts.length>0&&(f=f.then(function(){return d("MAWDbReceiptTxns").writeReceiptsForDevices(c.msgId,"delivered",b.deliveryReceipts)}));b.readReceipts.length>0&&(f=f.then(function(){return d("MAWDbReceiptTxns").writeReceiptsForDevices(c.msgId,"read",b.readReceipts)}));return f.then(function(b){var f=[];b!=null&&b.type!=="missing"&&b.receipt.statusTsPerUser.forEach(function(b,e){var g=b.deliveredTs!=null?c.ts:d("WATimeUtils").castToUnixTime(0),h=b.readTs!=null?c.ts:d("WATimeUtils").castToUnixTime(0);b=(b=b.readTs)!=null?b:d("WATimeUtils").castToUnixTime(0);f.push(d("MAWDbParticipantTxns").updateParticipantTimestamps(a,[c.threadJid,e],g,h,b))});return d("MAWDexieTable").dexieAll(f).then(function(){a.pendingReceipts["delete"](e)})})}else return d("MAWDexieTable").dexieAll([d("MAWMarkThreadAsReadTxns").markThreadAsReadUpToMsgSortOrderMs(a,c.threadJid,c.msgId,d("WATimeUtils").castToMillisTime(d("MAWDbMsg").getSortOrderWithFallback(c)))]).then(function(){return a.pendingReceipts["delete"](e)})})}g.processPendingReceipts=a}),98);
__d("MAWUpdateIsCollapsedMsgTxns",["MAWBridgeMsg","MAWDexieTable","MAWIndexedDb","MWXMAV2IsDataclassLiveLocationXMA","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h=1e3;function a(a,b,c,e){var f=b.collapsibleId;return f==null?d("MAWDexieTable").dexieResolve(b):a.messages.where(["threadJid","collapsibleId","sortOrderMs"]).between([e,f,Number.MIN_SAFE_INTEGER],[e,f,Number.MAX_SAFE_INTEGER],!1,!1).reverse().first().then(function(e){if(e!=null)if(b.serverTs!=null&&b.serverTs>e.serverTs){var f=babelHelpers["extends"]({},e,{isCollapsed:!0});return a.messages.put(f).then(function(){return d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(f)})}).then(function(){return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},b,{isCollapsed:!1}))})}else return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},b,{isCollapsed:!0}));else return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},b,{isCollapsed:i(c,b.serverTs)}))})}var i=function(a,b){var e=c("justknobx")._("4207");e=Math.floor(Date.now()/h)-e;var f=a!=null?JSON.parse(a):null;return b!=null&&b<e&&d("MWXMAV2IsDataclassLiveLocationXMA").isDataclassLiveLocationXMA(a)&&(f==null?void 0:(b=f.content.custom_template_data)==null?void 0:(e=b.location_metadata)==null?void 0:e.session_state)==="STARTED"};g.maybeUpdatePreviousCollapsibleMsgs=a}),98);
__d("MAWWriteEditTxns",["FBLogger","MAWAckLevel","MAWBridgeMsg","MAWBulkEditMsgsTxns","MAWDbEditMsgHistoryTxns","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWUnsafeCoerce","MAWUserJidWrapper","MAWWriteMsgTxns","WAJids","WAMsgType","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var e=b.args,f=b.externalId,g=e.editMsgContent;e=e.originalProtocolMsgId;var i=e.chat,j=e.externalId;return d("MAWDexieTable").dexieAll([a.threads.get({jid:i}),d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,e)]).then(function(e){var k=e[0],l=e[1];if(k==null)return d("WAResultOrError").makeError("missing_thread");if(l==null)return d("WAResultOrError").makeError("missing_msg");if(l.type!==d("WAMsgType").MSG_TYPE.TEXT)throw c("FBLogger")("messenger_web").mustfixThrow("Only text or cipher text can be edited. Original msg type: %s",l.type);return d("MAWDexieTable").dexieAll([a.messages.where("quoteExternalId").equals(j).toArray(),a.editMsgHistory.where("originalMsgExternalId").equals(j).toArray()]).then(function(e){var k=e[0];e=e[1];var m=e.find(function(a){return a.author===d("WAJids").AUTHOR_ME&&a.threadJid===i&&a.editExternalId===f});if((m==null?void 0:m.sendStatus)!=null&&m.sendStatus>d("MAWAckLevel").ACK.clock)return d("WAResultOrError").makeError("already_sent");m=[];m.push(h(b,i,j));e=e.find(function(a){return a.author===d("WAJids").AUTHOR_ME&&a.threadJid===i&&a.editExternalId===j});e==null&&(l.editCount==null||l.editCount===0)&&m.push(h(l,i,j));return d("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(a,m,!1).then(function(){var b,e=babelHelpers["extends"]({},l,{ack:d("MAWAckLevel").ACK.clock,editCount:((b=l.editCount)!=null?b:0)+1,msgContent:g}),h=[],m=d("MAWUserJidWrapper").getMyUserJid();k.filter(function(a){var b;return(((b=a.quote)==null?void 0:b.content.author)===d("WAJids").AUTHOR_ME||((b=a.quote)==null?void 0:b.content.author)===m)&&a.threadJid===i}).forEach(function(a){if(a!=null){var b=a.quote,d=a.quoteExternalId;if(b==null)c("FBLogger")("messenger_web").warn("[edit message] Failed to get the quoted content for a msg that has been quoted.",d);else{d=babelHelpers["extends"]({},a,{quote:babelHelpers["extends"]({},b,{content:babelHelpers["extends"]({},b.content,{msgContent:babelHelpers["extends"]({},e.msgContent)})})});h.push(d)}}});return a.messages.bulkPut([e].concat(h)).then(function(){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,l)}).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(e,void 0,a)})}).then(function(){h.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(a)})});return d("WAResultOrError").makeResult({originalMsgExternalId:j,originalMsgId:l.msgId,protocolMsgId:{author:d("WAJids").AUTHOR_ME,chat:i,externalId:f}})})})})})}function h(a,b,c){var e;return{author:d("WAJids").AUTHOR_ME,editExternalId:a.externalId,editTs:(e=a.serverTs)!=null?e:a.ts,msgContent:(e=(e=a.args)==null?void 0:e.editMsgContent)!=null?e:d("MAWUnsafeCoerce").unsafeCoerce(a.msgContent),originalMsgExternalId:c,sendStatus:d("MAWAckLevel").ACK.clock,specialTextSize:a.specialTextSize,threadJid:b}}function b(a,b,c,e,f,g,h){if(b.type!==d("WAMsgType").MSG_TYPE.TEXT||!e||e.length===0)return d("MAWWriteMsgTxns").writeNewIncomingMsg(a,b,c,f,g,h);var i=e.sort(function(a,b){return b.editTs-a.editTs})[0].msgContent;e=e.length;return d("MAWWriteMsgTxns").writeNewIncomingMsg(a,babelHelpers["extends"]({},b,{editCount:e,msgContent:i}),c,f,g,h).then(function(c){return(c.type===d("WAMsgType").MSG_TYPE.TEXT?d("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(a,[d("MAWBulkEditMsgsTxns").getMessageHistory(babelHelpers["extends"]({},c,{msgContent:b.msgContent}),c.threadJid)],g):d("MAWDexieTable").dexieResolve()).then(function(){return c})})}g.writeEdit=a;g.writeNewIncomingMsgAndEditHistory=b}),98);
__d("MAWWriteGroupInviteTxns",["MAWBridgeTypesCreators","MAWDbGroupInviteTxns","MAWDbParticipant","MAWDbParticipantTxns","MAWDbThreadTxns","MAWDexieTable","MAWIndexedDb","MAWLowLevelApiTypes","MAWThreadManagementTxns","MAWUserJidWrapper","WAGroupInviteUtils","WAJids","WAResultOrError","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c){return d("MAWDbThreadTxns").getThread(a,c).then(function(c){return!c.success?d("MAWLowLevelApiTypes").WRITE_GROUP_INVITE_ERROR.MISSING_GROUP:d("MAWDbGroupInviteTxns").maybeGetGroupInvite(a,b.threadJid,b.inviteeJid).then(function(c){return c&&!d("WATimeUtils").isInFuture(c.inviteExpirationTs)?d("MAWLowLevelApiTypes").WRITE_GROUP_INVITE_ERROR.EXISTING_GROUP_INVITE:d("MAWDbGroupInviteTxns").putGroupInvite(a,b)})})}function b(a,b,c,e){var f=b.caption,g=b.groupJid,h=b.inviteCode;b=b.inviteExpiration;var i=d("WAJids").interpretAsUserJid(c);if(g==null||b==null||h==null||i==null)return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError({type:"invalid_args"}));c=[d("WATimeUtils").castLongIntToUnixTime(b),d("WAJids").toGroupJid(g),d("WAGroupInviteUtils").toInviteCode(h)];var j=c[0];b=c[1];var k=c[2],l={folder:e,groupJid:b,inviteCode:k,inviteExpireTs:j,inviterJid:i,type:"group_invite"};return d("MAWThreadManagementTxns").getGroupThread(a,b,e,!0).then(function(b){return b==null?d("WAResultOrError").makeError(l):d("MAWDbParticipantTxns").getParticipant(a,b.thread.jid,i)}).then(function(b){if(!b.success)return d("WAResultOrError").makeError(l);var c=d("MAWUserJidWrapper").getMyUserJid(),e=d("MAWDbParticipant").craftParticipantId(b.value.threadJid,c);return d("MAWDbGroupInviteTxns").putGroupInvite(a,{caption:f==null?void 0:f.text,inviteCode:k,invitedParticipantId:e,inviteeJid:c,inviteExpirationTs:j,inviterJid:i,threadJid:b.value.threadJid}).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"GroupInviteUpdate",value:d("MAWBridgeTypesCreators").createBridgeGroupInvite(a)});return d("WAResultOrError").makeResult()})})}g.writeGroupInvite=a;g.writeIncomingGroupInviteMsg=b}),98);
__d("MAWWriteGroupPollCreateTxns",["I64","MAWArmadilloPollTableSchema.pb","MAWCurrentUser","MAWDbParticipantTxns","MAWDexieTable","MAWIndexedDb","MAWWriteMsgTxns","WAResultOrError","WATimeUtils","nullthrows"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,c,e){var f=c.optionsHashed;if(f==null)return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError({type:"invalid_args_poll_option_hashes"}));f=b.author;var g=b.externalId,h=b.ts,k=e.jid;return d("MAWDexieTable").dexieAll([i(a,k,c,f,g),d("MAWWriteMsgTxns").writeNewIncomingMsg(a,b,e,"handleGroupPollCreate")]).then(function(a){var b=a[0];a=a[1];j(b,a.msgId,d("WATimeUtils").castUnixTimeToMillisTime(h))}).then(function(){return d("WAResultOrError").makeResult()})}function i(a,b,e,f,g){var h=e.encKey,i=e.latestSenderTimestampsMs,j=e.name,k=e.optionsHashed,l=e.selectableOptionsCount;return d("MAWDbParticipantTxns").getParticipantsInThread(a,b).then(function(e){var m={chatJid:b,encKey:h,latestSenderTimestampsMs:i,pollAuthor:f,pollOptions:c("nullthrows")(k),pollParticipantCount:e.length,pollStanzaId:g,pollState:d("MAWArmadilloPollTableSchema.pb").POLL_STATE.OPEN,selectableOptionsCount:l,title:j};return a.poll.put(m).then(function(){return m})})}function j(a,b,c){d("MAWIndexedDb").afterTransaction({tag:"NewPoll",value:{contactIdForCurrentUser:(h||(h=d("I64"))).of_string(d("MAWCurrentUser").getID()),dbPoll:a,latestUpdateMsgId:b,latestUpdateTimestampMs:c}})}g.handleIncomingGroupPollCreate=a;g.savePollToDb=i;g.sendPollToUI=j}),98);
__d("MAWDbPollUtils",["FBLogger","MAWLocalizationType","WAJids","nullthrows"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,d,e){var f=a.pollAuthor,g=new Map(a.pollOptions.entries().map(function(a){var d=a[0];a=a[1];return a.optionText==null||!a.voteAuthors.has(b)?null:[d.toString(),c("nullthrows")(a.optionText)]}).filter(Boolean)),h=new Map(e.map(function(a){return[a.hashedOptionName,a.optionName]}));e=e.filter(function(a){return!g.has(a.hashedOptionName)}).map(function(a){return a.optionName});var k=Array.from(g.entries().map(function(a){var b=a[0];a=a[1];return h.has(b)?null:a}).filter(Boolean));if(d.length>0)if(e.length>0||k.length>0)return i(a,f);else return j(a,b,d);if(e.length>0)if(k.length===0)return m(a,b,e);else if(e.length===k.length)return p(a,b,e);else return i(a,f);if(k.length>0)return s(a,b,k);throw c("FBLogger")("messenger_web").mustfixThrow("Not a valid update for poll")}function h(a){if(a===d("WAJids").AUTHOR_SYSTEM||a===d("WAJids").AUTHOR_ME)throw c("FBLogger")("messenger_web").mustfixThrow("Not a valid author for poll vote");return d("WAJids").userIdFromJid(a)}function i(a,b){var c=b===d("WAJids").AUTHOR_ME;return c?{adminMsgContent:[a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_MIXED_POLL_UPDATE,version:1}:{adminMsgContent:[h(b),a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_MIXED_POLL_UPDATE,version:1}}function j(a,b,c){if(c.length===1)return k(a,b,c[0]);else return l(a,b,c[0],c.length)}function k(a,b,c){return b===d("WAJids").AUTHOR_ME?{adminMsgContent:[c,a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_POLL_OPTION,version:1}:{adminMsgContent:[h(b),c,a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_POLL_OPTION,version:1}}function l(a,b,c,e){return b===d("WAJids").AUTHOR_ME?{adminMsgContent:[c,e.toString(),a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_MULTIPLE_POLL_OPTIONS,version:1}:{adminMsgContent:[h(b),c,e.toString(),a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_MULTIPLE_POLL_OPTIONS,version:1}}function m(a,b,c){if(c.length===1)return n(a,b,c[0]);else return o(a,b,c[0],c.length)}function n(a,b,c){return b===d("WAJids").AUTHOR_ME?{adminMsgContent:[c,a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_POLL_VOTE,version:1}:{adminMsgContent:[h(b),c,a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_POLL_VOTE,version:1}}function o(a,b,c,e){return b===d("WAJids").AUTHOR_ME?{adminMsgContent:[c,e.toString(),a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_MULTIPLE_POLL_VOTES,version:1}:{adminMsgContent:[h(b),c,e.toString(),a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_MULTIPLE_POLL_VOTES,version:1}}function p(a,b,c){if(c.length===1)return q(a,b,c[0]);else return r(a,b,c[0],c.length)}function q(a,b,c){return b===d("WAJids").AUTHOR_ME?{adminMsgContent:[c,a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CHANGED_POLL_VOTE,version:1}:{adminMsgContent:[h(b),c,a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CHANGED_POLL_VOTE,version:1}}function r(a,b,c,e){return b===d("WAJids").AUTHOR_ME?{adminMsgContent:[c,e.toString(),a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CHANGED_MULTIPLE_POLL_VOTES,version:1}:{adminMsgContent:[h(b),c,e.toString(),a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CHANGED_MULTIPLE_POLL_VOTES,version:1}}function s(a,b,c){if(c.length===1)return t(a,b,c[0]);else return u(a,b,c[0],c.length)}function t(a,b,c){return b===d("WAJids").AUTHOR_ME?{adminMsgContent:[c,a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_POLL_VOTE,version:1}:{adminMsgContent:[h(b),c,a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_POLL_VOTE,version:1}}function u(a,b,c,e){return b===d("WAJids").AUTHOR_ME?{adminMsgContent:[c,e.toString(),a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_MULTIPLE_POLL_VOTES,version:1}:{adminMsgContent:[h(b),c,e.toString(),a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_MULTIPLE_POLL_VOTES,version:1}}g.getAdminMessageForUpdate=a}),98);
__d("MAWWriteGroupPollMessageTxns",["FBLogger","I64","MAWCurrentUser","MAWDbPoll","MAWDbPollTxns","MAWDbPollUtils","MAWDexieTable","MAWGroupPollsDualEncryptionUtils","MAWIndexedDb","MAWMsgType","MAWWriteMsgTxns","WALongInt","WAResultOrError","WAStanzaUtils","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,c,e){var f=c.decrypted;c=c.encryptedMessage;var g=b.author,k=(c=c.pollCreationMessageKey)==null?void 0:c.id;return k==null||g==null||f==null?d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError({type:"invalid_args_poll_update_message"})):d("MAWDbPollTxns").getPoll(a,e.jid,k).then(function(c){if(c==null)return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError({type:"missing_poll_for_update"}));var l=i(c,f),m=l.optionsToAdd;l=l.selectedOptions;m=d("MAWDbPollUtils").getAdminMessageForUpdate(c,g,m,l);var n=d("WAStanzaUtils").toStanzaId(k);l=babelHelpers["extends"]({},b,{msgContent:m,pollStanzaId:n,type:d("MAWMsgType").MSG_TYPE.GROUP_POLL_UPDATE});return d("MAWDexieTable").dexieAll([j(a,c,g,f),d("MAWWriteMsgTxns").writeNewIncomingMsg(a,l,e,"handleGroupPollUpdate")]).then(function(b){var c=b[0],f=b[1];return d("MAWDbPollTxns").maybeGetLatestPollUpdateMsg(a,n,e.jid).then(function(a){var b;d("MAWIndexedDb").afterTransaction({tag:"NewPoll",value:{contactIdForCurrentUser:(h||(h=d("I64"))).of_string(d("MAWCurrentUser").getID()),dbPoll:c,latestUpdateMsgId:(b=a==null?void 0:a.msgId)!=null?b:f.msgId,latestUpdateTimestampMs:d("WATimeUtils").castUnixTimeToMillisTime((b=a==null?void 0:a.ts)!=null?b:f.ts)}});return d("WAResultOrError").makeResult()})})})}function i(a,b){var c=b.optionsToAdd;b=b.vote;var e=a.pollOptions;b=((a=b==null?void 0:b.selectedOptions)!=null?a:[]).map(function(a){var b;a=d("MAWGroupPollsDualEncryptionUtils").getBase64EncodedHash(a);b=(b=e.get(a))==null?void 0:b.optionText;return b==null?null:{hashedOptionName:d("MAWDbPoll").convertOptionHashToString(a),optionName:b}}).filter(Boolean);return{optionsToAdd:((a=c)!=null?a:[]).map(function(a){return a.optionName}),selectedOptions:b}}function j(a,b,e,f){var g,h=f.optionsToAdd;f=f.vote;var i=b.pollOptions;h=h;k(h,i);h=d("WALongInt").maybeNumber((h=f==null?void 0:f.senderTimestampMs)!=null?h:0);if(h!=null&&h>((g=b.latestSenderTimestampsMs.get(e))!=null?g:0)){b.latestSenderTimestampsMs.set(e,d("WATimeUtils").castToMillisTime(h));g=f;l(g,i,e)}else h===0?c("FBLogger")("GroupPollsE2EE").warn("Poll vote message doesn't have a timestamp"):h==null?c("FBLogger")("GroupPollsE2EE").warn("Poll vote message timestamp is not a valid number"):h===0?c("FBLogger")("GroupPollsE2EE").mustfix("Poll vote message doesn't have a timestamp"):h==null?c("FBLogger")("GroupPollsE2EE").mustfix("Poll vote message timestamp is not a valid number"):c("FBLogger")("GroupPollsE2EE").info("Dropping poll vote message since we already have a newer vote message from this author %s",e);f=babelHelpers["extends"]({},b,{pollOptions:i});return d("MAWDbPollTxns").updatePoll(a,f).then(function(){return b})}function k(a,b){a==null?void 0:a.forEach(function(a){var c=a.hashedOptionName,d={optionText:a.optionName,voteAuthors:new Set()},e=b.get(c);e==null?b.set(c,d):e.optionText===void 0&&b.set(c,{optionText:a.optionName,voteAuthors:e.voteAuthors})})}function l(a,b,c){b.values().forEach(function(a){a.voteAuthors["delete"](c)}),a==null?void 0:a.selectedOptions.forEach(function(a){a=d("MAWGroupPollsDualEncryptionUtils").getBase64EncodedHash(a);if(!b.has(a)){var e={optionText:void 0,voteAuthors:new Set()};b.set(a,e)}(e=b.get(a))==null?void 0:e.voteAuthors.add(c)})}g.handleGroupPollUpdate=a;g.writeIncomingGroupPollUpdateMsg=j}),98);
__d("MAWExpiredXMACleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["ExpiredXMACleaner: Adding timestamps backend(",")"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);i=function(){return a};return a}var j=null;function a(a){j==null&&(j=new(d("MAWMsgCleaner").MsgCleaner)(a,d("MAWMsgCleaner").CLEANER_TYPE.XMA))}function b(a){if(j==null){var b="Trying to add new addNewExpiredXMACleanerTimestamp before the cleaner is initialized!";d("WALogger").ERROR(i(),b);throw c("FBLogger")("messenger_web").mustfixThrow(b)}else d("WALogger").DEV(h(),a),j.update(a)}function e(){return j}function f(){j=null}g.startExpiredXMACleaner=a;g.addNewExpiredXMACleanerTimestamp=b;g.getExpiredXMACleaner_FOR_TESTING_ONLY=e;g.resetExpiredXMACleaner_FOR_TESTING_ONLY=f}),98);
__d("MAWXMAManagementTxns",["FBLogger","MAWDexieTable","MAWMediaManagementTxns","MAWXMAUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f,g){var i=b.unstoredDbXMA,j=b.unstoredFavicon,k=b.unstoredHeaderMedia,l=b.unstoredPreviews;f===void 0&&(f=!1);g===void 0&&(g="wa");var m=new Map(),n=function(b){return b!=null?d("MAWMediaManagementTxns").handleUnstoredDbMedia(a,b,c,g,!0).then(function(a){return[b.plaintextHash,a]}):d("MAWDexieTable").dexieResolve([void 0,void 0])};f||(m.set(j==null?void 0:j.plaintextHash,n(j)).set(k==null?void 0:k.plaintextHash,n(k)),l==null?void 0:l.forEach(function(a){m.set(a==null?void 0:a.plaintextHash,n(a))}));b=Array.from(m.values());return d("MAWDexieTable").dexieAll(b).then(function(b){var g,m=new Map(b),n=((g=l)!=null?g:[]).map(function(a){return m.get(a.plaintextHash)}).filter(Boolean);return h(a,f?d("MAWXMAUtils").buildUnstoredTombstonedXMA(i):i,m.get(j==null?void 0:j.plaintextHash),m.get(k==null?void 0:k.plaintextHash),n,c,e).then(function(a){return{dbMedias:b.map(function(a){a[0];a=a[1];return a}).filter(Boolean),dbXMA:a,firstPreview:n[0]}})})}function h(a,b,d,e,f,g,h){h=babelHelpers["extends"]({},b,{associatedMessageId:(b=h)!=null?b:void 0,defaultPreviewMediaId:(h=f[0])==null?void 0:h.mediaId,defaultPreviewMediaPlaintextHash:(b=f[0])==null?void 0:b.plaintextHash,faviconMediaId:d==null?void 0:d.mediaId,faviconPlaintextHash:d==null?void 0:d.plaintextHash,headerMediaId:e==null?void 0:e.mediaId,headerMediaPlaintextHash:e==null?void 0:e.plaintextHash,msgId:g.msgId,previewMediaIds:f.map(function(a){return a.mediaId})});return a.xma.add(h).then(function(b){return a.xma.get(b)}).then(function(a){if(a==null)throw c("FBLogger")("messenger_web").mustfixThrow("Failed to write XMA to db");return a})}function b(a,b,c,e,f,g,h,i,j,k,l,m,n){var o=d("MAWXMAUtils").isXMAExpired(!1,j.targetExpiringAtSec);h=babelHelpers["extends"]({},j,{associatedMessageId:(j=h)!=null?j:void 0,author:i.author,externalId:i.externalId,isTombstoned:o,msgId:g,offlineAttachmentId:k,targetType:f,threadJid:i.chat});var p=o?h:babelHelpers["extends"]({},h,{defaultPreviewMediaId:(j=b)!=null?j:void 0,defaultPreviewMediaPlaintextHash:(g=l)!=null?g:void 0,faviconMediaId:(k=e)!=null?k:void 0,faviconPlaintextHash:(f=n)!=null?f:void 0,headerMediaId:(i=c)!=null?i:void 0,headerMediaPlaintextHash:(o=m)!=null?o:void 0,previewMediaIds:b!=null?[b]:[]});return a.xma.add(p).then(function(a){return babelHelpers["extends"]({},p,{xmaId:a})})}g.handleUnstoredXMAContent=a;g.saveXMA=b}),98);
__d("MAWWriteXMAMessageTxns",["FBLogger","MAWBridgeMsg","MAWDbXMATxns","MAWDexieTable","MAWExpiredXMACleaner","MAWGetIsMediaDownloadStatusEnabled","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWMsgType","MAWWriteMsgTxns","MAWXMAManagementTxns","MAWXMAUtils","MWPBumpEntityKey","WAJids","WATimeUtils","justknobx"],(function(a,b,c,d,e,f,g){"use strict";f=6*d("WATimeUtils").HOUR_SECONDS;var h=new Set([d("MAWMsgType").MSG_TYPE.TEXT,d("MAWMsgType").MSG_TYPE.GIF,d("MAWMsgType").MSG_TYPE.STICKER]);function a(a,b,c,e){var f=c.unstoredAssociatedMedia,g=c.unstoredAssociatedMsg,h=c.unstoredDbXMA;return d("MAWDbXMATxns").maybeGetAssociatedXMAMsg(a,g,e.jid).then(function(c){var i=b;if(c!=null&&c.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT){var j=c.serverTs,k=c.sortOrderMs;c=c.ts;i=babelHelpers["extends"]({},b,{serverTs:j,sortOrderMs:k!=null?k-1:k,ts:c})}j=[h.targetExpiringAtSec,h.targetType];k=j[0];c=j[1];d("MAWXMAUtils").isXMAStoryReaction(c)&&(g==null?void 0:g.msgContent)!=null&&(i=babelHelpers["extends"]({},b,{msgContent:g.msgContent}));j=d("MAWXMAUtils").isXMAExpired(h.isTombstoned,k);i.isExpiredXmaMsg=j;k=!d("MAWXMAUtils").isXMAStoryReaction(c)&&g!=null?d("MAWWriteMsgTxns").prepareMsgWriteData(a,g,e):d("MAWDexieTable").dexieResolve(null);return d("MAWDexieTable").dexieAll([d("MAWWriteMsgTxns").prepareMsgWriteData(a,i,e),k]).then(function(a){var b=a[0];a=a[1];return{associatedData:a,associatedMedia:f,associatedMsg:g,xmaData:b,xmaMsg:i}})})}function b(a,b,c,e,f){var g=c.unstoredDbXMA,h=[g.targetExpiringAtSec,g.targetType],i=h[0];h=h[1];if(b==null||b.type===d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME)return d("MAWDexieTable").dexieResolve({dbMedias:null,dbXMA:null});b.isExpiredXmaMsg!==!0&&i!=null&&d("MAWExpiredXMACleaner").addNewExpiredXMACleanerTimestamp(i);d("MAWXMAUtils").isXMAStoryReaction(h)&&d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(b)});return d("MAWXMAManagementTxns").handleUnstoredXMAContent(a,babelHelpers["extends"]({},c,{unstoredDbXMA:g}),b,f,b.isExpiredXmaMsg===!0,e).then(function(c){var e=c.dbMedias,f=c.dbXMA;c=c.firstPreview;var g=d("MAWDexieTable").dexieResolve();if(f!=null&&!d("MAWXMAUtils").isXMAStoryReply(f.targetType)&&b.isExpiredXmaMsg!==!0)if(d("MAWGetIsMediaDownloadStatusEnabled").getIsMediaDownloadStatusForXMAsEnabledWithChunkVerification()){var h=new Map(e.map(function(a){return[a.mediaId,a]})),i=f.headerMediaId!=null?h.get(f.headerMediaId):null;h=f.faviconMediaId!=null?h.get(f.faviconMediaId):null;g=d("MAWHandleXmaTransactionUtil").checkAllMediaChunksAndHandleXmaAfterTransaction(a,f,c,h,i)}else g=d("MAWHandleXmaTransactionUtil").checkMediaChunkAndHandleXmaAfterTransaction(a,f,c);return g.then(function(){return{dbMedias:e,dbXMA:f}})})}function e(a,b,e,f,g,i,j,k){if(!h.has(g.type))throw c("FBLogger")("messenger_web").mustfixThrow("flow check, this message type is not supported for XMA replies: "+g.type);var l=b.author;if(l==="@system")throw c("FBLogger")("messenger_web").mustfixThrow("wrong author of story reply");var m=d("WAJids").interpretAsUserJid(f);if(m==null)throw c("FBLogger")("messenger_web").mustfixThrow("this is a flow check, participant jid can not be null");var n=(k=k==null?void 0:(k=k[0])==null?void 0:k.plaintextHash)!=null?k:g.plaintextHash;(i?void 0:e==null?void 0:e.defaultPreviewMediaId)!=null&&n==null&&d("MWPBumpEntityKey").bumpEntityKeyWithAppId("maw.reply_attachment_media_missing_plaintext_hash","write_xma_message_txns_handle_xma_reply_msg");k={author:l===d("WAJids").AUTHOR_ME?m:d("WAJids").AUTHOR_ME,expirationTs:e.targetExpiringAtSec,externalId:e.externalId,mediaId:i?void 0:e==null?void 0:e.defaultPreviewMediaId,plaintextHash:c("justknobx")._("2969")&&!i?n:void 0,sourceId:(l=(k=e.defaultCTA)==null?void 0:k.nativeUrl)!=null?l:(m=e.defaultCTA)==null?void 0:m.actionUrl,ts:b.ts,type:d("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:e.targetType};var o=babelHelpers["extends"]({},g,{mediaId:(l=j==null?void 0:j.mediaId)!=null?l:g.mediaId,quote:{content:k,remoteJid:f}});return a.messages.put(o).then(function(){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:c("justknobx")._("2969")&&!i?d("MAWBridgeMsg").createBridgeMsg(o,void 0,{replyPlaintextHash:n}):d("MAWBridgeMsg").createBridgeMsg(o)})})}g.REVOKE_CONTENT_EXPIRATION_IN_SEC=f;g.XMA_REPLY_MSG_SUPPORTED_TYPES=h;g.prepareXMAWriteData=a;g.handleIncomingXMA=b;g.handleXMAReplyMsg=e}),98);
__d("MAWHandleIncomingMsgApi",["MAWDbMsgTxns","MAWDbPendingStanzaTxns","MAWDbRavenActionTxns","MAWDexieTable","MAWEphemeralAdminMsgBuildTxns","MAWEphemeralMsgTxns","MAWEphemeralSettingsTxns","MAWHIMLogger","MAWJidUtils","MAWMediaManagementTxns","MAWMsgActionType","MAWMsgType","MAWODSProxy","MAWPendingReceiptProcessingTxns","MAWUpdateIsCollapsedMsgTxns","MAWUpdateQuotedMsgTxns","MAWWriteEditTxns","MAWWriteGroupInviteTxns","MAWWriteGroupPollCreateTxns","MAWWriteGroupPollMessageTxns","MAWWriteMsgTxns","MAWWriteReceiverFetchTxns","MAWWriteRevokeMessageTxns","MAWWriteXMAMessageTxns","MAWXMAUtils","MWXMAV2IsCollapsibleXMA","WAGetPlatformFromStanzaId","WAJids","WAOdsEnums","WAResultOrError","gkx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Could not write dbAssociatedMsg but it exists: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleIncomingMsgInternal: Finished writing the incoming message"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleIncomingMsgInternal: Finished writing the incoming xma, has associated data = ",""]);j=function(){return a};return a}var k=d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeResult(void 0));function a(a,b,e){var f;b.receiveFlow.addPoint("him_write_message_start");var g=((f=b==null?void 0:(f=b.msg)==null?void 0:(f=f.ephemeralSetting)==null?void 0:f.ephemeralExpirationInSec)!=null?f:0)>0;return l(a,b,e).then(function(a){var c;b.receiveFlow.addPoint("him_write_message_end",{bool:{isEphemeralMsg:g,outOfSync:(a==null?void 0:(c=a.value)==null?void 0:c.outOfSyncEphemeralSetting)!=null},string:{msgWrittenResultType:(c=a==null?void 0:(c=a.value)==null?void 0:c.msgType)!=null?c:"unknown"}});g&&d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.TOTAL_INCOMING_MESSAGE,key:"ephemeralMsgs"});return a})["catch"](function(a){var e;if(a.name==="ConstraintError"){b.type!==d("MAWMsgType").MSG_TYPE.XMA&&c("MAWHIMLogger").mustfix("encounted a ConstraintError for type %s",b.type);return d("WAResultOrError").makeError({type:"constraint_error"})}a.message="[handleIncomingMsg] ["+((e=b.type)!=null?e:"")+"/"+b.action+"] "+a.message;throw a})}function l(a,b,e){if(b.action===d("MAWMsgActionType").MSG_ACTION.NO_ACTION)return k;var f=function(c,e,f){return d("MAWEphemeralMsgTxns").syncEphemeralSettingOnIncomingMsg(a,c,e,b.thread,f)};switch(b.type){case d("MAWMsgType").MSG_TYPE.CIPHERTEXT:case d("MAWMsgType").MSG_TYPE.UNAVAILABLE:return d("MAWWriteMsgTxns").writeNewIncomingMsg(a,b.msg,b.thread,"MAWHandleIncomingMsgApi::handleIncomingMsgInternal",e,b.stanzaSource).then(function(){return d("WAResultOrError").makeResult(null)});case d("MAWMsgType").MSG_TYPE.RAVEN_ACTION:return d("MAWDbRavenActionTxns").writeRavenActionMsg(a,b.msg,b.thread).then(function(){return d("WAResultOrError").makeResult(null)});case d("MAWMsgType").MSG_TYPE.REACTION:return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeResult({reactToExternalId:b.msg.reactToExternalId}));case d("MAWMsgType").MSG_TYPE.GROUP_INVITE:return d("WAJids").isAuthorMe(b.id.author)?k:d("MAWWriteGroupInviteTxns").writeIncomingGroupInviteMsg(a,b.msg,b.thread.jid,b.folder);case d("MAWMsgType").MSG_TYPE.TEXT:case d("MAWMsgType").MSG_TYPE.FUTUREPROOF:case d("MAWMsgType").MSG_TYPE.IMAGE:case d("MAWMsgType").MSG_TYPE.VIDEO:case d("MAWMsgType").MSG_TYPE.PTT:case d("MAWMsgType").MSG_TYPE.GIF:case d("MAWMsgType").MSG_TYPE.STICKER:case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:case d("MAWMsgType").MSG_TYPE.RAVEN:case d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return b.action===d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME?d("MAWWriteMsgTxns").handleDeleteForMeMessage(a,b.msg,b.thread,b.pendingDeleteForMeStanza).then(function(a){return n(a)}):r(a,b.msg,b.thread.jid).then(function(c){if(c)return k;c=b.action===d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT?d("MAWWriteMsgTxns").writeCiphertextUpdate(a,b.msg,b.existingMsg,b.thread,b.existingEditMsgHistory,b.stanzaSource):b.action===d("MAWMsgActionType").MSG_ACTION.REVOKE?d("MAWWriteMsgTxns").handleOutOfOrderRevokedMessage(a,b.msg,b.thread,b.pendingRevokedStanza,b.pendingRevokedStanza!=null):d("MAWWriteEditTxns").writeNewIncomingMsgAndEditHistory(a,b.msg,b.thread,b.editMsgHistories,"MAWHandleIncomingMsgApi::handleIncomingMsgInternal",e,b.stanzaSource);return c.then(function(c){var g=b.type===d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH?d("MAWWriteReceiverFetchTxns").handleUnstoredReceiverFetchInfo(a,c,b.receiverFetchInfo):d("MAWDexieTable").dexieResolve(),h=b.media!=null?d("MAWMediaManagementTxns").handleUnstoredDbMedia(a,b.media,c,b.stanzaSource,void 0,void 0,void 0,e):d("MAWDexieTable").dexieResolve();c.quote!=null&&b.receiveFlow.addAnnotations({bool:{isQuote:!0},string:{quoteType:c.quote.content.type}});return d("MAWDexieTable").dexieAll([g,h]).then(function(e){e[0];var g=e[1];return d("MAWDexieTable").dexieAll([o(a,b.id,c,c.type!==d("MAWMsgType").MSG_TYPE.FUTUREPROOF),f(c,d("MAWJidUtils").getAuthorJid(b.id.author),b.ts)]).then(function(a){a[0];a=a[1];return n(c,a,g==null?null:[g])})}).then(function(e){var f={author:c.author,chat:c.threadJid,externalId:c.externalId};return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,f).then(function(c){if(c!=null)return d("MAWUpdateQuotedMsgTxns").associateAllReplies(a,c,b.thread.jid)}).then(function(){return e})})})});case d("MAWMsgType").MSG_TYPE.REVOKED:return d("MAWWriteRevokeMessageTxns").writeIncomingRevokeMsg(a,b.msg,b.thread,b.originalMsg,b.previousRevokeMsg,b.ebTimestampMs).then(function(c){return d("MAWDexieTable").dexieAll([o(a,b.id,c),f(c,d("MAWJidUtils").getAuthorJid(b.id.author),b.ts)]).then(function(a){a[0];a=a[1];return n(c,a)})});case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:return d("MAWEphemeralSettingsTxns").handleAndWriteIncomingEphemeralSetting(a,d("MAWJidUtils").getAuthorJid(b.id.author),b.msg.ephemeralExpirationInSec,b.msg.ephemeralLastUpdatedOrSetTimestamp,b.msg.isEphemeralSettingReset,b.thread,b.ts,b.id.externalId,!0).then(function(a){return n(null,a==null?void 0:a.outOfSyncEphemeralSetting)});case d("MAWMsgType").MSG_TYPE.ICDC_ALERT:return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeResult({msgType:void 0,outOfSyncEphemeralSetting:void 0,plaintextHashs:void 0}));case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:return d("MAWEphemeralAdminMsgBuildTxns").writeEphemeralScreenshotActionMsg(a,d("MAWJidUtils").getAuthorJid(b.id.author),b.thread,b.ts,b.screenshotActionType,b.id.externalId,b.existingMsg).then(function(c){return d("MAWDexieTable").dexieAll([o(a,b.id,c),f(c,d("MAWJidUtils").getAuthorJid(b.id.author),b.ts)]).then(function(a){a[0];a=a[1];return n(c,a)})});case d("MAWMsgType").MSG_TYPE.XMA:if(b.action===d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME)return d("MAWWriteMsgTxns").handleDeleteForMeMessage(a,b.msg,b.thread,b.pendingDeleteForMeStanza).then(function(a){return n(a)});var g=b.xma!=null&&d("MWXMAV2IsCollapsibleXMA").isCollapsibleXMA(b.xma.unstoredDbXMA.xmaDataclass)&&c("gkx")("12844")?d("MAWUpdateIsCollapsedMsgTxns").maybeUpdatePreviousCollapsibleMsgs(a,b.msg,b.xma.unstoredDbXMA.xmaDataclass,b.thread.jid):d("MAWDexieTable").dexieResolve(b.msg);g=b.action===d("MAWMsgActionType").MSG_ACTION.WRITE_WITH_ASSOCIATED||b.action===d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED?p(a,b,e):b.action===d("MAWMsgActionType").MSG_ACTION.REVOKE?m(a,b,e):g.then(function(c){return m(a,babelHelpers["extends"]({},b,{msg:c}),e).then(function(c){return d("MAWWriteXMAMessageTxns").handleIncomingXMA(a,c,b.xma,b.stanzaSource,null).then(function(a){return babelHelpers["extends"]({},a,{dbMsg:c})})})});return g.then(function(e){var g=e.dbAssociatedMsg,h=e.dbMedias,i=e.dbMsg;c("MAWHIMLogger").DEBUG(j(),b.action===d("MAWMsgActionType").MSG_ACTION.WRITE_WITH_ASSOCIATED||b.action===d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED);return d("MAWDexieTable").dexieAll([o(a,b.id,i,!0,g),f(i,d("MAWJidUtils").getAuthorJid(b.id.author),b.ts)]).then(function(c){c[0];var e=c[1];return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b.id).then(function(c){if(c!=null)return d("MAWUpdateQuotedMsgTxns").associateAllReplies(a,c,b.thread.jid)}).then(function(){return e})}).then(function(a){return n(i,a,h)})});case d("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE:return d("MAWWriteGroupPollCreateTxns").handleIncomingGroupPollCreate(a,b.msg,b.pollInfo,b.thread);case d("MAWMsgType").MSG_TYPE.GROUP_POLL_UPDATE:return d("MAWWriteGroupPollMessageTxns").handleGroupPollUpdate(a,b.msg,b.pollInfo,b.thread);default:throw c("MAWHIMLogger").mustfixThrow("We do not support handleIncomingMsgInternal with type: "+((g=b.type)!=null?g:""))}}function m(a,b,c){return b.action===d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT||b.action===d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED?d("MAWWriteMsgTxns").writeCiphertextUpdate(a,b.msg,b.existingMsg,b.thread,null,b.stanzaSource):b.action===d("MAWMsgActionType").MSG_ACTION.REVOKE?d("MAWWriteMsgTxns").handleOutOfOrderRevokedMessage(a,b.msg,b.thread,b.pendingRevokedStanza,b.pendingRevokedStanza!=null):d("MAWWriteMsgTxns").writeNewIncomingMsg(a,b.msg,b.thread,"MAWHandleIncomingMsgApi::writeXmaMsg",c,b.stanzaSource)}function n(a,b,c){return d("WAResultOrError").makeResult({msgType:a==null?void 0:a.type,outOfSyncEphemeralSetting:(a=b)!=null?a:void 0,plaintextHashs:c==null?void 0:c.map(function(a){return a.plaintextHash})})}function o(a,b,e,f,g){var h=b.author;b=b.chat;f===void 0;if(e==null)return d("MAWDexieTable").dexieResolve();if(e==null)return d("MAWDexieTable").dexieResolve();f=d("MAWPendingReceiptProcessingTxns").processPendingReceipts(a,b,e);e=h===d("WAJids").AUTHOR_ME&&g!=null&&g.type!==d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME?d("MAWPendingReceiptProcessingTxns").processPendingReceipts(a,b,g):d("MAWDexieTable").dexieResolve();return d("MAWDexieTable").dexieAll([f,e]).then(function(){c("MAWHIMLogger").DEBUG(i())})}function p(a,b,e){e===void 0&&(e=!0);b.associatedMsg.externalId===b.msg.externalId&&c("MAWHIMLogger").tags(["XMA"]).mustfix("associatedMsg and msg have the same externalId, platform %s",d("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(b.msg.externalId));var f=b.existingAssociatedMsg,g;f!=null?f.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT?g=d("MAWWriteMsgTxns").writeCiphertextUpdate(a,b.associatedMsg,f,b.thread,null,b.stanzaSource):g=d("MAWDexieTable").dexieResolve(f):g=d("MAWWriteMsgTxns").writeNewIncomingMsg(a,b.associatedMsg,b.thread,"MAWHandleIncomingMsgApi::handleIncomingXMAWithAssociatedData",e,b.stanzaSource);return g.then(function(c){return c.type===d("MAWMsgType").MSG_TYPE.REVOKED?d("MAWDexieTable").dexieResolve({dbAssociatedMsg:null,dbMedias:null,dbMsg:null}):m(a,b,e).then(function(e){if(b.associatedMedia!=null)return d("MAWMediaManagementTxns").handleUnstoredDbMedia(a,b.associatedMedia,c,b.stanzaSource).then(function(d){return q(a,e,c,b.xma,b.msg,b.associatedMsg,b.thread.jid,b.stanzaSource,d)});else return q(a,e,c,b.xma,b.msg,b.associatedMsg,b.thread.jid,b.stanzaSource)})})}function q(a,b,e,f,g,i,j,k,l){return d("MAWWriteXMAMessageTxns").handleIncomingXMA(a,b,f,k,e.msgId).then(function(f){var k=f.dbMedias;f=f.dbXMA;e==null&&c("MAWHIMLogger").MUSTFIX(h(),i.externalId);return(e!=null&&f!=null&&d("MAWXMAUtils").isXMAStoryReply(f.targetType)?d("MAWWriteXMAMessageTxns").handleXMAReplyMsg(a,g,f,j,e,g.isExpiredXmaMsg===!0,l,k):d("MAWDexieTable").dexieResolve()).then(function(){return l!=null?{dbAssociatedMsg:e,dbMedias:k!=null?[].concat(k,[l]):[l],dbMsg:b}:{dbAssociatedMsg:e,dbMedias:k,dbMsg:b}})})}function r(a,b,c){var e;if(b.type!==d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE)return d("MAWDexieTable").dexieResolve(!1);e=(e=b.quote)==null?void 0:(e=e.content)==null?void 0:e.externalId;var f=(b=b.quote)==null?void 0:b.content.author;if(e==null||f==null)return d("MAWDexieTable").dexieResolve(!1);b=d("MAWJidUtils").maybeToProtocolMsgId(f,c,e);return d("MAWDexieTable").dexieAll([a.deletedMessages.get(babelHelpers["extends"]({},b)),a.unrenderedMessages.get({externalId:e}),d("MAWDbPendingStanzaTxns").maybeGetPendingRevokedStanza(a,e,f,c),d("MAWDbPendingStanzaTxns").maybeGetPendingDeletedStanza(a,e,f,c)]).then(function(a){var b=a[0],d=a[1],e=a[2];a=a[3];d=d!=null&&d.author===f&&d.threadJid===c;return b!=null||d||e!=null||a!=null})}g.handleIncomingMsg=a;g.processReceipts=o}),98);
__d("MAWLinkReactionsToMsgsTxns",["MAWDbMsgTxns","MAWDbReactionUtils","WAMsgMap"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return a.reduce(function(a,b){var c,d={author:b.reactToAuthor,chat:b.threadJid,externalId:b.reactToExternalId};c=(c=a.get(d))!=null?c:[];c.push(b);return a.set(d,c)},new(d("WAMsgMap").MsgMap)())}function i(a){a.forEach(function(a){d("MAWDbReactionUtils").dispatchReaction(a)})}function j(a,b){return a.reactions.where("reactToExternalId").anyOf(b).toArray().then(function(a){return h(a.filter(function(a){return a.reactToMsgId==null}))})}function a(a,b){return j(a,b).then(function(b){return d("MAWDbMsgTxns").getMsgsByProtocolMsgId(a,b.keys()).then(function(a){return a.flatMap(function(a){var c={author:a.author,chat:a.threadJid,externalId:a.externalId};c=(c=b.get(c))!=null?c:[];return c.map(function(b){b.reactToMsgId=a.msgId;return b})})})})}function b(a,b){return a.reactions.bulkPut(b).then(function(){i(b)})}g.getReactionLinkUpdatesForExternalIds=a;g.updateReactionLinks=b}),98);
__d("MAWOfflineThreadTxns",["I64","MAWBridgeThread","MAWDbGroupInfoTxns","MAWDbParticipantTxns","MAWDbThread","MAWDbThreadTxns","MAWDexieTable","MAWIndexedDb","MAWLoadOneToOneMessageRequestCapabilitiesTxn","MAWThreadMappingQPL","MAWThreadUpdateMiddlewareGatingUtil","MAWUserJidWrapper","MAWWriteBulkWriteIncomingAdminMsgTxns","WAArrayZip","WAJids","WATagsLogger","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Duplicated thread creation for ",""]);i=function(){return a};return a}var j=new Set();function a(a,b,c){var e=[],f=new Set(b),g=new Map(),h=new Map();c.forEach(function(a){h.set(a.jid,"exists"),g.set(a.jid,a),f["delete"](a.jid),e.push(a)});f.forEach(function(a){j.has(a)&&d("WATagsLogger").TAGS(["occamadillo","incoming_processing"]).LOG(i(),a)});return o(a,f).then(function(b){b.oneToOneThreadsCreationData.forEach(function(a){j.add(a.thread.jid)});b.groupThreadsCreationData.forEach(function(a,b){j.add(b),a.groupInfo==null&&h.set(b,"missing")});return a.threads.bulkAdd(p(b),{allKeys:!0}).then(function(b){return d("MAWDbThreadTxns").getThreads(a,Array.from(f.values())).then(function(b){e.push.apply(e,b);m(e);var c=q(b);return d("MAWDexieTable").dexieAll([k(a,c),d("MAWWriteBulkWriteIncomingAdminMsgTxns").writeE2EEAdminMsgsForIncomingCreatedThreads(a,b)]).then(function(){b.forEach(function(a){return g.set(a.jid,a)});return{threadCreationResult:h,threads:g}})})})})}function k(a,b){return d("MAWDexieTable").dexieAll([l(a,b),d("MAWLoadOneToOneMessageRequestCapabilitiesTxn").loadOneToOneMessageRequestCapabilities(Array.from(b.values()).map(function(a){return a.jid}))])}function l(a,b){var e=[],f=d("MAWUserJidWrapper").getMyUserJid();b.forEach(function(a,b){e.push({chatJid:b,type:"participant",userJid:b}),f!==b&&e.push({chatJid:b,type:"participant",userJid:f})});return d("MAWDbParticipantTxns").bulkAddParticipantsInThreads(a,e).then(c("emptyFunction"))}function m(a){a.forEach(function(a){var b=d("MAWThreadMappingQPL").getInstanceKeyForJidInWorker(a.jid);d("MAWThreadMappingQPL").startInWorker({instanceKey:b,jid:a.jid,threadKey:a.optimisticThreadKey==null?void 0:(h||(h=d("I64"))).of_string(a.optimisticThreadKey),trigger:"createAllThreadsForOfflineMsgs"});d("MAWThreadMappingQPL").addPoint("verify_optimistic_maw_thread",b);d("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:d("MAWBridgeThread").createBridgeThread(a,a.optimisticThreadKey,d("MAWThreadUpdateMiddlewareGatingUtil").isThreadCreationOptimisationEnabled()?a.authoritativeThreadKey:void 0,"createAllThreadsForOfflineMsgs",null,b)})})}function n(a,b){return{folder:null,jid:a,lastReadMsg:null,lastReadMsgReceiptSent:null,lastReadMsgTs:null,newestMsgTs:b!=null?d("WATimeUtils").castUnixTimeToMillisTime(b):null,oldestMsg:null,optimisticThreadKey:void 0,threadOrder:d("MAWDbThread").craftThreadOrder(d("WATimeUtils").millisTime(),a)}}function o(a,b){var c=[],e=[];b.forEach(function(a){d("WAJids").switchOnMsgrChatJidType(a,{group:function(a){return c.push(a)},user:function(a){return e.push(a)}})});return d("MAWDbGroupInfoTxns").getGroupInfos(a,c).then(function(a){var b=new Map(d("WAArrayZip").zip(c,a));a=new Map(c.map(function(a){var c=b.get(a);return[a,{groupInfo:c,thread:n(a,c==null?void 0:c.creationTs)}]}));var f=new Map(e.map(function(a){return[a,{thread:n(a,null)}]}));return{groupThreadsCreationData:a,oneToOneThreadsCreationData:f}})}function p(a){var b=a.groupThreadsCreationData;a=a.oneToOneThreadsCreationData;return Array.from(b.values()).map(function(a){a=a.thread;return a}).concat(Array.from(a.values()).map(function(a){a=a.thread;return a}))}function q(a){var b=new Map();a.forEach(function(a){d("WAJids").switchOnMsgrChatJidType(a.jid,{group:c("emptyFunction"),user:function(c){return b.set(c,a)}})});return b}g.createAllThreadsForOfflineMsgs=a}),98);
__d("MAWPreprocessMsgs",["LSMEBTaskCreationSource","MAWBuildIncomingMsgs","MAWDbMsgTxns","MAWDexieTable","MAWHIMLogger","MAWMediaGalleryEBTaggingUtils","MAWMediaManagementTxns","MAWMsgActionType","MAWMsgType","MAWWriteMsgTxns","MAWWriteXMAMessageTxns","WAGlobals","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unsupported message type on preprocessing ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media is null for StanzaID ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Preparing media for msg with StanzaID ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unexpected msg type when writing ephemeral setting message. Should not happen"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["No unstored content for incoming message: SHOULD NEVER HAPPEN"]);l=function(){return a};return a}var m=c("MAWHIMLogger").tags(["MAWPreprocessMsgs"]);function a(a){var b=[],c=[];a.forEach(function(a){var d=a.msgData;a=a.unstoredContent;switch(d.type){case"IncomingMsg":if(a==null){m.MUSTFIX(l());return}var e=a.unstoredDbEditActionMsg;a=a.unstoredDbReaction;if(a!=null){a={chatJid:d.id.chat,unstoredReaction:a};b.push(a)}e!=null&&c.push({chatJid:d.id.chat,msg:e});break;case"IncomingCiphertextMsg":default:break}});return{editActionMsgs:c,reactionMsgs:b}}function b(a,b,c,d){b.receiveFlow.addPoint("him_get_preprocessing_data_start");return n(a,b,c,d).then(function(a){var c;b.receiveFlow.addPoint("him_get_preprocessing_data_end",{string:{action:a.action,type:(c=a.type)!=null?c:""}});return a})}function n(a,b,e,f){var g=b.msgData,l=b.receiveFlow,n=b.stanzaSource,p=b.unstoredContent;b=g.folder;var q=g.id,r=g.ts,s={id:q,receiveFlow:l,stanzaSource:n,thread:e,ts:r},t=d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.NO_ACTION,msg:null,type:null}));switch(g.type){case"IncomingMsg":if(p==null)return t;var u=p.unstoredDbGroupPollCreateInfo;l=p.unstoredDbGroupPollUpdateInfo;var v=p.unstoredDbMsg,w=p.unstoredDbRavenActionMsg,x=p.unstoredDbReaction,y=p.unstoredDbReceiverFetchInfo,z=p.unstoredIncomingDbGroupInvite;if(w!=null)return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:w,type:d("MAWMsgType").MSG_TYPE.RAVEN_ACTION}));else if(x!=null)return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:x,type:d("MAWMsgType").MSG_TYPE.REACTION}));else if(z!=null)return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,folder:b,msg:z,type:d("MAWMsgType").MSG_TYPE.GROUP_INVITE}));else if(v==null)return t;else if(v.type===d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN){w=g.msg;if(w.version==="v3"&&w.type==="ephemeral")return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:w,type:v.type}));else{m.MUSTFIX(k());return t}}else if(v.type===d("MAWMsgType").MSG_TYPE.TEXT||v.type===d("MAWMsgType").MSG_TYPE.FUTUREPROOF)return d("MAWWriteMsgTxns").prepareTextMsgWriteData(a,v,e).then(function(a){var b=a.editMsgHistories,c=a.existingEditMsgHistory,e=a.existingMsg,f=a.isDeletedWithThread,g=a.isDeleteForMeOrRevoked,h=a.pendingDeleteForMeStanza;a=a.pendingRevokedStanza;var i=o(e,v,c);if(g||f||e!=null&&i!==!0)return t;if(i&&e!=null)return babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT,existingEditMsgHistory:c,existingMsg:e,msg:v,type:v.type});if(h!=null)return babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME,msg:v,pendingDeleteForMeStanza:h,type:v.type});return a!=null?babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.REVOKE,msg:v,pendingRevokedStanza:a,type:v.type}):babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,editMsgHistories:b,msg:n==="ebrestore"?babelHelpers["extends"]({},v,{source:"eb_restore"}):v,type:v.type})});else if(v.type===d("MAWMsgType").MSG_TYPE.IMAGE||v.type===d("MAWMsgType").MSG_TYPE.VIDEO||v.type===d("MAWMsgType").MSG_TYPE.PTT||v.type===d("MAWMsgType").MSG_TYPE.GIF||v.type===d("MAWMsgType").MSG_TYPE.STICKER||v.type===d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE||v.type===d("MAWMsgType").MSG_TYPE.RAVEN){v.type===d("MAWMsgType").MSG_TYPE.IMAGE&&((x=g.msg.metadata)==null?void 0:x.groupId)!=null&&(v.groupId=g.msg.metadata.groupId,v.groupIndex=g.msg.metadata.groupIndex,v.groupSize=g.msg.metadata.groupSize);v.type===d("MAWMsgType").MSG_TYPE.IMAGE&&(p==null?void 0:(b=p.unstoredDbMedia)==null?void 0:(z=b.validatedImageInfo)==null?void 0:z.hdType)!=null&&(v.hdType=p==null?void 0:p.unstoredDbMedia.validatedImageInfo.hdType);m.DEBUG(j(),v.externalId);return d("MAWMediaManagementTxns").prepareMediaWriteData(a,v,p==null?void 0:p.unstoredDbMedia,e).then(function(a){var b=a.existingMsg,e=a.isDeletedWithThread,g=a.isDeleteForMeOrRevoked,h=a.pendingDeleteForMeStanza,j=a.pendingRevokedStanza;a=a.shouldDropDocument;var k=[p==null?void 0:p.unstoredDbMedia,o(b,v)],l=k[0];k=k[1];l==null&&m.DEBUG(i(),v.externalId);if(n==="ebrestore"&&b!=null&&l!=null&&b.source==="media_restore"&&(!d("MAWMediaGalleryEBTaggingUtils").isMediaGalleryEBTaggingRestoreEnabled()||f!==c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE)){var q=!d("MAWMediaGalleryEBTaggingUtils").isMediaGalleryEBTaggingRestoreEnabled()&&f===c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE?"media_restore":"eb_restore";return babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT,existingMsg:b,media:l,msg:babelHelpers["extends"]({},v,{source:q}),type:v.type})}if(a===!0||g||e||l==null||b!=null&&!k)return t;if(k&&b!=null)return babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT,existingMsg:b,media:l,msg:v,type:v.type});if(h!=null)return babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME,msg:v,pendingDeleteForMeStanza:h,type:v.type});return j!=null?babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.REVOKE,msg:v,pendingRevokedStanza:j,type:v.type}):babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,media:l,msg:n==="ebrestore"?babelHelpers["extends"]({},v,{source:f===c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE?"media_restore":"eb_restore"}):v,type:v.type})})}else if(v.type===d("MAWMsgType").MSG_TYPE.XMA){var A=p==null?void 0:p.unstoredXMA;return A==null?t:d("MAWWriteXMAMessageTxns").prepareXMAWriteData(a,v,A,e).then(function(a){var b=a.xmaData.existingMsg,c=o(b,v),e=n==="ebrestore"?babelHelpers["extends"]({},a.xmaMsg,{source:"eb_restore"}):a.xmaMsg;if(a.associatedMsg!=null&&a.associatedData!=null&&!a.associatedData.isDeletedWithThread&&!a.associatedData.isDeleteForMeOrRevoked){var f,g=a.associatedMsg,h=a.associatedData.existingMsg;if(c&&b!=null)return babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED,associatedMsg:g,existingAssociatedMsg:h,existingMsg:b,msg:e,type:v.type,xma:A});if(b!=null&&a.associatedData.existingMsg!=null)return t;if([b,(f=a.associatedData)==null?void 0:f.existingMsg].filter(function(a){return a==null}).length===1){m.mustfix("[duplicate msgs] XMA and associated inconsistency: existing message not found for %s, xmaMessageType: %s, authorMe: %s, xma data: existingMsgType: %s, isDeletedWithThread: %s, isDeleteForMeOrRevoked: %s, hasPendingDeleteForMeStanza: %s, hasPendingRevokedStanza: %s, associated data: existingMsgType: %s, isDeletedWithThread: %s, isDeleteForMeOrRevoked: %s, hasPendingDeleteForMeStanza: %s, hasPendingRevokedStanza: %s",b==null?"XMA":"Associated",e==null?void 0:e.xmaMessageType,d("WAJids").isAuthorMe(e==null?void 0:e.author),b==null?void 0:b.type,(f=a.xmaData)==null?void 0:f.isDeletedWithThread,(f=a.xmaData)==null?void 0:f.isDeleteForMeOrRevoked,((f=a.xmaData)==null?void 0:f.pendingDeleteForMeStanza)!=null,((f=a.xmaData)==null?void 0:f.pendingRevokedStanza)!=null,h==null?void 0:h.type,(f=a.associatedData)==null?void 0:f.isDeletedWithThread,(f=a.associatedData)==null?void 0:f.isDeleteForMeOrRevoked,((f=a.associatedData)==null?void 0:f.pendingDeleteForMeStanza)!=null,((f=a.associatedData)==null?void 0:f.pendingRevokedStanza)!=null)}return babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE_WITH_ASSOCIATED,associatedMedia:a.associatedMedia,associatedMsg:g,existingAssociatedMsg:h,msg:e,type:v.type,xma:A})}if(c&&b!=null)return babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT,existingMsg:b,msg:e,type:v.type,xma:A});f=a.xmaData;g=f.isDeletedWithThread;h=f.isDeleteForMeOrRevoked;c=f.pendingDeleteForMeStanza;f=f.pendingRevokedStanza;if(g||h||b!=null)return t;if(c!=null)return babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME,msg:a.xmaMsg,pendingDeleteForMeStanza:c,type:v.type});return f!=null?babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.REVOKE,msg:a.xmaMsg,pendingRevokedStanza:f,type:v.type}):babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:e,type:v.type,xma:A})})}else if(v.type===d("MAWMsgType").MSG_TYPE.REVOKED)return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,v.revokedExternalId,e.jid,q.author),d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,v.externalId,e.jid,q.author)]).then(function(a){var b=a[0];a=a[1];return a!=null?t:babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,ebTimestampMs:v.ebTimestampMs,msg:v,originalMsg:b,previousRevokeMsg:a,type:v.type})});else if(v.type===d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION){w=d("WAJids").isAuthorMe(q.author)?d("WAGlobals").getMyUserJid():q.author;return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,q.externalId,e.jid,w)]).then(function(a){a=a[0];return babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,existingMsg:a,screenshotActionType:v.msgContent.screenshotActionType,type:v.type})})}else if(v.type===d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE)return d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,q.externalId,e.jid,q.author).then(function(a){return a!=null?t:babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:v,type:v.type})});else if(v.type===d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH&&y!=null)return d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,q.externalId,e.jid,q.author).then(function(a){return a!=null?t:babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:v,receiverFetchInfo:y,type:v.type})});else if(v.type===d("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE)return d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,q.externalId,e.jid,q.author).then(function(a){return a!=null||u==null?t:babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:v,pollInfo:u,type:v.type})});else if(v.type===d("MAWMsgType").MSG_TYPE.GROUP_POLL_UPDATE)return l==null||l.decrypted===void 0?t:d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:v,pollInfo:l,type:v.type}));else{m.MUSTFIX(h(),v.type);return t}case"IncomingCiphertextMsg":if(!((x=g==null?void 0:g.createPlaceholder)!=null?x:!1))return t;var B=d("MAWBuildIncomingMsgs").buildUnstoredCiphertextMsg(q,r);return d("MAWWriteMsgTxns").prepareMsgWriteData(a,B,e).then(function(a){var b=a.existingMsg,c=a.isDeletedWithThread;a=a.isDeleteForMeOrRevoked;return a||c||b!=null?t:babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:B,type:d("MAWMsgType").MSG_TYPE.CIPHERTEXT})});case"UnavailableMsg":case"FrankingInvalidMsg":var C=d("MAWBuildIncomingMsgs").buildUnstoredUnavailableMsg(q,r);return d("MAWWriteMsgTxns").prepareMsgWriteData(a,C,e).then(function(a){var b=a.existingMsg,c=a.isDeletedWithThread;a=a.isDeleteForMeOrRevoked;return a||c||b!=null?t:babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:C,type:d("MAWMsgType").MSG_TYPE.UNAVAILABLE})})}}function o(a,b,c){if(a==null&&c==null)return!1;return b.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT?!1:(a==null?void 0:a.type)===d("MAWMsgType").MSG_TYPE.CIPHERTEXT||(c==null?void 0:c.msgContent.content)===""}g.classifyIncomingMsgs=a;g.getMessageDataByType=b;g.isCiphertextUpdate=o}),98);
__d("MAWSharedOfflineResumeUINotifier",["MAWBridge","MAWQplProxy","MAWSharedProtocolQueueConst","WAOfflineUtils","WATagsLogger","WAThrottle","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose([' -> Unable to send "Offline Complete" event ',""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose([' -> "Offline Complete" bridge event sent']);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["MAW UI: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Set thread metadata: ",", ",""]);k=function(){return a};return a}var l=1e3/3,m=d("WATagsLogger").TAGS(["ProtocolQueue","MAWConsumer"]);a=function(){function a(){var a=this;this.$1={};this.$2={};this.$3=0;this.$4="wa";this.$5=!1;this.$6=0;this.$7=0;this.$8=0;this.$9=0;this.$10=null;this.$16=d("WAThrottle").throttle(function(){if(a.$5)return;a.$15(d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Processing)},l);this.$12=d("WAThrottle").throttle(function(){a.$4==="wa"&&a.$5===!1&&a.$11(d("WAOfflineUtils").WAClientInfraOfflineProgress.Processing)},l)}var b=a.prototype;b.subscribeToWAEvents=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"offline-start":b.$10=d("MAWQplProxy").performanceAbsoluteNow();b.$6=a.offlineStats.count;b.$8=a.offlineStats.message;b.$11(d("WAOfflineUtils").WAClientInfraOfflineProgress.Initializing,b.$10);b.$5=!1;b.$4="wa";break;case"offline-processed":break;case"offline-entity":b.$7++;b.$12();break;case"offline-end":b.$11(d("WAOfflineUtils").WAClientInfraOfflineProgress.Complete);b.$4="maw";break;case"connection-lost":b.$11(d("WAOfflineUtils").WAClientInfraOfflineProgress.Failed);break;default:a}})};b.subscribeToMawEvents=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"maw-infra-start":b.$10==null&&(b.$10=d("MAWQplProxy").performanceAbsoluteNow());b.$13();break;case"maw-infra-end":a.success?b.notifyUICurrentProcessingSucceeded():b.$14();b.$10=null;break}})};b.subscribeToMessageEvents=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"new-message":if(a.commonMessageBase.offline==null)return;b.addWAMessage();break}})};b.addWAMessage=function(){this.$9++,this.$12()};b.$13=function(){this.$3=0,this.$5=!1,this.$15(d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Initializing)};b.setThreadMetadata=function(a){var b=a.reduce(function(a,b){a[b.from]=b.t;return a},{});a=a.reduce(function(a,b){b=b.from;a[b]={chatStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Processing,snippetStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Processing};return a},{});m.DEV(k(),JSON.stringify(b),JSON.stringify(a));this.$1=b;this.$2=a};b.notifyUIChatReady=function(a){this.$2[a]={chatStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete,snippetStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete},this.$15(d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Processing)};b.updateChatState=function(a){var b=this;Object.entries(a).forEach(function(a){var c=a[0];a=a[1];if(b.$1[c]!=null){var e=b.$1[c];a>=e&&(b.$2[c]={chatStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete,snippetStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete})}});this.$16()};b.addMAWEntity=function(a){this.$3+=a,this.$16()};b.notifyUICurrentProcessingSucceeded=function(){var a=this;Object.keys(this.$2).forEach(function(b){a.$2[b]={chatStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete,snippetStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete}});this.$5=!0;this.$15(d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete);this.$1={};this.$2={}};b.$14=function(){var a=this;Object.keys(this.$2).forEach(function(b){a.$2[b]={chatStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete,snippetStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete}});this.$15(d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Failed);this.$1={};this.$2={}};b.maybeNotifyUI=function(){this.$16()};b.$11=function(a,b){d("MAWBridge").getBridge().fireAndForget("event","offlineSnapshot",{downloaded:{count:this.$7,message:this.$9},expected:{count:this.$6,message:this.$8},status:a,timestamp:b!=null?b:d("MAWQplProxy").performanceAbsoluteNow()})};b.$15=function(a){var b=d("MAWQplProxy").performanceAbsoluteNow();b={chatJidStatus:this.$2,startTime:this.$10!=null?this.$10:null,status:a,timestamp:b,totalExpectedCount:this.$6,totalProcessedCount:this.$3};m.LOG(j(),JSON.stringify(b));a===d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete?c("promiseDone")(d("MAWBridge").getBridge().sendAndReceive("event","offlineConsumerProgress",b),function(){m.LOG(i())},function(a){m.ERROR(h(),a)}):d("MAWBridge").getBridge().fireAndForget("event","offlineConsumerProgress",b)};return a}();b=new a();g.ConsumerUINotifier=a;g.offlineResumeUINotifier=b}),98);
__d("MAWBulkHandleIncomingMsgApi",["LSMEBTaskCreationSource","MAWBulkEditMsgsTxns","MAWBulkWriteReactionsTxns","MAWDbThreadTxns","MAWDexieTable","MAWHIMLogger","MAWHandleIncomingMsgApi","MAWIndexedDb","MAWLinkReactionsToMsgsTxns","MAWMsgActionType","MAWMsgType","MAWODSProxy","MAWOfflineThreadTxns","MAWPreprocessMsgs","MAWReceiverBumpEligibilityCache","MAWSharedOfflineQueueMetric","MAWSharedOfflineResumeUINotifier","MAWThreadFetchAndEmitTxns","MAWTransactionMode","WAMsgMap","WAOdsEnums","WAResultOrError","qex"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unexpected overwrite on WRITE action. Current type: ",", next type: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Should never have 'write' and 'delete' in same OQ batch"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Should never have 'update ciphertext' and 'delete' in same OQ batch"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Handling message with StanzaID ",", action "," and type ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Handling "," messages"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot create thread for message. Reason: ",". StanzaID ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot create thread for message. Reason: ","."]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["Previous message processing action failed so subsequent one can't succeed"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["ERROR!!! At this point we must have fields in the map, ",""]);p=function(){return a};return a}function a(a,b){var e;return d("MAWIndexedDb").makeMsgrTransactor({chunk:(e=d("MAWTransactionMode")).READONLY,deletedMessages:e.READWRITE,deviceChangeAlerts:e.READWRITE,editMsgHistory:e.READWRITE,ephemeralSettings:e.READWRITE,ftsBackloggedMessages:e.READWRITE,ftsPurgeBacklog:e.READWRITE,groupInfo:e.READWRITE,groupInvites:e.READWRITE,media:e.READWRITE,mediaBackup:e.READWRITE,messages:e.READWRITE,participants:e.READWRITE,pendingReceipts:e.READWRITE,pendingStanzas:e.READWRITE,poll:e.READWRITE,reactions:e.READWRITE,receiverFetchInfo:e.READWRITE,threads:e.READWRITE,unrenderedMessages:e.READWRITE,xma:e.READWRITE},"bulkHandleIncomingMsgs",function(e){return function(){var f=new(d("WAMsgMap").MsgMap)();d("MAWODSProxy").odsBumpEntityKey({amount:a.length,entity:d("WAOdsEnums").Entity.TOTAL_INCOMING_MESSAGE,key:"msgs"});d("MAWDexieTable").setDexiePSDItem("offlineQueueSize",a.length);d("MAWReceiverBumpEligibilityCache").updateReceiverBumpEligibilityCache(a);var g=new Set(a.map(function(a){a=a.msgData;return a.id.chat})),h=d("MAWPreprocessMsgs").classifyIncomingMsgs(a),i=h.editActionMsgs,j=h.reactionMsgs,k=function(a,b){var e=f.get(a);!b.success?f.set(a,b):e==null?c("MAWHIMLogger").MUSTFIX(p(),String(b)):!e.success?c("MAWHIMLogger").WARN(o()):f.set(a,d("WAResultOrError").makeResult(babelHelpers["extends"]({},e.value,b.value)))},l=function(a,b){f.set(a,d("WAResultOrError").makeResult({protocolMsgId:a,unknownGroup:b==="missing"}))},s=function(f){var g=f.threadCreationResult,h=f.threads;return d("MAWDexieTable").dexieAll(a.map(function(a){var f,i=h.get(a.msgData.id.chat);f=(f=g.get(a.msgData.id.chat))!=null?f:"missing";if(i==null){c("MAWHIMLogger").MUSTFIX(n(),f);c("MAWHIMLogger").DEBUG(m(),f,a.msgData.id.externalId);return}l(a.msgData.id,f);return d("MAWPreprocessMsgs").getMessageDataByType(e,a,i,b)}).filter(Boolean))["catch"](function(a){a.message="[getAllMessagesProcessingData] "+a.message;throw a})},v=b!==c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE,w=function(a){a=t(a);var b=d("MAWDexieTable").dexieResolve();a.forEach(function(a){b=b.then(function(){return d("MAWHandleIncomingMsgApi").handleIncomingMsg(e,a,v)}).then(function(b){k(a.id,b),r(a.id,a.ts)})});b["catch"](function(a){a.message="[writeIncomingMsgs] "+a.message;throw a});return b},x=function(){return i.length===0?d("MAWDexieTable").dexieResolve():d("MAWBulkEditMsgsTxns").prepareDataForMessageEdit(e,i).then(function(a){return d("MAWBulkEditMsgsTxns").bulkEditMsgs(e,i,a)})};h=function(){return q(e,g).then(function(a){return d("MAWDexieTable").dexieAll([s(a),d("MAWBulkWriteReactionsTxns").prepareReactionsData(e,j)]).then(function(a){var b=a[0];a=a[1];return d("MAWBulkWriteReactionsTxns").bulkWriteReactions(e,a).then(function(){return w(b)}).then(function(){return x()}).then(function(){return d("MAWThreadFetchAndEmitTxns").emitThreadContents(e,g)}).then(function(){return u(e,f)}).then(function(){return{msgResults:f}})})})};var y=function(){return q(e,g).then(function(a){return d("MAWDexieTable").dexieAll([s(a),d("MAWBulkWriteReactionsTxns").prepareReactionsData(e,j)])}).then(function(a){var b=a[0];a=a[1];return d("MAWDexieTable").dexieAll([w(b).then(x),d("MAWBulkWriteReactionsTxns").bulkWriteReactions(e,a)])}).then(function(){return d("MAWDexieTable").dexieAll([u(e,f),d("MAWThreadFetchAndEmitTxns").emitThreadContents(e,g)])}).then(function(){return{msgResults:f}})},z=c("qex")._("3654");return z===!0?y():h()}})()}function q(a,b){var c=Array.from(b);return d("MAWDbThreadTxns").getThreads(a,c).then(function(b){return d("MAWOfflineThreadTxns").createAllThreadsForOfflineMsgs(a,c,b)})}function r(a,b){var c;a=a.chat.toString();d("MAWSharedOfflineResumeUINotifier").offlineResumeUINotifier.updateChatState((c={},c[a]=b,c));d("MAWSharedOfflineResumeUINotifier").offlineResumeUINotifier.addMAWEntity(1);(a=d("MAWSharedOfflineQueueMetric").getOfflineQueueMetric())==null?void 0:a.addMAWEntity(1)}var s=c("MAWHIMLogger").tags(["MergeActions"]);function t(a){s.DEBUG(l(),a.length);var b=new(d("WAMsgMap").MsgMap)();for(var c of a){s.DEBUG(k(),c.id.externalId,c.action,c.type);c.receiveFlow.addPoint("him_merge_actions");var e=b.get(c.id);if(e==null){b.set(c.id,c);continue}if(e.action===c.action&&e.type===c.type){c.receiveFlow.addAnnotations({bool:{merge_actions_duplicate:!0}});continue}switch(c.action){case d("MAWMsgActionType").MSG_ACTION.NO_ACTION:continue;case d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT:case d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED:if(e.action===d("MAWMsgActionType").MSG_ACTION.REVOKE||e.action===d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME){s.MUSTFIX(j());continue}b.set(c.id,c);continue;case d("MAWMsgActionType").MSG_ACTION.WRITE:case d("MAWMsgActionType").MSG_ACTION.WRITE_WITH_ASSOCIATED:if(e.action===d("MAWMsgActionType").MSG_ACTION.REVOKE||e.action===d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME){s.MUSTFIX(i());continue}switch(c.type){case d("MAWMsgType").MSG_TYPE.UNAVAILABLE:break;case d("MAWMsgType").MSG_TYPE.CIPHERTEXT:e.type===d("MAWMsgType").MSG_TYPE.UNAVAILABLE&&b.set(c.id,c);break;default:s.WARN(h(),e.type,c.type),b.set(c.id,c)}break;case d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME:case d("MAWMsgActionType").MSG_ACTION.REVOKE:e.action!==d("MAWMsgActionType").MSG_ACTION.REVOKE&&b.set(c.id,c);break}}e=[];for(c of a){var f;a=b.get(c.id);c.receiveFlow.addAnnotations({string:{final_action:(f=a==null?void 0:a.action)!=null?f:"undefined",final_msg_type:(f=a==null?void 0:a.type)!=null?f:"undefined",has_replaced_action:(c!==a).toString(),initial_action:c.action,initial_msg_type:c.type}});if(a==null||a.action===d("MAWMsgActionType").MSG_ACTION.NO_ACTION)continue;e.push(a);b["delete"](c.id)}return e}function u(a,b){var c=new Set();b.values().forEach(function(a){if(a.success){a=a.value;var b=a.protocolMsgId;a=a.reactToExternalId;a!=null?c.add(a):b!=null&&c.add(b.externalId)}});return d("MAWLinkReactionsToMsgsTxns").getReactionLinkUpdatesForExternalIds(a,Array.from(c)).then(function(b){return d("MAWLinkReactionsToMsgsTxns").updateReactionLinks(a,b)})}g.bulkHandleIncomingMsgs=a;g.linkMsgsToReactions=u}),98);
__d("MAWCommonScheduler",["WorkerScheduler"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(){h==null&&(h=d("WorkerScheduler").makeScheduler("msgr-common",{concurrency:1,maxConcurrency:10,maxThrottleMs:5e3}));return h}g.mawCommonScheduler=a}),98);
__d("MAWSharedCOPLogger",["MWFBLogger"],(function(a,b,c,d,e,f,g){"use strict";a=d("MWFBLogger").MWLogger.tags(["COP"]);g["default"]=a}),98);
__d("WADexiePersistedQueueApi",["MAWTransactionMode","WADbTransactor"],(function(a,b,c,d,e,f,g){"use strict";function a(){return{ack:k,clear:m,"delete":l,index:i,keys:n,read:h,write:j}}function h(a,b){return d("WADbTransactor").persistedQueueTransactor(a,d("MAWTransactionMode").READONLY,function(a){a=a.toCollection();(b==null?void 0:b.order)==="desc"&&(a=a.reverse());(b==null?void 0:b.filter)!=null&&(a=a.filter(b.filter));(b==null?void 0:b.limit)!=null&&(a=a.limit(b.limit));return a.toArray()},"read")}function i(a,b){return{equals:function(c){return{read:function(e){return d("WADbTransactor").persistedQueueTransactor(a,d("MAWTransactionMode").READONLY,function(a){a=a.where(b).equals(c.length===1?c[0]:c);(e==null?void 0:e.order)==="desc"&&(a=a.reverse());(e==null?void 0:e.filter)!=null&&(a=a.filter(e.filter));(e==null?void 0:e.limit)!=null&&(a=a.limit(e.limit));return a.toArray()},"index-equal")}}},keys:function(){return d("WADbTransactor").persistedQueueTransactor(a,d("MAWTransactionMode").READONLY,function(a){a=a.orderBy(b);return a.uniqueKeys()},"index-keys")},read:function(c){return d("WADbTransactor").persistedQueueTransactor(a,d("MAWTransactionMode").READONLY,function(a){a=a.orderBy(b);(c==null?void 0:c.order)==="desc"&&(a=a.reverse());(c==null?void 0:c.filter)!=null&&(a=a.filter(c.filter));(c==null?void 0:c.limit)!=null&&(a=a.limit(c.limit));return a.toArray()},"index-read")}}}function j(a,b){return d("WADbTransactor").persistedQueueTransactor(a,d("MAWTransactionMode").READWRITE,function(a){return a.bulkAdd(b).then(function(){})},"write")}function k(a,b){return d("WADbTransactor").persistedQueueTransactor(a,d("MAWTransactionMode").READWRITE,function(a){return a.bulkDelete(b)},"ack")}function l(a,b){return d("WADbTransactor").persistedQueueTransactor(a,d("MAWTransactionMode").READWRITE,function(a){return a.bulkDelete(b)},"delete")}function m(a){return d("WADbTransactor").persistedQueueTransactor(a,d("MAWTransactionMode").READWRITE,function(a){return a.clear().then(function(){})},"clear")}function n(a){return d("WADbTransactor").persistedQueueTransactor(a,d("MAWTransactionMode").READONLY,function(a){a=a.toCollection();return a.primaryKeys()},"keys")}g.dexieApiForPersistedQueue=a;g.persistedQueueRead=h;g.persistedQueueIndex=i;g.persistedQueueWrite=j;g.persistedQueueAck=k;g.persistedQueueDelete=l;g.persistedQueueClear=m;g.persistedQueueKeys=n}),98);
__d("MAWDbStaleQueue",["MAWODSProxy","MAWSharedCOPLogger","WADexiePersistedQueueApi","WAGetPlatformFromStanzaId","WAOdsEnums","WAPersistedQueue"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Dropping: ",", error: ",". Source: ",""]);h=function(){return a};return a}var i=null;function j(){if(i)return i;var a=d("WAPersistedQueue").initPersistedQueue("staleQueue",d("WADexiePersistedQueueApi").dexieApiForPersistedQueue());i=a;return a}function a(a,b){var e=a.type==="message"?a.subtype!=null?d("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(a.stanzaId):d("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(a.message.details.externalId):null;c("MAWSharedCOPLogger").MUSTFIX(h(),a.type,b,e);d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.POISON_QUEUE_ENTTITY,key:""+a.type});e=j();return a.type!=="message"?Promise.resolve():e.addAndCommit([{exception:b,stanza:a}])}b=function(){return j().read({limit:1}).then(function(a){return a.length===0})};e=async function(a){a===void 0&&(a=500);a=j().read({limit:a});a=await a.then(function(a){return a.flatMap(function(a){return a})});return a};g.mawAddStaleStanza=a;g.isEmpty=b;g.read=e}),98);
__d("MAWDebugMsg",["MAWBridgeMsg","MAWDbMsg","MAWDbMsgTxns","MAWDbThreadTxns","MAWDexieTable","MAWExternalId","MAWIndexedDb","MAWLocalizationType","MAWLocalizationUtils","MAWMsgType","MAWTransactionMode","MAWTransactor","WATimeUtils","gkx"],(function(a,b,c,d,e,f,g){"use strict";b=d("MAWTransactor").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,groupInfo:a.READONLY,media:a.READONLY,messages:a.READWRITE,participants:a.READONLY,threads:a.READWRITE},"writeDebugMsg",function(a){return function(b,e,f){return!c("gkx")("23958")?d("MAWDexieTable").dexieResolve():d("MAWDbThreadTxns").getThread(a,b).then(function(b){if(!b.success)return;var c=b.value;return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").getThreadNewestMessageBySortOrder(a,c.jid),d("MAWDbMsgTxns").getThreadNewestMessageTs(a,c),(f==null?void 0:f.decryptionError)==="errDuplicateMsg"?d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,f.protocolMsgId).then(function(a){if(a==null)return", no existing message";return a.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT?", existing ciphertext message":",  existing message"}):d("MAWDexieTable").dexieResolve(""),d("MAWDbMsgTxns").getNextMsgIdNumberForThread(a,c)]).then(function(a){var b=a[0],f=a[1],g=a[2];a=a[3];a=d("MAWDbMsg").craftDebugMsgId(c.chatId,a-1);f=d("WATimeUtils").castToMillisTime(((b=(b=b==null?void 0:b.sortOrderMs)!=null?b:f)!=null?b:0)+1);b=d("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:["[fb-only][DEBUG]: "+(e+g)],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.DEBUG_MSG,version:0},c.jid,d("MAWExternalId").generateExternalId());d("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:d("MAWBridgeMsg").createBridgeMsg(babelHelpers["extends"]({},b,{msgId:a,sortOrderMs:f}))})})})}});g.writeDebugMsg=b}),98);
__d("MAWGetMsgIdByProtocolMsgId",["MAWDbMsgTxns","MAWDbReactionsTxns","MAWDbUnrenderedMsgTxns","MAWDexieTable","MAWIndexedDb","MAWMsgType","MAWTransactionMode","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";b=d("MAWIndexedDb").makeMsgrTransactor({messages:(a=d("MAWTransactionMode")).READONLY,reactions:a.READONLY,threads:a.READONLY,unrenderedMessages:a.READONLY},"getMsgIdByProtocolMsgId",function(a){return function(b){return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgResultByProtocolMsgId(a,b),d("MAWDbReactionsTxns").maybeGetReactionByProtocolMsgId(a,b),d("MAWDbUnrenderedMsgTxns").maybeGetUnrenderedMsgByProtocolMsgId(a,b)]).then(function(a){var b=a[0],c=a[1];a=a[2];if(b.success)return d("WAResultOrError").makeResult(b.value.msgId);else if(c!=null)return d("WAResultOrError").makeResult(c.reactionId);else if(a.success&&a.value.type===d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME)return d("WAResultOrError").makeResult(a.value.msgId);var e="missing_msg_in_db";b=b.error;a=a.error;if(b==="missing_msg"&&c==null&&a==="missing_unrendered_msg")e="missing_all_db_msg";else if(b==="missing_thread_msg"&&a==="missing_thread_unrendered_msg")e="missing_all_thread";else if(b==="missing_thread_msg"||a==="missing_thread_unrendered_msg"){e=b+"__"+((c=a)!=null?c:"unrenderedMsgResultNoError")}return d("WAResultOrError").makeError(e)})}});g.getMsgIdByProtocolMsgId=b}),98);
__d("WAIsDownloadMediaErrorRetryable",[],(function(a,b,c,d,e,f){"use strict";a=function(a){switch(a){case"media-entry-invalid":case"media-entry-invalid-direct-path":case"media-entry-invalid-file-enc-sha256":case"media-entry-invalid-file-sha256":case"media-entry-invalid-media-key":case"media-entry-invalid-server-media-type":case"hash-mismatch":case"ciphertext-hash-mismatch":case"enc-hash-mismatch":case"decryption-error":case"invalid-webp":case"invalid-mp4":return!1;case"create-payload-failed":case"resign-cdn-url-request-error":case"resign-cdn-url-runtime-error":case"resign-cdn-url-gql-error":case"direct-path-undefined":case"direct-path-corrupted":case"direct-path-empty":case"resign-cdn-url-timeout":case"missing-media-entry":case"missing-media-entry-for-restore":case"missing-sort-order-ms-for-restore":case"signature-expired":case"max-attempts-exceeded":case"request-error":case"download-throttled":case"media-not-found":case"no-host":case"backoff":case"body-network-error":case"disconnected":case"runtime-error":case"access-expired":case"http-fetch-exception":case"unspecified-http-error":case"server-timeout":case"preview-not-supported":return!0;default:a;return!0}};f.isDownloadMediaErrorRetryable=a}),66);
__d("MAWDownloadAndHandleMedia",["MAWAckLevel","MAWCastToMsgrServerMediaType","MAWConfig","MAWDbMsgTxns","MAWEBSwitch","MAWGetMostRescentDecodedMediaEntry","MAWGetMsgByProtocolIdApi","MAWGetMsgIdByProtocolMsgId","MAWHandleEchoMediaMsgsRestoreV2","MAWHandleMediaDownloadApi","MAWHandleMediaPreviewBeforeDownloadApi","MAWHandleMediaPreviewDownloadApi","MAWHandleMediaPreviewDownloadAsFailedApi","MAWIndexedDb","MAWIsMsgDeletedWithReason","MAWJobDefinitions","MAWJobManager","MAWLoggerUtils","MAWMediaDownloadStatus","MAWMediaDownloadStatusForUI","MAWMediaManager","MAWMediaManagerUiIntegrationCheck","MAWQplProxy","MAWShadowTestMediaStorage","MAWTransactionMode","MAWUpdateMediaEntryForMsgApi","MAWVideoAudioValidationUtils","MWFBLogger","Random","WAAPI","WAErrorMessage","WAHashUtils","WAIsDownloadMediaErrorRetryable","WAIsMediaExpiredError","WAIsMp4","WAIsWebP","WAJids","WAJobOrchestratorTypes","WAMediaCrypto","WAMediaManager","WAMediaUtils","WAPrewarmMediaValidate","WAResultOrError","WAStartMediaDownloadQplFlow","WAValidateMedia","cr:10071","gkx","justknobx","qpl"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["media validation audioStreamReport: ",", videoStreamReport: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["media validation was skipped: ",", setup_failed: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to validate media: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to validate for msg ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media for msg ",", error: "," "]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["fail to resign cdn url. ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url sproc start. ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url gql error: ",". ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url gql success. ",""]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url gql failed: ",". ",""]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url gql start. ",""]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["media key expired, resign cdn url for msgId: ",". isEBDownloadEnforced: ",""]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to prewarm media validate"]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["downloadAndHandleMedia: Failed to get DecodedMediaEntry - reason: ",""]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["downloadAndHandleMedia: Missing msgId in Db - reason: "," msgType: ",""]);v=function(){return a};return a}function w(){var a=babelHelpers.taggedTemplateLiteralLoose(["DownloadAndHandleMedia: "," hash with "," msgId, entry ",""]);w=function(){return a};return a}function x(){var a=babelHelpers.taggedTemplateLiteralLoose(["start legacy downloadAndHandleMedia"]);x=function(){return a};return a}function y(){var a=babelHelpers.taggedTemplateLiteralLoose(["Persist media runtime-error"]);y=function(){return a};return a}function z(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media for ",""]);z=function(){return a};return a}function A(){var a=babelHelpers.taggedTemplateLiteralLoose(["fullsize download runtime-error"]);A=function(){return a};return a}function B(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media preview: ",""]);B=function(){return a};return a}function C(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error: preview not supported"]);C=function(){return a};return a}function D(){var a=babelHelpers.taggedTemplateLiteralLoose(["start Media Manager downloadAndHandleMedia. msgType: ",""]);D=function(){return a};return a}var E=d("MWFBLogger").MWMediaLogger.tags([d("MAWLoggerUtils").Tag.MediaDownload,d("MAWLoggerUtils").Tag.MessageReceive]),F=0;a=d("MAWJobManager").getPersistedJobsApi().definePersistedJob().finalStep("downloadAndHandleMedia",function(a){var b=a.hash,c=a.msgType,e=a.protocolMsgId;a=a.qplEntryPoint;var f=d("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:a,msgType:c,protocolMsgId:e,triggerUIView:null});return G({downloadEntry:a,hash:b,mediaDownloadFlow:f,msgType:c,protocolMsgId:e})}).end();async function G(a){var b=a.downloadEntry,d=a.downloadType;d=d===void 0?"fullsizeAndPreview":d;var e=a.hash,f=a.mediaDownloadFlow,g=a.msgType;a=a.protocolMsgId;M(e,"download_and_handle_media");if(c("gkx")("5850")){await H({downloadEntry:b,downloadType:d,hash:e,mediaDownloadFlow:f,msgType:g,protocolMsgId:a});return}return K({hash:e,mediaDownloadFlow:f,msgType:g,protocolMsgId:a})}async function H(a){var b=a.downloadEntry,c=a.downloadType,e=a.hash,f=a.mediaDownloadFlow,g=a.msgType;a=a.protocolMsgId;E.DEBUG(D(),g);f.addAnnotations({string:{msgType:g}});g={fullSizePlaintextHash:e,mediaDownloadFlow:f,priority:T(b)};if(c==="preview"&&d("MAWMediaManagerUiIntegrationCheck").getIsMediaManagerUiIntegrationEnabled()){b=d("MAWMediaManager").getMawMediaManager().enqueueDownloadPreview(g);return I({hash:e,previewPromise:b,protocolMsgId:a})}if(c==="fullsize"&&d("MAWMediaManagerUiIntegrationCheck").getIsMediaManagerUiIntegrationEnabled()){b=d("MAWMediaManager").getMawMediaManager().enqueueDownloadFullSize(g);return J({fullsizePromise:b,hash:e,mediaDownloadFlow:f,protocolMsgId:a})}c=await d("MAWMediaManager").getMawMediaManager().enqueueDownloadFullSizeAndPreview(g);b=c.fullsizePromise;g=c.previewPromise;void I({hash:e,previewPromise:g,protocolMsgId:a});return J({fullsizePromise:b,hash:e,mediaDownloadFlow:f,protocolMsgId:a})}function I(a){var b=a.hash,c=a.previewPromise,e=a.protocolMsgId;return d("MAWHandleMediaPreviewBeforeDownloadApi").handleMediaPreviewBeforeDownload(b).then(function(){return c}).then(function(a){if(a.success===!1){if(a.error==="preview-not-supported"){E.DEBUG(C());return}return Promise.reject(a.error)}else{var c=d("WAMediaCrypto").convertServerMediaTypeToPreviewMediaType(a.value.serverMediaType);return c==null?Promise.reject("unsupported preview media type "+a.value.serverMediaType):d("MAWHandleMediaPreviewDownloadApi").handleMediaPreviewDownload(b,a.value.validatedResult.validatedPlaintext,c,e)}}).catch(function(a){E.DEBUG(B(),a);return d("MAWHandleMediaPreviewDownloadAsFailedApi").handleMediaPreviewDownloadFailed(b,a.toString()).then(function(){return Promise.reject(a)})})}async function J(a){var b,e=a.fullsizePromise,f=a.hash,g=a.mediaDownloadFlow;a=a.protocolMsgId;e=await e.catch(function(a){E.catching(a).MUSTFIX(A());return d("WAResultOrError").DEPRECATED_makeError("runtime-error",a)});if(e.success===!1){E.DEBUG(z(),String(a));g.endFail(e.error,{string:{failReason:e.payload==null?e.error:d("WAErrorMessage").maybeGetMessageFromError(e.payload)}});O(f,e.error);return}b=(b=e.value.validatedResult.mimeType)!=null?b:e.value.unvalidatedMimeType;g.addPoint("handle_media_download_start");var h=window.performance.now();b=await d("MAWHandleMediaDownloadApi").handleMediaDownload(f,b,e.value.validatedResult.validatedPlaintext,a,e.value.validatedResult).catch(function(a){E.catching(a).MUSTFIX(y());return d("WAResultOrError").DEPRECATED_makeError("runtime-error",a)});a=window.performance.now();c("gkx")("14317")&&R({filePlaintext:e.value.validatedResult.validatedPlaintext,idbReadLatency:a-h});b.success||(g.endFail("handle_media_download_fail",{string:{failReason:b.payload==null?b.error:d("WAErrorMessage").maybeGetMessageFromError(b.payload)}}),P(f,b.error));g.addPoint("handle_media_download_end");g.endSuccess();N(f,e.value.validatedResult)}async function K(a){var e=a.hash,f=a.mediaDownloadFlow,g=a.msgType,y=a.protocolMsgId;E.DEBUG(x());E.DEBUG(w(),d("WAHashUtils").sanitisePlaintextHash(e),String(y),f.downloadEntry);f.addPoint("maw_pre_download_start");a=await d("MAWGetMsgIdByProtocolMsgId").getMsgIdByProtocolMsgId(y);if(!a.success){var z=await d("MAWIsMsgDeletedWithReason").isMsgDeletedWithReason(y);if(z){f.addPoint("media_deleted");f.endSuccess();Q(e,"media_deleted");return}f.addPoint("maw_pre_download_fail");f.endFail(a.error,{string:{failReason:a.error}});E.MUSTFIX(v(),a.error,g);Q(e,a.error);return}var A=a.value;z=await d("MAWGetMostRescentDecodedMediaEntry").getMostRecentDecodedMediaEntry(e);if(!z.success){f.addPoint("maw_pre_download_fail");f.endFail(z.error,{string:{failReason:z.error}});E.MUSTFIX(u(),z.error);await L(A);Q(e,z.error);return}g=z.value;try{d("WAPrewarmMediaValidate").prewarmMediaValidate(g.serverMediaType)}catch(a){E.catching(a).MUSTFIX(t())}f.addPoint("maw_pre_download_end");a=c("MAWEBSwitch").isEnabled()&&c("gkx")("23960");a&&f.addPoint("forcing_eb_download");z=function(){F++;f.addAnnotations({int:{fileCount:F}});return d("MAWHandleMediaPreviewDownloadApi").handleMediaPreviewDownload.apply(void 0,arguments).finally(function(){F--})};z=a?d("WAResultOrError").makeError("signature-expired"):await c("WAAPI").downloadMedia({downloadMediaMetric:f,handleMediaPreviewBeforeDownload:d("MAWHandleMediaPreviewBeforeDownloadApi").handleMediaPreviewBeforeDownload,handleMediaPreviewDownload:z,handleMediaPreviewDownloadFailed:d("MAWHandleMediaPreviewDownloadAsFailedApi").handleMediaPreviewDownloadFailed,hash:e,mediaEntry:g,protocolMsgId:y,updateMediaEntryForMsg:d("MAWUpdateMediaEntryForMsgApi").updateMediaEntryForMsg});f.addPoint("maw_post_download_start");if(z.success===!1){var B=g.objectId;g=g.serverMediaType;var C=d("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(g);c("MAWEBSwitch").isEnabled()&&d("WAIsMediaExpiredError").isMediaExpiredError(z.error)&&B!=null&&C!=null?(E.DEBUG(s(),A,a),void d("MAWGetMsgByProtocolIdApi").getMsgsByProtocolMsgIdsTxn([y]).then(function(a){a=a[0]||{};a=a.sortOrderMs;if(a==null){f.addPoint("resign_cdn_url_missing_sort_order");return}var c=d("WAMediaUtils").stringToDeliveryObjectId(B),g=f.getFlowDetails().instanceKey.toString(),h={string:{externalId:y.externalId,mediaType:C,objectId:c,restoreEntry:"downloadAndHandleMedia",restoreMethod:b("cr:10071")==null?"sproc":"gql"}};f.addPoint("resign_cdn_url_start",h);var i="hash: "+d("WAHashUtils").sanitisePlaintextHash(e)+". msgId: "+A+". traceId: "+g;if(b("cr:10071")!==null)E.DEBUG(r(),i),f.addPoint("resign_cdn_url_gql_start"),void b("cr:10071").eblsResignCdnUrlWithGraphQL({chatJid:y.chat,deliveryObjectId:c,externalId:y.externalId,mediaType:C,sortOrderMs:a}).then(function(a){if(a.success===!1){a.error==="direct-path-undefined"?P(e,a.error):Q(e,a.error);E.DEBUG(q(),a.error,i);f.endFail(a.error,{string:{failReason:a.error}});return}E.DEBUG(p(),i);f.addPoint("resign_cdn_url_gql_success");a=d("MAWJobDefinitions").createStartJobInfo("downloadAndRestoreMedia",{deliveryObjectId:c,mediaDownloadFlow:f,msgId:A,plaintextHash:e,restorationCdnUrl:a.value,scheduleConfig:{priority:d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION},traceId:f.getFlowDetails().instanceKey});f.addPoint("download_and_restore_media_fire");return d("MAWJobManager").getJobManager().fireAndForget(a)}).catch(function(a){P(e,"resign_gql_"+a),E.MUSTFIX(o(),a,i),f.endFail("runtime-error",{string:{failReason:a.toString()}})});else{E.DEBUG(n(),i);f.addPoint("resign_cdn_url_sproc_start");h={attachmentObjectId:c,mediaType:C,messageId:y.externalId,messageTimeStamp:a,msgId:A,plaintextHash:e,productType:d("MAWConfig").getConfig().productTypeForEBAttachments,threadId:d("WAJids").threadIdForChatJid(y.chat),threadJid:y.chat};void d("MAWHandleEchoMediaMsgsRestoreV2").invokeRestoreAccessCheckSprocToDownloadAttachment(y.externalId,h,f)}}).catch(function(a){P(e,"resign_sproc_"+a),E.MUSTFIX(m(),a),f.endFail("resign_cdn_url_fail",{string:{failReason:a.toString()}})})):(d("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:z.error,hash:e,status:d("MAWMediaDownloadStatusForUI").getStatusFromWAAPIDownloadMediaError(z.error),type:"main"}),f.endFail("maw_post_download_fail",{string:{failReason:z.error}}),E.MUSTFIX(l(),A,z.error),await L(A));return}z.success;g=z.value;a=g.mimeType;z=g.plaintext;g=d("WAIsWebP").isWebP(new Uint8Array(z))||d("WAIsMp4").isMp4(new Uint8Array(z));var D=null;if(g){D=await d("WAValidateMedia").validateMedia(z,f);if(D.success===!1){f.endFail(D.error,{string:{failReason:D.error}});E.DEBUG(k(),A);E.MUSTFIX(j(),D.error);await L(A);d("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:D.error,hash:e,status:c("MAWMediaDownloadStatus").NOT_MANUAL_RETRYABLE_FAILURE,type:"main",validationResult:{audioAvgBitsPerSecond:null,audioNumberOfChannels:null,audioSamplingRate:null,audioStreamType:null,validatedMimeType:D.error,videoAvgBitsPerSecond:null,videoCalculatedFps:null,videoDuration:null,videoHeight:null,videoNominalFps:null,videoStreamType:null,videoWidth:null}});return}g=D.value;var G=g.audioStreamReport,H=g.mimeType,I=g.skipValidation;g.validatedPlaintext;var J=g.validationSetupFailed;g=g.videoStreamReport;E.DEBUG(i(),I,J);E.DEBUG(h(),String(G),String(g));d("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:"media_validation_success",hash:e,status:c("MAWMediaDownloadStatus").DOWNLOADING,type:"main",validationResult:d("MAWVideoAudioValidationUtils").normalizeValidationResult({audioAvgBitsPerSecond:G==null?void 0:G.avgBitsPerSecond,audioNumberOfChannels:G==null?void 0:G.numberOfChannels,audioSamplingRate:G==null?void 0:G.samplingRate,audioStreamType:G==null?void 0:G.streamType,validatedMimeType:H,videoAvgBitsPerSecond:g==null?void 0:g.avgBitsPerSecond,videoCalculatedFps:g==null?void 0:g.calculatedFps,videoDuration:g==null?void 0:g.duration,videoHeight:g==null?void 0:g.videoHeight,videoNominalFps:g==null?void 0:g.nominalFps,videoStreamType:g==null?void 0:g.streamType,videoWidth:g==null?void 0:g.videoWidth})})}I=z;f.addPoint("handle_media_download_start");G=await d("MAWHandleMediaDownloadApi").handleMediaDownload(e,a,I,y,(J=D)==null?void 0:J.value);if(G.success){f.addPoint("handle_media_download_end");N(e,(H=D)==null?void 0:H.value)}else f.addPoint("maw_post_download_fail"),f.endFail("handle_media_download_fail_"+G.error,{string:{failReason:G.error}}),P(e,G.error);f.addPoint("maw_post_download_end");f.endSuccess()}async function L(a){if(c("gkx")("4219")&&c("justknobx")._("2092"))return;await d("MAWIndexedDb").makeMsgrTransactor({chunk:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READWRITE,receiverFetchInfo:d("MAWTransactionMode").READONLY,xma:d("MAWTransactionMode").READONLY},"downloadMedia",function(a){return function(b,c){return d("MAWDbMsgTxns").updateSystemAck(a,b,c)}})(a,d("MAWAckLevel").ACK.failed)}function M(a,b){d("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:b,hash:a,status:c("MAWMediaDownloadStatus").DOWNLOADING,type:"main"})}function N(a,b){b=(b=b)!=null?b:{};var e=b.audioStreamReport,f=b.mimeType;b=b.videoStreamReport;d("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:"handle_media_download_end",hash:a,status:c("MAWMediaDownloadStatus").SUCCESS,type:"main",validationResult:d("MAWVideoAudioValidationUtils").normalizeValidationResult({audioAvgBitsPerSecond:e==null?void 0:e.avgBitsPerSecond,audioNumberOfChannels:e==null?void 0:e.numberOfChannels,audioSamplingRate:e==null?void 0:e.samplingRate,audioStreamType:e==null?void 0:e.streamType,validatedMimeType:f,videoAvgBitsPerSecond:b==null?void 0:b.avgBitsPerSecond,videoCalculatedFps:b==null?void 0:b.calculatedFps,videoDuration:b==null?void 0:b.duration,videoHeight:b==null?void 0:b.videoHeight,videoNominalFps:b==null?void 0:b.nominalFps,videoStreamType:b==null?void 0:b.streamType,videoWidth:b==null?void 0:b.videoWidth})})}function O(a,b){d("WAIsDownloadMediaErrorRetryable").isDownloadMediaErrorRetryable(b)?P(a,b):Q(a,b)}function P(a,b){d("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:b,hash:a,status:c("MAWMediaDownloadStatus").MANUAL_RETRYABLE_FAILURE,type:"main"})}function Q(a,b){d("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:b,hash:a,status:c("MAWMediaDownloadStatus").NOT_MANUAL_RETRYABLE_FAILURE,type:"main"})}function R(a){var b=a.filePlaintext;a=a.idbReadLatency;var e=d("Random").random()<S()/100;if(!e)return;e=d("Random").uint32();e=d("MAWQplProxy").startQplUserFlow(c("qpl")._(521472095,"2859"),{int:{input_file_size:b.byteLength},string:{storage_type:"idb"}},{providedInstanceKey:e});e.addAnnotations({double:{read_latency:a}});e.endSuccess();void d("MAWShadowTestMediaStorage").runMediaStorageShadowTesting(b)}function S(){return c("gkx")("2067")?100:c("justknobx")._("4271")}function T(a){switch(a){case"UILayout":case"DYIMediaManager":return d("WAMediaManager").MediaTaskPriority.HIGH;case"MebWAMediaDownloader":case"InstamadilloAddMessageMediaContent":case"MAWDyiDownloadMedia":case"WAIncomingMsg":return d("WAMediaManager").MediaTaskPriority.MEDIUM;case"MAWHandleFutureproofMsg":case"handleEchoMediaMsgsRestore":case"SyncMedia":case"EBRestore":return d("WAMediaManager").MediaTaskPriority.LOW}}g.downloadAndHandleMedia=a;g.downloadAndHandleMediaImpl=G;g.sendUIStatusDownloading=M;g.sendUIStatusSuccess=N;g.sendUIStatusFailure=O;g.getPriorityFromDownloadEntry=T}),98);
__d("MAWIsQuotaExceededError",[],(function(a,b,c,d,e,f){"use strict";a=function(a){return a.name==="QuotaExceededError"||a.inner&&a.inner.name==="QuotaExceededError"};f.isQuotaExceededError=a}),66);
__d("WAParseV3Protocol",["WAAckLevel","WAAssertUnreachable","WAGlobals","WAHex","WAMsgType","WAParseConsumerMessageProtocol","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return function(b,e,f,g,h,i){h={id:{chat:e,author:g,externalId:f},ts:h,serverTs:h,ack:d("WAAckLevel").ACK.RECEIVED,forwardingScore:b.type!=="futureProof"?(f=b==null?void 0:(g=b.metadata)==null?void 0:g.forwardingScore)!=null?f:0:0};g=b.type!=="futureProof"&&((g=b.metadata)==null?void 0:(f=g.chatEphemeralSetting)==null?void 0:f.ephemeralExpiration)!=null&&((g=b.metadata)==null?void 0:(f=g.chatEphemeralSetting)==null?void 0:f.ephemeralExpiration)>0;if(b.type==="futureProof"||g&&!d("WAGlobals").getConfig().isEphemeralMessagesEnabled())return{unstoredMsg:{type:d("WAMsgType").FUTUREPROOF,msgContent:{subtype:null,protobuf:d("WAHex").bytesToBuffer(b.protobuf)},id:h.id,ts:h.ts,sentTs:h.sentTs,serverTs:h.serverTs,ack:h.ack,reportingMeta:h.reportingMeta},unstoredMedia:null,unstoredQuotedMedia:null};else if(b.type==="subprotocol"){f=a==null?void 0:a.get(b.subprotocolType);if(f!=null)return f(e,b.subprotocol,h,b.protobuf,b.metadata,i);switch(b.subprotocolType){case"consumerMessage":return d("WAParseConsumerMessageProtocol").parseConsumerMessageProtocol(e,b.subprotocol,h,b.protobuf,b.metadata,i);case"businessMessage":throw c("err")("unsupported subprotocolType: "+b.subprotocolType);case"paymentMessage":throw c("err")("unsupported subprotocolType: "+b.subprotocolType);case"multiDevice":throw c("err")("unsupported subprotocolType: "+b.subprotocolType);case"voip":throw c("err")("unsupported subprotocolType: "+b.subprotocolType);default:throw c("err")("Subprotocol parser for: "+b.subprotocolType+" was not found")}}else return c("WAAssertUnreachable")(b.type)}}g.createV3ProtocolParser=a}),98);
__d("MAWIncomingMsgUtils",["FBLogger","MAWEphemeralUtil","MAWParseArmadilloProtocol","MAWUnstoredContentToUnstoredDbContentUtils","WAParseV3Protocol"],(function(a,b,c,d,e,f,g){"use strict";var h=null;function i(a){if(h==null){var b=function(b,c,e,f,g,h){return d("MAWParseArmadilloProtocol").parseArmadilloProtocol(b,c,e,f,a,g,h)};h=d("WAParseV3Protocol").createV3ProtocolParser(new Map([["armadillo",b]]))}return h}function a(a,b){var e=a.author,f=a.chat,g=a.ebTimestampMs,h=a.externalId,j=a.msg,k=a.reportingMeta;a=a.serverTs;if(j.version==="v2")throw c("FBLogger")("messenger_web").mustfixThrow("Armadillo does not support protobuf v2");if(j.type==="ephemeral"){var l=d("MAWEphemeralUtil").buildUnstoredDbEphemeralSettingMsgWithoutContentPlaceholder(a);k!=null&&l.unstoredDbMsg!=null&&(l.unstoredDbMsg.reportingMeta=k);return l}l=babelHelpers["extends"]({unstoredXMA:null},i(b)(j,f,h,e,a,g));k!=null&&l.unstoredMsg!=null&&(l.unstoredMsg.reportingMeta=k);return d("MAWUnstoredContentToUnstoredDbContentUtils").unstoredContentToUnstoredDbContent(l)}g.getDbMsg=a}),98);
__d("MAWProtocolQueueDecodeProto",["MAWIncomingMsgUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c){switch(a.type){case"IncomingMsg":var e=a.folder,f=a.id,g=a.msg,h=a.reportingMeta;a=a.ts;var i=f.author,j=f.chat;f=f.externalId;return d("MAWIncomingMsgUtils").getDbMsg({author:i,chat:j,ebTimestampMs:c,externalId:f,folder:e,msg:g,reportingMeta:h,serverTs:a},b);case"InvisibleMsg":case"IncomingCiphertextMsg":default:return}}g.decodeMsg=a}),98);
__d("isUseridAnnotationEnabled",["gkx"],(function(a,b,c,d,e,f,g){"use strict";function a(){return c("gkx")("24163")}g["default"]=a}),98);
__d("MAWUserHash",["MAWCurrentUser","WAGlobals","WAJids","isUseridAnnotationEnabled"],(function(a,b,c,d,e,f,g){"use strict";function a(){return d("MAWCurrentUser").isEmployee()&&c("isUseridAnnotationEnabled")()?d("WAJids").extractUserId(d("WAGlobals").getMyUserJid()).slice(-5):null}g.getUserHash=a}),98);
__d("WAServerRPCLogger",["WATagsLogger"],(function(a,b,c,d,e,f,g){"use strict";a=d("WATagsLogger").TAGS(["ServerRPC"]);g.logger=a}),98);
__d("MAWIncomingMsg",["MAWUserHash","WAGetPlatformFromStanzaId","WAHashStringToNumber","WAServerRPCLogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";a=d("WAServerRPCLogger").logger.TAGS(["HandleIncomingMsg"]);b=function(a){var b=a.encTypes,c=a.incomingType,e=a.msg,f=a.queueType,g=a.retryCount;a=a.taskSource;var h=e.details;e=e.decrypted;return{"int":{messageAge:d("WATimeUtils").unixTime()-h.ts,msgId:d("WAHashStringToNumber").hashStringToNumber(h.externalId.toString()),offlineDelivery:h.offline,retryCount:g,taskSource:a},string:{e2eePlatform:d("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(h.externalId),incomingType:c,jid:h.from.chat,msgDecryptedDataType:e.type,msgType:h.type,queueType:f,threadType:h.from.type,userHash:d("MAWUserHash").getUserHash()},string_array:{encTypes:b}}};g.logger=a;g.prepareAnnotationsForIncomingMessage=b}),98);
__d("MAWMessageReceiveReliabilityLogger",["WAHashStringToNumber","WAQPLProxy","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h=c("qpl")._(1056840931,"814"),i=c("qpl")._(521477947,"2395"),j=60*1e3;function a(a){return d("WAQPLProxy").waQPLProxyStart(a.incomingType==="wa"?h:i,{"int":{msgId:d("WAHashStringToNumber").hashStringToNumber(a.stanzaId)},string:{incomingType:a.incomingType,jid:a.jid,msgType:a.type}},d("WAHashStringToNumber").hashStringToNumber(a.stanzaId),j)}b=5*60*1e3;g.logRRStartForMessage=a;g.RECEIVE_RELIABILITY_TIMEOUT=b}),98);
__d("MAWProtocolQueueUtils",["MAWIncomingMsg","MAWMessageReceiveReliabilityLogger","WAGetStorageQplAnnotations","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var c=d("MAWMessageReceiveReliabilityLogger").logRRStartForMessage(a);c.addAnnotations(d("MAWIncomingMsg").prepareAnnotationsForIncomingMessage({incomingType:a.incomingType,msg:a.message,queueType:a.message.details.offline!=null?"offline":"online",retryCount:a.message.details.retryCount,taskSource:b}));return c}function b(a,b){c("promiseDone")(d("WAGetStorageQplAnnotations").getStorageQplAnnotations().then(function(a){b.addAnnotations(a)}));b.addPoint("consumer_handle_message_stanza_start");return babelHelpers["extends"]({},a,{receiveFlow:b})}g.startMetricForIncomingMsgV2=a;g.addAnnotationsToMessage=b}),98);
__d("MAWGetSyncResponseBackoffInfoByJidApi",["MAWIndexedDb","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({ephemeralSettings:d("MAWTransactionMode").READONLY},"getSyncResponseBackoffInfoByJid",function(a){return function(b){return a.ephemeralSettings.get({userJid:b}).then(function(a){return a==null?null:a.ephemeralSyncResponseBackoffInfo})}});g.getSyncResponseBackoffInfoByJid=a}),98);
__d("MAWMarkMsgDroppedApi",["MAWAckLevel","MAWDbMsgTxns","MAWDbReactionsTxns","MAWDexieTable","MAWIndexedDb","MAWQplProxy","MAWTransactionMode","gkx"],(function(a,b,c,d,e,f,g){"use strict";b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,media:a.READONLY,messages:a.READWRITE,reactions:a.READWRITE,receiverFetchInfo:a.READONLY,threads:a.READWRITE,xma:a.READONLY},"markMsgDropped",function(a){return function(b,e,f){f!=null&&d("MAWQplProxy").sendQplPointThroughBridge(f.qplEventType,"mark_msg_dropped_msg_and_reaction_fetch_start",{instanceKey:f.qplInstanceKey});return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b),d("MAWDbReactionsTxns").maybeGetReactionByProtocolMsgId(a,b)]).then(function(b){var g=b[0];b=b[1];f!=null&&d("MAWQplProxy").sendQplPointThroughBridge(f.qplEventType,"mark_msg_dropped_msg_and_reaction_fetch_end",{instanceKey:f.qplInstanceKey});if(g!=null){var h=(e==null?void 0:e.isRetriable)===!0?d("MAWAckLevel").ACK.failedRetryable:d("MAWAckLevel").ACK.expired,i=c("gkx")("7471");f!=null&&d("MAWQplProxy").sendQplPointThroughBridge(f.qplEventType,"mark_msg_dropped_update_system_ack_start",{annotations:{"int":{ack:h}},instanceKey:f.qplInstanceKey});return d("MAWDbMsgTxns").updateSystemAck(a,g.msgId,h,void 0,void 0,i&&(e==null?void 0:e.applicationErrorCode)!=null?e==null?void 0:e.applicationErrorCode:void 0).then(function(a){f!=null&&d("MAWQplProxy").sendQplPointThroughBridge(f.qplEventType,"mark_msg_dropped_update_system_ack_end",{instanceKey:f.qplInstanceKey});return a==null?"missing":a.ack<=d("MAWAckLevel").ACK.clock?"dropped":"sent"})}if(b!=null){f!=null&&d("MAWQplProxy").sendQplPointThroughBridge(f.qplEventType,"mark_msg_dropped_update_delete_reaction_start",{instanceKey:f.qplInstanceKey});return d("MAWDbReactionsTxns").deleteReaction(a,b).then(function(){f!=null&&d("MAWQplProxy").sendQplPointThroughBridge(f.qplEventType,"mark_msg_dropped_update_delete_reaction_end",{instanceKey:f.qplInstanceKey});return"dropped"})}f!=null&&d("MAWQplProxy").sendQplPointThroughBridge(f.qplEventType,"mark_msg_dropped_msg_and_reaction_missing",{instanceKey:f.qplInstanceKey});return"missing"})}});g.markMsgDropped=b}),98);
__d("MAWMessageSendScheduler",["WorkerScheduler","gkx","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h=12e4,i;function a(){i==null&&(i=d("WorkerScheduler").makeScheduler("message-send",{concurrency:5,defaultSamplingRate:500,maxConcurrency:5,maxThrottleMs:500,timeToStuckMs:c("gkx")("11177")?c("justknobx")._("3814"):h}));return i}g.messageSendScheduler=a}),98);
__d("MAWMessageSendsCommon",["MAWMarkMsgDroppedApi","MAWMessageSendScheduler","MAWQplProxy","MWFBLogger","WAGetSafeQPLError","WAPromiseDelays","WAResultOrError","WATimeUtils","WAWaitForComms","WorkerScheduler","justknobx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Guard: should not happen, result is null"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Message send fail. Error: ",""]);i=function(){return a};return a}var j=1e3,k=d("MWFBLogger").MWLogger.tags(["MessageSend"]);function l(){if(!c("justknobx")._("4635"))return{activeTasks:[],pendingTasks:[]};var a=d("MAWMessageSendScheduler").messageSendScheduler().getDebugState();return{activeTasks:a.activeTasks.map(function(a){return"executionTimeMs"+a.executionTimeMs+" priority: "+a.priority+" name: "+a.task+" waitTimeMs:"+a.waitTimeMs}),pendingTasks:a.pendingTasksByPriority.map(function(a){return a.map(function(a){return"name: "+a.task+" waitTimeMs:"+a.waitTimeMs})}).flat()}}async function m(a,b,e,f,g){d("MAWQplProxy").sendQplPointThroughBridge(a,"backend_reached",{annotations:{bool:{backendSetupReadyFromWorker:!d("WAWaitForComms").isStillWaitingForComms()}},instanceKey:b});var n;try{d("MAWQplProxy").sendQplPointThroughBridge(a,"wait_for_comms_start",{annotations:{},instanceKey:b});await d("WAWaitForComms").waitForComms();d("MAWQplProxy").sendQplPointThroughBridge(a,"wait_for_comms_end",{annotations:{},instanceKey:b});var o=l(),p=o.activeTasks;o=o.pendingTasks;d("MAWQplProxy").sendQplPointThroughBridge(a,"message_send_start",{annotations:c("justknobx")._("4635")?{string_array:{activeTasksBeforeSchedule:p,pendingTasksByPriorityBeforeSchedule:o}}:{},instanceKey:b});n=await d("MAWMessageSendScheduler").messageSendScheduler().runTask({customFlags:{runtimeReliability:!0},fn:function(){return e(d("WATimeUtils").unixTime())},name:f,priority:d("WorkerScheduler").BLOCKING_PRIORITY});if(n.success===!0)d("MAWQplProxy").sendQplPointThroughBridge(a,"message_send_end",{instanceKey:b});else{var q;p=l();o=p.activeTasks;p=p.pendingTasks;d("MAWQplProxy").sendQplPointThroughBridge(a,"message_send_fail",{annotations:{string:{errorType:(q=(q=n.error)==null?void 0:q.type)!=null?q:"unknown-error"},string_array:c("justknobx")._("4635")?{activeTasksBeforeSchedule:o,pendingTasksByPriorityBeforeSchedule:p}:{}},instanceKey:b})}}catch(e){q=l();o=q.activeTasks;p=q.pendingTasks;k.catching(e).MUSTFIX(i(),d("WAGetSafeQPLError").getSafeQPLErrorMessage(e));d("MAWQplProxy").sendQplPointThroughBridge(a,"message_send_fail",{annotations:{string:{errorDescription:d("WAGetSafeQPLError").getSafeQPLErrorMessage(e),errorType:"runtime-error",sendFailureError:d("WAGetSafeQPLError").getSafeQPLErrorMessage(e)},string_array:c("justknobx")._("4635")?{activeTasksBeforeSchedule:o,pendingTasksByPriorityBeforeSchedule:p}:{}},instanceKey:b});g!=null&&await d("MAWMarkMsgDroppedApi").markMsgDropped(g,void 0,{qplEventType:a,qplInstanceKey:b});throw e}if(!n){q="null-response-from-message-send";k.MUSTFIX(h());d("MAWQplProxy").sendQplPointThroughBridge(a,"message_send_fail",{instanceKey:b});return d("WAResultOrError").makeError({applicationErrorCode:null,details:q,isRetriable:!0,type:"unexpected-message-codepath"})}if(n.success===!0)return n;n.success;g!=null&&await d("MAWMarkMsgDroppedApi").markMsgDropped(g,n.error,{qplEventType:a,qplInstanceKey:b});if(((o=n.error)==null?void 0:o.type)==="retryable-error"){q=(p=n.error.backoff)!=null?p:j;await d("WAPromiseDelays").delayMs(q);return m(a,b,e,f,g)}else return n}g.messageSendLogger=k;g.messageSendObserver=m}),98);
__d("MAWGetEditMsgForSending",["FBLogger","MAWAckLevel","MAWAsMessageApplication","MAWDbEditMsgHistoryTxns","MAWDbMsgTxns","MAWDbThreadTxns","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWTransactionMode","WAJids","WALogger","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[SendEditMsg] Failed to get originalMsg"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[SendEditMsg] Failed to get thread (success:",")"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[SendEditMsg] Failed to get originalMsgProtocolMsgId"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[SendEditMsg] Failed to get edit history"]);k=function(){return a};return a}b=d("MAWIndexedDb").makeMsgrTransactor({editMsgHistory:(a=d("MAWTransactionMode")).READONLY,messages:a.READONLY,participants:a.READONLY,reactions:a.READONLY,threads:a.READONLY},"getEditMsgForSending",function(a){return function(b,e){return l(a,b,e).then(function(a){if(!a.success)return{type:a.error};a=a.value.msg;var e=d("MAWAsMessageApplication").asEditMessageApplication(a);if(d("WAJids").isAuthorSystem(a.author))throw c("FBLogger")("messenger_web").mustfixThrow("This cannot happen because there are no system edit");return{dbMsg:a,editOriginalExternalId:a.originalMsgExternalId,messageApplication:e,messageType:{isEdit:!0,isRevoked:!1,type:"text"},protocolMsgId:b,type:"unsent"}})}});function l(a,b,c){return d("MAWDbEditMsgHistoryTxns").getEditHistoryMsgByEditedProtocolMsgId(a,b,c).then(function(b){if(b==null){d("WALogger").ERROR(k());return d("WAResultOrError").makeError("missing_history")}else if(b.sendStatus!=null&&b.sendStatus>d("MAWAckLevel").ACK.clock)return d("WAResultOrError").makeError("sent");var c=d("MAWJidUtils").maybeToProtocolMsgId(b.author,b.threadJid,b.originalMsgExternalId);if(c==null){d("WALogger").ERROR(j());return d("WAResultOrError").makeError("missing_msg")}return d("MAWDexieTable").dexieAll([d("MAWDbThreadTxns").getThread(a,b.threadJid),d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,c)]).then(function(a){var c=a[0];a=a[1];if(!c.success){d("WALogger").ERROR(i(),c.success);return d("WAResultOrError").makeError("missing_thread")}if(a==null){d("WALogger").ERROR(h());return d("WAResultOrError").makeError("missing_msg")}return a.ack>d("MAWAckLevel").ACK.clock?d("WAResultOrError").makeError("sent"):d("WAResultOrError").makeResult({msg:b,thread:c.value})})})}g.getEditMsgForSending=b}),98);
__d("MAWMediaType",["WAServerMediaType"],(function(a,b,c,d,e,f,g){"use strict";function a(a){switch(a){case"XMA":return"xma-image";case"EphemeralScreenshotAction":case"Raven":case"RavenAction":case"EditAction":case"BumpExistingMessage":return null;default:return d("WAServerMediaType").getMediaType(a)}}g.getMediaType=a}),98);
__d("MAWSendMsgUtil",["MAWMediaType","WAConsumerApplication.pb","WAMsgType","decodeProtobuf","getMediaTypeFromConsumerMessage"],(function(a,b,c,d,e,f,g){"use strict";({});function h(a){var b=d("MAWMediaType").getMediaType(a),c=a===d("WAMsgType").MSG_TYPE.REVOKED;if(b!=null)return{mediaType:b,type:"media"};else if(a===d("WAMsgType").MSG_TYPE.SK_DISTRIBUTION)return{isInvisible:!0,isRevoked:!1,type:"text"};else return{isRevoked:c,type:"text"}}function a(a){var b=d("MAWMediaType").getMediaType(a);if(b!=null)return{mediaType:b,type:"media"};switch(a){case"XMA":case"Raven":case"RavenAction":case"EphemeralScreenshotAction":case"EditAction":case"BumpExistingMessage":return{isRevoked:!1,type:"text"};default:return h(a)}}function b(a){var b;a=(a=a.payload)==null?void 0:(a=a.subProtocol)==null?void 0:a.consumerMessage;if(a==null)return{isRevoked:!1,type:"text"};a=d("decodeProtobuf").decodeProtobuf(d("WAConsumerApplication.pb").ConsumerApplicationSpec,a.payload);if(a==null?void 0:(b=a.payload)==null?void 0:(b=b.applicationData)==null?void 0:b.revoke)return{isRevoked:!0,type:"text"};b=d("getMediaTypeFromConsumerMessage").getMediaTypeFromConsumerMessage(a);return b!=null?{mediaType:b,type:"media"}:{isRevoked:!1,type:"text"}}g.waGetMessageTypeFromMsg=h;g.getMessageTypeFromMsg=a;g.getMessageTypeFromMessageApplication=b}),98);
__d("MAWGetMsgForSendingApi",["FBLogger","MAWAckLevel","MAWAsMessageApplication","MAWDbGroupInviteTxns","MAWDbMediaTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbParticipantTxns","MAWDbUnrenderedMsgTxns","MAWDbXMATxns","MAWDexieTable","MAWIndexedDb","MAWMsgType","MAWSendMsgUtil","MAWTransactionMode","MAWXMAUtils","WAJids","WALogger","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[SendMsg] Failed to get XMA: isXma: ",", type: "," "]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[SendMsg] Failed to get message"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg "," -- MAWGetMsgForSendingAPI -- Done"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg "," -- MAWGetMsgForSendingAPI -- Unrecognized type ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg "," -- MAWGetMsgForSendingAPI -- Error: ",""]);l=function(){return a};return a}b=d("MAWIndexedDb").makeMsgrTransactor({groupInvites:(a=d("MAWTransactionMode")).READONLY,media:a.READONLY,messages:a.READONLY,participants:a.READONLY,reactions:a.READONLY,threads:a.READONLY,unrenderedMessages:a.READONLY,xma:a.READONLY},"getMsgForSending",function(a){return function(b){return m(a,b).then(function(a){if(!a.success){d("WALogger").LOG(l(),b,a.error);return{type:a.error}}a=a.value;var e=a.contactsInThread,f=a.groupInvite,g=a.isReplyMsg,h=a.media,i=a.msg;a=a.xmaPayload;if(!d("MAWDbMsg").NO_CONTENT_MESSAGE_TYPES_ALLOWLIST.includes(i.type)&&!d("MAWDbMsg").isContentMsg(i)){d("WALogger").LOG(k(),b,i.type);throw c("FBLogger")("messenger_web").mustfixThrow("We do not support message sending with "+i.type+" type")}var m=d("MAWAsMessageApplication").asMessageApplication(i,h,f,a,i.threadJid),n=null;i.type===d("MAWMsgType").MSG_TYPE.GROUP_INVITE&&f?n={invitedParticipantUserJid:f.inviteeJid,isRevoked:!1,type:"text"}:n=d("MAWSendMsgUtil").getMessageTypeFromMsg(i.type);if(d("WAJids").isAuthorSystem(i.author))throw c("FBLogger")("messenger_web").mustfixThrow("A system message cannot be sent");d("WALogger").LOG(j(),b);return{contactsInThread:e,dbMsg:i,isReplyMsg:g,isXMAMsg:a!=null,media:h,messageApplication:m,messageType:n,protocolMsgId:{author:i.author,chat:i.threadJid,externalId:a!=null&&a.associatedMessage!=null?a.associatedMessage.externalId:i.externalId},type:"unsent",xmaPayload:a}})}});function m(a,b){return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b),d("MAWDbUnrenderedMsgTxns").maybeGetUnrenderedMsgByProtocolMsgId(a,b)]).then(function(c){var e=c[0];c=c[1];var f=c.value,g=e||f;if(g==null){d("WALogger").ERROR(i());return d("WAResultOrError").makeError("missing_msg")}else if(g.ack>d("MAWAckLevel").ACK.clock)return d("WAResultOrError").makeError("sent");var j=d("MAWXMAUtils").maybeXMAMessage(e),k=g.quote!=null;return d("MAWDexieTable").dexieAll([e?d("MAWDbMediaTxns").getAndCheckMediaFromMsg(a,e):d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeResult()),c.success?d("MAWDbGroupInviteTxns").getAndCheckGroupInviteFromMsg(a,c.value):d("MAWDexieTable").dexieResolve(),j?d("MAWDbXMATxns").maybeGetXMAPayloadFromProtocolMsgId(a,b):null,d("MAWDbParticipantTxns").getParticipantsInThread(a,g.threadJid).then(function(a){return a.map(function(a){return a.userJid})})]).then(function(a){var b=a[0],c=a[1],e=a[2];a=a[3];if(!b.success)return b;if(e!=null&&!e.success){d("WALogger").ERROR(h(),j,g.type);return d("WAResultOrError").makeError("missing_xma")}b=b.value;return d("WAResultOrError").makeResult({contactsInThread:a,groupInvite:c,isReplyMsg:k,media:b,msg:g,xmaPayload:e!=null?e.value:null})})})}g.getMsgForSending=b}),98);
__d("MAWGetNoteReplyMsgForSendingApi",["MAWAckLevel","MAWAsMessageApplication","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWSendMsgUtil","MAWTransactionMode","WAJids","WALogger","WAResultOrError","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[SendMsg] Failed to get message"]);h=function(){return a};return a}function i(a,b){return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b)]).then(function(a){a=a[0];a=a;if(a==null){d("WALogger").ERROR(h());return d("WAResultOrError").makeError("missing_msg")}else if(a.ack>d("MAWAckLevel").ACK.clock)return d("WAResultOrError").makeError("sent");return d("WAResultOrError").makeResult({msg:a})})}b=d("MAWIndexedDb").makeMsgrTransactor({media:(a=d("MAWTransactionMode")).READONLY,messages:a.READONLY,threads:a.READONLY,unrenderedMessages:a.READONLY},"getNoteReplyForSending",function(a){return function(b){return i(a,b).then(function(a){if(!a.success)return{type:a.error};a=a.value.msg;var b=d("MAWAsMessageApplication").asNoteReplyMessageApplication(a),e=d("MAWSendMsgUtil").getMessageTypeFromMsg(a.type);if(d("WAJids").isAuthorSystem(a.author))throw c("err")("A system message cannot be sent");return{dbMsg:a,messageApplication:b,messageType:e,protocolMsgId:{author:a.author,chat:a.threadJid,externalId:a.externalId},type:"unsent"}})}});g.getNoteReplyForSending=b}),98);
__d("MAWGetReactionForSending",["FBLogger","MAWAckLevel","MAWAsMessageApplication","MAWDbReactionsTxns","MAWDbThreadTxns","MAWIndexedDb","MAWTransactionMode","WAJids","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b){return d("MAWDbReactionsTxns").maybeGetReactionByProtocolMsgId(a,b).then(function(b){if(b==null)return d("WAResultOrError").makeError("missing");else if(b.ack>d("MAWAckLevel").ACK.clock)return d("WAResultOrError").makeError("sent");return d("MAWDbThreadTxns").getThread(a,b.threadJid).then(function(a){return!a.success?d("WAResultOrError").makeError(a.error):d("WAResultOrError").makeResult({msg:b})})})}a=d("MAWIndexedDb").makeMsgrTransactor({reactions:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY},"getReactionForSending",function(a){return function(b){return h(a,b).then(function(a){if(!a.success)return{type:a.error};a=a.value.msg;var b=d("MAWAsMessageApplication").asReactionMessageApplication(a);if(d("WAJids").isAuthorSystem(a.author))throw c("FBLogger")("messenger_web").mustfixThrow("This cannot happen because there are no system reactions");return{chat:a.threadJid,dbMsg:a,externalId:a.externalId,messageApplication:b,messageType:{isInvisible:!0,type:"reaction"},protocolMsgId:{author:a.author,chat:a.threadJid,externalId:a.externalId},type:"unsent"}})}});g.getReactionForSending=a}),98);
__d("MAWLoadThreadParticipantsApi",["MAWDbParticipantTxns","MAWIndexedDb","MAWTransactionMode","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["MAWLoadThreadParticipantsApi -- loadThreadParticipants -- there is no thread in db"]);h=function(){return a};return a}a=d("MAWIndexedDb").makeMsgrTransactor({participants:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY},"loadThreadParticipants",function(a){return function(b){return a.threads.get({jid:b}).then(function(b){if(b==null){d("WALogger").ERROR(h());return[]}return d("MAWDbParticipantTxns").getParticipantsInThread(a,b.jid).then(function(a){return a.map(function(a){return a.userJid})})})}});g.loadThreadParticipants=a}),98);
__d("MAWMarkEditMsgDroppedApi",["FBLogger","MAWAckLevel","MAWBridgeMsg","MAWDbEditMsgHistoryTxns","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWTransactionMode","WAGlobals","WAJids","WALogger","WAMsgType","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] editMsgHistory updated"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] originalMsg is not a text message"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] thread is null"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] newestEditedMsg is not the newest edit"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] previousEditedMsg is null"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] newestEditedMsg is null"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] originalMsg is null"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] originalProtocolMsgId is null"]);o=function(){return a};return a}a=d("MAWIndexedDb").makeMsgrTransactor({editMsgHistory:d("MAWTransactionMode").READWRITE,messages:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE},"markEditMsgDropped",function(a){return function(b,e){var f=d("MAWJidUtils").maybeToProtocolMsgId(b.author,b.chat,e);if(f==null){d("WALogger").ERROR(o());return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError("missing_original_protocol_msg_id"))}return d("MAWDexieTable").dexieAll([a.threads.get({jid:b.chat}),d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,f),d("MAWDbEditMsgHistoryTxns").maybeGetEditMsgHistoryFromProtocolMsgId(a,f)]).then(function(f){var g=f[0],o=f[1],p=f[2];f=p.sort(function(a,b){return b.editTs-a.editTs});var q=p.find(function(a){return a.editExternalId===b.externalId}),r=f[1];if(o==null){d("WALogger").ERROR(n());return d("WAResultOrError").makeError("missing_original_msg")}if(q==null){d("WALogger").ERROR(m());return d("WAResultOrError").makeError("missing_newest_edited_msg")}if(r==null){d("WALogger").ERROR(l());return d("WAResultOrError").makeError("missing_previous_edited_msg")}if(q.editExternalId!==f[0].editExternalId){d("WALogger").ERROR(k());return d("WAResultOrError").makeError("invalid_newest_edited_msg")}if(g==null){d("WALogger").ERROR(j());return d("WAResultOrError").makeError("missing_thread")}if(o.type!==d("WAMsgType").MSG_TYPE.TEXT){d("WALogger").ERROR(i());return d("WAResultOrError").makeError("invalid_original_msg")}return a.messages.where("quoteExternalId").equals(e).toArray().then(function(e){var f,g=babelHelpers["extends"]({},o,{ack:d("MAWAckLevel").ACK.sent,editCount:((f=o.editCount)!=null?f:0)-1,msgContent:r.msgContent}),i=d("WAGlobals").getMyUserJid(),j=[];f=e.find(function(a){var c;return(((c=a.quote)==null?void 0:c.content.author)===d("WAJids").AUTHOR_ME||((c=a.quote)==null?void 0:c.content.author)===i)&&a.threadJid===b.chat});if(f!=null){e=f.quote;var k=f.quoteExternalId;if(e==null)c("FBLogger")("messenger_web").warn("[markEditMsgDropped] Failed to get the quoted content for a msg that has been quoted.",k);else{k=babelHelpers["extends"]({},f,{quote:babelHelpers["extends"]({},e,{content:babelHelpers["extends"]({},e.content,{msgContent:babelHelpers["extends"]({},g.msgContent)})})});j.push(k)}}f=[];o.editCount===1&&p.length===2&&f.push(r.editMsgHistoryId);f.push(q.editMsgHistoryId);return d("MAWDexieTable").dexieAll([a.messages.put(g),a.editMsgHistory.bulkDelete(f)]).then(function(){d("WALogger").LOG(h());d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(g)});j.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(a)})});return d("WAResultOrError").makeResult()})})})}});g.markEditMsgDropped=a}),98);
__d("MAWMarkEditMsgSentApi",["ArmadilloDataTraceType","MAWAckLevel","MAWBridgeMsg","MAWBridgeTrace","MAWBridgeTraceEvent","MAWDbEditMsgHistory","MAWDbEditMsgHistoryTxns","MAWDbMsgTxns","MAWDexieTable","MAWFTSTxns","MAWIndexedDb","MAWJidUtils","MAWLoadReplyMediaTxns","MAWTransactionMode","WAJids","WALogger","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgSent] editMsgHistory updated"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgSent] on incoming message"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgSent] editMsgHistory has already been sent"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgSent] editedMsg?.editExternalId is null"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgSent] originalMsgHistory is null"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgSent] originalMsg is null"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgSent] originalProtocolMsgId is null"]);n=function(){return a};return a}b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,editMsgHistory:a.READWRITE,ftsBackloggedMessages:a.READWRITE,media:a.READONLY,messages:a.READWRITE,receiverFetchInfo:a.READONLY,xma:a.READONLY},"markEditMsgSent",function(a){return function(b,e,f,g){var o=d("MAWJidUtils").maybeToProtocolMsgId(b.author,b.chat,e);if(o==null){d("WALogger").ERROR(n());return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError("missing_original_protocol_msg_id"))}return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,o),d("MAWDbEditMsgHistoryTxns").maybeGetEditMsgHistoryFromProtocolMsgId(a,o),d("MAWFTSTxns").maybePutMessageToBacklog(a,e)]).then(function(n){var o=n[0];n=n[1];var p=n.find(function(a){return a.editExternalId===e}),q=n.find(function(a){return a.editExternalId===b.externalId});if(o==null){d("WALogger").ERROR(m());return d("WAResultOrError").makeError("missing_original_msg")}if(p==null){d("WALogger").ERROR(l());return d("WAResultOrError").makeError("missing_original_msg_edit_history")}if((q==null?void 0:q.editExternalId)==null){d("WALogger").ERROR(k());return d("WAResultOrError").makeError("missing_edit_external_id")}if(q.sendStatus!=null&&q.sendStatus>d("MAWAckLevel").ACK.clock&&o.ack>d("MAWAckLevel").ACK.clock){d("WALogger").LOG(j());return d("WAResultOrError").makeError("already_sent")}if(q.author!==d("WAJids").AUTHOR_ME){d("WALogger").ERROR(i());return d("WAResultOrError").makeError("not_author")}d("MAWIndexedDb").afterTransaction({tag:"UpdateTrace",value:d("MAWBridgeTrace").createBridgeUpdateTraceData([q.editExternalId],c("MAWBridgeTraceEvent").ReceivedSent,d("ArmadilloDataTraceType").armadilloMessageSend)});var r=[];if(n.length===2&&o.editCount===1){n=babelHelpers["extends"]({},p,{sendStatus:d("MAWAckLevel").ACK.sent});r.push(n)}p=babelHelpers["extends"]({},q,{editTs:f,sendStatus:d("MAWAckLevel").ACK.sent});r.push(p);var s=r.map(function(a){return babelHelpers["extends"]({},a,{editMsgHistoryId:d("MAWDbEditMsgHistory").convertToEditMsgHistoryId64(a.editMsgHistoryId),originalMsgId:o.msgId})}),t=babelHelpers["extends"]({},o,{ack:d("MAWAckLevel").ACK.sent});g!=null&&(t.reportingMeta=g);return d("MAWDexieTable").dexieAll([a.editMsgHistory.bulkPut(r),a.messages.put(t),d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,t)]).then(function(a){a[0];a=a[2];d("WALogger").LOG(h());d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(t,void 0,a)});d("MAWIndexedDb").afterTransaction({tag:"EditMsgHistoryAdded",value:s});return d("WAResultOrError").makeResult(t)})})}});g.markEditMsgSent=b}),98);
__d("MAWMarkMsgSentApi",["ArmadilloDataTraceType","MAWAckLevel","MAWBridgeTrace","MAWBridgeTraceEvent","MAWDbMsgTxns","MAWDbThread","MAWDbThreadTxns","MAWDbUnrenderedMsgTxns","MAWDexieTable","MAWEphemeralMsgTxns","MAWEphemeralSettingsTxns","MAWIndexedDb","MAWMsgType","MAWTransactionMode","WALogger","WAResultOrError","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Thread missing from DB"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Found both regular and unrendered message with the same protocol msg ID"]);i=function(){return a};return a}b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,ephemeralSettings:a.READWRITE,groupInfo:a.READONLY,media:a.READONLY,messages:a.READWRITE,reactions:a.READONLY,receiverFetchInfo:a.READONLY,threads:a.READWRITE,unrenderedMessages:a.READWRITE,xma:a.READONLY},"markMsgSent",function(a){return function(b,e,f){return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b),d("MAWDbUnrenderedMsgTxns").maybeGetUnrenderedMsgByProtocolMsgId(a,b)]).then(function(g){var j=g[0];g=g[1];if(j==null&&!g.success)return d("WAResultOrError").makeError("msg_missing_in_db");else if(j!=null){d("MAWIndexedDb").afterTransaction({tag:"UpdateTrace",value:d("MAWBridgeTrace").createBridgeUpdateTraceData([j.externalId],c("MAWBridgeTraceEvent").ReceivedSent,d("ArmadilloDataTraceType").armadilloMessageSend)});g.success&&d("WALogger").ERROR(i());var k=j.ack<d("MAWAckLevel").ACK.sent;return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").updateSystemAck(a,j.msgId,d("MAWAckLevel").ACK.sent,e,f),d("MAWDbThreadTxns").getThread(a,j.threadJid)]).then(function(b){var c=b[0];b=b[1];if(!b.success){d("WALogger").ERROR(h());return d("WAResultOrError").makeError("thread_missing_in_db")}b=b.value;var f=d("WATimeUtils").castUnixTimeToMillisTime(e);f=babelHelpers["extends"]({},b,{lastReadMsgTs:f,newestMsgTs:f,threadOrder:d("MAWDbThread").craftThreadOrder(f,b.jid)});b=k?d("MAWDbThreadTxns").updateThread(a,f):d("MAWDexieTable").dexieResolve();return d("MAWDexieTable").dexieAll([d("MAWEphemeralMsgTxns").markEphemeralMessageAsSent(a,c),b]).then(function(){return d("WAResultOrError").makeResult(c)})})}else if(g.success){var l=g.value;return d("MAWDbUnrenderedMsgTxns").updateSystemAckForUnrenderedMsg(a,l.msgId,d("MAWAckLevel").ACK.sent).then(function(){if(l.type===d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE)return d("MAWEphemeralSettingsTxns").updateContactWhenEphemeralSettingChangeMarkedSent(a,b.chat,e)}).then(function(){return d("WAResultOrError").makeResult(null)})}return d("WAResultOrError").makeError("msg_missing_in_db")})}});g.markMsgSent=b}),98);
__d("MAWSendWrittenMsg",["EBAPI","EBLogger","MAWBridge","MAWDebugMsg","MAWGetEditMsgForSending","MAWGetMsgForSendingApi","MAWGetNoteReplyMsgForSendingApi","MAWGetReactionForSending","MAWJids","MAWLoadThreadParticipantsApi","MAWMarkEditMsgDroppedApi","MAWMarkEditMsgSentApi","MAWMarkMsgDroppedApi","MAWMarkMsgSentApi","MAWMessageSendsCommon","MAWMpsGating","MAWODSProxy","MAWSendMsgUtil","MAWUpdateThreadListItem","MpsTypes","WAAPI","WAAsMessageApplication","WABuildMpsPayload","WAFrankingTypes","WAGlobals","WAMsgApplication.pb","WAOdsEnums","WAResultOrError","WebMps","encodeProtobuf","err","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to save message to MPS: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg END "," : ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg not sending message: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg ",""]);k=function(){return a};return a}async function l(a,b,e){d("MAWMessageSendsCommon").messageSendLogger.DEBUG(k(),String(a.protocolMsgId));b.addPoint("get_msg_for_sending_start",{string:{type:a.type}});var f,g,l,m,n=null,o;if(e==null){if(a.type==="message"||a.type==="revoke"||a.type==="bump")n=await d("MAWGetMsgForSendingApi").getMsgForSending(a.protocolMsgId);else if(a.type==="reaction")n=await d("MAWGetReactionForSending").getReactionForSending(a.protocolMsgId);else if(a.type==="edit")n=await d("MAWGetEditMsgForSending").getEditMsgForSending(a.protocolMsgId,a.referencedOriginalExternalId);else if(a.type==="noteReply")n=await d("MAWGetNoteReplyMsgForSendingApi").getNoteReplyForSending(a.protocolMsgId);else{a.type;throw c("err")("This cannot happen because type has `message` as default argument but flow does not know that")}if(n.type!=="unsent"){d("MAWMessageSendsCommon").messageSendLogger.DEBUG(j(),n.type);return d("WAResultOrError").makeError({details:n.type,isRetriable:!0,type:"wrong-message-state"})}var p=n,q=p.dbMsg,r=p.isReplyMsg;p=p.isXMAMsg;o=n.protocolMsgId;f=n.messageApplication;l=n.messageType;g=q==null?void 0:q.type;m=n.editOriginalExternalId;q=(q==null?void 0:q.ephemeralSetting)!=null&&((q=(q=q.ephemeralSetting)==null?void 0:q.ephemeralExpirationInSec)!=null?q:0)>0;b.addPoint("get_msg_for_sending_end",{bool:{isEditMsg:m!=null,isEphemeralMsg:q,isReplyMsg:r,isXMAMsg:p},string:{msgType:l.type}});q&&d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_OLD_MESSAGE_SEND,key:"sendEphemeralMsg"},!0)}else f=e.messageApplication,l=d("MAWSendMsgUtil").getMessageTypeFromMessageApplication(f),m=null,o=a.protocolMsgId;r=d("encodeProtobuf").encodeProtobuf(d("WAMsgApplication.pb").MessageApplicationSpec,f).readBuffer();p={bytes:d("WAAsMessageApplication").castToMessageApplicationBytes(new Uint8Array(r)),version:"v3"};b.addPoint("wa_send_msg_start");q=await c("WAAPI").sendChatMessage({loadThreadParticipants:d("MAWLoadThreadParticipantsApi").loadThreadParticipants,messagePayload:{backupDirective:null,frankingKey:((q=f.metadata)==null?void 0:q.frankingKey)?d("WAFrankingTypes").castToFrankingKey(new Uint8Array((e=f.metadata)==null?void 0:e.frankingKey)):null,frankingVersion:(a=f.metadata)==null?void 0:a.frankingVersion,messageBytes:p,messageType:l,protocolMsgId:o}},b);if(q.success===!1){b.addPoint("wa_send_msg_fail",{string:{errorType:q.error.type,msgType:g}});m!=null?await d("MAWMarkEditMsgDroppedApi").markEditMsgDropped(o,m):await d("MAWMarkMsgDroppedApi").markMsgDropped(o,q.error);d("MAWMessageSendsCommon").messageSendLogger.MUSTFIX(i(),q.error.type,String((e=q.payload)!=null?e:""));switch(q.error.type){case"non-retryable-error":if(q.error.applicationErrorCode!=null&&q.error.applicationErrorCode===10009)try{d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"RefreshContact",value:d("MAWJids").convertChatJidToIntJid(o.chat)}]})}catch(a){d("EBLogger").EBLogger.catching(a).mustfix("Failed to call bridge handler RefreshContact for JID %s and mediaType %s",o.chat,g)}return q;case"missing-receipt":case"wrong-message-state":case"unexpected-message-codepath":case"result-parsing-error":case"retryable-error":case"no-recipients":case"encryption-error":case"too-many-retries":return q;default:q.error.type;throw c("err")("Unreachable code")}}q.success;b.addPoint("wa_send_msg_end");((a=q.value.meta)==null?void 0:a.pOrDhashMismatch)&&(b.addPoint("dhash_phash_mismatch"),c("promiseDone")(d("MAWDebugMsg").writeDebugMsg(o.chat,"Outgoing msg "+o.externalId+" got a phash mismatch")));if(n!=null){b.addPoint("mark_edit_msg_sent_start");l=m!=null?await d("MAWMarkEditMsgSentApi").markEditMsgSent(o,m,q.value.serverTs,q.value.reportingMeta):await d("MAWMarkMsgSentApi").markMsgSent(o,q.value.serverTs,q.value.reportingMeta);b.addPoint("mark_edit_msg_sent_end");if(l.success&&l.value!=null){e=l.value;await d("MAWUpdateThreadListItem").updateThreadListItemFromInsertion(e,e.threadJid,"outgoing_msg",m!=null)}}if(d("MAWMpsGating").isMpsEnabled())try{await d("WebMps").mps().saveNewMessages([{directive:null,insertionSource:d("MpsTypes").InsertionSource.Send,message:d("WABuildMpsPayload").buildMpsMessage({encryptedTransportMessage:r},{externalId:o.externalId,senderJid:d("WAGlobals").getMyUserJid(),serverTs:q.value.serverTs,threadId:o.chat})}],{source:"wa-message-sent"})}catch(a){d("MAWMessageSendsCommon").messageSendLogger.MUSTFIX(h(),a)}if(n!=null&&!d("MAWMpsGating").isFullMpsEnabled()){b.addPoint("eb_upload_scheduling_start");a=n;l=a.dbMsg;e=a.isXMAMsg;m=a.media;r=a.xmaPayload;await c("EBAPI").uploadSentMessage({dbMsg:l,instanceKey:o.externalId,isXMAMsg:e,media:m,messageApplication:f,messageApplicationBytes:p.bytes,protocolMsgId:o,serverTs:q.value.serverTs,xmaPayload:r});b.addPoint("eb_upload_scheduling_end")}return q}function a(a,b,c,d){b.addAnnotations({bool:{is_secure:!0},string:{description:c,jid:a.protocolMsgId.chat}});return l(a,b,d)}g.sendWrittenMsgExternal=a}),98);
__d("MAWWriteOutgoingMsgApi",["MAWAckLevel","MAWBuildNewMsgPayload","MAWDbMsg","MAWDbMsgTxns","MAWDbRavenActionTxns","MAWDexieTable","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWMsgType","MAWQplProxy","MAWTransactionMode","MAWVault","MAWWriteMsgTxns","WAJids","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h=function(a,b,c,e){b!=null&&d("MAWQplProxy").sendQplPointThroughBridge(c,a,{annotations:e,instanceKey:b})};b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,ephemeralSettings:a.READWRITE,ftsBackloggedMessages:a.READWRITE,groupInfo:a.READONLY,media:a.READONLY,messages:a.READWRITE,participants:a.READONLY,receiverFetchInfo:a.READONLY,threads:a.READWRITE,unrenderedMessages:a.READWRITE,xma:a.READONLY},"writeOutgoingMsg",function(a){return function(b,c,d,e,f,g,h){return i(a,b,c,d,e,f,g,h)}});function i(a,b,c,e,f,g,i,l){f.content!=null&&(f.content=d("MAWVault").vault(f.content));h("write_outgoing_msg_start",l,i);return d("MAWDexieTable").dexieAll([a.threads.get({jid:c}),a.messages.where("externalId").equals(b).toArray(),j(a,f.quote,c),d("MAWDbRavenActionTxns").maybeGetRavenMsgQueryByProtocolMsgId(a,f.ravenProtocolMsgId,g)]).then(function(c){var j=c[0],m=c[1],n=c[2];c=c[3];h("write_outgoing_msg_data_fetched",l,i,{bool:{isUnrenderedMsgType:d("MAWDbMsg").isUnrenderedMsgType(g)}});if(j==null)return{type:"missing_thread"};m=m.find(function(a){return a.threadJid===j.jid&&a.author===d("WAJids").AUTHOR_ME});if(m!=null)return m.ack>=d("MAWAckLevel").ACK.sent?{msgId:m.msgId,protocolMsgId:{author:d("WAJids").AUTHOR_ME,chat:j.jid,externalId:m.externalId},type:"already_sent"}:{msgId:m.msgId,protocolMsgId:{author:d("WAJids").AUTHOR_ME,chat:j.jid,externalId:m.externalId},type:"not_sent"};else{if(!d("MAWDbMsg").isUnrenderedMsgType(g)){m={ack:d("MAWAckLevel").ACK.clock,altIndex:void 0,author:d("WAJids").AUTHOR_ME,ephemeralSetting:f.ephemeralSetting,externalId:b,isForwarded:f.isForwarded,specialTextSize:f.specialTextSize,threadJid:j.jid,ts:e};var o=d("MAWBuildNewMsgPayload").buildNewMsg(g,m,f,n),p=f.isFirstMsg,q=f.openMessageOtid,r=f.openMessageParticipantCount,s=f.optimisticMsg,t=f.participantCount;m=d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,o).then(function(b){return d("MAWWriteMsgTxns").writeMsg(a,o,j,"MAWWriteOutgoingMsgApi",{isCurrentDeviceSendingMsg:!0,isFirstMsg:p,isOutgoing:!0,openMessageOtid:q,openMessageParticipantCount:r,optimisticMsg:s,participantCount:t,quotedReplyAttachmentMeta:b,s2sInstanceKey:l})})}else{n={ack:d("MAWAckLevel").ACK.clock,author:d("WAJids").AUTHOR_ME,externalId:b,threadJid:j.jid,ts:e};n=d("MAWBuildNewMsgPayload").getNewUnrenderedMsg(g,n,f,c==null?void 0:c.externalId);m=d("MAWWriteMsgTxns").writeUnrenderedMsg(a,n,j)}return m.then(function(c){h("write_outgoing_msg_promise_resolved",l,i);return k(a,g,j.jid,e).then(function(){return{msgId:c.msgId,protocolMsgId:{author:d("WAJids").AUTHOR_ME,chat:j.jid,externalId:b},type:"not_sent"}})})}})}function j(a,b,c){return b==null?d("MAWDexieTable").dexieResolve(null):d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b).then(function(b){return b==null?null:a.threads.get({jid:b.threadJid}).then(function(a){var e=d("MAWBuildNewMsgPayload").msgToQuotedMsg(b);if(e==null)return null;b.messageExpirationTs!=null&&b.messageExpirationTs<d("WATimeUtils").unixTime()&&(e=babelHelpers["extends"]({},e,{mediaId:void 0,msgContent:void 0,type:d("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL,xmaMessageType:void 0}));if(a==null||a.jid===c)return{content:e,remoteJid:null};a=d("WAJids").interpretAndValidateJid(a.jid);a=a.jidType==="group"?a.groupJid:null;return{content:e,remoteJid:a}})})}function k(a,b,e,f){if(b===d("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE)return d("WAJids").switchOnMsgrChatJidType(e,{group:function(){return d("MAWDexieTable").dexieResolve()},user:function(b){return a.ephemeralSettings.get({userJid:b}).then(function(b){var c;if(b==null)return d("MAWDexieTable").dexieResolve();b.ephemeralSyncResponseBackoffInfo={syncResponseRetries:((c=(c=b.ephemeralSyncResponseBackoffInfo)==null?void 0:c.syncResponseRetries)!=null?c:0)+1,syncResponseSentTs:f};return a.ephemeralSettings.put(b)}).then(c("emptyFunction"))}});return b===d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE?d("WAJids").switchOnMsgrChatJidType(e,{group:function(){return d("MAWDexieTable").dexieResolve()},user:function(b){return a.ephemeralSettings.get({userJid:b}).then(function(b){if(b==null||b.ephemeralSyncResponseBackoffInfo==null)return d("MAWDexieTable").dexieResolve();b.ephemeralSyncResponseBackoffInfo=void 0;return a.ephemeralSettings.put(b).then(c("emptyFunction"))})}}):d("MAWDexieTable").dexieResolve()}g.writeOutgoingMsg=b;g.writeOutgoingMsgImpl=i;g.getQuoteInfo=j}),98);
__d("MAWSendEphemeralSettingMsg",["FBLogger","MAWGetSyncResponseBackoffInfoByJidApi","MAWLoggerUtils","MAWMessageSendsCommon","MAWMsgType","MAWSendWrittenMsg","MAWWriteOutgoingMsgApi","WAAPI","WAJids","WAQPLProxy","WAResultOrError","WATagsLogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["sendMsg cannot send to a non-existent thread"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["sendMsg already sent message"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["send ephemeral setting message: chatJid ",", type ",", externalId ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["ephemeral sync response backed off"]);k=function(){return a};return a}var l=d("WATagsLogger").TAGS([d("MAWLoggerUtils").Tag.Ephemeral,d("MAWLoggerUtils").Tag.SettingSync]);async function m(a,b,e,f,g,m){if(a.isForSyncResponse){var o=await d("WAJids").switchOnMsgrChatJidType(b,{group:function(){throw c("FBLogger")("messenger_web").mustfixThrow("ChatJid is not supposed to be a group")},user:function(a){return d("MAWGetSyncResponseBackoffInfoByJidApi").getSyncResponseBackoffInfoByJid(a)}});if(n(f,o)){l.LOG(k());return d("WAResultOrError").makeResult({description:"send not needed",messageType:"fixMe"})}}o=a.isForSyncResponse?d("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE;await c("WAAPI").getDevicesBeforeSend({chatJid:b,reason:"SendEphemeralSettings"});f=await d("MAWWriteOutgoingMsgApi").writeOutgoingMsg(e,b,f,a,o,g,m);l.LOG(j(),b,o,e);if(f.type==="already_sent"){l.LOG(i());return d("WAResultOrError").makeError({isRetriable:!1,type:"already-sent"})}else if(f.type==="missing_thread"){l.LOG(h());return d("WAResultOrError").makeError({isRetriable:!1,type:"missing-thread"})}b=await d("MAWSendWrittenMsg").sendWrittenMsgExternal({protocolMsgId:f.protocolMsgId,type:"message"},d("WAQPLProxy").waQPLProxyStartResume(g,m),"MAWSendEphemeralSettingMsg");if(b.success===!1)return d("WAResultOrError").makeError(b.error);else return d("WAResultOrError").makeResult({chatJid:f.protocolMsgId.chat,content:a.content,ephemeralSetting:a.ephemeralSetting,externalId:f.protocolMsgId.externalId,initiatingSource:a.initiatingSource,messageType:"sendMsg",quote:a.quote,source:a.source,specialTextSize:a.specialTextSize,xmaMessageType:a.xmaMessageType})}function a(a){var b=a.args,c=a.chatJid,e=a.externalId,f=a.qplEventType,g=a.qplInstanceKey;return d("MAWMessageSendsCommon").messageSendObserver(f,g,function(a){return m(b,c,e,a,f,g)},"ephemeral",{author:d("WAJids").AUTHOR_ME,chat:c,externalId:e})}function n(a,b){if(b==null)return!1;var c=b.syncResponseRetries;b=b.syncResponseSentTs;switch(c){case 1:return d("WATimeUtils").happenedWithinAt(a,b,3*60);case 2:return d("WATimeUtils").happenedWithinAt(a,b,15*60);default:return!0}}g.sendEphemeralSettingMsgFn=a}),98);
__d("MAWUpdateThreadListItemFromCOP",["MAWDbMsgTxns","MAWDeletedReactionsCache","MAWDexieTable","MAWIndexedDb","MAWMsgType","MAWTransactionMode","MAWUpdateThreadListItem","WALogger","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[MAWUpdateThreadListItemFromCOP] Bump message not found in db"]);h=function(){return a};return a}async function a(a){a=o(a);if(a.length===0)return;await i(a)}var i=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY,reactions:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY},"updateThreadListItemFromCOP",function(a){return function(b){return j(a,b)}});function j(a,b){return d("MAWDexieTable").dexieAll(b.map(function(b){var c=b.protocolMsgId,e=b.source;b=b.unstoredDbContent;var f=b.unstoredDbEditActionMsg,g=b.unstoredDbMsg;b=b.unstoredDbReaction;if(b!=null)return k(a,b,c,e);if(f!=null)return l(a,f,c,e);return g!=null?g.type===d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE?n(a,c,e):m(a,g,c,e):d("MAWDexieTable").dexieResolve()})).then(c("emptyFunction"))}function k(a,b,c,e){return p(a,b,c).then(function(f){if(f)return;if(b.reaction!=null)return d("MAWUpdateThreadListItem").updateThreadListItemFromInsertionTxn(a,b,c.chat,e);f=d("MAWDeletedReactionsCache").DeletedReactionsCache.get(c);d("MAWDeletedReactionsCache").DeletedReactionsCache.delete(c);if(f!=null)return d("MAWUpdateThreadListItem").updateThreadListItemFromDeletionTxn(a,f,f.threadJid)})}function l(a,b,c,e){return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,{author:c.author,chat:c.chat,externalId:b.originalMsgExternalId}).then(function(b){if(b==null)return;return d("MAWUpdateThreadListItem").updateThreadListItemFromInsertionTxn(a,b,c.chat,e,!0)})}function m(a,b,c,e){return d("MAWUpdateThreadListItem").updateThreadListItemFromInsertionTxn(a,b,c.chat,e)}function n(a,b,c){return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b).then(function(e){if(e==null){d("WALogger").ERROR(h());return}d("MAWUpdateThreadListItem").updateThreadListItemFromInsertionTxn(a,e,b.chat,c)})}function o(a){return a.map(function(a){var b=a[0],c=b.decodedMsg;b=b.stanza;a[1];a=a[2];return c==null||a==null||!a.success?null:{protocolMsgId:a.value.protocolMsgId,source:b.incomingType==="ebrestore"?"eb_restore":"incoming_msg",unstoredDbContent:c}}).filter(Boolean)}function p(a,b,c){return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,{author:b.reactToAuthor,chat:c.chat,externalId:b.reactToExternalId}).then(function(a){return a==null})}g.maybeUpdateThreadListItemsFromCOPMessagesHandler=a}),98);
__d("WAQueryGroupInvite",["WADeprecatedSendIq","WAPREList","WAPREMetrics","WAQueryGroup","WAResultOrError","WAWap"],(function(a,b,c,d,e,f,g){"use strict";async function a(a,b,c,e){var f,g=d("WAPREMetrics").startMetric(d("WAPREList").PRE_METRIC.QUERY_GROUP,{string:{key:"query_group_invite"}});a=(f=d("WAWap")).wap("iq",{id:f.generateId(),to:f.GROUP_JID(a),type:"get",xmlns:"w:g2"},f.wap("query",null,f.wap("add_request",{admin:f.USER_JID(e),code:f.CUSTOM_STRING(b),expiration:f.CUSTOM_STRING(c.toString(10))})));e=await d("WADeprecatedSendIq").deprecatedSendIq(a,d("WAQueryGroup").parseQueryGroupResponse);if(!e.success){g.endFail("query_group_for_invitee_fail");return d("WAResultOrError").makeError(e)}g.endSuccess();return d("WAResultOrError").makeResult(e.result.group)}g.queryGroupInvite=a}),98);
__d("MAWCOPMessagesHandler",["ACTSanitizerApiLazyLoader","ACTSanitizerApiTypes","EBAPI","FBLogger","IGDInstamadilloUtils","LSMEBTaskCreationSource","LSMessagingThreadAttributionType","MAWBridge","MAWCommonScheduler","MAWDbStaleQueue","MAWDebugMsg","MAWDownloadAndHandleMedia","MAWExternalId","MAWIsQuotaExceededError","MAWJobDefinitions","MAWJobManager","MAWLoggerUtils","MAWMediaGalleryM2Utils","MAWMessageDropError","MAWMessageParseError","MAWMpsGating","MAWMsgType","MAWODSProxy","MAWProtocolQueueDecodeProto","MAWProtocolQueueMsg","MAWProtocolQueueUtils","MAWQplProxy","MAWSendEphemeralSettingMsg","MAWSharedCOPLogger","MAWUpdateThreadListItemFromCOP","MWEBODSEntityName.enum","MWEBODSUtils","MWSharedS2SBaseAnnotations","WACreateGroup","WAGlobals","WAHashUtils","WAIsMediaDownloadRemovePersistedJobEnable","WAJids","WAMsgMap","WAOdsEnums","WAProtocolQueue","WAQueryGroup","WAQueryGroupInvite","WAResultOrError","WAStartMediaDownloadQplFlow","WATimeUtils","WorkerScheduler","err","gkx","promiseDone","qpl"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot load XMA Validation WASM module"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Scheduling job for ",", plaintextHash: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleMsg: detected out-of-sync ephemeral setting for ",", sending EPHEMERAL_SYNC_RESPONSE"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media: externalId="," - plaintextFollowUp - plaintextHash=",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot find db result for message"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Errors occurred while processing messages batch, see transactor error reports."]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot prepare msgs to put to EBUploadQueue"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot prepare msgs to put to EBUploadQueue"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["Decode error"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["Message consumer error"]);q=function(){return a};return a}function a(a,b){b===void 0&&(b=c("LSMEBTaskCreationSource").UNKNOWN);return r(a,b).catch(function(a){if(d("MAWIsQuotaExceededError").isQuotaExceededError(a))throw a;c("MAWSharedCOPLogger").catching(a).MUSTFIX(q());return[]})}async function r(a,b){if(a.length===0)return[];var e=new Set();w(a);var f=await y(),g=new(d("WAMsgMap").MsgMap)(),h=c("gkx")("8488"),i=new Map(a.map(function(a){a=x(a);a=d("WAProtocolQueue").mapProcolQueueMessageV2toV1(a);var h=a.incomingType==="ebrestore",i=d("MAWProtocolQueueUtils").startMetricForIncomingMsgV2(a,b);try{if(a.message.decrypted.type==="InstamadilloMsg")if(c("gkx")("3577")){d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.IGDW_INSTAMADILLO_MESSAGE_ON_OLD_WORKER,key:"message"});e.add(a.stanzaQueueId);i.endFail("instamadillo_msg_on_old_worker");return null}else{i.endFail("instamadillo_msg_not_supported_on_msgr");throw c("FBLogger")("messenger_web").mustfixThrow("InstamadilloMsg is not supported in MSGR. Should never happen "+d("IGDInstamadilloUtils").getE2EEGatingStateAsString())}var j=d("MAWProtocolQueueDecodeProto").decodeMsg(a.message.decrypted,f,a.ebTimestampMs);g.set(a.message.decrypted.id,a.incomingType);h&&(a.message.details.type=(j==null?void 0:j.unstoredDbReaction)!=null?"reaction":(j==null?void 0:j.unstoredXMA)!=null||(j==null?void 0:j.unstoredDbMedia)!=null?"media":"text");return[a.stanzaQueueId,d("MAWProtocolQueueUtils").addAnnotationsToMessage({decodedMsg:j!=null?j:void 0,stanza:babelHelpers.extends({},a)},i)]}catch(b){h=b instanceof Error?b:c("err")("Unknown error");c("MAWSharedCOPLogger").catching(h).MUSTFIX(p());j=b instanceof d("MAWMessageParseError").MAWMessageParseError?b:null;var k=b instanceof d("MAWMessageDropError").MAWMessageDropError;if(k){e.add(a.stanzaQueueId);i.addPoint("network_verification_msg_dropped");i.endSuccess({string:{isDropped:"true"}});return null}if(j==null&&d("MAWMpsGating").isMpsM3OrLater()===!1){c("promiseDone")(d("MAWDbStaleQueue").mawAddStaleStanza(a,"Decode issue: "+((k=h==null?void 0:h.message)!=null?k:"")))}e.add(a.stanzaQueueId);i.endFail("decoding_error",{string:{errorDescription:(a=(k=j==null?void 0:j.message)!=null?k:h==null?void 0:h.message)!=null?a:"",isDropped:"true"}});return null}}).filter(Boolean)),j=0;if(h&&!d("MAWMpsGating").isFullMpsEnabled())try{d("MWEBODSUtils").markODSForEB(c("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"upload.api.receive.call",i.size);var q=Array.from(i.values()).filter(function(a){return a.stanza.incomingType==="wa"});j=q.length;await c("EBAPI").uploadReceivedMessagesProtobufOnly({uploadArray:q})}catch(a){c("MAWSharedCOPLogger").catching(a).MUSTFIX(o())}var r=await d("MAWProtocolQueueMsg").handleIncomingMessagesStanzas(Array.from(i.values()),b);r.toAck.forEach(function(a){return e.add(a)});q=a.map(function(a){var b=i.get(a.stanzaQueueId);if(b==null)return null;b=b;var c=r.followUpParams.incomingMsgResults.get(b.stanza.message.decrypted.id);return[b,e.has(a.stanzaQueueId),c]}).filter(Boolean);if(!h&&!d("MAWMpsGating").isFullMpsEnabled())try{d("MWEBODSUtils").markODSForEB(c("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"upload.api.receive.call",i.size),await c("EBAPI").uploadReceivedMessages({incomingMessages:Array.from(i.values()).filter(function(a){return a.stanza.incomingType==="wa"}),msgResults:r.followUpParams.incomingMsgResults})}catch(a){c("MAWSharedCOPLogger").catching(a).MUSTFIX(n())}e.size!==a.length&&c("MAWSharedCOPLogger").WARN(m());var z=new Map(),A=new Set();q.forEach(function(a){var e=a[0],f=a[1];a=a[2];e.receiveFlow.addPoint("consumer_handle_message_stanza_end",{bool:{dbSuccess:!!(a==null?void 0:a.success)}});if(f){e.receiveFlow.addPoint("ack_received");var h=e.stanza.message.decrypted.type;h==="UnavailableMsg"||h==="IncomingCiphertextMsg"?e.receiveFlow.endFail(h):(e.stanza.message.details.type==="media"&&e.receiveFlow.addPoint("message_with_media"),e.receiveFlow.endSuccess())}if(!a&&!f){c("MAWSharedCOPLogger").MUSTFIX(l());e.receiveFlow.endFail("db_result_not_found");return}if(!a)return;if(a.success===!1){h=a.error;switch(h.type){case"group_invite":e.receiveFlow.endFail("end_with_db_error_group_invite");z.set(h.groupJid,{folder:h.folder,inviteCode:h.inviteCode,inviteExpireTs:h.inviteExpireTs,inviterJid:h.inviterJid});e.receiveFlow.endFail("need_group_invite");break;case"invalid_args":e.receiveFlow.endFail("invlid_args");break;default:e.receiveFlow.endFail(h.type);break}return}a.success;if(a.value!=null){f=a.value;var i=f.msgType;h=f.outOfSyncEphemeralSetting;a=f.plaintextHashs;var j=f.protocolMsgId;f=f.unknownGroup;if(f){f=d("WAJids").interpretAsGroupJid(j.chat);f!=null&&A.add(f)}s(h,j);f=!(b===c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE&&d("MAWMediaGalleryM2Utils").shouldSkipSyncToLSDB());f&&(a==null?void 0:a.forEach(function(a){c("MAWSharedCOPLogger").DEBUG(k(),e.stanza.message.details.externalId,d("WAHashUtils").sanitisePlaintextHash(a));t({msgType:i,plaintextHash:a,protocolMsgId:j,source:(a=g.get(j))!=null?a:"wa"})}))}});await d("MAWUpdateThreadListItemFromCOP").maybeUpdateThreadListItemsFromCOPMessagesHandler(q);u(A);v(z);h&&j>0&&j>e.size&&d("MAWODSProxy").odsBumpEntityKey({amount:j-e.size,entity:d("WAOdsEnums").Entity.EB_UPLOAD,key:"upload_count_higher_than_acks"});return Array.from(e)}function s(a,b){a!=null&&(c("MAWSharedCOPLogger").tags([d("MAWLoggerUtils").Tag.Ephemeral,d("MAWLoggerUtils").Tag.SettingSync]).DEBUG(j(),b==null?void 0:b.externalId),c("promiseDone")(d("MAWCommonScheduler").mawCommonScheduler().runTask({fn:async function(){var b=d("MAWLoggerUtils").getInstanceKey(),e=d("MAWQplProxy").startQplUserFlow(c("qpl")._(25313175,"1551"),await d("MWSharedS2SBaseAnnotations").getSendToSentBaseAnnotations(d("MWSharedS2SBaseAnnotations").getMessageTypeParams({isEphemeralSetting:!0}),c("LSMessagingThreadAttributionType").UNKNOWN),{providedInstanceKey:b});try{b=await d("MAWSendEphemeralSettingMsg").sendEphemeralSettingMsgFn({args:{ephemeralSetting:{ephemeralExpirationInSec:a.correctEphemeralExpirationInSec,ephemeralLastUpdatedOrSetTimestamp:a.correctEphemeralLastUpdatedOrSetTimestamp},isEphemeralSettingReset:!1,isForSyncResponse:!0},chatJid:a.chatJid,externalId:d("MAWExternalId").generateExternalId(),qplEventType:c("qpl")._(25313175,"1551"),qplInstanceKey:b});if(b.success){e.endSuccess();if(b.value!=null){var f=b.value;d("MAWBridge").getBridge().fireAndForget("event","handleMessageSendResult",{report:f,success:!0},!0)}}else e.endFail(b.error.type)}catch(a){f=a instanceof Error?a:null;e==null?void 0:e.endFail("failed_to_send_empemeral_settings",{string:{errorDescription:(b=f==null?void 0:f.message)!=null?b:""}})}},name:"ephemeral_sync_response",priority:d("WorkerScheduler").BACKGROUND_PRIORITY})))}function t(a){var b=a.msgType,e=a.plaintextHash,f=a.protocolMsgId;a=a.source;if(f!=null&&e!=null&&b!==d("MAWMsgType").MSG_TYPE.RAVEN){c("MAWSharedCOPLogger").tags(["downloadAndHandleMedia"]).DEBUG(i(),String(f),d("WAHashUtils").sanitisePlaintextHash(e));var g=a==="ebrestore"?"EBRestore":"WAIncomingMsg";if(d("WAIsMediaDownloadRemovePersistedJobEnable").isMediaDownloadRemovePersistedJobEnable()){if(c("gkx")("1614")&&a==="ebrestore")return;a=d("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:g,msgType:b,protocolMsgId:f,triggerUIView:null});void d("MAWDownloadAndHandleMedia").downloadAndHandleMediaImpl({downloadEntry:g,hash:e,mediaDownloadFlow:a,msgType:b,protocolMsgId:f})}else d("MAWJobManager").getJobManager().fireAndForget(d("MAWJobDefinitions").jobSerializers.downloadAndHandleMedia(f,e,g,b,null))}}function u(a){if(a.size===0)return;c("promiseDone")(d("MAWCommonScheduler").mawCommonScheduler().runTask({fn:function(){return b()},name:"queryGroup",priority:d("WorkerScheduler").BACKGROUND_PRIORITY}));async function b(){var b=await Promise.all(Array.from(a).map(function(a){return d("WAQueryGroup").queryGroup(a,"interactive").catch(function(a){return d("WAResultOrError").makeError()})}));b=b.map(function(a){if(a.success===!0){a={extras:null,folder:null,groupStatus:"added",groupToCreate:a.value,key:null,serverTs:d("WATimeUtils").unixTime()};return a}return null}).filter(Boolean);await d("WACreateGroup").createGroups(b)}}function v(a){if(a.size===0)return;c("promiseDone")(d("MAWCommonScheduler").mawCommonScheduler().runTask({fn:function(){return b()},name:"queryGroupInvite",priority:d("WorkerScheduler").BACKGROUND_PRIORITY}));async function b(){var b=await Promise.all(Array.from(a.entries()).map(function(a){var b=a[0];a=a[1];var c=a.inviteCode,e=a.inviteExpireTs;a=a.inviterJid;return d("WAQueryGroupInvite").queryGroupInvite(b,c,e,a).catch(function(a){return d("WAResultOrError").makeError()})}));b=b.map(function(a){if(a.success===!0){a={extras:null,folder:null,groupStatus:"added",groupToCreate:a.value,key:null,serverTs:d("WATimeUtils").unixTime()};return a}return null}).filter(Boolean);await d("WACreateGroup").createGroups(b)}}function w(a){if(c("gkx")("23915"))for(a of a)a.subtype==="ciphertext"&&c("promiseDone")(d("MAWDebugMsg").writeDebugMsg(a.jid,"Message "+a.stanzaId+" has decryption error: "+a.decryptionError+" from user "+a.from,{decryptionError:a.decryptionError,protocolMsgId:{author:d("WAGlobals").getMyDeviceJid()===a.from?"@me":d("WAJids").extractUserJid(a.from),chat:a.jid,externalId:a.stanzaId}}))}function x(a){if(a.message==null)return a;if(a.message.type!=="ephemeral")return a;var b=a.serverTs;a.message.ephemeralLastUpdatedOrSetTimestamp=a.message.ephemeralLastUpdatedOrSetTimestamp===d("WATimeUtils").DEFAULT_UNIXTIME?b:a.message.ephemeralLastUpdatedOrSetTimestamp;return a}function y(){return d("MAWMpsGating").isMpsM3OrLater()?Promise.resolve(function(){return d("ACTSanitizerApiTypes").ACTSanitizerValidationResult.Valid}):d("ACTSanitizerApiLazyLoader").loadACTSanitizerApi().then(function(a){return a.isXMAValid}).catch(function(a){c("MAWSharedCOPLogger").tags(["ActSanitizerWasmApi"]).catching(a).MUSTFIX(h());return function(){throw a}})}g.default=a}),98);
__d("MAWDbHistorySyncQRCodeData",[],(function(a,b,c,d,e,f){"use strict";a="qrCodeRowId";f.qrCodeRowId=a}),66);
__d("MAWHandleEncryptedBackupsSecretsApi",["MAWDbHistorySyncQRCodeData","MAWIndexedDb","MAWTransactionMode","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({historySyncQRCodeData:d("MAWTransactionMode").READWRITE},"handleEncryptedBackupsSecret",function(a){return function(b){var e=b.backupId,f=b.epoch,g=b.mailboxRootKey,i=b.obliviousValidationToken,j=b.serverDataId,k=b.tempOcmfClientState;return a.historySyncQRCodeData.get(d("MAWDbHistorySyncQRCodeData").qrCodeRowId).then(function(b){if(!(b==null?void 0:b.isQRScanned))return a.historySyncQRCodeData.put({isQRScanned:!0,rowId:d("MAWDbHistorySyncQRCodeData").qrCodeRowId}).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"CallFinishAddDevice",value:{backupId:e.toString(),epoch:h(f),mailboxRootKey:g,obliviousValidationToken:i,serverDataId:j.toString(),tempOcmfClientState:k}});return})["catch"](function(b){return a.historySyncQRCodeData.put({isQRScanned:!1,rowId:d("MAWDbHistorySyncQRCodeData").qrCodeRowId}).then(c("emptyFunction"))})})}});function h(a){return a.map(function(a){var b=a.anonId,c=a.id,d=a.rootKey;a=a.status;return{epoch_anon_id:b,epoch_id:c.toString(),epoch_root_key:d,epoch_status:a.toString()}})}g.handleEncryptedBackupsSecret=a}),98);
__d("MAWWriteMetaSyncsTxns",["MAWDbDeletedMessages","MAWDbPendingStanza","MAWDbPendingStanzaTxns","MAWDbThreadTxns","MAWDexieTable","MAWFTSTxns","MAWThreadManagementTxns","WALogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[MAWWriteMetaSyncsTxns] Thread delete stanza was processed before thread insertion ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Received chatDelete: ",""]);i=function(){return a};return a}var j=30*d("WATimeUtils").DAY_SECONDS;function a(a,b){d("WALogger").LOG(i(),b);var c=b.messageRange;c=c!=null?d("MAWDbPendingStanzaTxns").putPendingStanza(a,{content:{metaSyncMessageRange:c},type:d("MAWDbPendingStanza").PENDING_TYPE.DELETE_THREAD},j,b.chatJid,d("MAWDbPendingStanza").PENDING_TYPE.DELETE_THREAD):d("MAWDexieTable").dexieResolve();return d("MAWDexieTable").dexieAll([d("MAWDbThreadTxns").getThread(a,b.chatJid),c,d("MAWFTSTxns").maybePutThreadToPurgeBacklog(a,b.chatJid)]).then(function(c){c=c[0];if(c.success)return d("MAWThreadManagementTxns").metaSyncChatDeleteThread(a,c.value,b.messageRange,d("MAWDbDeletedMessages").DbDeletedMsgReasonEnum.cast(b.type));else{d("WALogger").LOG(h(),b.chatJid);return{deletedMessages:[]}}})}g.PENDING_DELETE_THREAD_EXPIRATION_IN_SEC=j;g.handleChatDelete=a}),98);
__d("WADeleteReceiptsApi",["MAWTransactionMode","WADbTransactor"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b){return a.receipts.where("waMsgId").anyOf(b)["delete"]().then(function(){})}a=d("WADbTransactor").makeSignalTransactor({receipts:d("MAWTransactionMode").READWRITE},"deleteReceipts",function(a){return function(b){return h(a,b)}});g.deleteAllReceiptsForWAMsgIds=h;g.deleteReceipts=a}),98);
__d("MAWHandleMetaSyncAction",["MAWIndexedDb","MAWTransactionMode","MAWWriteDeleteMessageTxns","MAWWriteMetaSyncsTxns","WAAssertUnreachable","WADeleteReceiptsApi","WALogger","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Received action: ",""]);h=function(){return a};return a}async function a(a){for(a of a.actions)a.chatAction?await i(a.chatAction):a.messageAction&&await l(a.messageAction)}function i(a){d("WALogger").LOG(h(),a);switch(a.type){case"chat_archive":return j(a);case"chat_delete":return m(a).then(function(a){a=a.deletedMessages;return d("WADeleteReceiptsApi").deleteReceipts(a)});default:a.type;return k(a)}}function j(a){return Promise.resolve()}function k(a){return Promise.resolve()}function l(a){switch(a.type){case"delete_for_me":return n(a).then(c("emptyFunction"));default:return c("WAAssertUnreachable")(a.type)}}var m=d("MAWIndexedDb").makeMsgrTransactor({chunk:(b=d("MAWTransactionMode")).READWRITE,deletedMessages:b.READWRITE,editMsgHistory:b.READWRITE,ftsPurgeThreadBacklog:b.READWRITE,groupInfo:b.READWRITE,groupInvites:b.READWRITE,media:b.READWRITE,messages:b.READWRITE,participants:b.READWRITE,pendingStanzas:b.READWRITE,reactions:b.READWRITE,threads:b.READWRITE,unrenderedMessages:b.READWRITE,xma:b.READWRITE},"handleChatDeleteTxn",function(a){return function(b){return d("MAWWriteMetaSyncsTxns").handleChatDelete(a,b)}}),n=d("MAWIndexedDb").makeMsgrTransactor({chunk:b.READWRITE,editMsgHistory:b.READWRITE,ftsPurgeBacklog:b.READWRITE,groupInfo:b.READWRITE,groupInvites:b.READWRITE,media:b.READWRITE,messages:b.READWRITE,participants:b.READWRITE,pendingStanzas:b.READWRITE,reactions:b.READWRITE,threads:b.READWRITE,unrenderedMessages:b.READWRITE,xma:b.READWRITE},"handleDeleteForMeTxn",function(a){return function(b){return d("MAWWriteDeleteMessageTxns").handleDeleteForMe(a,b)}});g.handleMetaSyncActions=a}),98);
__d("MAWProtocolQueueAppdata",["MAWHandleEncryptedBackupsSecretsApi","MAWHandleMetaSyncAction","MAWSharedCOPLogger","Promise","WAConvertAppData","WAMsgApplication.pb","WAParseMessageApplication","WAProtocolQueue","WAResultOrError","decodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unknown appdata type: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Handle appdata: backup secret"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Handle appdata: meta sync"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Handle appdata"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Appdata contains unparseable message application."]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Parse Appdata application protocol"]);n=function(){return a};return a}function a(a){var c=a.map(function(a){return o(a.appdata)});return(h||(h=b("Promise"))).all(c.map(function(a){a=p(a);return a})).then(function(b){var c=[];b.map(function(b,d){b.success===!0&&c.push(a[d].stanzaQueueId)});return{followUpParams:void 0,toAck:c}})}function o(a){c("MAWSharedCOPLogger").DEBUG(n());a=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMsgApplication.pb").MessageApplicationSpec,d("WAProtocolQueue").extractSubProtocolFromAppdataProtocol(a).payload);a=d("WAParseMessageApplication").parseMessageApplication(a);if(a.type==="error"){c("MAWSharedCOPLogger").MUSTFIX(m());return}return d("WAConvertAppData").parseAppData(a)}function p(a){c("MAWSharedCOPLogger").DEBUG(l());if(a==null)return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult());switch(a.type){case"meta_sync":c("MAWSharedCOPLogger").DEBUG(k());return d("MAWHandleMetaSyncAction").handleMetaSyncActions(a).then(function(){return d("WAResultOrError").makeResult()});case"backups_secrets":c("MAWSharedCOPLogger").DEBUG(j());return d("MAWHandleEncryptedBackupsSecretsApi").handleEncryptedBackupsSecret(a.encryptedBackupsSecrets).then(function(){return d("WAResultOrError").makeResult()});case"sync_key_share":return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult());case"sync_key_request":return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult());default:a.type;c("MAWSharedCOPLogger").WARN(i(),a.type);return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult())}}g.handleAppdataStanzas=a}),98);
__d("MAWCOPAppdataHandler",["MAWIsQuotaExceededError","MAWProtocolQueueAppdata","MAWSharedCOPLogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Errors occurred while processing appdata batch, see transactor error reports."]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Appdata consumer error"]);i=function(){return a};return a}function a(a){return j(a).catch(function(a){if(d("MAWIsQuotaExceededError").isQuotaExceededError(a))throw a;c("MAWSharedCOPLogger").catching(a).MUSTFIX(i());return[]})}async function j(a){if(a.length===0)return[];var b=await d("MAWProtocolQueueAppdata").handleAppdataStanzas(a);b.toAck.length!==a.length&&c("MAWSharedCOPLogger").WARN(h());return b.toAck}g.default=a}),98);
__d("MAWDbAddDeviceChangeAlertsTxn",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){return a.deviceChangeAlerts.add(b)}f.addDeviceChangeAlertsTxn=a}),66);
__d("MAWDbDeviceChangeAlerts",[],(function(a,b,c,d,e,f){"use strict";b="add";c="keyChange";d="remove";function a(a){return a}f.ADD=b;f.KEY_CHANGE=c;f.REMOVE=d;f.unsafeCoerceToDeviceChangeAlertsID=a}),66);
__d("MAWDbGetAlertsWithDeviceJidTxn",["err"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return a.deviceChangeAlerts.filter(function(a){return a.deviceJid===b&&!a.loggedOut}).toArray().then(function(a){a.length>1&&c("err")("Invalid result, more than one active devices with the same deviceJid: "+b);return a[0]})}g.getAlertsWithDeviceJidTxn=a}),98);
__d("MAWDbGetUnArchivedDeviceChangeAlertsCountTxn",["MAWIndexedDb"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return a.deviceChangeAlerts.filter(function(a){return a.isArchived===!1}).toArray().then(function(a){return d("MAWIndexedDb").afterTransaction({tag:"UnArchivedSelfDeviceChangeAlerts",value:a.length})})}g.getUnArchivedDeviceChangeAlertsCountTxn=a}),98);
__d("MAWDbUpdateDeviceChangeAlertsTxn",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){return a.deviceChangeAlerts.put(b)}f.updateDeviceChangeAlertsTxn=a}),66);
__d("MAWDbUpdateDeviceChangeAlertsLogInStatusTxn",["MAWDbGetAlertsWithDeviceJidTxn","MAWDbUpdateDeviceChangeAlertsTxn"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return d("MAWDbGetAlertsWithDeviceJidTxn").getAlertsWithDeviceJidTxn(a,b).then(function(b){return d("MAWDbUpdateDeviceChangeAlertsTxn").updateDeviceChangeAlertsTxn(a,babelHelpers["extends"]({},b,{loggedOut:!0}))})}g.updateDeviceChangeAlertsLogInStatusTxn=a}),98);
__d("WAUpdateDevicesForUserApi",[],(function(a,b,c,d,e,f){"use strict";function a(a){var b=a.allowSecurityAlertForContact;a=a.isMe;return!a&&b}f.getShouldShowAdminMessages=a}),66);
__d("WAUpdateRotateSenderKeyToTrue",["MAWTransactionMode","WADbPersonalSenderKeyStatusTxns","WADbTransactor"],(function(a,b,c,d,e,f,g){"use strict";a=d("WADbTransactor").makeSignalTransactor({personalSenderKeyStatuses:d("MAWTransactionMode").READWRITE},"updateRotateSenderKeyToTrue",function(a){return function(b){return d("WADbPersonalSenderKeyStatusTxns").bulkSetRotateSenderKeyToTrueTxn(a,b)}});g.updateRotateSenderKeyToTrue=a}),98);
__d("WAUpdateRotateSenderKeyToTrueV2",["WASignalDB"],(function(a,b,c,d,e,f,g){"use strict";a=function(a){return d("WASignalDB").getDb().runInTransaction(["personalSenderKeyStatuses"],"readwrite",async function(b){var c=await b.stores.personalSenderKeyStatuses.bulkGet(a);c=c.filter(function(a){return a!=null}).map(function(a){return babelHelpers.extends({},a,{rotateSenderKey:!0})});await b.stores.personalSenderKeyStatuses.bulkPut(c);return c},d("WASignalDB").signalOp("updateRotateSenderKeyToTrue"))};g.updateRotateSenderKeyToTrue=a}),98);
__d("MAWProtocolQueueInstructions",["MAWAdminWriteUserDeviceMsgTxn","MAWBridge","MAWDbAddDeviceChangeAlertsTxn","MAWDbDeviceChangeAlerts","MAWDbGetAlertsWithDeviceJidTxn","MAWDbGetUnArchivedDeviceChangeAlertsCountTxn","MAWDbMsgTypeVersionTxns","MAWDbThreadTxns","MAWDbUpdateDeviceChangeAlertsLogInStatusTxn","MAWDexieTable","MAWIndexedDb","MAWODSProxy","MAWTransactionMode","WAAssertUnreachable","WADbContact","WADexieToWormMigration","WAGlobals","WAJids","WALogger","WAOdsEnums","WAUpdateDevicesForUserApi","WAUpdateRotateSenderKeyToTrue","WAUpdateRotateSenderKeyToTrueV2"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["ICDC error instruction for thread "," not found"]);h=function(){return a};return a}function i(a,b){b=new Set(b.map(function(a){return a.jid}));return d("MAWDexieTable").dexieAll([d("MAWDbMsgTypeVersionTxns").maybeBulkGetSecuritySetting(a),d("MAWDbThreadTxns").getAllThreadsForUsers(a,Array.from(b))])}async function a(a){var b=await d("MAWBridge").getBridge().sendAndReceive("event","getLSDBUsersRelationships",{users:Array.from(new Set(a.map(function(a){return a.jid})))});a=await j(a,b);b=a.followUpParams;a=a.toAck;b=b.groupsToUpdateForIdentityRemoved.flat();var c=d("WADexieToWormMigration").isWorm("MAWProtocolQueueInstructions")?d("WAUpdateRotateSenderKeyToTrueV2").updateRotateSenderKeyToTrue:d("WAUpdateRotateSenderKeyToTrue").updateRotateSenderKeyToTrue;await c(b);return{followUpParams:void 0,toAck:a}}var j=d("MAWIndexedDb").makeMsgrTransactor({appMeta:(b=d("MAWTransactionMode")).READONLY,deviceChangeAlerts:b.READWRITE,ftsBackloggedMessages:b.READWRITE,groupInfo:b.READONLY,messages:b.READWRITE,participants:b.READONLY,threads:b.READWRITE},"handleInstructions",function(a){return function(b,c){return i(a,b).then(function(e){var f=e[0],g=f.allowSecurityAlertForContact,h=f.allowSecurityAlertForSelf,i=e[1];return d("MAWDexieTable").dexieSequentialAll(b.map(function(b){var e=b.jid,f=e===d("WAGlobals").getMyUserJid(),j=d("WAUpdateDevicesForUserApi").getShouldShowAdminMessages({allowSecurityAlertForContact:g,isMe:f})&&c.get(e)===d("WADbContact").TWO_WAY_CONTACT,l={allowSecurityAlertForSelf:h,isMe:f,shouldShowAdminMessages:j,threads:(f=i.get(e))!=null?f:[],user:e};return function(){return k(a,b,l)}})).then(function(){var a=b.filter(function(a){return a.instruction==="identityRemoved"}).map(function(a){a=(a=i.get(a.jid))!=null?a:[];a=a.map(function(a){return d("WAJids").interpretAsGroupJid(a.jid)}).filter(Boolean);return a});return{followUpParams:{groupsToUpdateForIdentityRemoved:a},toAck:b.map(function(a){return a.stanzaQueueId})}})})}});function k(a,b,d){switch(b.instruction){case"identityChanged":return l(a,b,d);case"identityAdded":return m(a,b,d);case"identityRemoved":return n(a,b,d);case"icdcError":return o(a,b,d);default:throw c("WAAssertUnreachable")(b)}}function l(a,b,c){var e=c.allowSecurityAlertForSelf,f=c.isMe,g=c.shouldShowAdminMessages;c=c.threads;var h=f&&b.model!=null&&b.platform!=null&&b.notificationTs!=null;return d("MAWDexieTable").dexieAll([h&&b.model!=null&&b.platform!=null&&b.notificationTs!=null?d("MAWDbAddDeviceChangeAlertsTxn").addDeviceChangeAlertsTxn(a,{action:d("MAWDbDeviceChangeAlerts").KEY_CHANGE,deviceJid:b.device,identity:b.identity,isArchived:!e,model:b.model,platform:b.platform,ts:b.notificationTs}).then(function(){return d("MAWDbGetUnArchivedDeviceChangeAlertsCountTxn").getUnArchivedDeviceChangeAlertsCountTxn(a)}):d("MAWDexieTable").dexieResolve()].concat(g?c.map(function(c){return d("WAJids").interpretAsGroupJid(c.jid)==null&&d("MAWAdminWriteUserDeviceMsgTxn").writeUserDeviceAdminMsg(a,b.jid,c,d("MAWAdminWriteUserDeviceMsgTxn").DeviceChange.update,b.notificationTs)}):[])).then(function(){(h||g)&&d("MAWODSProxy").odsBumpEntityKey({entity:f?d("WAOdsEnums").Entity.SECURITY_ALERT_FOR_SELF:d("WAOdsEnums").Entity.SECURITY_ALERT_FOR_CONTACT,key:d("MAWDbDeviceChangeAlerts").KEY_CHANGE})})}function m(a,b,c){var e=c.allowSecurityAlertForSelf,f=c.isMe,g=c.shouldShowAdminMessages,h=c.threads,i=c.user,j=f&&b.model!=null&&b.platform!=null&&b.notificationTs!=null;return d("MAWDexieTable").dexieAll([j&&b.model!=null&&b.platform!=null&&b.notificationTs!=null?d("MAWDbAddDeviceChangeAlertsTxn").addDeviceChangeAlertsTxn(a,{action:d("MAWDbDeviceChangeAlerts").ADD,deviceJid:b.device,identity:b.identity,isArchived:!e,model:b.model,platform:b.platform,ts:b.notificationTs}).then(function(){return d("MAWDbGetUnArchivedDeviceChangeAlertsCountTxn").getUnArchivedDeviceChangeAlertsCountTxn(a)}):d("MAWDexieTable").dexieResolve()].concat(g?h.map(function(c){return d("WAJids").interpretAsGroupJid(c.jid)==null&&d("MAWAdminWriteUserDeviceMsgTxn").writeUserDeviceAdminMsg(a,i,c,d("MAWAdminWriteUserDeviceMsgTxn").DeviceChange.add,b.notificationTs)}):[])).then(function(){(j||g)&&d("MAWODSProxy").odsBumpEntityKey({entity:f?d("WAOdsEnums").Entity.SECURITY_ALERT_FOR_SELF:d("WAOdsEnums").Entity.SECURITY_ALERT_FOR_CONTACT,key:d("MAWDbDeviceChangeAlerts").ADD})})}function n(a,b,c){var e=c.isMe,f=c.shouldShowAdminMessages,g=c.threads,h=c.user;return d("MAWDexieTable").dexieAll([e?d("MAWDbGetAlertsWithDeviceJidTxn").getAlertsWithDeviceJidTxn(a,b.device).then(function(){return d("MAWDbUpdateDeviceChangeAlertsLogInStatusTxn").updateDeviceChangeAlertsLogInStatusTxn(a,b.device)}).then(function(){return d("MAWDbGetUnArchivedDeviceChangeAlertsCountTxn").getUnArchivedDeviceChangeAlertsCountTxn(a)}):d("MAWDexieTable").dexieResolve()].concat(f?g.map(function(c){return d("WAJids").interpretAsGroupJid(c.jid)==null&&d("MAWAdminWriteUserDeviceMsgTxn").writeUserDeviceAdminMsg(a,h,c,d("MAWAdminWriteUserDeviceMsgTxn").DeviceChange.remove,b.notificationTs)}):[])).then(function(){(e||f)&&d("MAWODSProxy").odsBumpEntityKey({entity:e?d("WAOdsEnums").Entity.SECURITY_ALERT_FOR_SELF:d("WAOdsEnums").Entity.SECURITY_ALERT_FOR_CONTACT,key:d("MAWDbDeviceChangeAlerts").REMOVE})})}function o(a,b,c){c=c.threads;if(!d("WAGlobals").getConfig().isICDCErrorEnabled())return d("MAWDexieTable").dexieResolve();c=c.find(function(a){return a.jid===b.jid});if(c==null){d("WALogger").ERROR(h(),b.jid);return d("MAWDexieTable").dexieResolve()}return d("MAWAdminWriteUserDeviceMsgTxn").writeICDCAlert(a,b.jid,c,b.notificationTs)}g.handleInstructions=a}),98);
__d("MAWCOPInstructionsHandler",["MAWIsQuotaExceededError","MAWProtocolQueueInstructions","MAWSharedCOPLogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Errors occurred while processing instructions batch, see transactor error reports."]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Instruction consumer error"]);i=function(){return a};return a}function a(a){return j(a).catch(function(a){if(d("MAWIsQuotaExceededError").isQuotaExceededError(a))throw a;c("MAWSharedCOPLogger").catching(a).MUSTFIX(i());return[]})}async function j(a){if(a.length===0)return[];var b=await d("MAWProtocolQueueInstructions").handleInstructions(a);b.toAck.length!==a.length&&c("MAWSharedCOPLogger").WARN(h());return b.toAck}g.default=a}),98);
__d("MAWChangeGroupMemberAddModeApi",["MAWAdminMsgHelpers","MAWRunInTransaction","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";a=function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return d("MAWRunInTransaction").runInTransaction({GroupInfoStore:!0,MessagesStore:!0},function(a){return h.apply(void 0,[a].concat(b))},"changeGroupMemberAddMode")};var h=async function(a,b,c,e,f,g){var h=a.GroupInfoStore;a=a.MessagesStore;var i=await h.get(b);if(!i.success)return d("WAResultOrError").makeError("missing_group");await h.update(b,function(a){return babelHelpers.extends({},a,{memberAddMode:e})});if(g==="create_admin_message"){i=d("MAWAdminMsgHelpers").createMemberAddModeChangeAdminMsg(b,e,c,f);i!=null&&await a.create(i)}return d("WAResultOrError").makeResult()};g.changeGroupMemberAddMode=a;g.changeGroupMemberAddModeTransactor=h}),98);
__d("MAWChangeGroupParticipantAdminStatusApi",["MAWAdminMsgHelpers","MAWRunInTransaction","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";a=function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return d("MAWRunInTransaction").runInTransaction({GroupInfoStore:!0,MessagesStore:!0,ParticipantsStore:!0},function(a){return h.apply(void 0,[a].concat(b))},"changeGroupParticipantAdminStatus")};var h=async function(a,b,c,e,f,g,h){var i=a.GroupInfoStore,j=a.MessagesStore;a=a.ParticipantsStore;var k=await i.get(c);if(!k.success)return d("WAResultOrError").makeError("missing_group");k=f.map(function(a){return{addressable:a.addressable,chatJid:c,type:g,user:a.user}});await a.bulkPut(k);if(b!=null){await i.update(c,function(a){return babelHelpers.extends({},a,{participantVersion:b.current})});for(f=0;f<k.length;f++)g==="admin"?a=d("MAWAdminMsgHelpers").createParticipantPromoteAdminMsg(c,k[f].user,e,h):a=d("MAWAdminMsgHelpers").createParticipantDemoteAdminMsg(c,k[f].user,e,h),await j.create(a)}return d("WAResultOrError").makeResult()};g.changeGroupParticipantAdminStatus=a;g.changeGroupParticipantAdminStatusTransactor=h}),98);
__d("MAWParticipantManagementTxns",["MAWDbParticipantTxns","MAWDbThreadTxns","MAWDexieTable","MAWUserJidWrapper"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c){return d("MAWDbParticipantTxns").getParticipantsInThread(a,b).then(function(e){if(c.length===0&&e.length===0)return{addedJids:[],participants:e,removedJids:[],typeUpdateJids:[]};var f=new Map();e.forEach(function(a){f.set(a.userJid,a)});var g=new Set(c.map(function(a){return a.userJid})),h=[],i=[],j=[],k=[];f.forEach(function(a,b){g.has(b)||(a.type!=="invitedParticipant"?h.push(b):(k.push({type:a.type,userJid:a.userJid}),j.push(babelHelpers["extends"]({},a))))});c.forEach(function(a){var b=f.get(a.userJid);b==null?(i.push(a),a.type==="admin"&&k.push({type:a.type,userJid:a.userJid})):(b.type!==a.type&&k.push({type:a.type,userJid:a.userJid}),j.push(babelHelpers["extends"]({},b,a)))});var l=h.indexOf(d("MAWUserJidWrapper").getMyUserJid())>=0;e=function(){return[d("MAWDbParticipantTxns").bulkAddParticipants(a,b,i),d("MAWDbParticipantTxns").bulkUpdateParticipants(a,j),d("MAWDbParticipantTxns").bulkDeleteParticipantsInThread(a,b,h),l?d("MAWDbThreadTxns").archiveThreads(a,[b],!0):d("MAWDexieTable").dexieResolve()]};return d("MAWDexieTable").dexieAll(e()).then(function(a){var b=a[0];a=a[1];return{addedJids:i.map(function(a){return a.userJid}),participants:[].concat(b,a),removedJids:h,typeUpdateJids:k}})})}g.syncParticipantList=a}),98);
__d("MAWGroupManagementTxns",["MAWAdminWriteChangeParticipantsAdminMsgTxn","MAWAdminWriteGroupNameChangeTxn","MAWDbGroupInfoTxns","MAWDbParticipantTxns","MAWDbThreadTxns","MAWDexieTable","MAWExternalId","MAWFolderTypes","MAWGetOrCreateThreadTxns","MAWParticipantManagementTxns","MAWThreadManagementTxns","MAWUserJidWrapper","WATimeUtils","isGroupInvitesEnabled"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c){return d("MAWDexieTable").dexieAll([d("MAWThreadManagementTxns").deleteAllThreadData(a,c),d("MAWDbGroupInfoTxns").deleteGroupInfo(a,b)]).then(function(a){a=a[0];return a}).then(function(a){return a})}b=function(a,b){var e=b.authoritativeThreadKey,f=b.deduplicationKey,g=b.extras,h=b.folder,i=b.groupStatus,j=b.groupToCreate,k=b.serverTs;b=i==="added"?d("WATimeUtils").unixTime():j.creationTs;return d("MAWGetOrCreateThreadTxns").getOrCreateThread(a,{authoritativeThreadKey:e,clientThreadKey:g==null?void 0:g.clientThreadKey,createTs:d("WATimeUtils").castUnixTimeToMillisTime(b),deduplicationKey:f,description:"createGroup",folder:h==null?d("MAWFolderTypes").FOLDER_ID.INBOX:h,jid:j.jid}).then(function(b){var e=b.created,f=b.thread;b=j.participants.map(function(a){return a.error?c("isGroupInvitesEnabled")()&&a.error.errorCode===403?{addressable:!0,type:"invitedParticipant",userJid:a.error.user}:null:{addressable:a.value.addressable,type:a.value.type,userJid:a.value.user}}).filter(Boolean);var g=e?d("MAWDbParticipantTxns").bulkAddParticipants:d("MAWParticipantManagementTxns").syncParticipantList;g=g(a,f.jid,b);b=d("MAWUserJidWrapper").getMyUserJid();b=i==="added"&&!e&&j.creator!==b?d("MAWAdminWriteChangeParticipantsAdminMsgTxn").writeAddParticipantAdminMsg(a,{admin:j.inviter,chatJid:f.jid,externalId:d("MAWExternalId").generateExternalId(),participants:[b],serverTs:k}):d("MAWDexieTable").dexieResolve();j.description;j.participants;var h=babelHelpers.objectWithoutPropertiesLoose(j,["description","participants"]);return d("MAWDexieTable").dexieAll([g,d("MAWDbGroupInfoTxns").putGroupInfo(a,h),b]).then(function(b){b[0];b=b[1];return e&&i==="added"?d("MAWAdminWriteGroupNameChangeTxn").writeGroupNameChangeInfo(a,b,f):d("MAWDexieTable").dexieResolve()}).then(function(){return f.archived===!0?d("MAWDbThreadTxns").unarchiveThreads(a,[f.jid]):d("MAWDbThreadTxns").subscribeToThreads(a,[f.jid])}).then(function(a){return f.jid})})};g.deleteGroup=a;g.createGroupInternal=b}),98);
__d("MAWThreadTypes",["MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";b={chunk:(a=d("MAWTransactionMode")).READWRITE,deletedMessages:a.READWRITE,editMsgHistory:a.READWRITE,groupInfo:a.READWRITE,groupInvites:a.READWRITE,media:a.READWRITE,messages:a.READWRITE,participants:a.READWRITE,pendingStanzas:a.READWRITE,reactions:a.READWRITE,threads:a.READWRITE,unrenderedMessages:a.READWRITE,xma:a.READWRITE};g.ThreadRelatedTablesPermissions=b}),98);
__d("MAWDeleteGroupsApi",["MAWDbThreadTxns","MAWDexieTable","MAWGroupManagementTxns","MAWIndexedDb","MAWThreadTypes","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor(d("MAWThreadTypes").ThreadRelatedTablesPermissions,"deleteGroups",function(a){return function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){var c=b.group;return d("MAWDbThreadTxns").getThread(a,c).then(function(b){return!b.success?d("WAResultOrError").makeError("missing_thread"):d("MAWGroupManagementTxns").deleteGroup(a,c,b.value).then(function(a){return d("WAResultOrError").makeResult({deletedGroupId:c,deletedMsgIds:a.deletedMessages})})})})).then(function(a){return a})}});g.deleteGroupsFromMAW=a}),98);
__d("WADeleteGroupFollowUpLowLevelApi",["MAWDexieTable","MAWTransactionMode","WADbPersonalSenderKeyStatusTxns","WADbTransactor"],(function(a,b,c,d,e,f,g){"use strict";a=d("WADbTransactor").makeSignalTransactor({personalSenderKeyStatuses:d("MAWTransactionMode").READWRITE,receipts:d("MAWTransactionMode").READWRITE},"deleteGroupFollowUpLowLevel",function(a){return function(b,c){return d("MAWDexieTable").dexieAll([d("WADbPersonalSenderKeyStatusTxns").bulkDeletePersonalSenderKeyStatus(a,[b]),h(a,c)]).then(function(){})}});function h(a,b){return a.receipts.where("waMsgId").anyOf(b)["delete"]().then(function(){})}g.deleteGroupFollowUpLowLevel=a}),98);
__d("WADeleteGroupFollowUpLowLevelApiV2",["WASignalDB"],(function(a,b,c,d,e,f,g){"use strict";a=function(a){return d("WASignalDB").getDb().runInTransaction(["senderKeySessions","personalSenderKeyStatuses"],"readwrite",async function(b){await Promise.all([b.stores.senderKeySessions.readIndex("groupJid",[a]).then(function(a){return b.stores.senderKeySessions.bulkDelete(a.map(function(a){return a.id}))}),b.stores.personalSenderKeyStatuses.delete(a)])},d("WASignalDB").signalOp("deleteGroupFollowUpLowLevel"))};g.deleteGroupFollowUpLowLevel=a}),98);
__d("MAWDeleteGroup",["MAWDeleteGroupsApi","WADeleteGroupFollowUpLowLevelApi","WADeleteGroupFollowUpLowLevelApiV2","WALogger","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["deleteGroups failed to delete group to a non-existent thread"]);h=function(){return a};return a}async function a(a,b){b=await d("MAWDeleteGroupsApi").deleteGroupsFromMAW(b.map(function(b){return{deleter:a,group:b}}));return Promise.all(b.map(async function(a){if(!a.success)d("WALogger").ERROR(h());else{a=a.value;var b=a.deletedGroupId;a=a.deletedMsgIds;await Promise.all([d("WADeleteGroupFollowUpLowLevelApi").deleteGroupFollowUpLowLevel(b,a),d("WADeleteGroupFollowUpLowLevelApiV2").deleteGroupFollowUpLowLevel(b,a)])}})).then(c("emptyFunction"))}g.default=a}),98);
__d("MAWRemoveGroupInvitesApi",["MAWDbGroupInviteTxns","MAWIndexedDb","MAWTransactionMode","WALogger","justknobx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["removeGroupInvites deleted "," record(s) from "," for ",""]);h=function(){return a};return a}a=d("MAWIndexedDb").makeMsgrTransactor({groupInvites:d("MAWTransactionMode").READWRITE},"removeGroupInvites",function(a){return function(b,e){return d("MAWDbGroupInviteTxns").deleteGroupInvitesByThreadAndInvitedParticipant(a,b,e).then(function(a){d("WALogger").DEV(h(),a,b,e),c("justknobx")._("1162")&&d("MAWIndexedDb").afterTransaction({tag:"DeleteGroupInvite",value:{threadJid:b}})}).then(function(){c("justknobx")._("1162")&&d("MAWIndexedDb").afterTransaction({tag:"GroupInviteLoaded",value:{actorId:e,threadJid:b}})})}});g.removeGroupInvites=a}),98);
__d("MAWRemoveGroupParticipantsApi",["MAWAdminMsgHelpers","MAWRunInTransaction","WAAPI","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";a=function(){for(var a=arguments.length,b=new Array(a),e=0;e<a;e++)b[e]=arguments[e];return d("MAWRunInTransaction").runInTransaction({GroupInfoStore:!0,MessagesStore:!0,ParticipantsStore:!0},function(a){return h.apply(void 0,[a].concat(b))},"removeGroupParticipants").then(async function(a){a.success&&await c("WAAPI").setRotateSenderKeyToTrue([b[1]]);return a})};var h=async function(a,b,c,e,f,g,h){var i=a.GroupInfoStore,j=a.MessagesStore;a=a.ParticipantsStore;var k=await i.get(c);if(!k.success)return d("WAResultOrError").makeError("missing_group");k=f.map(function(a){return a.user});f=k.map(function(a){return{groupJid:c,userJid:a}});await a.bulkDelete(f,{remover:e});if(b!=null){a=d("MAWAdminMsgHelpers").createParticipantRemoveAdminMsg(c,k,e,h);await j.create(a);await i.update(c,function(a){return babelHelpers.extends({},a,{participantVersion:b.current})},{updateParticipantMedatadata:g})}return d("WAResultOrError").makeResult()};g.removeGroupParticipants=a;g.removeGroupParticipantsTransactor=h}),98);
__d("MAWUpdateGroupSubjectApi",["MAWAdminMsgHelpers","MAWRunInTransaction","WAJids","WAResultOrError","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";a=function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return d("MAWRunInTransaction").runInTransaction({GroupInfoStore:!0,MessagesStore:!0,ParticipantsStore:!0},function(a){return h.apply(void 0,[a].concat(b))},"updateGroupSubject")};var h=async function(a,b,c){var e=a.GroupInfoStore;a=a.MessagesStore;var f=await e.get(b);if(!f.success)return d("WAResultOrError").makeError("missing_group");f=f.value;if(f.subject.ts!=null&&(c.ts==null||f.subject.ts>c.ts))return d("WAResultOrError").makeResult();await e.update(b,function(a){return babelHelpers.extends({},a,{subject:c})});e=await e.get(f.jid);if(!e.success)return d("WAResultOrError").makeError("missing_group");f=e.value;e=f.subject.user;f=d("MAWAdminMsgHelpers").createGroupNameChangeAdminMsg(b,f,e!=null?d("WAJids").userIdFromJid(e):void 0,(b=c.ts)!=null?b:d("WATimeUtils").unixTime());f!=null&&await a.create(f);return d("WAResultOrError").makeResult()};g.updateGroupSubject=a;g.updateGroupSubjectTransactor=h}),98);
__d("MAWHandleGroupNotifications",["FBLogger","MAWAddGroupParticipantsApi","MAWChangeGroupMemberAddModeApi","MAWChangeGroupParticipantAdminStatusApi","MAWDeleteGroup","MAWRemoveGroupInvitesApi","MAWRemoveGroupParticipantsApi","MAWUpdateGroupSubjectApi","WAAPI","WACreateGroup","WAGlobals","WAResultOrError","emptyFunction","justknobx"],(function(a,b,c,d,e,f,g){"use strict";function a(a){a=a.notification;switch(a.type){case"join":return h(a).then(function(){return d("WAResultOrError").makeResult()});case"add":return i(a);case"remove":return j(a);case"promote":return l(a);case"demote":return k(a);case"delete":var b=a.groupJid,e=a.participant;if(e==null)throw c("FBLogger")("messenger_web").mustfixThrow("Group delete notification without deleter JID: "+b);return c("MAWDeleteGroup")(e,[b]).then(function(){return d("WAResultOrError").makeResult()});case"subject":return m(a).then(function(){return d("WAResultOrError").makeResult()});case"memberAddMode":return n(a);default:a.type;return Promise.resolve(d("WAResultOrError").makeResult())}}async function h(a){if(a.isE2EEMigration)return;var b=a.group,e=a.isNew,f=a.key,g=a.serverTs;await d("WACreateGroup").createGroups([{extras:f!=null?{deduplicationKey:f,platform:"msgr"}:null,folder:null,groupStatus:e?"new":"added",groupToCreate:b,key:f,serverTs:g}]);e=a.group.participants.map(function(a){if(a.success)return a.value.user;else return a.error.user});var h=d("WAGlobals").getMyUserJid();f=c("justknobx")._("1162");f&&e.find(function(a){return a===h})&&await d("MAWRemoveGroupInvitesApi").removeGroupInvites(b.jid,h);await c("WAAPI").getDevices({ignoreDhash:!1,reason:"added-to-group",users:new Set(e)})}function i(a){var b=a.groupJid,e=a.participant,f=a.participants,g=a.previousVersionId,h=a.reason,i=a.serverTs;a=a.versionId;if(e==null)throw c("FBLogger")("messenger_web").mustfixThrow("Group add participant notification without adder JID: "+b);return d("MAWAddGroupParticipantsApi").addGroupParticipants({current:a,previous:g},b,e,f,!1,h,i)}function j(a){var b=a.groupJid,e=a.participant,f=a.participants,g=a.previousVersionId,h=a.serverTs;a=a.versionId;if(e==null)throw c("FBLogger")("messenger_web").mustfixThrow("Group remove participant notification without remover JID: "+b);var i=null;a!=null&&(i={current:a,previous:g});return d("MAWRemoveGroupParticipantsApi").removeGroupParticipants(i,b,e,f,!1,h)}function k(a){var b=a.groupJid,c=a.participant,e=a.participants,f=a.previousVersionId,g=a.serverTs;a=a.versionId;return d("MAWChangeGroupParticipantAdminStatusApi").changeGroupParticipantAdminStatus({current:a,previous:f},b,c,e,"participant",g)}function l(a){var b=a.groupJid,c=a.participant,e=a.participants,f=a.previousVersionId,g=a.serverTs;a=a.versionId;return d("MAWChangeGroupParticipantAdminStatusApi").changeGroupParticipantAdminStatus({current:a,previous:f},b,c,e,"admin",g)}function m(a){var b=a.groupJid,e=a.participant,f=a.subject;a=a.ts;return d("MAWUpdateGroupSubjectApi").updateGroupSubject(b,{content:f,ts:a,user:e}).then(c("emptyFunction"))}function n(a){var b=a.groupJid,c=a.memberAddMode,e=a.participant;a=a.serverTs;return d("MAWChangeGroupMemberAddModeApi").changeGroupMemberAddMode(b,e,c,a,"create_admin_message")}g.persistGroupNotification=a}),98);
__d("WAParticipant",[],(function(a,b,c,d,e,f){"use strict";function a(a){switch(a){case"admin":case"superadmin":return!0;default:return!1}}f.isGroupAdminParticipantType=a}),66);
__d("WASyncParticipantsApi",["WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";a=async function(a,b,c){a=a.ParticipantsStore;var e=await a.bulkGetInGroup(b);if(e.success!==!0)return d("WAResultOrError").makeError("missing_participants");if(c.length===0&&e.value.length===0)return d("WAResultOrError").makeResult({removedJids:[],addedJids:[],typeUpdateJids:[]});var f=new Map();e.value.forEach(function(a){f.set(a.user,a)});var g=new Set(c.map(function(a){return a.user})),h=[],i=[],j=[],k=[];f.forEach(function(a,c){g.has(c)||(a.type!=="invitedParticipant"?h.push({userJid:c,groupJid:b}):(k.push({previousType:a.type,newType:a.type,userJid:a.user}),j.push(babelHelpers.extends({},a))))});c.forEach(function(a){var b=f.get(a.user);b==null?(i.push(a),a.type==="admin"&&k.push({previousType:"nonparticipant",newType:a.type,userJid:a.user})):(b.type!==a.type&&k.push({previousType:b.type,newType:a.type,userJid:a.user}),j.push(babelHelpers.extends({},b,a)))});await a.bulkPut(i);await a.bulkPut(j);await a.bulkDelete(h);return d("WAResultOrError").makeResult({removedJids:h.map(function(a){a=a.userJid;return a}),addedJids:i.map(function(a){return a.user}),typeUpdateJids:k})};g.syncParticipantsTransactor=a}),98);
__d("MAWResetGroupParticipantInfoApi",["MAWAdminMsgHelpers","MAWRunInTransaction","WAAPI","WALogger","WAParticipant","WAResultOrError","WASyncParticipantsApi","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unexpectedly received an error when sync-ing participants"]);h=function(){return a};return a}a=function(){for(var a=arguments.length,b=new Array(a),e=0;e<a;e++)b[e]=arguments[e];return d("MAWRunInTransaction").runInTransaction({GroupInfoStore:!0,MessagesStore:!0,ParticipantsStore:!0},function(a){return i.apply(void 0,[a].concat(b))},"resetGroupParticipantInfo").then(async function(a){a.success&&await c("WAAPI").setRotateSenderKeyToTrue([b[0]]);return a})};var i=async function(a,b,c,e){var f=a.GroupInfoStore,g=a.MessagesStore;a=a.ParticipantsStore;c=c.map(function(a){return{addressable:a.addressable,chatJid:b,type:a.type,user:a.user}});a=await d("WASyncParticipantsApi").syncParticipantsTransactor({ParticipantsStore:a},b,c);if(e!=null){c=await f.update(b,function(a){return babelHelpers.extends({},a,{participantVersion:e})});if(!c.success)return c}if(a.success!==!0){d("WALogger").ERROR(h());return a}f=a.value;c=[];if(f.removedJids.length>0){a=d("MAWAdminMsgHelpers").createParticipantRemoveAdminMsg(b,f.removedJids,null,d("WATimeUtils").unixTime());c.push(g.create(a))}if(f.addedJids.length>0){a=d("MAWAdminMsgHelpers").createParticipantAddAdminMessage(b,f.addedJids,null,d("WATimeUtils").unixTime());c.push(g.create(a))}if(f.typeUpdateJids.length>0)for(a=0;a<f.typeUpdateJids.length;a++){var i=f.typeUpdateJids[a].previousType,j=f.typeUpdateJids[a].newType;i=d("WAParticipant").isGroupAdminParticipantType(i);j=d("WAParticipant").isGroupAdminParticipantType(j);var k=!i&&j;i=i&&!j;if(k){j=d("MAWAdminMsgHelpers").createParticipantPromoteAdminMsg(b,f.typeUpdateJids[a].userJid,null,d("WATimeUtils").unixTime());c.push(g.create(j))}else if(i){k=d("MAWAdminMsgHelpers").createParticipantDemoteAdminMsg(b,f.typeUpdateJids[a].userJid,null,d("WATimeUtils").unixTime());c.push(g.create(k))}}return Promise.all(c).then(function(){return d("WAResultOrError").makeResult()})};g.resetGroupParticipantInfo=a;g.resetGroupParticipantInfoTransactor=i}),98);
__d("MAWProtocolQueueGroupNotification",["FBLogger","MAWHandleGroupNotifications","MAWResetGroupParticipantInfoApi","WAAPI","WACreateGroup","WALogger","WAQueryGroup","WAResultOrError","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to create group infos"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to recover missing group info"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[doGroupRecovery] Cannot get a group, as per ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to query groups"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to query groups"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to get group info"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unexpectedly received a participant with an error"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[ParticipantRecovery] Cannot get a group, as per ",""]);o=function(){return a};return a}function a(a){var b=a.notification;return d("MAWHandleGroupNotifications").persistGroupNotification(a).then(function(a){return a.success?a:d("WAResultOrError").makeResult({errorResult:a,groupNotification:b})})}async function b(a){var b=[];await Promise.all(a.map(async function(a){try{var e=await d("WAQueryGroup").queryGroup(a,"participant_change_recovery");if(e.success===!1){var f;d("WALogger").ERROR(o(),e.error);throw c("FBLogger")("messenger_web").mustfixThrow("[ParticipantRecovery] Cannot get a group, as per "+JSON.stringify((f=e.error)!=null?f:null))}f=e.value;e=f.participants.map(function(a){if(a.error){d("WALogger").ERROR(n());return null}return a.value}).filter(Boolean);e=await d("MAWResetGroupParticipantInfoApi").resetGroupParticipantInfo(a,e,f.participantVersion);f=e.error;!e.success&&f==="missing_group"&&b.push(a)}catch(a){d("WALogger").DEV(m()).devConsole(a)}}));try{c("WAAPI").queryGroups({groups:b,type:"array"}).catch(function(a){d("WALogger").DEV(l()).devConsole(a)})}catch(a){d("WALogger").DEV(k()).devConsole(a)}}async function e(a){var b=[];await Promise.all(a.map(async function(a){try{a=await d("WAQueryGroup").queryGroup(a,"interactive");if(a.success===!1){var e;d("WALogger").ERROR(j(),a.error);throw c("FBLogger")("messenger_web").mustfixThrow("[doGroupRecovery] Cannot get a group, as per "+JSON.stringify((e=a.error)!=null?e:null))}b.push(a.value)}catch(a){d("WALogger").DEV(i()).devConsole(a)}}));try{await d("WACreateGroup").createGroups(b.map(function(a){return{extras:null,folder:null,groupStatus:"queried",groupToCreate:a,key:null,serverTs:d("WATimeUtils").unixTime()}}))}catch(a){d("WALogger").DEV(h()).devConsole(a)}}g.handleProtocolQueueGroupNotification=a;g.doParticipantRecovery=b;g.doGroupRecovery=e}),98);
__d("MAWHandleConnectedAdminMsgApi",["MAWAdminWriteUsersConnectedMsgTxn","MAWIndexedDb","MAWTransactionMode","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleConnectedAdminMsg: chat ",""]);h=function(){return a};return a}b=d("MAWIndexedDb").makeMsgrTransactor({ftsBackloggedMessages:(a=d("MAWTransactionMode")).READWRITE,groupInfo:a.READONLY,messages:a.READWRITE,threads:a.READWRITE},"handleConnectedAdminMsg",function(a){return function(b){var c=b.chatJid,e=b.isOtherContactMsplit;b=b.notificationTs;d("WALogger").LOG(h(),c);return d("MAWAdminWriteUsersConnectedMsgTxn").writeUsersConnectedAdminMsg(a,c,e,b)}});g.handleConnectedAdminMsg=b}),98);
__d("MAWUpdateThreadFolderApi",["MAWBridgeTypesCreators","MAWDbThreadTxns","MAWIndexedDb","MAWTransactionMode","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Update thread "," folder with folder id ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Update thread ",""]);i=function(){return a};return a}a=d("MAWIndexedDb").makeMsgrTransactor({threads:d("MAWTransactionMode").READWRITE},"updateThreadFolder",function(a){return function(b,c){d("WALogger").LOG(i(),b);return d("MAWDbThreadTxns").getThread(a,b).then(function(b){if(!b.success)return;return d("MAWDbThreadTxns").updateThread(a,babelHelpers["extends"]({},b.value,{folder:c})).then(function(a){d("WALogger").LOG(h(),b.value.jid,c);d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({folder:c,threadJid:b.value.jid})});return})})}});g.updateThreadFolder=a}),98);
__d("MAWProtocolQueueNotification",["MAWBridge","MAWFolderTypes","MAWHandleConnectedAdminMsgApi","MAWODSProxy","MAWProtocolQueueGroupNotification","MAWUpdateThreadFolderApi","MWFBLogger","WAJids","WAOdsEnums","WAResultOrError","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Received unsupported notification type: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleThreadNotification (",") unknown thread action, jid: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleThreadNotification (",") connected, jid: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleThreadNotification (",") with folder id ",", jid: ",""]);k=function(){return a};return a}var l=d("MWFBLogger").MWLogger.tags(["ProtocolQueue"]);async function m(a){var b=a.stanzaId;a=a.notification;var e=a.actions,f=a.chatJid,g=a.ts,h=d("WAJids").interpretAsUserJid(f),m=await d("MAWBridge").getBridge().sendAndReceive("event","getLSDBUsersIsMsplit",{users:[h].filter(Boolean)});return Promise.all(e.map(function(a){switch(a.type){case"folder":var c;c=(c=a.folderId)!=null?c:d("MAWFolderTypes").FOLDER_ID.INBOX;l.DEBUG(k(),b,c,f);return d("MAWUpdateThreadFolderApi").updateThreadFolder(f,c);case"connected":l.DEBUG(j(),b,f);c=h!=null&&m.get(h)===!0;return d("MAWHandleConnectedAdminMsgApi").handleConnectedAdminMsg({chatJid:f,isOtherContactMsplit:c,notificationTs:g});default:a.type;l.MUSTFIX(i(),b,f);return Promise.reject("Handle thread notification: unknown thread action")}})).then(c("emptyFunction"))}function a(a){return Promise.all(a.map(function(a){a=a.notification;a=n(a);return a})).then(function(b){var c={groupRecoveries:[],participantRecoveries:[]},d=[];b.map(function(b,e){if(b.success===!0){d.push(a[e].stanzaQueueId);if(b.value!=null){e=b.value;e.type==="group"&&c.groupRecoveries.push(e.data.groupNotification.groupJid)}}});return{followUpParams:c,toAck:d}})}function n(a){switch(a.type){case"group":d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.WA_PROTOCOL_QUEUE_NOTIFICATION,key:a.type+"."+a.notification.type});return d("MAWProtocolQueueGroupNotification").handleProtocolQueueGroupNotification(a).then(function(a){return a.value?d("WAResultOrError").makeResult({data:a.value,type:"group"}):d("WAResultOrError").makeResult()});case"thread":a.notification.actions.forEach(function(b){d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.WA_PROTOCOL_QUEUE_NOTIFICATION,key:a.type+"."+b.type})});return m(a).then(function(){return d("WAResultOrError").makeResult()});default:a;l.MUSTFIX(h(),a.type);return Promise.resolve(d("WAResultOrError").makeResult())}}g.handleIncomingNotificationStanzas=a}),98);
__d("MAWCOPNotificationsHandler",["MAWCommonScheduler","MAWIsQuotaExceededError","MAWProtocolQueueGroupNotification","MAWProtocolQueueNotification","MAWSharedCOPLogger","WorkerScheduler","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Errors occurred while processing notifications batch, see transactor error reports."]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Notification consumer error"]);i=function(){return a};return a}function a(a){return j(a).catch(function(a){if(d("MAWIsQuotaExceededError").isQuotaExceededError(a))throw a;c("MAWSharedCOPLogger").catching(a).MUSTFIX(i());return[]})}async function j(a){if(a.length===0)return[];var b=await d("MAWProtocolQueueNotification").handleIncomingNotificationStanzas(a);b.toAck.length!==a.length&&c("MAWSharedCOPLogger").WARN(h());a=b.followUpParams;var e=a.groupRecoveries,f=a.participantRecoveries;f.length>0&&c("promiseDone")(d("MAWCommonScheduler").mawCommonScheduler().runTask({fn:function(){return d("MAWProtocolQueueGroupNotification").doParticipantRecovery(f)},name:"ParticipantsRecovery",priority:d("WorkerScheduler").BACKGROUND_PRIORITY}));e.length>0&&c("promiseDone")(d("MAWCommonScheduler").mawCommonScheduler().runTask({fn:async function(){await d("MAWProtocolQueueGroupNotification").doGroupRecovery(e)},name:"GroupsRecovery",priority:d("WorkerScheduler").BACKGROUND_PRIORITY}));return b.toAck}g.default=a}),98);
__d("MAWIncomingReceiptDataFormatTxns",["MAWDbMsgTxns","MAWDbUnrenderedMsgTxns","MAWDexieTable","MAWMsgType","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to map the threadId of a message to its threadJid during receipt-writing"]);h=function(){return a};return a}function i(a){var b=a.author,c=a.chat;a=a.externalId;return c+"_"+a+"_"+b}function a(a,b){if(b.length===0)return d("MAWDexieTable").dexieResolve();var c=new Map(),e=new Set();b.forEach(function(a){a=a.msgs;a.forEach(function(a){return e.add(babelHelpers["extends"]({},a))})});a=d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").getMsgsByProtocolMsgId(a,Array.from(e)),d("MAWDbUnrenderedMsgTxns").getUnrenderedMsgsByProtocolMsgId(a,Array.from(e))]).then(function(a){var b=a[0];a=a[1];var c=[];b.forEach(function(a){return c.push({msg:a,renderType:"regular"})});a.forEach(function(a){return c.push({msg:a,renderType:"unrendered"})});return{msgs:c}});return a.then(function(a){a=a.msgs;b.forEach(function(a){var b=a.msgs,d=a.receivers,e=a.type;b.forEach(function(a){var b=i(a),f=c.get(b)||{deliveryReceipts:[],protocolMsgId:a,readReceipts:[],senderReceipts:[]};d.forEach(function(a){if(e==="read"||e==="read-self"){f.readReceipts.push(a);return}else if(e==="delivered"){f.deliveryReceipts.push(a);return}else if(e==="sender"){f.senderReceipts.push(a);return}else if(e==="inactive"){f.deliveryReceipts.push(a);return}e});c.set(b,f)})});var e=new Map(),f=new Map(),g=[];a.forEach(function(a){var b=a.msg,g=b.author,j=b.externalId,k=b.msgId,l=b.threadJid;b=b.type;if(l==null){d("WALogger").ERROR(h());return}if(b!==d("MAWMsgType").MSG_TYPE.CIPHERTEXT){b=i({author:g,chat:l,externalId:j});g=c.get(b);if(g!=null){g.protocolMsgId;l=babelHelpers.objectWithoutPropertiesLoose(g,["protocolMsgId"]);j=babelHelpers["extends"]({msgId:k},l);f.set(k,j);c["delete"](b)}}e.set(k,a)});c.forEach(function(a){var b=a.deliveryReceipts,c=a.protocolMsgId;a=a.readReceipts;if(b.length===0&&a.length===0)return;var d=c.author,e=c.chat;c=c.externalId;g.push({author:d,deliveryReceipts:b,externalId:c,readReceipts:a,thread:e})});return{msgIdToDbMsgMap:e,pendingReceiptsToWrite:g,receiptsToWriteMap:f}})}g.prepareDataForReceiptsToWrite=a}),98);
__d("MAWDbPendingReceiptTxns",["WAJids","WAMsg"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var c=b.map(function(a){var b=a.author,c=a.externalId;a=a.thread;return d("WAMsg").craftWAMsgIdString({author:b,chat:a,externalId:c})});return a.pendingReceipts.where("id").anyOf(c).toArray().then(function(c){var e=new Map();c.forEach(function(a){e.set(a.id,a)});var f=b.map(function(a){var b=a.author,c=a.externalId,f=a.thread,g=d("WAMsg").craftWAMsgIdString({author:b,chat:f,externalId:c}),h=e.get(g),i=(h=h)!=null?h:{author:b,deliveryReceipts:[],externalId:c,id:g,readReceipts:[],thread:f};b===d("WAJids").AUTHOR_ME?(a.deliveryReceipts.forEach(function(a){i.deliveryReceipts.push(a)}),a.readReceipts.forEach(function(a){i.readReceipts.push(a)})):(i.deliveryReceipts=[],a.readReceipts.forEach(function(a){i.readReceipts.push(a)}));return i});return a.pendingReceipts.bulkPut(f).then(function(){return f})})}function b(a,b){return a.pendingReceipts.bulkGet(b)}g.bulkAddPendingReceipts=a;g.getPendingReceipts=b}),98);
__d("MAWIncomingReceiptDataFormatUtils",["MAWAckLevel","MAWDbMsg"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var c=[],e=[];a.forEach(function(a){var f=null,g=a.receipt.msgId,h=a.receipt.statusTsPerUser,i=b.get(g);if(i==null)return;var j=i.msg;i=i.renderType;a.affectedUserJids.forEach(function(a){var b,c=null;((b=h.get(a))==null?void 0:b.readTs)!=null?c=d("MAWAckLevel").ACK.read:((b=h.get(a))==null?void 0:b.deliveredTs)!=null&&(c=d("MAWAckLevel").ACK.received);f=f==null||c!=null&&c>f?c:f});f!=null&&f>j.ack&&(i==="regular"?c.push({ack:f,msgId:g,reportingMeta:null}):(i,e.push({ack:f,msgId:g})))});return{regular:c,unrendered:e}}function b(a,b,c){return a.map(function(a){var e=b.get(a.receipt.msgId);if(e==null)return null;var f=e.msg,g=c.get(f.msgId);return g==null||g.deliveryReceipts.length===0&&g.readReceipts.length===0?null:babelHelpers["extends"]({},a,{externalId:f.externalId,msgRenderType:e.renderType,msgTs:d("MAWDbMsg").getCanonicalTsFromMsg(f),threadJid:f.threadJid})}).filter(Boolean)}g.createUpdateSystemAckParams=a;g.formatWriteReceiptResultsWithExtras=b}),98);
__d("MAWReceiptTrace",["ArmadilloDataTraceType","MAWBridgeTrace","MAWBridgeTraceEvent","MAWIndexedDb"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){if(a==="delivered"){a=b.reduce(function(a,b){return b.externalId!=null?[].concat(a,[b.externalId]):a},[]);a.length>0&&d("MAWIndexedDb").afterTransaction({tag:"UpdateTrace",value:d("MAWBridgeTrace").createBridgeUpdateTraceData(a,c("MAWBridgeTraceEvent").ReceivedReceipt,d("ArmadilloDataTraceType").armadilloMessageSend)})}}g.flushTrace=a}),98);
__d("MAWIncomingReceiptTxns",["MAWAckAndTimestampUpdatesForReceiptsTxns","MAWDbPendingReceiptTxns","MAWDbReceiptTxns","MAWDexieTable","MAWIncomingReceiptDataFormatUtils","MAWReceiptTrace"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){if(b==null)return d("MAWDexieTable").dexieResolve();var c=b.msgIdToDbMsgMap,e=b.pendingReceiptsToWrite,f=b.receiptsToWriteMap;b=Array.from(f.values());return d("MAWDexieTable").dexieAll([d("MAWDbReceiptTxns").bulkWriteReceiptsForDevices(b),d("MAWDbPendingReceiptTxns").bulkAddPendingReceipts(a,e)]).then(function(b){b=b[0];var e=d("MAWIncomingReceiptDataFormatUtils").createUpdateSystemAckParams(b,c);b=d("MAWIncomingReceiptDataFormatUtils").formatWriteReceiptResultsWithExtras(b,c,f);var g=b.filter(function(a){a=((a=f.get(a.receipt.msgId))==null?void 0:a.deliveryReceipts)||[];return a.length>0});g.length>0&&d("MAWReceiptTrace").flushTrace("delivered",g);return d("MAWAckAndTimestampUpdatesForReceiptsTxns").handleAckAndTimestampUpdatesForReceipts(a,b,e)})}g.bulkHandleIncomingReceipts=a}),98);
__d("MAWWriteAppDataReceiptsApi",["MAWDexieTable","MAWIndexedDb","MAWTransactionMode","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({appData:d("MAWTransactionMode").READWRITE},"writeAppDataReceipts",function(a){return function(b){return h(a,b).then(function(b){return i(a,b)})}});function h(a,b){if(b.length===0)return d("MAWDexieTable").dexieResolve();b=b.reduce(function(a,b){var c=a.appDataExternalIdSet,d=a.appDataReceiversSet;a=b.externalIds;b=b.receivers;a.forEach(function(a){c.add(a)});b.forEach(function(a){d.add(a)});return{appDataExternalIdSet:c,appDataReceiversSet:d}},{appDataExternalIdSet:new Set(),appDataReceiversSet:new Set()});var c=b.appDataExternalIdSet;b=b.appDataReceiversSet;c=Array.from(c);var e=Array.from(b);return a.appData.where("externalId").anyOf(c).toArray().then(function(a){if(a.length===0)return;return j(a,e)})}function i(a,b){if(b==null)return d("MAWDexieTable").dexieResolve();var e=b.toDelete;b=b.toUpdate;return d("MAWDexieTable").dexieAll([e.length>0?a.appData.bulkDelete(e):d("MAWDexieTable").dexieResolve(),b.length>0?a.appData.bulkPut(b):d("MAWDexieTable").dexieResolve()]).then(c("emptyFunction"))}function j(a,b){return a.reduce(function(a,c){if(c==null)return a;for(var d of b)c.permittedIdentitiesPerDevice["delete"](d);if(c.permittedIdentitiesPerDevice.size===0){a.toDelete.push(c.appDataId);return a}else{a.toUpdate.push(c);return a}},{toDelete:[],toUpdate:[]})}g.writeAppDataReceipts=a;g.prepareBulkAppDataReceipts=h;g.writeBulkAppDataReceipts=i}),98);
__d("MAWWritePeerMsgReceiptsApi",["MAWDbMsg","MAWDbMsgTxns","MAWDbPendingReceiptTxns","MAWDexieTable","MAWLoggerUtils","MAWMarkThreadAsReadTxns","MAWMsgType","WAGlobals","WAJids","WATagsLogger","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Processing "," receipt for messages not from me"]);h=function(){return a};return a}function i(a,b,c){return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b).then(function(a){return a==null||a.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT?{msg:b,readReceipt:c,type:"missing"}:{dbMsg:a,msg:b,readReceipt:c,type:"found"}})}function j(a){a=a.map(function(a){return a.type==="missing"?null:a.dbMsg}).filter(Boolean);return a.reduce(function(a,b){var c=b.threadJid,e=d("WATimeUtils").castToMillisTime(d("MAWDbMsg").getSortOrderWithFallback(b)),f=a.get(c);(f==null||e>f.msgSortOrderMs)&&a.set(c,{msgId:b.msgId,msgSortOrderMs:e});return a},new Map())}function a(a,b){if(b.length===0)return d("MAWDexieTable").dexieResolve([]);b=b.map(function(a){d("WATagsLogger").TAGS([d("MAWLoggerUtils").Tag.Ephemeral,d("MAWLoggerUtils").Tag.PeerReceipt]).LOG(h(),a.type);if(a.type==="delivered")return;var b={device:void 0,ts:void 0};a.receivers.forEach(function(a){var c=a.device;a=a.ts;var e=d("WAJids").extractUserJid(c);e===d("WAGlobals").getMyUserJid()&&(b.ts==null||a<b.ts)&&(b.device=c,b.ts=a)});if(b.device!=null&&b.ts!=null)return babelHelpers["extends"]({},a,{receivers:{device:b.device,ts:b.ts}});else return}).filter(Boolean);var c=[];b.forEach(function(a){a.msgs.forEach(function(b){c.push([b,a.receivers])})});return d("MAWDexieTable").dexieAll(c.map(function(b){var c=b[0];b=b[1];return i(a,c,b)}))}function b(a,b){if(b.length===0)return d("MAWDexieTable").dexieResolve();var e=[],f=[];b.map(function(a){a.type==="missing"?e.push({author:a.msg.author,deliveryReceipts:[],externalId:a.msg.externalId,readReceipts:[a.readReceipt],thread:a.msg.chat}):f.push({msgId:a.msg,ts:a.readReceipt.ts})});var g=j(b);b=b.reduce(function(a,b){b=b.msg.chat;var c=g.get(b);c!=null&&a.set(b,{msgId:c.msgId,sortOrderMs:c.msgSortOrderMs});return a},new Map());return d("MAWDexieTable").dexieAll([d("MAWDbPendingReceiptTxns").bulkAddPendingReceipts(a,e),d("MAWMarkThreadAsReadTxns").bulkMarkThreadAsReadUpToMsgSortOrderMs(a,b)]).then(c("emptyFunction"))}g.getResultByProtocolMsgId=i;g.prepareReceiptsForMeToWrite=a;g.bulkWritePeerReceiptsForMsgsNotFromMeInternal=b}),98);
__d("MAWBulkWriteReceiptsApi",["MAWDexieTable","MAWIncomingReceiptDataFormatTxns","MAWIncomingReceiptTxns","MAWIndexedDb","MAWTransactionMode","MAWWriteAppDataReceiptsApi","MAWWritePeerMsgReceiptsApi","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b){var c=[],e=[],f=[];b.forEach(function(a){switch(a.type){case"msg-receipt":c.push(a.params);break;case"not-from-me":e.push(a.params);break;default:f.push(a.params);break}});return d("MAWDexieTable").dexieAll([f.length>0?d("MAWWriteAppDataReceiptsApi").prepareBulkAppDataReceipts(a,f):d("MAWDexieTable").dexieResolve(),c.length>0?d("MAWIncomingReceiptDataFormatTxns").prepareDataForReceiptsToWrite(a,c):d("MAWDexieTable").dexieResolve(),e.length>0?d("MAWWritePeerMsgReceiptsApi").prepareReceiptsForMeToWrite(a,e):d("MAWDexieTable").dexieResolve([])]).then(function(a){var b=a[0],c=a[1];a=a[2];if(b==null)return{incomingReceiptData:c,processedPeerReceiptsNotForMeResults:a};var d=b.toDelete;b=b.toUpdate;return{appDataReceipts:{toDelete:d,toUpdate:b},incomingReceiptData:c,processedPeerReceiptsNotForMeResults:a}})}b=d("MAWIndexedDb").makeMsgrTransactor({appData:(a=d("MAWTransactionMode")).READWRITE,chunk:a.READONLY,media:a.READONLY,messages:a.READWRITE,participants:a.READWRITE,pendingReceipts:a.READWRITE,receiverFetchInfo:a.READONLY,threads:a.READWRITE,unrenderedMessages:a.READWRITE,xma:a.READONLY},"bulkWriteReceipts",function(a){return function(b){return b.length===0?d("MAWDexieTable").dexieResolve():h(a,b).then(function(b){var e=b.appDataReceipts,f=b.incomingReceiptData;b=b.processedPeerReceiptsNotForMeResults;return d("MAWDexieTable").dexieAll([e!=null&&(e==null?void 0:e.toDelete.length)>0&&(e==null?void 0:e.toUpdate.length)>0?d("MAWWriteAppDataReceiptsApi").writeBulkAppDataReceipts(a,e):d("MAWDexieTable").dexieResolve(),f!=null?d("MAWIncomingReceiptTxns").bulkHandleIncomingReceipts(a,f):d("MAWDexieTable").dexieResolve(),b.length>0?d("MAWWritePeerMsgReceiptsApi").bulkWritePeerReceiptsForMsgsNotFromMeInternal(a,b):d("MAWDexieTable").dexieResolve()]).then(c("emptyFunction"))})}});g.bulkWriteReceipts=b}),98);
__d("MAWSharedProtocolQueueReceipt",[],(function(a,b,c,d,e,f){"use strict";function g(a){if(a.receiptType==="appdata")return{params:{externalIds:a.externalIds,receivers:[a.from]},type:"appdata"};var b,c,d=a.chat;switch(a.receiptType){case"user":c=a.externalIds;b=[{device:a.from.author,ts:a.ts}];break;case"group":c=a.externalIds;b=[{device:a.from.author,ts:a.ts}];break;default:a.receiptType;c=[a.externalId];b=a.receivers;break}var e=a.messageAuthor;a=a.type;if(e==="@me"||a==="sender")return{params:{msgs:c.map(function(a){return{author:"@me",chat:d,externalId:a}}),receivers:b,type:a},type:"msg-receipt"};else return{params:{msgs:c.map(function(a){return{author:e,chat:d,externalId:a}}),receivers:b,type:a},type:"not-from-me"}}async function a(a,b){var c=a.map(function(a){a=g(a.receipt);return a});await b(c);return{followUpParams:void 0,toAck:a.map(function(a){return a.stanzaQueueId})}}f.sharedHandleIncomingReceiptStanza=a}),66);
__d("WADbHandlePermitedIdentitiesApi",["MAWTransactionMode","WADbTransactor"],(function(a,b,c,d,e,f,g){"use strict";a=d("WADbTransactor").makeSignalTransactor({receipts:d("MAWTransactionMode").READWRITE},"handlePermitedIdentitiesPerDevice",function(a){return function(b){var c=Array.from(b.keys());return a.receipts.where("waMsgId").anyOf(c).toArray().then(function(a){return a.map(function(a){var c;c=(c=b.get(a.waMsgId))!=null?c:new Set();for(c of c){var d;(d=a.permittedIdentitiesPerDevice)==null?void 0:d["delete"](c)}return a})}).then(function(b){return a.receipts.bulkPut(b).then(function(){})})}});g.handlePermitedIdentitiesPerDevice=a}),98);
__d("WAPreKeysStanzaUtils",["WAWap"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b;return(b=d("WAWap")).wap("key",null,b.wap("id",null,b.BIG_ENDIAN_CONTENT(a.id,3)),b.wap("value",null,a.keyPair.publicKey))}function b(a){var b;return(b=d("WAWap")).wap("skey",null,b.wap("id",null,b.BIG_ENDIAN_CONTENT(a.id,3)),b.wap("value",null,a.keyPair.publicKey),b.wap("signature",null,a.signature))}function c(a){var b=a.child("skey"),c=null;if(a.hasChild("key")){var d=a.child("key");c={id:d.child("id").contentUint(3),publicKey:d.child("value").contentSerializedPubKey()}}return{identity:a.child("identity").contentSerializedPubKey(),signedKey:{id:b.child("id").contentUint(3),publicKey:b.child("value").contentSerializedPubKey(),signature:b.child("signature").contentBytes(64)},oneTimeKey:c}}g.xmppPreKey=a;g.xmppSignedPreKey=b;g.readSessionInfo=c}),98);
__d("WAReceiptUtils",["WACryptoManagerUtils","WADeprecatedSendIq","WAMapWithDefault","WAMsg","WAPreKeysStanzaUtils","WARequestPreKeyDigest","WAWap"],(function(a,b,c,d,e,f,g){"use strict";async function h(a,b){var c=a.retryCount;c=c+1;c>=3&&await d("WARequestPreKeyDigest").requestPreKeyDigestFn(function(a){return a(b)});var e=null;c>=2&&(e=await d("WACryptoManagerUtils").getSignalInfoForRetry(b.cryptoManager));var f=b.cryptoManager.regInfo.regId;return i(a,c,f,e)}async function a(a,b){var c=a.externalId,e=a.from,f=a.participant,g;e.type==="group"?g=e.groupJid:(e.type,g=e.deviceJid);await d("WADeprecatedSendIq").deprecatedSendStanzaAndWaitForAck(await h(a,b),{id:c,class:"receipt",from:g,participant:f})}function i(a,b,c,e){var f=null;if(e!=null){var g=e.keyType,h=e.signedPreKey,i=e.preKey;e=e.publicKey;var j=a.deviceIdentity!=null?d("WAWap").wap("device-identity",null,a.deviceIdentity):null;f=d("WAWap").wap("keys",null,d("WAWap").wap("type",null,d("WAWap").BIG_ENDIAN_CONTENT(g,1)),d("WAWap").wap("identity",null,e),d("WAPreKeysStanzaUtils").xmppPreKey(i),d("WAPreKeysStanzaUtils").xmppSignedPreKey(h),j)}a.from.type==="group"?g=a.from.groupJid:(a.from.type,g=a.from.deviceJid);return d("WAWap").wap("receipt",{category:a.category!=null?d("WAWap").CUSTOM_STRING(a.category):d("WAWap").DROP_ATTR,id:d("WAWap").CUSTOM_STRING(a.externalId),participant:a.participant?d("WAWap").DEVICE_JID(a.participant):d("WAWap").DROP_ATTR,recipient:a.recipient?d("WAWap").USER_JID(a.recipient):d("WAWap").DROP_ATTR,to:d("WAWap").JID(g),type:"retry"},d("WAWap").wap("retry",{count:d("WAWap").INT(b),id:d("WAWap").CUSTOM_STRING(a.externalId),t:d("WAWap").INT(a.ts),v:"1"}),d("WAWap").wap("registration",null,d("WAWap").BIG_ENDIAN_CONTENT(c)),f)}function b(a){var b=new(d("WAMapWithDefault").MapWithDefault)(function(a){return new Set()});for(a of a){var c=a.receipt;if(c.receiptType==="group"||c.receiptType==="user")for(var e of c.externalIds)b.get(d("WAMsg").craftWAMsgIdString({author:c.messageAuthor,chat:c.chat,externalId:e})).add(c.from.author);else if(c.receiptType==="group-server-agg")for(e of c.receivers)b.get(d("WAMsg").craftWAMsgIdString({author:c.messageAuthor,chat:c.chat,externalId:c.externalId})).add(e.device)}return b.toMap()}g.makeRetryReceipt=h;g.sendRetryReceipt=a;g.calculateIdentitiesToDelete=b}),98);
__d("MAWProtocolQueueReceipt",["MAWBulkWriteReceiptsApi","MAWSharedProtocolQueueReceipt","WADbHandlePermitedIdentitiesApi","WAReceiptUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return d("WADbHandlePermitedIdentitiesApi").handlePermitedIdentitiesPerDevice(d("WAReceiptUtils").calculateIdentitiesToDelete(a)).then(function(){return d("MAWSharedProtocolQueueReceipt").sharedHandleIncomingReceiptStanza(a,d("MAWBulkWriteReceiptsApi").bulkWriteReceipts)})}g.handleIncomingReceiptStanza=a}),98);
__d("MAWCOPReceiptsHandler",["MAWIsQuotaExceededError","MAWProtocolQueueReceipt","MAWSharedCOPLogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Errors occurred while processing receipts batch, see transactor error reports."]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Receipt consumer error"]);i=function(){return a};return a}function a(a){return j(a).catch(function(a){if(d("MAWIsQuotaExceededError").isQuotaExceededError(a))throw a;c("MAWSharedCOPLogger").catching(a).MUSTFIX(i());return[]})}async function j(a){if(a.length===0)return[];var b=await d("MAWProtocolQueueReceipt").handleIncomingReceiptStanza(a);b.toAck.length!==a.length&&c("MAWSharedCOPLogger").WARN(h());return b.toAck}g.default=a}),98);
__d("MAWConstants",[],(function(a,b,c,d,e,f){"use strict";a=5;b="Facebook user";c="Instagram user";d=3;f.MESSAGE_RETRY_COUNT_LIMIT=a;f.FB_UNKNOWN_USER=b;f.INS_UNKNOWN_USER=c;f.CURRENT_REGISTRATION_VERSION=d}),66);
__d("MAWWriteAppDataRetryApi",["MAWIndexedDb","MAWTransactionMode","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({appData:d("MAWTransactionMode").READWRITE},"writeAppDataRetry",function(a){return function(b,d,e){return a.appData.get({externalId:b}).then(function(b){if(b==null)return;var f=b.permittedIdentitiesPerDevice,g=f.get(d);if(g==null)return;g.baseKey=e;f.set(d,g);return a.appData.update(b.appDataId,{permittedIdentitiesPerDevice:f}).then(c("emptyFunction"))})}});g.writeAppDataRetry=a}),98);
__d("WAMarkParticipantNeedsKeyApi",["MAWTransactionMode","WADbPersonalSenderKeyStatusTxns","WADbTransactor"],(function(a,b,c,d,e,f,g){"use strict";a=d("WADbTransactor").makeSignalTransactor({personalSenderKeyStatuses:d("MAWTransactionMode").READWRITE},"markParticipantNeedsKey",function(a){return function(b,c){return d("WADbPersonalSenderKeyStatusTxns").removeDevicesToMultiplePersonalSenderKeyStatuses(a,[b],[c]).then(function(){})}});g.markParticipantNeedsKey=a}),98);
__d("WAMarkParticipantNeedsKeyApiV2",["WASignalDB"],(function(a,b,c,d,e,f,g){"use strict";a=function(a,b){return d("WASignalDB").getDb().runInTransaction(["personalSenderKeyStatuses"],"readwrite",async function(c){var d=await c.stores.personalSenderKeyStatuses.get(a);if(d==null||d.rotateSenderKey)return;d.hasSenderKey.delete(b);await c.stores.personalSenderKeyStatuses.bulkPut([d])},d("WASignalDB").signalOp("markParticipantNeedsKey"))};g.markParticipantNeedsKey=a}),98);
__d("WASendAppDataIndividualProtocol",["WAAsMessageApplication","WAConvertAppData","WAEncUserMsg","WAErrorMessage","WAGetCurrentUserDeviceInfoApi","WAGlobals","WAMsgApplication.pb","WAResultOrError","WASmaxAppdataPublishPeerRPC","WATagsLogger","WATimeUtils","encodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to send appdata. Error: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to fetch current device public identity key"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["MAWSendAppData Failed to encrypt appdata"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Sending appdata, externalId: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to send appdata retry to device with error: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to send appdata to device with error: ",""]);m=function(){return a};return a}var n=d("WATagsLogger").TAGS(["sendAppDataIndividual"]);function a(a,b,c,e,f){return o(a,b,c,void 0,e,f).catch(function(a){a=d("WAErrorMessage").maybeGetMessageFromError(a);n.ERROR(m(),a);return d("WAResultOrError").makeError("runtime-error")})}function b(a,b,c,e,f,g){return o(a,b,c,e,f,g).catch(function(a){a=d("WAErrorMessage").maybeGetMessageFromError(a);n.ERROR(l(),a);return d("WAResultOrError").makeError("runtime-error")})}async function o(a,b,c,e,f,g){n.LOG(k(),b);a=d("WAConvertAppData").convertAppData(a);var l={bytes:d("WAAsMessageApplication").castToMessageApplicationBytes(d("encodeProtobuf").encodeProtobuf(d("WAMsgApplication.pb").MessageApplicationSpec,a).readByteArray()),version:"v3"};a=await d("WAGlobals").getWaOneQueue().enqueue(function(a){a=a.cryptoManager;return d("WAEncUserMsg").encryptDeviceJidMessage(c,{messageBytes:l,type:"appdata"},{cryptoManager:a},void 0,g,f)},{operationType:"encrypt",flush:!0});if(a==null){n.LOG(j());return d("WAResultOrError").makeError("encrypt-failure")}var m;e!=null&&(m={appdataT:d("WATimeUtils").unixTime(),encRetryMixinArgs:{encCount:e}});e={appdataTo:c,encVersionFutureproofMixinArgs:{encV:parseInt(a.v,10)},encTypeIndividualMixinArgs:{encType:a.type,encElementValue:a.ciphertext},retryMixinArgs:m};e={peerPeerSingle:e};var o=void 0;if(a.type==="pkmsg"){var p=await d("WAGetCurrentUserDeviceInfoApi").getCurrentUserDeviceInfo();p=p==null?void 0:p.identityKey;if(p==null){n.ERROR(i());return d("WAResultOrError").makeError("no-public-identity")}o={deviceIdentityElementValue:p}}p={appdataId:b,peerMsgTypesArgs:e,deviceIdentityMixinArgs:o};b=await d("WASmaxAppdataPublishPeerRPC").sendPeerRPC(p);switch(b.name){case"PeerResponseSuccess":return d("WAResultOrError").makeResult({baseKey:a.baseKey});default:b.name;n.ERROR(h(),b.value.error);return d("WAResultOrError").makeError("ack-failure")}}g.sendAppDataToIndividualDeviceProtocol=a;g.sendAppDataRetryToIndividualDeviceProtocol=b}),98);
__d("WAWriteMsgRetryApi",["MAWTransactionMode","WADbTransactor","WAMsg"],(function(a,b,c,d,e,f,g){"use strict";a=d("WADbTransactor").makeSignalTransactor({receipts:d("MAWTransactionMode").READWRITE},"writeMsgRetry",function(a){return function(b,c,e){return h(a,d("WAMsg").craftWAMsgIdString({author:b.author,chat:b.chat,externalId:b.externalId}),c,e)}});function h(a,b,c,d){return a.receipts.get({waMsgId:b}).then(function(b){if(b==null||b.permittedIdentitiesPerDevice==null)return;var e=b.permittedIdentitiesPerDevice,f=e.get(c);if(f==null)return;f.baseKey=d;e.set(c,f);return a.receipts.put(babelHelpers["extends"]({},b,{permittedIdentitiesPerDevice:e})).then(function(){})})}g.writeMsgRetry=a}),98);
__d("WAWriteMsgRetryCountApi",["MAWTransactionMode","WADbTransactor","WAMsg"],(function(a,b,c,d,e,f,g){"use strict";a=d("WADbTransactor").makeSignalTransactor({receipts:d("MAWTransactionMode").READWRITE},"writeMsgRetryCount",function(a){return function(b,c,e){return h(a,d("WAMsg").craftWAMsgIdString({author:b.author,chat:b.chat,externalId:b.externalId}),c,e)}});function h(a,b,c,d){return a.receipts.get({waMsgId:b}).then(function(b){var e;if(b==null||d==null)return;e=(e=b.retryCountsPerDevice)!=null?e:new Map();e.set(c,d);return a.receipts.put(babelHelpers["extends"]({},b,{retryCountsPerDevice:e})).then(function(){})})}g.writeMsgRetryCount=a}),98);
__d("MAWSharedHandleRetryRequest",["MAWBulkGetAppDataForRetryApi","MAWConstants","MAWDebugMsg","MAWWriteAppDataRetryApi","WACryptoManagerUtils","WACryptoUtils","WADexieToWormMigration","WAGenReportingMeta","WAGlobals","WAJids","WALoadReceiptApi","WALogger","WAMarkParticipantNeedsKeyApi","WAMarkParticipantNeedsKeyApiV2","WAQPLProxy","WASendAppDataIndividualProtocol","WASendMsgInternal","WASentBytesCache","WAWap","WAWriteMsgRetryApi","WAWriteMsgRetryCountApi","gkx","qpl"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleRetryRequest denied because receipt is null"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleRetryRequest denied because (messageId, deviceJID, retryCount) is already executed for retryCount ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleRetryRequest denied with type ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleRetryRequest denied with type "," id: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unknown receipt categories: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["handleRetryRequest denied due to retry count"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Received retry request from peer without recipient set"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["bulkHandleRetryRequest unexpected receipt"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["bulkHandleRetryRequest called for ",""]);p=function(){return a};return a}function q(){var a=0,b=0,c=new Map();return{getMetrics:function(){var d;return{appDataMissing:(d=c.get("appDatamissing"))!=null?d:0,appDataUnauthorized:(d=c.get("appDataunauthorized"))!=null?d:0,appDataUnsupported:(d=c.get("appDataunsupported"))!=null?d:0,msgMissing:(d=c.get("msgmissing"))!=null?d:0,msgUnauthorized:(d=c.get("msgunauthorized"))!=null?d:0,msgUnsupported:(d=c.get("msgunsupported"))!=null?d:0,receiptFailures:b,receiptSuccesses:a}},markError:function(){return b++},markSuccess:function(){return a++},setError:function(a){var b=c.get(a);b!=null?c.set(a,b+1):c.set(a,1)}}}function r(a,b){return b+"_"+a}async function a(a){if(a.length===0)return[];d("WALogger").LOG(p(),a.map(function(a){a=a.externalId;return a}).join(","));var b=d("WAQPLProxy").waQPLProxyStart(c("qpl")._(25308942,"164"),{bool:{bulk:!0},int:{receipts:a.length},string:{origin:self.location.origin}}),e=new Set(a.filter(function(a){return a.category!=null&&!x(a)||y(a)}).map(function(a){return a.externalId})),f=a.filter(function(a){return!e.has(a.externalId)&&!x(a)}),g=a.filter(x);g=await Promise.all([s(g),u(f)]);f=g[0];g=g[1];b.addPoint("get_msg_for_retry_complete");var h=[],i=q();for(a of a){var j=f.get(a.externalId),k=g.get(r(a.from.author,a.externalId));e.has(a.externalId)?(b.addPoint("just_ack"),i.markError(),i.setError("just_ack"),z(a)):j!=null?(b.addPoint("app_data_for_retry"),await A(a,j,b,!1,i),b.addPoint("app_data_for_retry_complete")):k!=null?(b.addPoint("msg_for_retry"),await B(a,k,b,!1,i),b.addPoint("msg_for_retry_complete")):(d("WALogger").ERROR(o()),i.markError(),i.setError("unexpected_receipt"));h.push(w(a))}b.endSuccess({int:babelHelpers.extends({},i.getMetrics())});return h}async function s(a){if(a.length===0)return new Map();var b=a.map(function(a){var b=a.externalId;a=a.from;return{deviceJid:a.author,externalId:b}});b=await d("MAWBulkGetAppDataForRetryApi").bulkGetAppDataForRetry(b);return new Map(b.map(function(b,c){c=a[c];return[c.externalId,b]}))}function t(a){return a.map(function(a){var b=a.externalId,c=a.from,e=a.recipient,f=c.chat;if(c.type==="device"&&d("WAJids").extractUserJid(c.author)===d("WAJids").extractUserJid(d("WAGlobals").getMyDeviceJid())){if(e==null){d("WALogger").ERROR(n());return}f=e}e={author:"@me",chat:f,externalId:b};return{deviceJid:c.author,protocolMsgId:e,retryCount:a.retryCount}})}async function u(a){if(a.length===0)return new Map();var b=t(a),c=a.filter(function(a,c){return b[c]!=null}),e=b.filter(Boolean);a=await d("WASentBytesCache").sentBytesCache().getMsgsForRetry(e);a=new Map(a.map(function(a,b){return[r(e[b].deviceJid,c[b].externalId),{msgForRetry:a,retryRequest:e[b]}]}));return a}async function v(a,b){var c=void 0,e=await d("WAGlobals").getWaOneQueue().enqueue(function(b){b=b.cryptoManager;return d("WACryptoManagerUtils").getParticipantInfo(a.from.author,b)},{flush:!1,operationType:"get_participant_info"});if(a.keys!=null){var f=a.keys,g=a.timestamp;b={baseKey:b.baseKey,keys:f,timestamp:g};f=C(a,e);f?c={session:b,type:"compareTSAndUseSession"}:c={session:b,type:"useSession"}}else{g=e==null||a.regId!==e.regId;g&&(c={type:"requestNewSession"})}return c}function w(a){var b,c=a.externalId;a=a.from;return(b=d("WAWap")).wap("ack",{class:"receipt",id:b.CUSTOM_STRING(c),participant:b.PARTICIPANT_JID(a),to:b.TO_JID(a),type:"retry"})}function x(a){a=a.category;return a==="peer_appdata"||a==="peer"}function y(a){a=a.retryCount;return a>=d("MAWConstants").MESSAGE_RETRY_COUNT_LIMIT}function z(a){if(y(a)){d("WALogger").LOG(m());return}if(a.category!=null){d("WALogger").WARN(l(),a.category);return}}async function A(a,b,c,e,f){e===void 0&&(e=!0);var g=a.externalId,h=a.from,i=a.retryCount;c.addPoint("get_app_data_for_retry");if(b.type!=="unacked"){d("WALogger").LOG(k(),b.type,g);e?c.endFail(b.type):c.addPoint(b.type);f==null?void 0:f.markError();f==null?void 0:f.setError("appData"+b.type);return}e=b.appData;b=b.deviceIdentity;a=await v(a,b);c.addPoint("get_session_info");e=await d("WASendAppDataIndividualProtocol").sendAppDataRetryToIndividualDeviceProtocol(e,g,h.author,i,b.pubKey,a);c.addPoint("send_app_data");if(i>=2&&e.success===!0&&e.value.baseKey!=null){b=e.value.baseKey;await d("MAWWriteAppDataRetryApi").writeAppDataRetry(g,h.author,b)}f==null?void 0:f.markSuccess();return e}async function B(a,b,e,f,g){var k;f===void 0&&(f=!0);var l=b.msgForRetry;b=b.retryRequest;var m=a.externalId,n=a.from,o=a.retryCount,p=b.protocolMsgId.chat;if(l.type!=="unacked"){f&&e.endFail(l.type);d("WALogger").LOG(j(),l.type);g==null?void 0:g.markError();g==null?void 0:g.setError("msg"+l.type);return}if(l.retryCount!=null&&l.retryCount>0&&l.retryCount===o){f&&e.endFail("unauthorized");d("WALogger").LOG(i(),o);g==null?void 0:g.markError();g==null?void 0:g.setError("msgunauthorized");return}if(n.type==="group"){var q=d("WADexieToWormMigration").isWorm("MAWSharedHandleRetryRequest")?d("WAMarkParticipantNeedsKeyApiV2").markParticipantNeedsKey:d("WAMarkParticipantNeedsKeyApi").markParticipantNeedsKey;await q(n.chat,n.author);e.addPoint("mark_participant_needs_key_complete")}q=l.backupDirective;var r=l.frankingKey,s=l.frankingVersion,t=l.isInstamadillo,u=l.messageBytes,w=l.messageType,x=l.protocolMsgId,y=await d("WALoadReceiptApi").loadReceipt({author:x.author,chat:x.chat,externalId:x.externalId}).then(function(a){return a.success?a.value:null});k=y==null?void 0:(k=y.permittedIdentitiesPerDevice)==null?void 0:k.get(b.deviceJid);if(y==null||k==null){f&&e.endFail("unauthorized");d("WALogger").LOG(h());g==null?void 0:g.markError();g==null?void 0:g.setError("msgunauthorized");return}y=await v(a,k);e.addPoint("get_session_info_complete");c("gkx")("24021")&&await d("MAWDebugMsg").writeDebugMsg(p,"Handling retry request for message: "+l.protocolMsgId.externalId.toString()+" to user "+n.author);f=await d("WAGenReportingMeta").genReportingMeta(u.bytes,r,s);a=await d("WASendMsgInternal").sendMessage({backupDirective:q,chat:p,count:o,deviceIdentity:null,externalId:m,identityKey:k.pubKey,messageBytes:u,messageType:w,protocolMsgId:x,reportingMeta:f,sessionInfo:y,to:n.author,type:"direct"},e,t);e.addPoint("send_message_complete");if(o>=2&&a.success&&a.value.baseKey!=null){l=a.value.baseKey;await d("WAWriteMsgRetryApi").writeMsgRetry(b.protocolMsgId,n.author,l)}o>=1&&a.success&&await d("WAWriteMsgRetryCountApi").writeMsgRetryCount(b.protocolMsgId,n.author,o);g==null?void 0:g.markSuccess()}function C(a,b){if(a.offline==null)return!1;var c=b==null||a.regId!==b.regId;b=b!=null&&a.keys!=null&&!d("WACryptoUtils").uint8ArraysEqual(b.pubKey,a.keys.identity);return c||b}g.bulkHandleRetryRequest=a}),98);
__d("MAWCOPRetryHandler",["MAWIsQuotaExceededError","MAWSharedCOPLogger","MAWSharedHandleRetryRequest"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Receipt consumer error"]);h=function(){return a};return a}function a(a){return i(a).catch(function(a){if(d("MAWIsQuotaExceededError").isQuotaExceededError(a))throw a;c("MAWSharedCOPLogger").catching(a).MUSTFIX(h());return[]})}async function i(a){if(a.length===0)return[];await d("MAWSharedHandleRetryRequest").bulkHandleRetryRequest(a.map(function(a){return a.retry}));return a.map(function(a){return a.stanzaQueueId})}g.default=a}),98);
__d("MAWSplitProtocolEntityByType",[],(function(a,b,c,d,e,f){"use strict";function a(a){var b={appdatas:[],instructions:[],messages:[],notifications:[],receipts:[],retries:[]};a.forEach(function(a){switch(a.type){case"message":b.messages.push(a);return;case"retryReceipt":b.retries.push(a);return;case"appdata":b.appdatas.push(a);return;case"notification":b.notifications.push(a);return;case"receipt":b.receipts.push(a);return;default:a;b.instructions.push(a);return}});return b}f["default"]=a}),66);
__d("WAParseMessageTransport",["WALogger","decodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["There are unknown fields in the integral"]);h=function(){return a};return a}function i(a){return{version:"v3",type:"error",error:a}}function j(a,b){return a!=null&&(b.dsm==null||b.dsm.destinationJid==null||b.dsm.destinationJid!==a)}function a(a,b){var c=a.payload,e=a.protocol;if(c==null&&e==null)return i("There is no payload and protocol in the message transport");else if(e==null)return i("There is no protocol part in the message transport");var f=e.integral;if(f==null)return i("There is no integral part in the message transport");else if(f.padding==null)return i("There is no padding in the message transport");else if(j(b,f))return i("The recipient does not match the device sent message recipient");else if(d("decodeProtobuf").getUnknownFields(f)!=null){d("WALogger").ERROR(h());return babelHelpers["extends"]({},i("There are unknown fields in the integral"),{futureProof:c==null?void 0:c.futureProof})}if(c!=null){b=c.applicationPayload;return b==null?i("There is no applicationPayload payload in the message transport"):{type:"applicationPayload",applicationPayload:b,skdm:l(e.ancillary),icdc:m(e.ancillary)}}f=l(e.ancillary);if(f!=null)return{type:"skdm",skdm:f,icdc:m(e.ancillary)};return k(a)===!0?{type:"empty",version:"v3"}:{type:"unknown"}}function k(a){var b;if(a.payload!=null)return!1;if(a.protocol==null)return!0;a=a.protocol;var c=new Set(["$$unknownFieldCount","padding"]);b=Object.keys((b=a.integral)!=null?b:{}).filter(function(a){return!c.has(a)});a=Object.keys((a=a.ancillary)!=null?a:{}).filter(function(a){return!c.has(a)});return a.length===0&&b.length===0}function l(a){return a==null?null:a.skdm}function m(a){return a==null?null:a.icdc}g.parseMessageTransport=a}),98);
__d("WADecodeIncomingMsg",["WALogger","WALongInt","WAMsgApplication.pb","WAMsgTransport.pb","WAParseMessageApplication","WAParseMessageTransport","WAStanzaUtils","WATimeUtils","decodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["decodeIncomingMsg called with unexpected encoding version: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["instamadillo decodeIncomingMsg called with null applicationPayload"]);i=function(){return a};return a}function j(a,b,c){return a.futureProof&&c!=null?{version:"v3",type:"futureProof",futureProof:a.futureProof,protobuf:b,applicationPayload:c,subtype:null}:{version:"v3",type:"error",error:a.error}}function a(a,b,c,e){if(b==="v2")return{version:"v2",encoded:a};else if(b==="v3"){var f=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMsgTransport.pb").MessageTransportSpec,a);c=d("WAParseMessageTransport").parseMessageTransport(f,c);f=n(f);if(c.type==="error")return j(c,a);if(c.type==="skdm")return k(c.skdm,c.icdc);else if(c.type==="applicationPayload"){if(e===!0){if(c.applicationPayload.payload==null){d("WALogger").DEV(i());return{version:"v3",type:"error",error:"instamadillo unhandled proto"}}return{version:"v3",type:"instamadillo",applicationPayload:new Uint8Array(c.applicationPayload.payload),backupDirective:f}}e=l(c.applicationPayload,a,c.icdc,f);if(c.skdm!=null){a=k(c.skdm,c.icdc);return{version:"v3",type:"msgWithSKDM",msg:e,skdm:a}}return e}else if(c.type==="empty")return{version:"v3",type:"empty"};else{c.type;return{version:"v3",type:"error",error:"unhandled proto with type "+c.type}}}else{d("WALogger").DEV(h(),b);return{type:"error",version:"v3",error:"decodeIncomingMsg called with unexpected encoding version: "+b}}}function k(a,b){var c=a.axolotlSenderKeyDistributionMessage;a=a.groupId;if(c==null)return{type:"error",version:"v3",error:"parseSKDM called with null axolotlSenderKeyDistributionMessage"};else if(a==null)return{type:"error",version:"v3",error:"parseSKDM called with null groupId"};return{version:"v3",type:"skdm",msg:{senderKey:c,groupId:a},icdc:b}}function l(a,b,c,e){var f=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMsgApplication.pb").MessageApplicationSpec,a.payload);if(f.payload==null)return m(f.metadata,a.payload);var g=d("WAParseMessageApplication").parseMessageApplication(f);if(g.type==="error")return j(g,b);return a.payload==null?j({error:"Empty application payload",type:"error",version:"v3"},b):{version:"v3",type:"subprotocol",metadata:(f=f.metadata)!=null?f:null,subprotocolType:g.subprotocolType,subprotocol:g.payload,applicationPayload:a.payload,protobuf:b,frankingContent:a.payload,backupDirective:e,icdc:c}}function m(a,b){a=a==null?void 0:a.chatEphemeralSetting;if(a!=null){var c=a.ephemeralExpiration,e=a.ephemeralSettingTimestamp;if(c==null)return{version:"v3",type:"error",error:"Ephemeral setting without expiration"};if(b==null)return{error:"Empty application payload",type:"error",version:"v3"};try{e=e!=null?d("WATimeUtils").castToUnixTime(d("WALongInt").numberOrThrowIfTooLarge(e)/1e3):d("WATimeUtils").DEFAULT_UNIXTIME;return{version:"v3",type:"ephemeral",ephemeralExpirationInSec:c,ephemeralLastUpdatedOrSetTimestamp:e,isEphemeralSettingReset:(e=a.isEphemeralSettingReset)!=null?e:!1,applicationPayload:b}}catch(f){return{version:"v3",type:"ephemeral",ephemeralExpirationInSec:c,ephemeralLastUpdatedOrSetTimestamp:d("WATimeUtils").DEFAULT_UNIXTIME,isEphemeralSettingReset:(e=a.isEphemeralSettingReset)!=null?e:!1,applicationPayload:b}}}else return{version:"v3",type:"error",error:"MessageApplication has no payload and is not ephemeral"}}function n(a){a=(a=a.protocol)==null?void 0:(a=a.ancillary)==null?void 0:a.backupDirective;if(a==null)return null;var b=a.messageId,c=a.actionType;a=a.supplementalKey;return b==null||c==null?null:{messageId:d("WAStanzaUtils").toStanzaId(b),actionType:c,supplementalKey:a}}g.decodeIncomingMsg=a;g.parseEphemeralSetting=m}),98);
__d("MawMpsPayloadToWaProtocolEntry",["FBLogger","MAWJids","MAWUnsafeCoerce","MpsDeserializers","MpsFutureProofKey","MpsTypes","WAArmadilloTransportEvent.pb","WADecodeIncomingMsg","WAFranking","WAFrankingTypes","WAJids","WAProtocolQueue","WAStanzaUtils","WATimeUtils","err"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return null}function a(a){return a.directive==null?null:i(a.message.payload,a.message.messageId,a.message.threadId,a.message.senderId,a.message.timestampMs,"wa")}function b(a){var b=a.toplevelProtobuf,e=b.messageId,f=b.payload,g=b.senderId,h=b.threadId;b=b.timestampMs;f=i(f,e,h,g,b,"ebrestore");e=a.supplementalProtobufs;g=Array.from(e.values()).map(function(a){var b;b=(b=d("MpsDeserializers").DeserializedBackupMessage.create(a.payload).proto.metadata)==null?void 0:b.senderId;if(b==null){c("FBLogger")("mps").mustfix("Supplemental message has no senderId");return null}b=i(a.payload,a.messageId,h,b,a.timestampMs,"ebrestore");return b});return[f].concat(g).filter(Boolean)}function i(a,b,c,e,f,g){a=d("MpsDeserializers").DeserializedBackupMessage.create(a);var i=a.payload();switch(i.kind){case"messageApplication":var j=i,k=j.subProtocol(),l;if(k==null){l=d("WADecodeIncomingMsg").parseEphemeralSetting(j.proto.metadata,i.bytes);if(l.type==="error")return null}else{var m;l={applicationPayload:j.bytes,backupDirective:null,frankingContent:j.bytes,icdc:null,metadata:(m=i.proto.metadata)!=null?m:null,protobuf:new Uint8Array(j.bytes),subprotocol:k.bytes,subprotocolType:k.kind==="armadillo"?"armadillo":"consumerMessage",type:"subprotocol",version:"v3"}}l={contentType:h(j),fbFolderId:null,from:d("WAJids").toDeviceJid(d("MAWJids").toUserJid(e),d("WAJids").DEFAULT_DEVICE_ID),incomingType:g,jid:d("MAWJids").threadIdToChatJid(c),message:l,offline:null,priority:d("WAProtocolQueue").WAProtocolQueuePriorityHigh,recipient:void 0,remoteIdentity:null,reportingMeta:{frankingKey:null,frankingTag:((m=a.proto.metadata)==null?void 0:(k=m.frankingMetadata)==null?void 0:k.frankingTag)!=null?d("WAFrankingTypes").castToFrankingTag(new Uint8Array(a.proto.metadata.frankingMetadata.frankingTag)):null,frankingVersion:d("WAFranking").getFrankingVersion(),reportingContent:null,reportingTag:((j=a.proto.metadata)==null?void 0:(g=j.frankingMetadata)==null?void 0:g.reportingTag)!=null?new Uint8Array(a.proto.metadata.frankingMetadata.reportingTag):null},retryCount:0,serverTs:d("WATimeUtils").castMilliSecondsToUnixTime(f),stanzaId:d("MpsTypes").messageIdToStanzaId(b),subtype:"armadillo",type:"message"};m=d("MAWUnsafeCoerce").unsafeCoerce(b);return babelHelpers["extends"]({},l,{stanzaQueueId:m});case"transportEvent":k=i;if(k.proto.event!=null){j=k.proto.event;if(j.icdcAlert!=null){g={instruction:"icdcError",jid:d("MAWJids").toUserJid(e),notificationTs:d("WATimeUtils").castMilliSecondsToUnixTime(f),priority:d("WAProtocolQueue").WAProtocolQueuePriorityHigh,type:"instruction"};l=d("MAWUnsafeCoerce").unsafeCoerce(b);return babelHelpers["extends"]({},g,{stanzaQueueId:l})}}if(k.proto.placeholder!=null&&k.proto.placeholder.type!=null)switch(k.proto.placeholder.type){case d("WAArmadilloTransportEvent.pb").TransportEvent$Placeholder$Type.DECRYPTION_FAILURE:m={contentType:null,decryptionError:"",fbFolderId:null,from:d("WAJids").toDeviceJid(d("MAWJids").toUserJid(e),d("WAJids").DEFAULT_DEVICE_ID),hideDecryptionFailure:((m=a.proto.metadata)==null?void 0:m.futureProofBehavior)===d("MpsFutureProofKey").WCEPlaintextPayloadFutureProof.WCEPlaintextPayloadFutureProofNoPlaceholder,jid:d("MAWJids").threadIdToChatJid(c),offline:null,priority:d("WAProtocolQueue").WAProtocolQueuePriorityHigh,recipient:void 0,reportingMeta:{frankingKey:null,frankingTag:((j=a.proto.metadata)==null?void 0:(g=j.frankingMetadata)==null?void 0:g.frankingTag)!=null?d("WAFrankingTypes").castToFrankingTag(new Uint8Array(a.proto.metadata.frankingMetadata.frankingTag)):null,frankingVersion:d("WAFranking").getFrankingVersion(),reportingContent:null,reportingTag:((l=a.proto.metadata)==null?void 0:(k=l.frankingMetadata)==null?void 0:k.reportingTag)!=null?new Uint8Array(a.proto.metadata.frankingMetadata.reportingTag):null},retryCount:0,serverTs:d("WATimeUtils").castMilliSecondsToUnixTime(f),stanzaId:d("WAStanzaUtils").toStanzaId(b),subtype:"ciphertext",type:"message"};j=d("MAWUnsafeCoerce").unsafeCoerce(b);return babelHelpers["extends"]({},m,{stanzaQueueId:j});case d("WAArmadilloTransportEvent.pb").TransportEvent$Placeholder$Type.UNAVAILABLE_MESSAGE:j={contentType:null,fbFolderId:null,from:d("WAJids").toDeviceJid(d("MAWJids").toUserJid(e),d("WAJids").DEFAULT_DEVICE_ID),jid:d("MAWJids").threadIdToChatJid(c),offline:null,priority:d("WAProtocolQueue").WAProtocolQueuePriorityHigh,recipient:void 0,reportingMeta:{frankingKey:null,frankingTag:((g=a.proto.metadata)==null?void 0:(l=g.frankingMetadata)==null?void 0:l.frankingTag)!=null?d("WAFrankingTypes").castToFrankingTag(new Uint8Array(a.proto.metadata.frankingMetadata.frankingTag)):null,frankingVersion:d("WAFranking").getFrankingVersion(),reportingContent:null,reportingTag:((k=a.proto.metadata)==null?void 0:(m=k.frankingMetadata)==null?void 0:m.reportingTag)!=null?new Uint8Array(a.proto.metadata.frankingMetadata.reportingTag):null},retryCount:0,serverTs:d("WATimeUtils").castMilliSecondsToUnixTime(f),stanzaId:d("WAStanzaUtils").toStanzaId(b),subtype:"unavailable",type:"message"};e=d("MAWUnsafeCoerce").unsafeCoerce(b);return babelHelpers["extends"]({},j,{stanzaQueueId:e})}break;case"locallyTransformedMessage":break;case"adminMessage":break;default:i}}function e(a,b,e){b=new Set(b);for(a of a)!b.has(d("MAWUnsafeCoerce").unsafeCoerce(a.message.messageId))&&!e.has(a.message.messageId)&&e.set(a.message.messageId,c("err")("Ack not received"));return e}g.mpsIncomingPayloadToWAProtocolEntry=a;g.mpsFullMessageToMawPayload=b;g.mawAcksToMpsIncomingPayloadErrorMap=e}),98);
__d("MAWProtocolQueueProcess",["FBLogger","MAWCOPAppdataHandler","MAWCOPInstructionsHandler","MAWCOPMessagesHandler","MAWCOPNotificationsHandler","MAWCOPReceiptsHandler","MAWCOPRetryHandler","MAWSharedCOPLogger","MAWSplitProtocolEntityByType","MawMpsPayloadToWaProtocolEntry","getErrorSafe"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["New COP handler for "," msgs, "," appdatas, "," notifications, "," receipts, "," retries, "," instructions"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["New COP handler for "," msgs, "," appdatas, "," notifications, "," receipts, "," retries, "," instructions"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["New COP handler for "," msgs, "," appdatas, "," notifications, "," receipts, "," retries, "," instructions"]);j=function(){return a};return a}async function a(a){a=c("MAWSplitProtocolEntityByType")(a);c("MAWSharedCOPLogger").DEBUG(j(),a.messages.length,a.appdatas.length,a.notifications.length,a.receipts.length,a.retries.length,a.instructions.length);a=(await Promise.all([c("MAWCOPMessagesHandler")(a.messages),c("MAWCOPInstructionsHandler")(a.instructions),c("MAWCOPReceiptsHandler")(a.receipts),c("MAWCOPAppdataHandler")(a.appdatas),c("MAWCOPNotificationsHandler")(a.notifications),c("MAWCOPRetryHandler")(a.retries)])).flat();return a}async function b(a){a=a.map(function(a){try{return d("MawMpsPayloadToWaProtocolEntry").mpsFullMessageToMawPayload(a)}catch(d){var b=c("getErrorSafe")(d);c("FBLogger")("COP").catching(b).mustfix("Failed to convert FullMessage %s to MAW payload",a.toplevelProtobuf.messageId);return null}}).flat().filter(Boolean);a=c("MAWSplitProtocolEntityByType")(a);c("MAWSharedCOPLogger").DEBUG(i(),a.messages.length,a.appdatas.length,a.notifications.length,a.receipts.length,a.retries.length,a.instructions.length);await Promise.all([c("MAWCOPMessagesHandler")(a.messages),c("MAWCOPInstructionsHandler")(a.instructions),c("MAWCOPAppdataHandler")(a.appdatas),c("MAWCOPNotificationsHandler")(a.notifications)])}async function e(a){var b=new Map(),e=a.map(function(a){try{return d("MawMpsPayloadToWaProtocolEntry").mpsIncomingPayloadToWAProtocolEntry(a)}catch(d){var e=c("getErrorSafe")(d);c("FBLogger")("COP").catching(e).mustfix("Failed to convert incoming payload to MAW payload");b.set(a.message.messageId,e);return null}}).flat().filter(Boolean);e=c("MAWSplitProtocolEntityByType")(e);c("MAWSharedCOPLogger").DEBUG(h(),e.messages.length,e.appdatas.length,e.notifications.length,e.receipts.length,e.retries.length,e.instructions.length);e=(await Promise.all([c("MAWCOPMessagesHandler")(e.messages),c("MAWCOPInstructionsHandler")(e.instructions),c("MAWCOPAppdataHandler")(e.appdatas),c("MAWCOPNotificationsHandler")(e.notifications)])).flat();return d("MawMpsPayloadToWaProtocolEntry").mawAcksToMpsIncomingPayloadErrorMap(a,e,b)}g.processProtocolQueueEntries=a;g.processMPSFullMessageEntries=b;g.processMPSIncomingPayloadEntries=e}),98);
__d("MAWDecryptUnstoredPollUpdateMessage",["FBLogger","MAWGroupPollsDualEncryptionUtils","WAGlobals","WAJids"],(function(a,b,c,d,e,f,g){"use strict";async function a(a,b,e){var f=b.encryptedMessage.vote,g=b.encryptedMessage.addOption,h=e.encKey,i=e.pollAuthor===d("WAJids").AUTHOR_ME?d("WAGlobals").getMyUserJid():d("WAJids").authorAsUserJid(e.pollAuthor);e=e.pollStanzaId;var j=a.externalId;a=a.author===d("WAJids").AUTHOR_ME?d("WAGlobals").getMyUserJid():d("WAJids").authorAsUserJid(a.author);if(a==null||j==null||i==null){c("FBLogger")("GroupPollsE2EE").mustfix("Missng param - pollUpdateSenderJid:%s pollUpdateStanzaId:%s pollCreationSenderJid:%s",a,j,i);return Promise.resolve(b)}h={pollCreationMessageKey:h,pollCreationSenderJid:i,pollCreationStanzaId:e,pollUpdateSenderJid:a,pollUpdateStanzaId:j};i=null;f!=null&&(i=await d("MAWGroupPollsDualEncryptionUtils").decryptGroupPollVote(f,h).then(function(a){if(a.success===!1){c("FBLogger")("GroupPollsE2EE").mustfix("Failed to decrypt vote for pollUpdateStanzaId:%s",j,a.error);return null}return a.value}));e=null;if(g!=null){a=await d("MAWGroupPollsDualEncryptionUtils").decryptGroupPollAddOption(g,h).then(function(a){if(a.success===!1){c("FBLogger")("GroupPollsE2EE").mustfix("Failed to decrypt poll options for pollUpdateStanzaId:%s",j,a.error);return null}return a.value});a!=null&&(e=await Promise.all(a.pollOption.map(function(a){if(a.optionName==null)return null;var b=a.optionName;return d("MAWGroupPollsDualEncryptionUtils").getHashForOptionName(b).then(function(a){return{hashedOptionName:a,optionName:b}})}).filter(Boolean)))}return i==null&&e==null?b:babelHelpers.extends({},b,{decrypted:{optionsToAdd:(f=e)!=null?f:void 0,vote:(g=i)!=null?g:void 0}})}g.decryptUnstoredPollUpdateMessage=a}),98);
__d("WAStanzaRootTag",[],(function(a,b,c,d,e,f){"use strict";a="notification";b="receipt";c="message";d="call";e="chatstate";var g="presence",h="appdata",i="failure",j="stream:error",k="ib",l="iq",m="error",n="success",o="xmlstreamend",p={NOTIFICATION:a,RECEIPT:b,MESSAGE:c,CHATSTATE:e,PRESENCE:g,APPDATA:h,CALL:d,IQ:l,IB:k,STREAM_ERROR:j,FAILURE:i,SUCCESS:n,ERROR:m,XML_STREAM_END:o};f.NOTIFICATION=a;f.RECEIPT=b;f.MESSAGE=c;f.CALL=d;f.CHATSTATE=e;f.PRESENCE=g;f.APPDATA=h;f.FAILURE=i;f.STREAM_ERROR=j;f.IB=k;f.IQ=l;f.ERROR=m;f.SUCCESS=n;f.XML_STREAM_END=o;f.STANZA_ROOT_TAG=p}),66);
__d("MAWProtocolQueueMsg",["MAWBulkHandleIncomingMsgApi","MAWDbPoll","MAWDbPollTxns","MAWDecryptUnstoredPollUpdateMessage","MAWGroupPollsDualEncryptionUtils","MAWHIMLogger","MAWMpsGating","MAWMsgType","MAWParseXMAProtocol","MAWXMALoggingUtils","MAWXMAUtils","MWFBLogger","PersistedQueueDB","WAStanzaRootTag","gkx","qex"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot have null result for non-invisible msgs"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Handle: "," msgs: done"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Handle: "," msgs"]);j=function(){return a};return a}function k(a,b){if(a==null)return b;return a>b?b:a}async function a(a,b){var e=new Set(),f=a.filter(function(a){return a.stanza.message.details.retryCount>0});if(f.length>0){var g=d("MAWMpsGating").isMpsM3OrLater()?[]:await d("PersistedQueueDB").getPersistedQueues().runInTransaction(["stanzaQueue"],"readonly",function(a){return Promise.all(f.map(function(b){return a.stores.stanzaQueue.readIndex("[jid+priority+stanzaId]",[b.stanza.jid,b.stanza.priority,b.stanza.stanzaId])}))},"fetch-pending-ciphertext-stanzas");f.forEach(function(a,b){var c,e=null;g[b].forEach(function(a){if(a.type!==d("WAStanzaRootTag").STANZA_ROOT_TAG.MESSAGE)return;a;if(a.subtype!=="ciphertext")return;e==null&&(e=a);e.serverTs>a.serverTs&&(e=a)});if(e==null)return;e;b=e.serverTs;a.stanza.message.details.ts=k(a.stanza.message.details.ts,b);a.stanza.message.decrypted.ts=k(a.stanza.message.decrypted.ts,b);if(((c=a.decodedMsg)==null?void 0:c.unstoredDbMsg)!=null){c=a.decodedMsg.unstoredDbMsg;c.ts=k(c.ts,b);c.serverTs=k(c.serverTs,b)}if(((c=a.decodedMsg)==null?void 0:c.unstoredDbMedia)!=null){c=a.decodedMsg.unstoredDbMedia;c.ts=k(c.ts,b)}})}var l=a.map(function(a){var b,f,g=a.decodedMsg,h=a.receiveFlow;a=a.stanza;var i=a.message.decrypted,j=d("MAWXMALoggingUtils").getXmaTargetTypeStringFromEnum(g==null?void 0:g.xmaTargetTypeForLogging);b=g==null?void 0:(b=g.unstoredXMA)==null?void 0:b.unstoredDbXMA.xmaDataclass;f=g==null?void 0:(f=g.unstoredXMA)==null?void 0:f.unstoredDbXMA.targetType;f=d("MAWParseXMAProtocol").getUnsupportedMessageType(f,b);h.addAnnotations({bool:{furuteproof:(g==null?void 0:(b=g.unstoredDbMsg)==null?void 0:b.type)===d("MAWMsgType").MSG_TYPE.FUTUREPROOF},int:{xmaTargetType:(b=g==null?void 0:g.xmaTargetTypeForLogging)!=null?b:-1},string:{contentType:(b=g==null?void 0:g.contentTypeForLogging)!=null?b:"",subtype:(b=g==null?void 0:(b=g.unstoredDbMsg)==null?void 0:(b=b.msgContent)==null?void 0:b.subtype)!=null?b:f,xmaTargetTypeString:j}});if(d("MAWXMAUtils").isRtcXMA(g==null?void 0:(b=g.unstoredXMA)==null?void 0:(f=b.unstoredDbXMA)==null?void 0:f.targetType)&&!c("gkx")("13099")){h.endFail("rtc_xma_not_supported");e.add(a.stanzaQueueId);return null}if(i.type==="InstamadilloMsg"){h.endFail("instamadillo_not_supported");e.add(a.stanzaQueueId);return null}if(i.type==="InvisibleMsg"){e.add(a.stanzaQueueId);return null}return{msgData:i,receiveFlow:h,stanzaSource:a.incomingType,unstoredContent:g}}).filter(Boolean),m=c("qex")._("3170")!==!0?l:await Promise.all(l.map(async function(a){var b,c=a.msgData,e=a.receiveFlow,f=a.stanzaSource,g=a.unstoredContent;if((g==null?void 0:(b=g.unstoredDbMsg)==null?void 0:b.type)===d("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE&&(g==null?void 0:g.unstoredDbGroupPollCreateInfo)!=null){var h;b=g.unstoredDbGroupPollCreateInfo;h=(h=b.options)!=null?h:[];h=await Promise.all(h.map(async function(a){var b=await d("MAWGroupPollsDualEncryptionUtils").getHashForOptionName(a);return{optionHash:b,optionText:a}}));h=new Map(h.map(function(a){var b=a.optionHash;a=a.optionText;return[d("MAWDbPoll").convertStringToOptionHash(b),{optionText:a,voteAuthors:new Set()}]}));return{msgData:c,receiveFlow:e,stanzaSource:f,unstoredContent:babelHelpers.extends({},g,{unstoredDbGroupPollCreateInfo:babelHelpers.extends({},b,{optionsHashed:h})})}}if((g==null?void 0:g.unstoredDbGroupPollUpdateInfo)!=null){b=g.unstoredDbGroupPollUpdateInfo;h=(h=b.encryptedMessage.pollCreationMessageKey)==null?void 0:h.id;if(h==null){d("MWFBLogger").MWLogger.tags(["PollsE2EE"]).warn("pollStanzaId is null");return{msgData:c,receiveFlow:e,stanzaSource:f,unstoredContent:g}}h=await d("MAWDbPollTxns").getDbPoll(c.id.chat,h);if(h==null)return{msgData:c,receiveFlow:e,stanzaSource:f,unstoredContent:g};b=await d("MAWDecryptUnstoredPollUpdateMessage").decryptUnstoredPollUpdateMessage(c.id,b,h);return{msgData:c,receiveFlow:e,stanzaSource:f,unstoredContent:babelHelpers.extends({},g,{unstoredDbGroupPollUpdateInfo:b})}}return a}));c("MAWHIMLogger").DEBUG(j(),m.length);return d("MAWBulkHandleIncomingMsgApi").bulkHandleIncomingMsgs(m,b).then(function(b){var d=b.msgResults;c("MAWHIMLogger").DEBUG(i(),m.length);a.map(function(a){a=a.stanza;var b=d.get(a.message.decrypted.id);if(b==null){e.has(a.stanzaQueueId)||c("MAWHIMLogger").MUSTFIX(h());return}b.success===!0&&e.add(a.stanzaQueueId)});return{followUpParams:{incomingMsgResults:d,incomingMsgs:a},toAck:Array.from(e)}}).catch(function(b){var c="Not an Error instance",d="N/A";typeof b.message==="string"&&(c=b.message);typeof b.stack==="string"&&(d=b.stack);a.forEach(function(a){a.receiveFlow.endFail("consumer_handle_message_transaction_error",{string:{errorDescription:c,errorStack:d}})});throw b})}g.handleIncomingMessagesStanzas=a}),98);
__d("MawCopScheduler",["WorkerScheduler","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(){h==null&&(h=d("WorkerScheduler").makeScheduler("cop",{concurrency:1,maxConcurrency:1,maxThrottleMs:1e5,timeToStuckMs:c("gkx")("10466")?1e5:3e4}));return h}g.copScheduler=a}),98);
__d("MpsToUIPostProcessor",["FBLogger","MpsMessageToBridge","MpsMessageToBridgeWrapper","MpsToBridgeMessageId","MpsTypes","WAJids","WATimeUtils","WebMps"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return[{tag:"NewMsg",value:a}]}function i(a){return[{tag:"EditMsgHistoryAdded",value:[a]}]}function j(a){if(a.type==="upsert")return[{tag:"UpsertReaction",value:a.reaction}];else if(a.type==="delete")return[{tag:"DeleteReaction",value:a.reaction}];a.type;throw c("FBLogger")("messenger_web").mustfixThrow("unreachable")}function k(a){return[{tag:"NewMedia",value:a}]}function l(a){return[{tag:"MsgsStartCountdown",value:a}]}function m(a){return[{tag:"NewReceiverFetchInfo",value:a}]}async function a(a){if(a.directive.actionType===d("MpsTypes").ActionType.DeleteTopLevel){var b=d("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromTopLevel(a.message),e=d("MpsToBridgeMessageId").mpsToBridgeMsgId(b.message.threadId,a.directive.targetMessageId);return[{tag:"DeleteMessages",value:{messages:[{msgId:e,ts:b.getUnixTs()}],threadJid:b.getChatJid()}}]}if(!(a.directive.actionType===d("MpsTypes").ActionType.UpsertTopLevel||a.directive.actionType===d("MpsTypes").ActionType.UpsertSupplemental||a.directive.actionType===d("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder))return[];e=a.directive.actionType===d("MpsTypes").ActionType.UpsertSupplemental?a.directive.targetMessageId:a.message.messageId;b=await d("WebMps").mps().loadMessage({config:{shouldFetchSupplementals:!0,strategy:"local-only"},debug:{purpose:"UI-fetch"},messageId:e,threadId:a.message.threadId});e=b.value;if(!e)return[];a=d("MpsMessageToBridge").mpsFullMessagetoBridge(e);if(a==null)return[];b=[a.topLevel].concat(a.supplementals).map(function(a){switch(a.kind){case"bridgeMsg":return h(a.value);case"bridgeEditHistoryMsg":return i(a.value);case"bridgeReactionAction":return j(a.value);case"bridgeMedia":return k(a.value);case"bridgeMsgsStartCountdown":return l(a.value);case"bridgeReceiverFetchInfo":return m(a.value);default:a.kind;throw c("FBLogger")("messenger_web").mustfixThrow("unreachable")}});a=b.flat();b=d("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromTopLevel(e.toplevelProtobuf);e=[{tag:"VerifyThreadExists",value:{authoritativeThreadKey:null,cannotReplyReason:null,clientThreadKey:null,description:"mpsToUIPostProcessor",folder:null,instanceKey:null,isGroup:d("WAJids").switchOnMsgrChatJidType(b.getChatJid(),{group:function(){return!0},user:function(){return!1}}),jid:b.getChatJid(),lastActivityTs:d("WATimeUtils").castToMillisTime(0),lastReadTs:d("WATimeUtils").castToMillisTime(0)}}];return e.concat(a)}g.mpsToUIEventPostProcessPayload=a}),98);
__d("MawMpsCop",["FBLogger","MAWBridge","MAWMpsGating","MAWProtocolQueueProcess","MawCopScheduler","MawMpsCopProtocolQueueProcessor","MpsToUIPostProcessor","MpsTypes","WAPubSub","WAWaitForUserUnblocked","WebMps","getErrorSafe","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h=10,i=1,j=10,k=c("justknobx")._("4688"),l=function(){function a(){this.$1=d("WAPubSub").simplePubSub(),this.$3=new Map(),this.$2=new(d("MawMpsCopProtocolQueueProcessor").ProtocolQueueProcessor)()}var b=a.prototype;b.loadMoreMsgsIntoMaw=async function(a){var b=await d("WebMps").mps().loadMessages(babelHelpers.extends({},a,{config:{shouldFetchSupplementals:!0,shouldFetchTags:!0,strategy:"full-fetch"}}));return b.success===!1?b:d("MAWProtocolQueueProcess").processMPSFullMessageEntries(b.value.messages).then(function(){return b})};b.subscribe=function(a){return this.$1.subscribe(a)};b.$4=async function(a,b){var c=this;if(this.$3.size===0)return{exhausted:!0};var e=[];this.$3.forEach(function(d,f){if(b!=null&&e.length>=b)return;e.push.apply(e,d.splice(-a));d.length===0&&c.$3.delete(f)});if(d("MAWMpsGating").isFullMpsEnabled()){await this.$5(e);return{exhausted:this.$3.size===0}}await this.$6(e);return{exhausted:this.$3.size===0}};b.$7=function(a){var b=this;a.forEach(function(a){var c,d=a.message.threadId;c=(c=b.$3.get(d))!=null?c:[];c.push(a);b.$3.set(d,c)})};b.$5=async function(a){var b=new Map(),e=[];await Promise.all(a.map(async function(a){try{e.push.apply(e,await d("MpsToUIPostProcessor").mpsToUIEventPostProcessPayload(a))}catch(d){b.set(a.message.messageId,c("getErrorSafe")(d))}}));d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:e});a.forEach(function(a){var d=b.get(a.message.messageId);if(d){d=d;c("FBLogger")("mps").catching(d).mustfix("Failed to process payload for UI for thread id = %s , message Id = %s",a.message.threadId,a.message.messageId)}})};b.$6=function(a){return d("MAWProtocolQueueProcess").processMPSIncomingPayloadEntries(a).then(function(a){a.forEach(function(a,b){c("FBLogger")("mps").catching(a).mustfix("Failed to process payload for MAW for message Id = %s",b)})}).catch(function(a){c("FBLogger")("mps").catching(a).mustfix("Failed to process payload for MAW")})};b.postProcessMessages=function(a){if(d("WAWaitForUserUnblocked").isStillWaitingForUserUnblocked()){this.$7(a);return Promise.resolve()}if(d("MAWMpsGating").isFullMpsEnabled())return this.$5(a);return a.length>0&&a[0].insertionSource===d("MpsTypes").InsertionSource.Send?Promise.resolve():this.$6(a)};b.subscribeToOfflineQueue=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"offline-start":d("WAWaitForUserUnblocked").maybeResetWaitForUserUnblocked();break;case"offline-end":b.$1.publish({type:"maw-infra-start"});b.$4(d("MAWMpsGating").isFullMpsEnabled()?h:i).catch(function(a){c("FBLogger")("cop").catching(a).mustfix("offline-end cop fails"),b.$1.publish({success:!1,type:"maw-infra-end"})}).finally(function(){b.$8(),b.$2.startProcessing()});b.$1.publish({success:!0,type:"maw-infra-end"});d("WAWaitForUserUnblocked").unblockUser();break;default:a.type;break}})};b.$8=function(){var a=this;if(this.$9!=null)return;this.$9=d("MawCopScheduler").copScheduler().task({fn:function(){return a.$4(j,k)},name:"background-iterator"});this.$9.run().then(function(b){a.$9=null,b.exhausted===!1&&a.$8()}).catch(function(b){c("FBLogger")("cop").catching(b).mustfix("Cop fails"),a.$9=null,a.$8()})};return a}(),m;function a(){if(!m){m=new l();return m}return m}g.MpsCop=l;g.mpsCop=a}),98);
__d("MAWSharedRestoreUnavailableMessages",["LSMEBTaskCreationSource","MAWBridgeEventTransmitter","WAGlobals","WAJids","setTimeout"],(function(a,b,c,d,e,f,g){"use strict";var h=1e4,i=new Map();function j(a){if(i.has(a.externalId))return;i.set(a.externalId,!0);c("setTimeout")(function(){var b=a.chat;d("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(a.externalId,d("WAJids").threadIdForChatJid(b),void 0,c("LSMEBTaskCreationSource").EB_POINT_QUERY_RETRY_DECRYPTION_FAILURES,b)},h)}function a(a){a.forEach(function(a){if(a.type!=="message")return;if(a.subtype!=null){if(a.subtype==="unavailable"||a.subtype==="ciphertext"){var b=d("WAJids").extractUserJid(a.from);j({author:d("WAGlobals").getMyUserJid()===b?"@me":b,chat:a.jid,externalId:a.stanzaId})}}else(a.message.decrypted.type==="IncomingCiphertextMsg"||a.message.decrypted.type==="UnavailableMsg")&&j(a.message.decrypted.id)})}g.restoreUnavailableMessages=a}),98);
__d("MAWSharedCOPHandleBatch",["MAWDbStaleQueue","MAWIsQuotaExceededError","MAWSharedCOPLogger","MAWSharedRestoreUnavailableMessages","WALogger","WAProtocolQueue","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Linear COP v2"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose([""," stanzas. Config:",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Received more than 1 entry, despite having limit === 1"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed processing "," items"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[ackProtocols] Cannot ack from MAWConsumer"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Runtime error while processing stanzas batch"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Quota exceeded while processing stanzas batch."]);n=function(){return a};return a}async function o(a,b,e){e=await e(a).then(function(a){return[a,null,!1]}).catch(function(a){if(d("MAWIsQuotaExceededError").isQuotaExceededError(a)){c("MAWSharedCOPLogger").catching(a).MUSTFIX(n());return[[],null,!0]}c("MAWSharedCOPLogger").catching(a).MUSTFIX(m());return[[],a instanceof Error?a:c("err")(""+a),!1]});var f=e[0],g=e[1];e=e[2];if(e)return{entriesLeft:[],exhausted:!0,handled:0};await d("WAProtocolQueue").protocolQueue().ack(f).catch(function(a){return c("MAWSharedCOPLogger").catching(a).MUSTFIX(l())});if(f.length>=a.length)return{entriesLeft:[],exhausted:!1,handled:f.length};c("MAWSharedCOPLogger").WARN(k(),a.length-f.length);if(b===1){a.length>1&&c("MAWSharedCOPLogger").MUSTFIX(j());if(a.length===0)return{entriesLeft:[],exhausted:!1,handled:0};e=a[0];g=(b=g==null?void 0:g.toString())!=null?b:"not-processed";await d("WAProtocolQueue").protocolQueue().delete([e.stanzaQueueId]);await d("MAWDbStaleQueue").mawAddStaleStanza(e,g);return{entriesLeft:[],exhausted:!1,handled:1}}var h=new Map(a.map(function(a){return[a.stanzaQueueId,a]}));f.forEach(function(a){return h.delete(a)});return{entriesLeft:Array.from(h.values()),error:!0,exhausted:!1,handled:f.length}}async function a(a,b,e,f){a=await a(b);b.order==="desc"&&(a=a.toReversed());if(a.length===0)return{exhausted:!0,handled:0};f==null?void 0:f.publish({type:"maw-infra-batch"});c("MAWSharedCOPLogger").DEBUG(i(),a.length,String(b));d("MAWSharedRestoreUnavailableMessages").restoreUnavailableMessages(a);f=await o(a,b.limit,e);if(f.error==null)return{exhausted:f.exhausted,handled:f.handled};d("WALogger").LOG(h());a=0;for(b of f.entriesLeft){var g=await o([b],1,e);a+=g.handled;if(g.exhausted)return{exhausted:!0,handled:a+f.handled}}return{exhausted:!1,handled:a+f.handled}}g.copHandleBatch=a}),98);
__d("MawMpsCopProtocolQueueProcessor",["FBLogger","MAWProtocolQueueProcess","MAWSharedCOPHandleBatch","MawCopScheduler","Promise","WAProtocolQueue","WAWaitForUserUnblocked","WorkerScheduler","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(){function a(){this.$2=c("justknobx")._("2539"),this.$3=null,this.$1()}var e=a.prototype;e.$4=function(){var a=this;if(this.$3!=null)return;this.$3=d("MawCopScheduler").copScheduler().task({fn:function(){return d("WAWaitForUserUnblocked").isStillWaitingForUserUnblocked()?(h||(h=b("Promise"))).resolve({exhausted:!0,handled:0}):d("MAWSharedCOPHandleBatch").copHandleBatch(d("WAProtocolQueue").protocolQueue().index("priority").read,{limit:a.$2,order:"desc"},d("MAWProtocolQueueProcess").processProtocolQueueEntries)},name:"protocol-queue",priority:d("WorkerScheduler").BACKGROUND_PRIORITY});this.$3.run().then(function(b){a.$3=null,b.exhausted===!1&&a.$4()})["catch"](function(b){c("FBLogger")("cop").catching(b).mustfix("ProtocolQueueProcessor fails"),a.$3=null,a.$4()})};e.startProcessing=function(){this.$4()};e.$1=function(){var a=this;d("WAProtocolQueue").protocolQueue().subscribe(function(b){switch(b.type){case"flush":if(d("WAWaitForUserUnblocked").isStillWaitingForUserUnblocked())return;a.startProcessing();return}})};return a}();g.ProtocolQueueProcessor=a}),98);
__d("MAWSharedOfflineQueueMetric",["$InternalEnum","FBLogger","MAWMpsGating","MawMpsCop","WAGlobals","WAPREList","WATagsLogger","WATimeUtils","WAWaterFlow"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["New mailbox age is ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["New mailbox age is ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Waterflow should start before the start of the processing"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Possible stuck reason: ",""]);k=function(){return a};return a}var l=d("WATagsLogger").TAGS(["offline-resume"]);f=b("$InternalEnum").Mirrored(["OFFLINE","ONLINE"]);var m=b("$InternalEnum").Mirrored(["WA_CLIENT_INFRA","WA_CLIENT_INFRA_DUPLICATED_START","WA_PASSIVE_MODE","WA_PASSIVE_MODE_FAIL","MAW_INFRA","MAW_STUCK","WA_STUCK","MAW_NOT_IDLE_OQ"]),n=function(){function a(a,b,c,e){this.$1=0,this.$3=c,this.$2=d("WAWaterFlow").makeWaterflow("offline-resume",d("WAPREList").PRE_METRIC.OFFLINE_QUEUE),this.$6(a),this.$7(),this.$8(b),this.$9(e),this.$4=Math.round(d("WATimeUtils").performanceAbsoluteNow()/1e3)}var b=a.prototype;b.$8=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"passive-mode-start":b.$2.isOnGoing()||b.$2.startMetric();b.$2.startPoint(m.WA_PASSIVE_MODE,{passiveModeAcks:a.count});b.$10("wa");break;case"passive-mode-end":b.$2.endPoint(m.WA_PASSIVE_MODE);b.$10("wa");break;default:a.type,b.$2.addPoint(m.WA_PASSIVE_MODE_FAIL),b.$10("wa")}})};b.$9=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"new-message":if(a.commonMessageBase.offline==null)return;b.addWAMessage();b.$10("wa");break}})};b.$6=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"offline-start":b.$11(a.offlineStats);b.$10("wa");break;case"offline-end":b.$2.isOnGoing()&&(b.$2.endPoint(m.WA_CLIENT_INFRA),b.$10("maw"));break;case"offline-entity":b.$12(a.serverTs,a.offline);b.$10("wa");break;case"offline-processed":b.$13(a.count);b.$10("wa");break;case"connection-lost":b.$2.isOnGoing()&&b.$2.endFail("connection-lost",{isConnectionLost:!0});b.$14();break;default:a}})};b.$10=function(a){var b=this;clearTimeout(this.$5);this.$2.isOnGoing()&&(this.$5=setTimeout(function(){b.$2.isOnGoing()&&(a==="wa"?b.$2.addPoint(m.WA_STUCK,{waStuck:!0}):b.$2.addPoint(m.MAW_STUCK,{mawStuck:!0}),l.WARN(k(),a))},d("WAGlobals").getConfig().offlineQueueStuckTimeoutMs()))};b.$14=function(){clearTimeout(this.$5)};b.$7=function(){var a=this;d("MAWMpsGating").isMpsM3OrLater()?d("MawMpsCop").mpsCop().subscribe(function(b){a.$15(b)}):this.$3.subscribe(function(b){a.$15(b)})};b.$15=function(a){switch(a.type){case"idle-oq-safe-guard":if(!this.$2.isOnGoing())break;this.$2.addPoint(m.MAW_NOT_IDLE_OQ);break;case"maw-infra-start":if(!this.$2.isOnGoing())break;this.$10("maw");this.$2.startPoint(m.MAW_INFRA);break;case"maw-infra-batch":this.$2.isOnGoing()||(this.$2.startMetric(),this.$2.startPoint(m.MAW_INFRA));this.$10("maw");this.$2.reAnnotate(function(a){a=a.mawInfraBatchCount;return{mawInfraBatchCount:((a=a)!=null?a:0)+1}});break;case"maw-infra-end":if(!this.$2.isOnGoing())break;this.$2.endPoint(m.MAW_INFRA);this.$14();a.success?this.$2.endSuccess():this.$2.endFail("fail");break;default:a}};b.addWAMessage=function(){this.$2.isOnGoing()&&(this.$2.reAnnotate(function(a){a=a.waMessage;return{waMessage:((a=a)!=null?a:0)+1}}),this.$10("wa"))};b.addMAWEntity=function(a){this.$2.isOnGoing()&&(this.$2.reAnnotate(function(b){b=b.mawProcessedCount;return{mawProcessedCount:((b=b)!=null?b:0)+a}}),this.$10("maw"))};b.$11=function(a){this.$2.isOnGoing()?this.$2.addPoint(m.WA_CLIENT_INFRA_DUPLICATED_START):(this.$1++,this.$2.startMetric(),this.$4=Math.round(d("WATimeUtils").performanceAbsoluteNow()/1e3)),this.$2.startPoint(m.WA_CLIENT_INFRA,{batchSize:d("WAGlobals").getConfig().limitPullMode()?250:d("WAGlobals").getConfig().batchSize(),expectedAppdata:a.appdata,expectedCount:a.count,expectedMessage:a.message,expectedNotification:a.notification,expectedReceipt:a.receipt,mpsStatus:this.$16(),offlineResumeCount:this.$1,waDanglingQueue:d("WAGlobals").getConfig().waDanglingQueue()})};b.$16=function(){if(d("MAWMpsGating").isFullMpsEnabled())return"full";if(d("MAWMpsGating").isMpsM3OrLater())return"m3";if(d("MAWMpsGating").isMpsDev())return"dev";return d("MAWMpsGating").isMpsEnabled()?"should_not_be_exposed_separately":"disabled"};b.getDetails=function(){var a;return((a=this.$2)==null?void 0:a.getAnnotations())||{}};b.$13=function(a){var b;(b=this.$2)==null?void 0:b.reAnnotate(function(b){return{waProcessed:((b=b.waProcessed)!=null?b:0)+a}})};b.addRuntimeErrorDuringOffflineQueue=function(){if(this.$2.isOnGoing()){var a;(a=this.$2)==null?void 0:a.reAnnotate(function(a){return{runtimeErrors:((a=a.runtimeErrors)!=null?a:0)+1}})}};b.addDecryptionError=function(){if(this.$2.isOnGoing()){var a;(a=this.$2)==null?void 0:a.reAnnotate(function(a){return{decryptErrors:((a=a.decryptErrors)!=null?a:0)+1}})}};b.addRetriesTrack=function(a){if(this.$2.isOnGoing()){var b;(b=this.$2)==null?void 0:b.reAnnotate(function(b){return{retries:((b=b.retries)!=null?b:0)+a}})}};b.$12=function(a,b){var c=this;if(!this.$2.isOnGoing()){l.WARN(j());return}this.$2.reAnnotate(function(d){var e=d.mailboxAgeSec,f=d.maxOffline;d=d.waDownloaded;e=e;e==null&&a!=null&&(e=c.$4-a,l.LOG(i(),e));e!=null&&a!=null&&(c.$4-a>e&&(e=c.$4-a,l.LOG(h(),e)));return{mailboxAgeSec:e,maxOffline:Math.max((e=f)!=null?e:0,b),waDownloaded:((f=d)!=null?f:0)+1}})};return a}(),o;function a(a,b,d,e){if(o!=null){var f=o;c("FBLogger")("messenger_e2ee_web").mustfix("Offline sync reported is inited twice");return f}o=new n(a,b,d,e);return o}function e(){if(o==null){c("FBLogger")("messenger_e2ee_web").mustfix("Offline sync reported is not inited");return null}return o}g.OfflineMode=f;g.OfflineStages=m;g.makeOfflineQueueMetric=a;g.getOfflineQueueMetric=e}),98);
__d("WAClearSignalStores",["MAWDexieTable","MAWTransactionMode","WADbTransactor"],(function(a,b,c,d,e,f,g){"use strict";a=d("WADbTransactor").makeSignalTransactor({personalSenderKeyStatuses:d("MAWTransactionMode").READWRITE,tasks:d("MAWTransactionMode").READWRITE},"clearSignalStores",function(a){return function(){return d("MAWDexieTable").dexieAll([a.tasks.clear(),a.personalSenderKeyStatuses.clear()]).then(function(){})}});g.clearSignalStores=a}),98);
__d("WAClearSignalStoresV2",["WASignalDB"],(function(a,b,c,d,e,f,g){"use strict";a=function(){return d("WASignalDB").getDb().runInTransaction(["identity","contacts","meta","prekey","prekeyGeneration","senderKeySessions","session","signedPrekey","personalSenderKeyStatuses"],"readwrite",async function(a){await Promise.all([a.stores.identity.clear(),a.stores.contacts.clear(),a.stores.meta.clear(),a.stores.prekey.clear(),a.stores.prekeyGeneration.clear(),a.stores.senderKeySessions.clear(),a.stores.session.clear(),a.stores.signedPrekey.clear(),a.stores.personalSenderKeyStatuses.clear()])},d("WASignalDB").signalOp("clearSignalStores"))};g.clearSignalStores=a}),98);
__d("MAWClearSignalAndTempStores",["MAWDeleteOldLogsFromDisk","MAWJobActionsV2","MAWJobsIndexedDb","MAWLoggingSwitches","MAWTransactionMode","Promise","WAClearSignalStores","WAClearSignalStoresV2","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h,i=d("MAWJobsIndexedDb").makeJobsTransactor("jobs",d("MAWTransactionMode").READWRITE,"clearJob")(d("MAWJobActionsV2").clearJobs);a=function(){return(h||(h=b("Promise"))).all([d("MAWLoggingSwitches").removeLoggingFromBridge&&d("MAWDeleteOldLogsFromDisk").clearLogs(),d("WAClearSignalStores").clearSignalStores(),i(),d("WAClearSignalStoresV2").clearSignalStores()]).then(c("emptyFunction"))};g.clearSignalAndTempStores=a}),98);
__d("MAWCryptoAuthTokenWrapper",["MessengerWebInitData"],(function(a,b,c,d,e,f,g){"use strict";function a(){return d("MessengerWebInitData").cryptoAuthToken}g.getCryptoAuthToken=a}),98);
__d("MAWDbInitIndexedDb",["MAWIndexedDb","MWEARKeychainV3","gkx"],(function(a,b,c,d,e,f,g){"use strict";function a(a){a=a.onDbPopulate;return d("MAWIndexedDb").makeDB(d("MWEARKeychainV3").getDbEncryptionKey,{enableDataSyncMiddleware:!0,enableMutationValidator:c("gkx")("1627"),onDbPopulate:a})}g.dbInit=a}),98);
__d("WADbIdentityTxnsV2",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){return a.identity.bulkGet(b).then(function(a){return a.map(function(a){if(a==null)return;return{id:a.deviceJid,identity:a.identity}}).filter(Boolean)})}f.bulkGetIdentities=a}),66);
__d("WACompareIdentityV2",["WACryptoUtils","WADbIdentityTxnsV2","WADbSignal","WAJids","WASignalKeys"],(function(a,b,c,d,e,f,g){"use strict";async function a(a){var b=await a.meta.bulkGet([d("WADbSignal").MetaKeysEnum.fbid,d("WADbSignal").MetaKeysEnum.deviceId,d("WADbSignal").MetaKeysEnum.identityKeyPair]),c=b[0],e=b[1];b=b[2];c=c==null?void 0:c.value.fbid;e=e==null?void 0:e.value.deviceId;b=b==null?void 0:b.value.identityKeyPair;if(c!=null&&e!=null){c=d("WAJids").toDeviceJid(d("WAJids").toMsgrUserJid(c),e);e=await d("WADbIdentityTxnsV2").bulkGetIdentities(a,[c]);if(!(e.length===0)){a=e[0];if((b==null?void 0:b.publicKey)==null)return!0;if(!d("WACryptoUtils").serializedPubKeysEqual(a.identity,d("WASignalKeys").serializePubKey(b)))return!1}return!0}return!0}g.compareIdentity=a}),98);
__d("WAGetRegistrationInfoApi",["WACompareIdentityV2","WADbSignal","WALogger","WASignalDB","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Registration history log unexpectedly empty"]);h=function(){return a};return a}function a(){return d("WASignalDB").getDb().runInTransaction(["meta","identity"],"readonly",async function(a){var b;b=await Promise.all([a.stores.meta.bulkGet([(b=d("WADbSignal")).MetaKeysEnum.lastSignedPrekeyId,b.MetaKeysEnum.deviceUUID,b.MetaKeysEnum.lastSessionDeviceWasLinkedTo,b.MetaKeysEnum.regId,b.MetaKeysEnum.identityKeyPair,b.MetaKeysEnum.fbid,b.MetaKeysEnum.deviceId,b.MetaKeysEnum.registrationVersion,b.MetaKeysEnum.deviceRegUnixTime,b.MetaKeysEnum.cat]),d("WACompareIdentityV2").compareIdentity(a.stores)]);a=b[0];var c=a[0],e=a[1],f=a[2],g=a[3],h=a[4],i=a[5],j=a[6],k=a[7],l=a[8];a=a[9];b=b[1];c=c==null?void 0:(c=c.value)==null?void 0:c.lastSignedPrekeyId;e=e==null?void 0:(e=e.value)==null?void 0:e.deviceUUID;f=f==null?void 0:(f=f.value)==null?void 0:f.lastSessionDeviceWasLinkedTo;g=g==null?void 0:(g=g.value)==null?void 0:g.regId;h=h==null?void 0:(h=h.value)==null?void 0:h.identityKeyPair;i=i==null?void 0:(i=i.value)==null?void 0:i.fbid;j=j==null?void 0:(j=j.value)==null?void 0:j.deviceId;k=k==null?void 0:k.value.registrationVersion;l=l==null?void 0:(l=l.value)==null?void 0:l.deviceRegUnixTime;a=a==null?void 0:(a=a.value)==null?void 0:(a=a.cat)==null?void 0:a.expiration_time_in_seconds;return{lastSignedPrekeyId:c,deviceUUID:e,lastSessionDeviceWasLinkedTo:f,regId:g,identityKeyPair:h,registrationUnixTime:l,fbid:i,deviceId:j,registrationVersion:k,identityCompareResult:b,catExpiryUnixTime:a!=null?d("WATimeUtils").castToUnixTime(a):void 0}},d("WASignalDB").signalOp("getRegistrationInfo"))}function b(){return d("WASignalDB").getDb().runInTransaction(["plaintextMeta"],"readonly",function(a){return a.stores.plaintextMeta.get(d("WADbSignal").PlainTextMetaKeysEnum.registrationHistory).then(function(a){return a==null?void 0:a.value.registrationHistory})},"getRegistrationHistory")}var i=10;function c(a){return d("WASignalDB").getDb().runInTransaction(["plaintextMeta"],"readwrite",function(b){return b.stores.plaintextMeta.get(d("WADbSignal").PlainTextMetaKeysEnum.registrationHistory).then(function(c){var e=d("WATimeUtils").unixTime();c=c==null?void 0:c.value.registrationHistory;if(c==null&&a==null)return;if(a!=null){var f;f=[].concat((f=c)!=null?f:[],[{deviceRegTime:a,lastActivityTime:e}])}else{c=c;if(c.length===0){d("WALogger").ERROR(h());return}var g=c[c.length-1];f=[].concat(c.slice(0,-1),[babelHelpers.extends({},g,{lastActivityTime:e})])}return b.stores.plaintextMeta.bulkPut([{key:d("WADbSignal").PlainTextMetaKeysEnum.registrationHistory,value:{registrationHistory:f.slice(-i)}}])})},"updateRegistrationHistory")}g.getRegistrationInfo=a;g.getRegistrationHistory=b;g.updateRegistrationHistory=c}),98);
__d("WASignedKeyApi",["WASignalDB"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return d("WASignalDB").getDb().runInTransaction(["signedPrekey"],"readonly",function(b){return b.stores.signedPrekey.get(a)},d("WASignalDB").signalOp("getSignedKey"))}g.getSignedKey=a}),98);
__d("MAWDeviceRegistrationActions",["MAWLoggerUtils","MAWODSProxy","MWFBLogger","MessengerWebInitData","WADbSignal","WAGetRegistrationInfoApi","WAOdsEnums","WASignedKeyApi"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": signedPrekey}"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["[Device Registration Meta Check] Device Id should be a number"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["MAWDeviceRegistrationActions: sessionId is null"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["",": ",""]);o=function(){return a};return a}var p="Device registration meta is incomplete: ",q=d("MWFBLogger").MWLogger.tags([d("MAWLoggerUtils").Tag.DeviceRegistration]);function r(a,b,c,e,f){(a!=null||b!=null||c!=null||e!=null||f!=null)&&(a==null&&q.MUSTFIX(o(),p,d("WADbSignal").MetaKeysEnum.lastSignedPrekeyId),b==null&&q.MUSTFIX(n(),p,d("WADbSignal").MetaKeysEnum.deviceUUID),c==null&&q.MUSTFIX(m(),p,d("WADbSignal").MetaKeysEnum.regId),e==null&&q.MUSTFIX(l(),p,d("WADbSignal").MetaKeysEnum.identityKeyPair),f==null&&q.MUSTFIX(k(),p,d("WADbSignal").MetaKeysEnum.fbid))}async function a(){var a=await d("WAGetRegistrationInfoApi").getRegistrationInfo(),b=a.deviceId,e=a.deviceUUID,f=a.fbid,g=a.identityCompareResult,k=a.identityKeyPair,l=a.lastSessionDeviceWasLinkedTo,m=a.lastSignedPrekeyId,n=a.regId,o=a.registrationUnixTime;a=a.registrationVersion;g||d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.COMPARE_IDENTITY,key:"meta_identity_mismatch"});if(m==null||e==null||n==null||k==null||f==null){r(m,e,n,k,f);return null}c("MessengerWebInitData").sessionId==null&&q.MUSTFIX(j());if(b!=null&&typeof b!=="number"){q.MUSTFIX(i());return null}f=await d("WASignedKeyApi").getSignedKey(m);if(f==null){q.MUSTFIX(h(),p);return null}return{deviceId:b,deviceUUID:e,identityCompareResult:g,lastSessionDeviceWasLinkedTo:l,lastSignedPrekeyId:m,registrationUnixTime:o,registrationVersion:a!=null?a:void 0,signalRegInfo:{identityKeyPair:k,regId:n,signedPreKey:f}}}g.getRegistrationMetaWorm=a}),98);
__d("MAWDeviceRegistrationODSBump",["MAWCurrentUser","MAWODSProxy","WAOdsEnums"],(function(a,b,c,d,e,f,g){"use strict";function a(a){d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.DEVICE_REGISTRATION,key:a}),d("MAWCurrentUser").isEmployee()||d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.DEVICE_REGISTRATION_NON_EMPLOYEE,key:a})}g["default"]=a}),98);
__d("XArmadilloWebLinkDeviceToSessionControllerRouteBuilder",["jsRouteBuilder"],(function(a,b,c,d,e,f,g){a=c("jsRouteBuilder")("/messenger/armadillo/link_device/",Object.freeze({}),void 0);b=a;g["default"]=b}),98);
__d("MAWDeviceRegistrationSessionUtil",["CSRFGuard","CurrentMessengerUser","DTSG","DTSGUtils","MAWLoggerUtils","MWFBLogger","PHPQuerySerializer","SprinkleConfig","WAAPI","WAWorkerGlobalScope","XArmadilloWebLinkDeviceToSessionControllerRouteBuilder"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["fetch result is not succesful"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["LinkDeviceToTheSession success"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Parse response error"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Fetch is not 200: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Fetch error, fetch defined: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["DeviceUUID is null"]);n=function(){return a};return a}var o=d("MWFBLogger").MWLogger.tags([d("MAWLoggerUtils").Tag.DeviceRegistration,"LinkDeviceToTheSession"]);async function a(a,b){var e;e=(e=d("WAWorkerGlobalScope").workerGlobalScope.location)==null?void 0:e.origin;if(e==null||e==="")return;if(d("CurrentMessengerUser").isTestUser()&&e.includes("twshared"))return;if(a==null){o.MUSTFIX(n());return}e=new URL(e).hostname;e=(e=c("XArmadilloWebLinkDeviceToSessionControllerRouteBuilder").buildUri({}).setDomain(e))==null?void 0:(e=e.setProtocol("https"))==null?void 0:e.toString();if(e==null)return;var f=d("DTSG").getToken();if(f==null)return;a={device_id:a,fb_dtsg:f};c("SprinkleConfig").param_name&&(a[c("SprinkleConfig").param_name]=c("DTSGUtils").getNumericValue(f));f=d("WAWorkerGlobalScope").workerGlobalScope.fetch;var g;try{g=await f(e,{body:(h||(h=c("PHPQuerySerializer"))).serialize(a),headers:{"Content-Type":"application/x-www-form-urlencoded"},method:"POST",redirect:"error"})}catch(a){o.catching(a).MUSTFIX(m(),f!=null);return}if(!g.ok){o.MUSTFIX(l(),g.status);return}e=await g.text();d("CSRFGuard").exists(e)&&(e=d("CSRFGuard").clean(e));var p;try{p=JSON.parse(e)}catch(a){o.catching(a).MUSTFIX(k());return}((a=p)==null?void 0:a.success)===!0?(o.DEBUG(j()),await c("WAAPI").saveLastSessionDeviceWasLinkedTo({sessionId:b})):o.WARN(i())}g.linkDeviceToTheSession=a}),98);
__d("WAPreRegistrationCrypto",["WACryptoManager","WASignalSignatures","err"],(function(a,b,c,d,e,f,g){"use strict";async function a(){var a=await d("WACryptoManager").generateRegistrationInfo(),b=a.regId,c=a.staticKeyPair;a=a.authKeyPair;var e=Date.now();e=await d("WASignalSignatures").generateSignedPreKey(1,e,c);var f=e.plainObject;e=e.record;return{regId:b,identityKeyPair:c,authKeyPair:a,signedPreKey:{keyId:f.id,encoded:e}}}function b(a){var b=d("WASignalSignatures").deserializeSignedPreKey(a.signedPreKey.encoded);if(b==null||b.id!==a.signedPreKey.keyId)throw c("err")("Badly formatted signed prekey");return{regId:a.regId,identityPubKeyType:5,identityPubKey:a.identityKeyPair.publicKey,signedPreKey:b}}g.makeRegistrationData=a;g.serializeRegistrationData=b}),98);
__d("MAWDeviceRegistrationUtilWorker",["FBLogger","MAWConstants","MAWCurrentUser","URI","WABase64","WADbDeviceRegistration","WAPreRegistrationCrypto","WATimeUtils","WAWorkerGlobalScope","gkx","qex","uuidv4"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a,b){var c=new Uint8Array(b);a=a;for(b=b-1|0;b>=0;--b)c[b]=a&255,a=a>>>8;return c}function j(a,b,c,e,f,g,h,j,k){var l;f=(l=d("WABase64")).encodeB64(i(f,4));g=l.encodeB64(i(g,1));h=l.encodeB64(h);var m=l.encodeB64(i(j.id,3)),n=l.encodeB64(j.keyPair.publicKey);l=l.encodeB64(j.signature);j=new Map().set("fbid",a).set("fb_cat",b).set("app_id",c).set("device_id",e).set("e_regid",f).set("e_keytype",g).set("e_ident",h).set("e_skey_id",m).set("e_skey_val",n).set("e_skey_sig",l);if(k){a=d("WABase64").encodeB64(k.signedICDCIdentityList);b=d("WABase64").encodeB64(k.ihash);j.set("icdc_list",a).set("icdc_ts",k.ts).set("icdc_seq",k.seq).set("ihash",b)}return j}function k(a){var b=[];a.forEach(function(a,c,d){b.push(encodeURIComponent(c)+("="+encodeURIComponent(a.toString())))});return b.join("&")}async function l(a,b){b=await d("WAWorkerGlobalScope").workerGlobalScope.fetch(b,{body:a,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},method:"POST",priority:c("qex")._("4183")?"high":"auto"});return await b.json()}async function m(a,b,e){b=await d("WAWorkerGlobalScope").workerGlobalScope.fetch(b,{body:a,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},method:"POST",priority:c("qex")._("4183")?"high":"auto",signal:e});return b.json()}function n(){var a=new(h||(h=c("URI")))(p()+d("WADbDeviceRegistration").ICDC_ENDPOINT);return a.toString()}async function o(a){var b=n();a=await l(a,b);if(a==null)throw c("FBLogger")("messenger_web").mustfixThrow(d("WADbDeviceRegistration").NULL_RESPONSE_FROM_SERVER);if(a.status!==200)throw c("FBLogger")("messenger_web").mustfixThrow("WA Server returned status code "+a.status+" while attempting device registration");return a}function p(){var a=Number(d("MAWCurrentUser").getAppID()),b=d("WADbDeviceRegistration").REG_FB_DOMAIN;switch(a){case 1217981644879628:case 936619743392459:case 487152425211411:case 1035956773910536:b=d("WADbDeviceRegistration").REG_IGD_DOMAIN;break;case 772021112871879:b=d("WADbDeviceRegistration").REG_MSGR_DOMAIN;break;default:b=d("WADbDeviceRegistration").REG_FB_DOMAIN}return b}function q(){var a=new(h||(h=c("URI")))(p()+d("WADbDeviceRegistration").REGISTRATION_ENDPOINT);return a.toString()}var r=new Set(["www.facebook.com","intern.facebook.com","web.facebook.com","www.instagram.com","www.messenger.com"]);function s(){if(c("gkx")("2456")){var a=d("WAWorkerGlobalScope").workerGlobalScope.location.hostname;r.has(a)||c("FBLogger")("bt","device_registration").warn("Invalid subdomain for device registration: %s",a)}}async function t(a){var b=q();s();var e;try{e=await m(a,b)}catch(a){throw c("FBLogger")("messenger_web").mustfixThrow("Post request failed: "+(a==null?void 0:a.message)+" url:"+b)}if(e==null)throw c("FBLogger")("messenger_web").mustfixThrow(d("WADbDeviceRegistration").NULL_RESPONSE_FROM_SERVER);if(e.status!==200){c("FBLogger")("messenger_web").warn("WA Server returned status code %s %s while attempting device registration",e.status,(a=e.message)!=null?a:"");return{message:(b=e.message)!=null?b:"Empty message",status:e.status,success:!1}}if(typeof e.wa_device_id!=="number")throw c("FBLogger")("messenger_web").mustfixThrow("Device ID from WA Server was not a number");if(typeof e.product!=="string")throw c("FBLogger")("messenger_web").mustfixThrow("Product info from WA Server was not a string");return{edge_routing_info:e.edge_routing_info,icdc_success:e.icdc_success,product:e.product,status:200,success:!0,type:e.type,wa_device_id:e.wa_device_id}}function a(a,b,c,d){a=new Map().set("fbid",a).set("fb_cat",b).set("app_id",c).set("device_id",d);b=k(a);return o(b)}function b(a,b,c,d,e,f,g,h,i){a=j(a,b,c,d,e,f,g,h,i);b=k(a);return t(b)}async function e(){var a=await d("WAPreRegistrationCrypto").makeRegistrationData();return{deviceUUID:c("uuidv4")(),lastSignedPrekeyId:a.signedPreKey.keyId,registrationUnixTime:d("WATimeUtils").unixTime(),registrationVersion:d("MAWConstants").CURRENT_REGISTRATION_VERSION,signalRegInfo:a}}g.getRegistrationEndpoint=q;g.fetchICDC=a;g.register=b;g.createNewRegistrationMeta=e}),98);
__d("WAIdentityApiV2",["WASignalDB"],(function(a,b,c,d,e,f,g){"use strict";a=function(a){return d("WASignalDB").getDb().runInTransaction(["identity"],"readwrite",function(b){return b.stores.identity.bulkPut([a])},d("WASignalDB").signalOp("saveIdentity"))};g.saveIdentity=a}),98);
__d("WAMockServerShell",["cr:8600"],(function(a,b,c,d,e,f,g){"use strict";a=b("cr:8600")!=null;g.isMockServerMode=a;g.getMockServer=b("cr:8600")}),98);
__d("MAWDeviceRegistrationWorker",["IGDWebUtils","MAWClearSignalAndTempStores","MAWCryptoAuthTokenWrapper","MAWCurrentUser","MAWDeviceRegistrationActions","MAWDeviceRegistrationODSBump","MAWDeviceRegistrationSessionUtil","MAWDeviceRegistrationUtilWorker","MAWJids","MAWLoggerUtils","MAWODSProxy","MAWQplProxy","MWFBLogger","MessengerWebInitData","UserAgentData","WADbDeviceRegistration","WADbMetaTxnsV2","WADbRegistrationApiV2","WAGetSafeQPLError","WAICDCUtils","WAIdentityApiV2","WAIdentityUtils","WAJids","WAMockServerShell","WAOdsEnums","WAPreRegistrationCrypto","WASignalKeys","WATimeUtils","cr:7755","promiseDone","qpl"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Device registration failure - ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Skipping device registration"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Crypto Auth Token was null or incomplete"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot process ICDC payload during registration"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Beginning device registration"]);m=function(){return a};return a}var n=d("MWFBLogger").MWLogger.tags([d("MAWLoggerUtils").Tag.DeviceRegistration]),o=function(){return d("IGDWebUtils").isInstagramWebSupportedApp(Number(d("MAWCurrentUser").getAppID()))};function p(a){switch(a){case 1217981644879628:case 936619743392459:case 487152425211411:case 1035956773910536:return"instagram.com";case 772021112871879:return"messenger.com";case 2220391788200892:return"facebook.com";default:return"unknown"}}function q(a,b){b===void 0&&(b=400);return{message:a,registrationState:{type:d("WADbDeviceRegistration").RegistrationStatesEnum.failed},status:b}}async function r(a,b,e){function f(a){b.addPoint(a),e!=null&&d("MAWQplProxy").sendQplPointThroughBridge(e,"device_registration_"+a)}n.DEBUG(m());var g=await d("MAWDeviceRegistrationUtilWorker").createNewRegistrationMeta();f("registration_created");b.addAnnotations({string:{unique_device_id:g.deviceUUID}});await d("WADbRegistrationApiV2").saveRegistrationMeta(d("MAWCurrentUser").getID(),g);f("registration_saved");var h=d("MAWCurrentUser").getID(),i=g.deviceUUID,j=d("WAPreRegistrationCrypto").serializeRegistrationData(g.signalRegInfo),k=null,p=!1;p=(p=p?1019394685547802:d("MAWCurrentUser").getAppID())==null?void 0:p.toString();if(p==null)return q("appId is null, cannot register to WhatsApp");if(h==="0")return q(d("WADbDeviceRegistration").DEVICE_REGISTER_ERROR_ZERO_AS_USER_ID);var r=null,s=null;try{var t=await d("MAWDeviceRegistrationUtilWorker").fetchICDC(h,a.encrypted_serialized_cat,p,i);f("icdc_fetched");var u=[].concat(d("WAICDCUtils").base64DeviceIdentitiesToSerializedPubKeys(t.device_identities));if(t.curr_identity_idx!=null){var v=t.curr_identity_idx;u[v]=d("WASignalKeys").serializeIdentity(j.identityPubKey)}else u.push(d("WASignalKeys").serializeIdentity(j.identityPubKey));r=d("WAICDCUtils").computeICDCInfoForUpload(g.signalRegInfo.identityKeyPair,t.icdc_seq,u,"registration","registration");s=await d("WAIdentityUtils").computeIdentitiesHash(u);f("identities_computed")}catch(a){n.catching(a).MUSTFIX(l())}v=!1;try{t=await d("MAWDeviceRegistrationUtilWorker").register(h,a.encrypted_serialized_cat,p,i,j.regId,j.identityPubKeyType,j.identityPubKey,j.signedPreKey,r&&s?{ihash:s,seq:r.icdcInfo.seq,signedICDCIdentityList:r.encodedSignedICDC,ts:r.icdcInfo.timestamp}:null);f("device_registered");u=t==null?void 0:t.type;u!=null&&d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.REGISTRATION_TYPE,key:u});if(!t||!(t==null?void 0:t.success)){return{message:(a=t==null?void 0:t.message)!=null?a:d("WADbDeviceRegistration").NULL_RESPONSE_FROM_SERVER,registrationState:{type:d("WADbDeviceRegistration").RegistrationStatesEnum.failed},status:(p=t==null?void 0:t.status)!=null?p:"400"}}k=t.wa_device_id;v=(j=t.icdc_success)!=null?j:!1}catch(a){return q(d("WAGetSafeQPLError").getSafeQPLErrorMessage(a))}if(k==null)return q(d("WADbDeviceRegistration").NULL_RESPONSE_FROM_SERVER);s=d("MAWJids").toUserJid(h);if(!o()){f=c("MessengerWebInitData").sessionId;f!=null&&c("promiseDone")(d("MAWDeviceRegistrationSessionUtil").linkDeviceToTheSession(i,f))}if(r!=null&&v){u=r.icdcInfo;await d("WADbRegistrationApiV2").saveICDC(s,{devices:u.devices,dirty:!0,sequence:u.seq,signingDeviceIndex:u.signingDeviceIndex,timestamp:u.timestamp});b.addPoint("icdc_saved")}await d("WADbRegistrationApiV2").saveDeviceId(k);b.addPoint("device_saved");a={deviceJid:d("WAJids").toDeviceJid(s,k),identity:d("WASignalKeys").serializeIdentity(g.signalRegInfo.identityKeyPair.publicKey),userJid:s};await d("WAIdentityApiV2").saveIdentity(a);b.addPoint("identity_saved");return{message:d("WADbDeviceRegistration").DEVICE_SUCCESSFULLY_REGISTERED,registrationState:{registrationTime:g.registrationUnixTime,type:d("WADbDeviceRegistration").RegistrationStatesEnum.finished},status:200}}async function a(a,e){var f=d("MAWQplProxy").startQplUserFlow(c("qpl")._(25307273,"1410"),{string:{browser_name:c("UserAgentData").browserName,device_os:c("UserAgentData").platformName,device_os_version:c("UserAgentData").platformVersion,interface:p(Number(d("MAWCurrentUser").getAppID()))}},{providedTimeoutInMs:2e4}),g=function(a,b){return d("MAWQplProxy").measurePerfInQPL(f,a,b)};try{e=(e=e)!=null?e:d("MAWCryptoAuthTokenWrapper").getCryptoAuthToken();if(e==null||e.encrypted_serialized_cat===""){n.WARN(k());f.endFail("empty_cat_token");return q(d("WADbDeviceRegistration").DEVICE_REGISTER_ERROR_EMPTY_CAT_TOKEN,414)}a!=null&&d("MAWQplProxy").sendQPLAnnotationsThroughBridge(a,{int:{secondsUntilCATExpiration:Math.floor(e.expiration_time_in_seconds-Date.now()/1e3)}});if(!d("WATimeUtils").isInFuture(d("WATimeUtils").castToUnixTime(e.expiration_time_in_seconds))){f.endFail("expired_cat_token");return q(d("WADbDeviceRegistration").DEVICE_REGISTER_ERROR_EXPIRED_CAT_TOKEN,413)}if(d("WAMockServerShell").isMockServerMode){var h=await d("MAWDeviceRegistrationUtilWorker").createNewRegistrationMeta();await Promise.all([d("WADbRegistrationApiV2").saveRegistrationMeta(d("MAWCurrentUser").getID(),h),d("WADbRegistrationApiV2").saveDeviceId(d("WAJids").interpretAsDeviceId(1)),d("WADbMetaTxnsV2").saveCAT(e)]);f.addPoint("wa_device_registration_mock_server");f.endSuccess();return{message:"Skipping registration because of Mock Server",registrationState:{registrationTime:h.registrationUnixTime,type:d("WADbDeviceRegistration").RegistrationStatesEnum.finished},status:200}}b("cr:7755")!=null&&await b("cr:7755").updateRegDataFromLocalStorage();h=d("MAWDeviceRegistrationActions").getRegistrationMetaWorm();h=await g("get_registration_data",h);f.addAnnotations({string:{unique_device_id:h==null?void 0:h.deviceUUID}});a!=null&&d("MAWQplProxy").sendQplPointThroughBridge(a,"device_registration_check",{annotations:{bool:{identityCompareResult:h==null?void 0:h.identityCompareResult},int:{registrationVersion:h==null?void 0:h.registrationVersion}}});var i=(h==null?void 0:h.identityCompareResult)===!1;if(h==null||h.deviceId==null||i){f.addAnnotations({bool:{isNewRegistartion:!0}});a!=null&&d("MAWQplProxy").sendQplPointThroughBridge(a,"device_registration_new_reg_start");try{await g("clear_signal_stores",d("MAWClearSignalAndTempStores").clearSignalAndTempStores()),a!=null&&d("MAWQplProxy").sendQplPointThroughBridge(a,"device_registration_signal_temp_stores_cleared"),await g("save_cat",d("WADbMetaTxnsV2").saveCAT(e)),a!=null&&d("MAWQplProxy").sendQplPointThroughBridge(a,"device_registration_cat_saved")}catch(a){return q(d("WAGetSafeQPLError").getSafeQPLErrorMessage(a))}i=await g("try_register",r(e,f,a));i.registrationState.type===d("WADbDeviceRegistration").RegistrationStatesEnum.failed?f.endFail("wa_device_registration_failed",{string:{errorMsg:i.message}}):(f.addPoint("wa_device_registration_successful"),f.endSuccess());a!=null&&d("MAWQplProxy").sendQplPointThroughBridge(a,"device_registration_new_reg_end");return i}else{f.addAnnotations({bool:{isNewRegistartion:!1}});a!=null&&d("MAWQplProxy").sendQplPointThroughBridge(a,"device_registration_existing_reg_start");await g("save_cat",d("WADbMetaTxnsV2").saveCAT(e));i=c("MessengerWebInitData").sessionId;g=h.lastSessionDeviceWasLinkedTo==null||h.lastSessionDeviceWasLinkedTo!==i;i!=null&&!(h.deviceUUID===i||h.deviceUUID.startsWith(i+"-"))&&g&&!o()&&c("promiseDone")(d("MAWDeviceRegistrationSessionUtil").linkDeviceToTheSession(h.deviceUUID,i));a!=null&&d("MAWQplProxy").sendQplPointThroughBridge(a,"device_registration_existing_reg_end")}c("MAWDeviceRegistrationODSBump")("already_registered");f.addPoint("wa_device_registration_persisted");f.endSuccess();n.DEBUG(j());return{message:d("WADbDeviceRegistration").DEVICE_ALREADY_REGISTERED,registrationState:{type:d("WADbDeviceRegistration").RegistrationStatesEnum.finished},status:200}}catch(a){f.endFail("uncaught_exception",{string:{errorMsg:(e=a==null?void 0:a.message)!=null?e:"No error message"}});throw a}}function e(a){c("MAWDeviceRegistrationODSBump")("fail");n.MUSTFIX(i(),d("WADbDeviceRegistration").FAILED_REGISTRATION_RETRIES);for(a of a)n.MUSTFIX(h(),a)}g.handleRegistrationError=q;g.setupDeviceRegistration=a;g.logDeviceRegistrationRetryFailure=e}),98);
__d("MAWFbCat",["FBLogger"],(function(a,b,c,d,e,f,g){"use strict";var h=null;function a(a){h=a}function b(){if(h==null)throw c("FBLogger")("messenger_web").mustfixThrow("FBCat is not set");return h}g.setFbCat=a;g.getFbCat=b}),98);
__d("MAWRotateCAT",["FBLogger","MAWBridge","MAWCatQuery.graphql","MAWCryptoAuthToken","MAWFbCat","MAWODSProxy","MAWQplProxy","WAArrayBufferUtils","WADbDeviceRegistration","WADbMetaTxnsV2","WALogger","WAOdsEnums","WAPromiseRetryLoop","WARetryUtils","createWorkerQuery","getErrorSafe","gkx","qex","qpl","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Rotate CAT finished, ending rotate CAT promise retry loop"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unable to rotate CAT"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["[MAWRotateCAT] Got an error while attempting to rotate CAT: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["CAT Finished Rotating"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Starting rotate CAT Task Bridge event"]);l=function(){return a};return a}var m=c("requireDeferred")("WorkerRelayNetwork").__setRef("MAWRotateCAT"),n=c("qpl")._(1056847537,"2667"),o=0,p=function(){return c("qex")._("4299")};function q(a){var b=a.initiator;a=a.qplAnnotations;o++;var e=d("MAWQplProxy").startQplUserFlow(n,{int:babelHelpers.extends({},a.int,{totalRotationCounter:o}),string:babelHelpers.extends({},a.string,{initiator:b})});d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.CAT_ROTATION,key:"rotateCAT"});d("WALogger").LOG(l());c("gkx")("8216")?(e.addAnnotations({string:{fetchFrom:"worker"}}),a=s(e).catch(function(a){if(p()){e.addPoint("fallback_to_ui");return t().catch(function(b){b=c("getErrorSafe")(b);e.addPoint("fallback_error",{string:{errorDescriptionUI:b.message}});return Promise.reject(a)})}return Promise.reject(a)})):(e.addAnnotations({string:{fetchFrom:"tab"}}),a=t());return a.then(function(a){if(!a){e.addPoint("no_valid_result");throw c("FBLogger")("messenger_web").mustfixThrow("CAT Rotation failed: no valid result")}return d("WADbMetaTxnsV2").saveCAT(a)}).then(function(a){e.addPoint("set_fb_cat");d("MAWFbCat").setFbCat(d("WAArrayBufferUtils").stringToArrayBuffer(a.encrypted_serialized_cat));d("WALogger").LOG(k());e.endSuccess();return a}).catch(function(a){a=c("getErrorSafe")(a);d("WALogger").ERROR(j(),a);e.endFail("error",{string:{errorDescription:a.message}});return null})}var r=null;function a(a){var b;if(r!=null)return r.promise();var e=(b=a==null?void 0:a.retries)!=null?b:d("WADbDeviceRegistration").MAX_ROTATE_CRYPTO_AUTH_TOKEN_RETRIES,f=0;b=new(d("WAPromiseRetryLoop").PromiseRetryLoop)({code:async function(b){var g;if(f===e){d("WALogger").COUNT(i());throw c("FBLogger")("messenger_web").mustfixThrow("Unable to rotate CAT")}g=await q({initiator:"MAWRotateCAT::tryRotateCAT",qplAnnotations:{int:babelHelpers.extends({},(g=a.qplAnnotations)==null?void 0:g.int,{retryLoopAllowedRetries:e,retryLoopZeroBasedIteration:f}),string:babelHelpers.extends({},(g=a.qplAnnotations)==null?void 0:g.string,{retryLoopInitiator:a.initiator})}});g!=null&&(d("WALogger").LOG(h()),b());f++},name:"rotateCAT",timer:d("WARetryUtils").fibonacciBackoff(!0)});b.start();b.promise().finally(function(){r=null});r=b;return b.promise()}async function s(a){p()&&await m.load().then(function(a){a=a.createWorkerNetworkExecute;a()});return c("createWorkerQuery")(c("MAWCatQuery.graphql"),{},{onExecute:function(){a.addPoint("query_executed")},onResponse:function(b){a.addPoint("response_received",{bool:{response_is_array:Array.isArray(b),response_is_null:b===null},int:{response_array_size:Array.isArray(b)?b.length:void 0},string:{response_type:typeof b}});if(typeof b==="object"){b=Array.isArray(b)?b[0]:b;b!=null&&a.addAnnotations({string:{response_payload:JSON.stringify(b.payload)},string_array:{response_keys:Object.keys(b)}})}}}).then(function(a){return d("MAWCryptoAuthToken").processCatResponse(a)}).then(function(a){if(a.error!=null)throw c("FBLogger")("messenger_web").mustfixThrow(a.error);return a.success})}async function t(){await d("MAWQplProxy").workerBridgeDeferred.getPromise();return d("MAWBridge").getBridge().sendAndReceive("event","rotateCryptoAuthToken",{})}g.rotateCAT=q;g.tryRotateCAT=a}),98);
__d("MAWDeviceRegistrationInitWorker",["BackendInitLoggingUtils","BrowserLockManager","FBLogger","MAWDeviceRegistrationODSBump","MAWDeviceRegistrationWorker","MAWHMACKey","MAWLoggerUtils","MAWQplProxy","MAWRotateCAT","WADbDeviceRegistration","WADbRegistrationApiV2","WAGetRegistrationInfoApi","WALogger","WAPromiseRetryLoop","WARetryUtils","WATagsLogger","justknobx","memoizeOneWithArgs","promiseDone","qex","qpl","shouldUseMAWSharedWorker"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Registration finished, ending device registration promise retry loop"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["DeviceRegistration 500: Retry is needed"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["DeviceRegistration 403: User is banned"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["DeviceRegistration 415: User should take action to  re-register to WAI"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["DeviceRegistration ",": User should re-login"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["DeviceRegistration ",". Rotate CAT"]);n=function(){return a};return a}function a(){var a;a=(a=d("shouldUseMAWSharedWorker").shouldUseMAWSharedWorker()&&c("qex")._("4242"))!=null?a:!1;return c("BrowserLockManager")!=null&&!a?d("BackendInitLoggingUtils").measureMawInit("request_maw_registration_lock",function(){return new Promise(function(a,b){c("promiseDone")(c("BrowserLockManager").request("maw_registration_lock",async function(){try{var c=await o();a(c)}catch(a){b(a)}}))})}):o()}var o=c("memoizeOneWithArgs")(async function(){var a=await d("BackendInitLoggingUtils").measureMawInit("init_device_reg_overall",function(){return p()}),b=a.message;a=a.registrationState;if(a===d("WADbDeviceRegistration").RegistrationStatesEnum.failed)throw c("FBLogger")("messenger_web").mustfixThrow("registration_failed: "+b);a=await Promise.all([d("BackendInitLoggingUtils").measureMawInit("load_reg_in_txn",function(){return d("WADbRegistrationApiV2").loadAllRegistrationMetaInTransaction()}),d("BackendInitLoggingUtils").measureMawInit("gen_insert_hmac",function(){return d("MAWHMACKey").generateAndInsertHMACKey()})]);b=a[0];a=a[1];return{hmacKey:a,regData:b}});function p(){var a=0,b=new Set(),e=0,f=new(d("WAPromiseRetryLoop").PromiseRetryLoop)({code:async function(f){a++;if(a>d("WADbDeviceRegistration").MAX_DEVICE_REGISTRATION_RETRIES){d("MAWDeviceRegistrationWorker").logDeviceRegistrationRetryFailure(b);var g=d("MAWDeviceRegistrationWorker").handleRegistrationError(d("WADbDeviceRegistration").FAILED_REGISTRATION_RETRIES);f(g);return}try{g=null;switch(e){case 414:case 413:case 418:d("WALogger").LOG(n(),e);g=await d("MAWRotateCAT").rotateCAT({initiator:"MAWDeviceRegistrationInitWorker::initDeviceRegistration",qplAnnotations:{int:{prevStatusCode:e}}});break;case 400:case 401:d("WALogger").ERROR(m(),e);c("justknobx")._("3526")&&(g=await d("MAWRotateCAT").rotateCAT({initiator:"MAWDeviceRegistrationInitWorker::initDeviceRegistration",qplAnnotations:{int:{prevStatusCode:e}}}));break;case 415:d("WALogger").ERROR(l());break;case 403:d("WALogger").ERROR(k());break;case 500:d("WALogger").EXPECTED_ERROR(j());break}var o=a===1?c("qpl")._(25310776,"6155"):null;o=await d("MAWDeviceRegistrationWorker").setupDeviceRegistration(o,g);e=o.status;c("MAWDeviceRegistrationODSBump")("attempt."+a+".result."+o.registrationState.type);o.registrationState.type===d("WADbDeviceRegistration").RegistrationStatesEnum.finished&&(o.registrationState.registrationTime!=null&&c("MAWDeviceRegistrationODSBump")("success"),d("WALogger").LOG(i()),f(o));b.add(o.message);d("MAWQplProxy").sendQPLAnnotationsThroughBridge(c("qpl")._(25310776,"6155"),{int:{deviceRegistrationLastAttemptCount:a},string:{deviceRegistrationLastAttemptMessages:Array.from(b).join(", ")}})}catch(e){g="Uncaught device registration error - "+e;d("WATagsLogger").TAGS([d("MAWLoggerUtils").Tag.DeviceRegistration]).WARN(h(),g);b.add(""+g);d("MAWQplProxy").sendQPLAnnotationsThroughBridge(c("qpl")._(25310776,"6155"),{int:{deviceRegistrationLastAttemptCount:a},string:{deviceRegistrationLastAttemptMessages:Array.from(b).join(", ")}})}},name:"deviceRegistration",timer:d("WARetryUtils").fibonacciBackoff(!0)});f.start();return f.promise().then(function(a){a.registrationState.type===d("WADbDeviceRegistration").RegistrationStatesEnum.finished&&c("promiseDone")(d("WAGetRegistrationInfoApi").updateRegistrationHistory(a.registrationState.registrationTime));return a})}g.registerDevice=a;g.performDeviceRegistration=o;g.initDeviceRegistration=p}),98);
__d("MAWGetDownloadableThumbnailForMediaApi",["MAWOptimisticUploadManager","WALogger","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["GetDownloadableThumbnail - previewEntry optimistedPromise rejected with ",""]);h=function(){return a};return a}a=async function(a){a=d("MAWOptimisticUploadManager").getOptimisticUploadManager().get(a);if(a==null)return null;a=a.previewPlaintextHash;if(a==null)return null;a=d("MAWOptimisticUploadManager").getOptimisticUploadManager().get(a);if(a==null)return null;a=await ((a=a.optimisticUploadPromise)==null?void 0:a.catch(function(a){d("WALogger").ERROR(h(),a);return d("WAResultOrError").makeError("runtime-error")}));if(a==null||a.success!==!0)return null;a=a.value;var b=a.directPath,c=a.fileEncSha256,e=a.fileSha256,f=a.mediaKey,g=a.mediaKeyTimestamp;a=a.objectId;return{directPath:b,fileEncSha256:c,fileSha256:e,mediaKey:f,mediaKeyTimestamp:g,objectId:a}};g.getDownloadableThumbnailForMedia=a}),98);
__d("MAWGetMediaKnownEntriesApi",["MAWDbMediaTxns","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWTransactionMode","WAHashUtils","WAJids","WAMsgMap","WAResultOrError","WATagsLogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Message missing in messages table for given msgId for plaintextHash ",". Skipping..."]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["No existing media entry found for plaintextHash ",". Returning new MsgMap."]);i=function(){return a};return a}var j=d("WATagsLogger").TAGS(["GetMediaKnownEntries"]);a=d("MAWIndexedDb").makeMsgrTransactor({media:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READONLY},"getMediaKnownEntries",function(a){return function(b){return k(a,b)}});function k(a,b){return d("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(a,b).then(function(c){if(!c){j.LOG(i(),d("WAHashUtils").sanitisePlaintextHash(b));return d("WAResultOrError").makeError("no-media-entry-by-plaintext-hash")}var e=Array.from(c.mediaEntries.keys());return d("MAWDexieTable").dexieAll(e.map(function(b){return d("MAWDbMsgTxns").maybeGetMsgListByMsgId_I_KNOW_WHAT_I_AM_DOING(a,b)})).then(function(a){a=a.map(function(a){return a.find(function(a){return(a==null?void 0:a.mediaId)===c.mediaId})});var f=[];a=a.reduce(function(a,g,i){if(!g){j.WARN(h(),d("WAHashUtils").sanitisePlaintextHash(b));f.push(e[i]);return a}i=c.mediaEntries.get(g.msgId);var k=g.author,l=g.threadJid;i&&!d("WAJids").isAuthorSystem(k)&&l!=null&&a.set({author:k,chat:l,externalId:g.externalId},i);return a},new(d("WAMsgMap").MsgMap)());return{missingMessages:f,msgMap:a,numEntries:e.length}}).then(d("WAResultOrError").makeResult)})}g.getMediaKnownEntries=a;g.getMediaKnownEntriesTxn=k}),98);
__d("MAWGetMediaPlaintextApi",["MAWIndexedDb","MAWMediaUtils","MAWOptimisticUploadManager","MAWTransactionMode","Promise","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media blob does not exist for the given hashedPlaintextHash"]);i=function(){return a};return a}a=function(a){var c=d("MAWOptimisticUploadManager").getOptimisticUploadManager();c=c.get(a);if(c==null)return j(a);else return(h||(h=b("Promise"))).resolve(c.file)};function j(a){return d("MAWIndexedDb").makeMsgrTransactor({chunk:d("MAWTransactionMode").READONLY},"getMediaPlaintextFromDb",function(a){return function(b){b=d("MAWMediaUtils").genHMACPlaintextHash(b);return a.chunk.where("hashedPlaintextHash").equals(b).first().then(function(a){if(!a){d("WALogger").WARN(i());return null}return new Blob([a.blobData],{type:a.mimetype})})}})(a)}g.getMediaPlaintext=a}),98);
__d("MAWGetOrCreateMediaKnownEntriesApi",["MAWGetMediaKnownEntriesApi","MAWIndexedDb","MAWTransactionMode","WAMsgMap"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({media:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READONLY},"getOrCreateMediaKnownEntries",function(a){return function(b){return d("MAWGetMediaKnownEntriesApi").getMediaKnownEntriesTxn(a,b).then(function(a){if(a.success===!1)return new(d("WAMsgMap").MsgMap)();else return a.value.msgMap})}});g.getOrCreateMediaKnownEntries=a}),98);
__d("getProtocolMsgIdByMsgIdCommon",["MAWDexieTable","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return d("MAWDexieTable").dexieAll([a.messages.get({msgId:b}),a.unrenderedMessages.get({msgId:b}),a.reactions.get({reactionId:b})]).then(function(b){var c=b[0],e=b[1];b=b[2];if(b!=null)if(d("WAJids").isAuthorSystem(b.author))return null;else return{author:b.author,chat:b.threadJid,externalId:b.externalId};var f=c||e;return f==null?null:a.threads.get({jid:f.threadJid}).then(function(a){if(a==null)return null;return d("WAJids").isAuthorSystem(f.author)?null:{author:f.author,chat:a.jid,externalId:f.externalId}})})}g.getProtocolMsgIdByMsgIdCommon=a}),98);
__d("MAWGetProtocolMsgIdByMsgId",["MAWIndexedDb","MAWTransactionMode","getProtocolMsgIdByMsgIdCommon"],(function(a,b,c,d,e,f,g){"use strict";b=d("MAWIndexedDb").makeMsgrTransactor({messages:(a=d("MAWTransactionMode")).READONLY,reactions:a.READONLY,threads:a.READONLY,unrenderedMessages:a.READONLY},"getProtocolMsgByMsgId",function(a){return function(b){return d("getProtocolMsgIdByMsgIdCommon").getProtocolMsgIdByMsgIdCommon(a,b)}});g.getProtocolMsgIdByMsgId=b}),98);
__d("encryptedBackupsOptOutOfBackup",["LSEncryptedBackupsOpStatus","LSFactory","LSIntEnum","LSOptOutOfBackupStoredProcedure","LSResult","ReQL"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){return d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.tables.encrypted_backups)).then(function(b){if(b==null)return c("LSResult")((h||(h=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsOpStatus").FAILURE));var e=b.backupId;return e!=null?a.runInTransaction(function(a){return c("LSOptOutOfBackupStoredProcedure")(c("LSFactory")(a),{backupId:e})},"readwrite",void 0,void 0,f.id+":31"):c("LSResult")((h||(h=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsOpStatus").FAILURE))}).then(function(){return d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a.tables.secure_encrypted_backups_client_state).take(1))})}g.optOutOfBackupStoredProcedure=a}),98);
__d("WAStringz",[],(function(a,b,c,d,e,f){"use strict";var g=/\ud83c[\udffb-\udfff](?=\ud83c[\udffb-\udfff])|(?:[^\ud800-\udfff][\u0300-\u036f\ufe20-\ufe23\u20d0-\u20f0]?|[\u0300-\u036f\ufe20-\ufe23\u20d0-\u20f0]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff]|[\ud800-\udfff])[\ufe0e\ufe0f]?(?:[\u0300-\u036f\ufe20-\ufe23\u20d0-\u20f0]|\ud83c[\udffb-\udfff])?(?:\u200d(?:[^\ud800-\udfff]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff])[\ufe0e\ufe0f]?(?:[\u0300-\u036f\ufe20-\ufe23\u20d0-\u20f0]|\ud83c[\udffb-\udfff])?)*/g;function a(a){a=a.match(g);return a?a.length:0}function b(a,b,c){b===void 0&&(b=0);a=a.match(g);return!a?"":a.slice(Math.max(0,b),Math.max(0,c)).join("")}function c(a){return a.match(g)||[]}f.astralRange=g;f.length=a;f.substring=b;f.toArray=c}),66);
__d("WAUnicodeUtils",["WAStringz"],(function(a,b,c,d,e,f,g){"use strict";var h=5e3,i=.5;function a(a,b){return j(a||"",0,b)}function b(a){return d("WAStringz").length(a||"")}function j(a,b,c){if(a==null||a==="")return"";b=b||0;c=c==null?Infinity:c;if(b===0&&c===Infinity)return a;return a.length>=h&&c/a.length<=i?l(a,b,c):d("WAStringz").substring(a,b,c)}function k(a,b,c){a=a||"";b=b||0;c=c==null?Infinity:c;return a.length>=h&&c/a.length<=i?m(a,b,c):d("WAStringz").toArray(a).slice(b,c)}function c(a,b){b===void 0&&(b=0);if(a.codePointAt)return a.codePointAt(b);var c=a.charCodeAt(b);if(c>=55296&&c<=56319){a=a.charCodeAt(b+1);a>=56320&&a<=57343&&(c=65536+(c-55296<<10)+(a-56320))}return c}function e(a,b){if(b==null)return a;if(encodeURI(a).length<=b)return a;var c=0,d=k(a),e=d.length;for(var f=0;f<e;f++){var g=d[f];g=encodeURI(g).length;if(c+g>b)return j(a,0,f);c+=g}return a}function l(a,b,c){b=new RegExp(d("WAStringz").astralRange);var e="",f,g=0;do f=b.exec(a),f&&(e+=f[0]),g++;while(f&&g<c);return e}function m(a,b,c){b=new RegExp(d("WAStringz").astralRange);var e=[],f;do f=b.exec(a),f&&e.push(f[0]);while(f&&e.length<c);return e}g.firstNCodepoints=a;g.numCodepoints=b;g.substring=j;g.toArray=k;g.codePointAt=c;g.firstNEncodedBytes=e}),98);
__d("MAWStartMediaUploadQplFlow",["WAGetStorageQplAnnotations","WAJids","WAMediaQplHelper","WAPREList","WAPREMetrics","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.chatJid,e=a.fileSize,f=a.serverMediaType;a=a.uploadEntry;var g=d("WAPREMetrics").startMetric(d("WAPREList").PRE_METRIC.MEDIA_UPLOAD,{bool:{is_quick_media_send:c("gkx")("14382")},string:{chat_type:d("WAJids").switchOnMsgrChatJidType(b,{group:function(){return"group"},user:function(){return"user"}}),jid:b,media_size:d("WAMediaQplHelper").convertIntegerSizeToStringBucket(e),media_type:f,upload_entry:a}},void 0);c("promiseDone")(d("WAGetStorageQplAnnotations").getStorageQplAnnotations().then(function(a){g.addAnnotations(a)}));return g}g.startMediaUploadQplFlow=a}),98);
__d("MAWUpdateMediaEntryForOptimisticUploadApi",["FBLogger","MAWGetProtocolMsgIdByMsgId","MAWOptimisticUploadManager","MAWUpdateMediaEntryForMsgApi"],(function(a,b,c,d,e,f,g){"use strict";a=async function(a,b,e,f){var g=d("MAWOptimisticUploadManager").getOptimisticUploadManager(),h=g.get(a),i=h==null?void 0:h.msgId,j=b();if(i!=null){i=await d("MAWGetProtocolMsgIdByMsgId").getProtocolMsgIdByMsgId(i);i&&await d("MAWUpdateMediaEntryForMsgApi").updateMediaEntryForMsg(a,i,b,e,f)}else{if(!h)throw c("FBLogger")("messenger_web").mustfixThrow("Cannot update mediaEntry without both uploadEntry and msgId");g.set(a,babelHelpers.extends({},h,{mediaEntry:j}))}return};g.updateMediaEntryForOptimisticUpload=a}),98);
__d("MAWMediaSizeCheck",[],(function(a,b,c,d,e,f){"use strict";function a(a){return a>100*1024}f.isMinSizeForImagePreviewGeneration=a}),66);
__d("MAWUploadAndHandleMedia",["FBLogger","MAWMediaManager","WAAPI","WAResultOrError","gkx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["getDownloadableThumbnailForMedia unexpected runtime-erorr: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to enqueue upload full size: ",""]);i=function(){return a};return a}var j=c("FBLogger")("messenger_web_media");function a(a){var b=a.chatJid,d=a.dbCallbacks,e=a.filename,f=a.hash,g=a.mediaTypeDetails,h=a.plaintext,i=a.protocolMsgId,j=a.serverMediaType,l=a.size;a=a.uploadMediaMetric;if(c("gkx")("14382"))return k({chatJid:b,dbCallbacks:d,filename:e,hash:f,plaintext:h,protocolMsgId:i,serverMediaType:j,size:l,uploadMediaMetric:a});h=d.getDownloadableThumbnailForMedia;j=d.getMediaKnownEntries;var m=d.getMediaPlaintext,n=d.updateMediaEntryForMsg;d=d.updateMediaEntryForOptimisticUpload;return c("WAAPI").uploadMedia({chatJid:b,filename:e,getDownloadableThumbnailForMedia:h,getMediaKnownEntries:j,getMediaPlaintext:m,hash:f,mediaTypeDetails:g,protocolMsgId:i,size:l,updateMediaEntryForMsg:n,updateMediaEntryForOptimisticUpload:d,uploadMediaMetric:a})}async function k(a){a.chatJid;var b=a.dbCallbacks,c=a.filename,e=a.hash,f=a.plaintext,g=a.serverMediaType,k=a.size;a=a.uploadMediaMetric;f=await d("MAWMediaManager").getMawMediaManager().enqueueUploadFullSize({mediaUploadFlow:a,plaintext:f,plaintextHash:e,serverMediaType:g});if(f.success!==!0){j.WARN(i(),f.error);a.endFail(f.error);return f}g=await b.getDownloadableThumbnailForMedia(e).catch(function(a){j.catching(a).MUSTFIX(h(),a);return null});b=babelHelpers.extends({},f.value,{downloadableThumbnail:g,filename:c,size:k});a.endSuccess();return d("WAResultOrError").makeResult(b)}g.uploadAndHandleMedia=a}),98);
__d("MAWOptimisticUploadMedia",["MAWConfig","MAWFrontendMediaUtils","MAWGetDownloadableThumbnailForMediaApi","MAWGetMediaPlaintextApi","MAWGetOrCreateMediaKnownEntriesApi","MAWMediaSizeCheck","MAWMediaUtils","MAWOptimisticUploadManager","MAWStartMediaUploadQplFlow","MAWUpdateMediaEntryForMsgApi","MAWUpdateMediaEntryForOptimisticUploadApi","MAWUploadAndHandleMedia","MWFBLogger","WABlobToArrayBuffer","WAHashUtils","WAMediaCrypto","WAProgressiveJpegGetScanLengths","WAResultOrError","gkx"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Skipping preview upload for media type ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["fileUploadResult success, setting with previewPlaintextHash"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["previewUploadResult success"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["unsupported preview media type ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["preview uploading"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["thumbnail_exists: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["File is already being uploaded"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["fileUploadResult success"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["file uploading"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["start uploading type: ",""]);q=function(){return a};return a}var r=d("MWFBLogger").MWMediaLogger.tags(["OptimisticUploadMedia"]);async function s(a,b,c){r.DEBUG(q(),String(c));var e=await d("MAWMediaUtils").hashBlob(a);e=d("WAHashUtils").toPlaintextHash(e);var f=d("MAWOptimisticUploadManager").getOptimisticUploadManager();f=f.get(e);if(f!=null)return d("WAResultOrError").makeError("already_uploading");f=c.type==="regular"?c.mediaType:"preview";var g=await d("MAWStartMediaUploadQplFlow").startMediaUploadQplFlow({chatJid:b,fileSize:a.size,serverMediaType:f,uploadEntry:"optimisticUploadMedia"});b=d("MAWUploadAndHandleMedia").uploadAndHandleMedia({chatJid:b,dbCallbacks:{getDownloadableThumbnailForMedia:d("MAWGetDownloadableThumbnailForMediaApi").getDownloadableThumbnailForMedia,getMediaKnownEntries:d("MAWGetOrCreateMediaKnownEntriesApi").getOrCreateMediaKnownEntries,getMediaPlaintext:d("MAWGetMediaPlaintextApi").getMediaPlaintext,updateMediaEntryForMsg:d("MAWUpdateMediaEntryForMsgApi").updateMediaEntryForMsg,updateMediaEntryForOptimisticUpload:d("MAWUpdateMediaEntryForOptimisticUploadApi").updateMediaEntryForOptimisticUpload},filename:f==="document"?a.name:void 0,hash:e,mediaTypeDetails:c,plaintext:await d("WABlobToArrayBuffer").blobToArrayBuffer(a),protocolMsgId:null,serverMediaType:f,size:a.size,uploadMediaMetric:g});return d("WAResultOrError").makeResult({plaintextHash:e,uploadPromise:b})}async function a(a){var b=a.file,c=a.jid;a=a.thumbnail;var e=d("MAWOptimisticUploadManager").getOptimisticUploadManager(),f=d("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(b.type);f=f.serverMediaType;r.DEBUG(p());var g=await s(b,c,{mediaType:f,type:"regular"});g.success===!0?(r.DEBUG(o()),e.set(g.value.plaintextHash,{file:b,optimisticUploadPromise:g.value.uploadPromise,previewPlaintextHash:null})):(g.error,r.DEBUG(n()));var h=null;r.DEBUG(m(),a!=null);var q=new Uint8Array(await d("WABlobToArrayBuffer").blobToArrayBuffer(b));if(a&&t(f,b.size,q)){r.DEBUG(l());q=d("WAMediaCrypto").convertServerMediaTypeToPreviewMediaType(f);if(q==null){r.MUSTFIX(k(),f);return}f=await s(a,c,{messageType:q,type:"preview"});f.success===!0&&(r.DEBUG(j()),h=f.value.plaintextHash,e.set(f.value.plaintextHash,{file:a,optimisticUploadPromise:f.value.uploadPromise}),g.success===!0&&(r.DEBUG(i()),e.set(g.value.plaintextHash,{file:b,optimisticUploadPromise:g.value.uploadPromise,previewPlaintextHash:h})))}}function t(a,b,c){switch(a){case"gif":return u();case"image":return v(b,c);case"video":return!0;default:r.DEBUG(h(),a);return!1}}function u(){return c("gkx")("8554")===!0?!1:!0}function v(a,b){if(!d("MAWMediaSizeCheck").isMinSizeForImagePreviewGeneration(a))return!1;return!w(b)&&d("MAWConfig").getConfig().shouldFallbackToPreviewForFailedProgressiveJpeg()===!0?!0:!1}function w(a){a=d("WAProgressiveJpegGetScanLengths").getProgressiveJpegScanLengths(a);return a.length>0}g.optimisticUploadMedia=a;g.shouldUploadPreview=t}),98);
__d("WAGetRemotePublicIdentityV2",["WAJids","WASignalDB"],(function(a,b,c,d,e,f,g){"use strict";a=function(a,b){return d("WASignalDB").getDb().runInTransaction(["identity"],"readonly",async function(c){var e=d("WAJids").toMsgrUserJid(b);e=d("WAJids").toDeviceJid(e,a);c=await c.stores.identity.get(e);return c==null?void 0:c.identity},d("WASignalDB").signalOp("getRemotePublicIdentityKey"))};g.getRemotePublicIdentity=a}),98);
__d("MAWLowLevelApiImpl",["MAWBridgeHandlers"],(function(a,b,c,d,e,f,g){"use strict";function a(){return{bridgeHandlers:d("MAWBridgeHandlers").bridgeHandlers}}g.makeLowLevelApi=a}),98);
__d("createInstamadilloAddMessagePayload",["I64","InstamadilloMessageIdUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a){return a!=null?{ephemeralityParams:{ephemeralDurationSec:(h||(h=d("I64"))).to_int32(a)}}:{}}function j(a){return a.isForwarded===!0?{forwardingParams:{forwardedThreadId:(h||(h=d("I64"))).to_string(a.threadKey)}}:{}}function k(a){if(a.replySourceId==null&&a.replySourceTimestampMs==null)return{};function b(){return a.replySourceId!=null?{repliedToMessageOtid:d("InstamadilloMessageIdUtils").fromInstamadilloMessageId(a.replySourceId).stanzaId}:{}}function c(){return a.replySourceTimestampMs!=null?{repliedToMessageWaServerTimeSec:(h||(h=d("I64"))).to_string(a.replySourceTimestampMs)}:{}}return{repliedToMessage:babelHelpers["extends"]({},b(),c())}}function a(a,b){b={content:{text:{text:b?void 0:a.text}},metadata:babelHelpers["extends"]({},i(a.ephemeralDurationInSec),j(a),k(a))};return b}function b(a,b){b={content:{media:b},metadata:babelHelpers["extends"]({},i(a.ephemeralDurationInSec),j(a),k(a))};return b}function c(a,b){b={content:{receiverFetchXma:JSON.parse(b)},metadata:babelHelpers["extends"]({},i(a.ephemeralDurationInSec),j(a),k(a))};return b}g.createInstamadilloAddMessageTextPayload=a;g.createInstamadilloAddMessageMediaPayload=b;g.createInstamadilloAddMessageReceiverFetchXmaPayload=c}),98);
__d("createInstamadilloTransportPayload",[],(function(a,b,c,d,e,f){"use strict";function a(a){a={add:a};return a}function b(a){a={supplement:a};return a}function c(a){a={"delete":a};return a}function d(a){a={franking:a};return a}f.createInstamadilloAddMessageTransportPayload=a;f.createInstamadilloSupplementMessageTransportPayload=b;f.createInstamadilloDeleteMessageTransportPayload=c;f.createInstamadilloFrankingTransportPayload=d}),66);
__d("WAFrameSocket",["WABinary","WAErrors","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["FrameSocket: queueing partial frame of "," bytes"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Buffer to send: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["FrameSocket closed"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["FrameSocket error"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["FrameSocket closed, waiting for pending processing"]);l=function(){return a};return a}var m=function(b){babelHelpers.inheritsLoose(a,b);function a(a){var c="SocketClosed";a=b.call(this,(a=a)!=null?a:c)||this;a.name=c;return a}var c=a.prototype;c.toString=function(){return this.name};return a}(babelHelpers.wrapNativeSuper(Error));a=function(){function a(a,b){var c=this;this.$3=new(d("WABinary").Binary)();this.closed=!1;this.$4=!1;this.onFrame=null;this.onClose=null;this.$5=function(a){c.$3.writeByteArray(a),c.convertBufferedToFrames()};this.$6=function(){if(c.$3.peek(n)){d("WALogger").LOG(l());c.$4=!0;return}c.$9()};this.$7=function(a){d("WALogger").DEV(k()).devConsole(a)};this.$2=b;this.$1=a;a.onData=this.$5;a.onClose=this.$6;a.onError=this.$7}var b=a.prototype;b.sendFrame=function(a){if(this.$4)return;this.throwIfClosed();var b=this.$2,c=a.byteLength;this.$8(c);var d=this.$1.dataToSend;b?(this.$2=null,d.ensureAdditionalCapacity(b.length+3+c),d.writeByteArray(b)):d.ensureAdditionalCapacity(3+c);d.writeUint8(c>>16);d.writeUint16(c&65535);d.write(a);this.$1.requestSend()};b.$9=function(){if(this.closed)return;d("WALogger").LOG(j());this.$4=!1;this.closed=!0;var a=this.onClose;a&&a()};b.$8=function(a){if(a>=1<<24){d("WALogger").WARN(i(),a);throw new(d("WAErrors").BufferTooLargeError)("Buffer too large: "+a)}};b.convertBufferedToFrames=function(){var a=this.$3,b=this.onFrame;while(b&&a.peek(n)){var c=o(a);c=a.readByteArray(c);b(c);b=this.onFrame}this.$4&&!a.peek(n)&&this.$9();b&&a.size()&&d("WALogger").LOG(h(),a.size())};b.throwIfClosed=function(){if(this.closed)throw new m()};b.close=function(){this.$1.close()};return a}();function n(a){if(a.size()<3)return!1;var b=o(a);return b<=a.size()}function o(a){return a.readUint8()<<16|a.readUint16()}g.SocketClosed=m;g.FrameSocket=a}),98);
__d("WANoiseSocket",["WACryptoDependencies","WALogger","WAPromiseQueue"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["sendFrame adding to queue with frame size: "," bytes"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["NoiseSocket socket closed while encrypting frame"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Sending encrypted frame to web socket"]);j=function(){return a};return a}a=Promise.reject("UNINITIALIZED HANDSHAKE");var k=new Uint8Array(0);a.catch(function(){});b=function(){function a(a,b,c){var e=this;this.$4=[];this.$5=new(d("WAPromiseQueue").PromiseQueue)();this.$6=new(d("WAPromiseQueue").PromiseQueue)();this.$7=0;this.$8=0;this.$9=!1;this.$14=function(a){!e.$1.closed?(d("WALogger").DEV(j()).tags("WANoiseSocket"),e.$1.sendFrame(a)):d("WALogger").LOG(i())};this.$12=function(a){var b=e.$7++;e.$5.enqueueHandlers(n(e.$2,b,void 0,a),e.$15)};this.$13=function(){e.$9=!0,e.$5.wait().then(function(){e.$9=!1;var a=e.$11;a&&a()})};this.$15=function(a){e.$10?e.$10(a):e.$4.push(a)};this.$1=a;this.$3=b;this.$2=c;a.onFrame=this.$12;this.$1.onClose=this.$13;a.convertBufferedToFrames()}var b=a.prototype;b.sendFrameAsync=async function(a){a=await this.sendFrame(a);return a};b.sendFrame=function(a){if(this.$9)return Promise.resolve();this.$1.throwIfClosed();var b=this.$8++;d("WALogger").DEV(h(),a.length).tags("WANoiseSocket");return this.$6.enqueueHandlers(m(this.$3,b,void 0,a),this.$14)};b.setOnFrame=function(a){this.$10=a};b.setOnClose=function(a){this.$11=a};b.close=function(){this.$1.close()};return a}();function l(a){var b=new ArrayBuffer(12),c=new DataView(b);c.setUint32(8,a);return new Uint8Array(b)}function m(a,b,c,e){return d("WACryptoDependencies").getCrypto().subtle.encrypt({name:"AES-GCM",iv:l(b),additionalData:c?new Uint8Array(c):k},a,e)}function n(a,b,c,e){return d("WACryptoDependencies").getCrypto().subtle.decrypt({name:"AES-GCM",iv:l(b),additionalData:c?new Uint8Array(c):k},a,e)}g.NoiseSocket=b}),98);
__d("getBroadcastChannelForExecutionContext",["CometTaskFrameworkTypes","MWBroadcastChannel"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return d("MWBroadcastChannel").MWBroadcastChannel(d("CometTaskFrameworkTypes").TASK_FRAMEWORK_PREFIX+"_"+String(a))}g["default"]=a}),98);
__d("loadTaskHandlerResource",["cr:3760"],(function(a,b,c,d,e,f,g){"use strict";async function a(a){a=b("cr:3760").TASK_HANDLERS_RESOURCES[a];return a==null?null:a.getModuleIfRequired()||a.load()}g.default=a}),98);
__d("registerExecutionContext",["BroadcastChannelClientServerHandshake","FBLogger","getBroadcastChannelForExecutionContext","loadTaskHandlerResource","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";async function h(a,b){var d=a.context,e=a.name,f=a.payload;try{var g=await c("loadTaskHandlerResource")(e);if(g==null)throw c("FBLogger")("messenger_web").mustfixThrow("No task handler found in context %s",e);e=await g.handleTask(f,d);g={context:d,result:e,type:"task_success"};b.postMessage(g)}catch(g){c("FBLogger")("messenger_web").catching(g).mustfix("%s executionContext: Failed to execute task %s",String(a.context.executionContext),a.name);e={context:d,reason:(f=g.message)!=null?f:"",type:"task_failure"};b.postMessage(e)}return}function a(a){var b=c("getBroadcastChannelForExecutionContext")(a);d("BroadcastChannelClientServerHandshake").listen(b);var e=new Set();b.addEventListener("message",function(a){switch(a.data.type){case"execute_task":a=a.data;var d=a.context.taskID;if(e.has(d))return;e.add(d);c("promiseDone")(h(a,b).finally(function(){e.delete(d)}));break;default:}});return function(){return b.close()}}g.default=a}),98);
__d("MAWMainWebWorker",["CurrentWorkerMessagePort","FalcoLoggerTransports","MAWBackend","MAWCommonMainWebWorker","MAWLowLevelApiImpl","MAWMainWebWorkerConfig","WABridge","WADynamicRouterSync","WorkerBridgeAdaptor","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h=!((b=c("gkx")("23949"))!=null?b:!1);function a(){var a=new(c("WorkerBridgeAdaptor"))(d("CurrentWorkerMessagePort").getMessagePort(),"MAWMainWebWorker");d("WABridge").makeWABridge(new(d("WADynamicRouterSync").DynamicRouterSync)());d("MAWCommonMainWebWorker").initWorker({config:d("MAWMainWebWorkerConfig").waConfig,currentWorker:a,initBackend:d("MAWBackend").startMAWBackend,makeLowLevelApi:d("MAWLowLevelApiImpl").makeLowLevelApi});h&&d("FalcoLoggerTransports").attach()}g["default"]=a}),98);
__d("MAWMainWebWorkerV2",["MAWMainWebWorker"],(function(a,b,c,d,e,f,g){"use strict";g["default"]=c("MAWMainWebWorker")}),98);